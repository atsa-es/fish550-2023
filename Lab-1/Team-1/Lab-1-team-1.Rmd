---
title: Lab 1 Forecasting with ARIMA models
author: Nick Chambers (SAFS), Liz Elmstrom (SAFS), Maria Kuruvilla (QERM)
date: March 22, 2023
output: 
  html_document:
    code-folding: true
    toc: true
    toc_float: true
---

```{r include=FALSE}
library(tidyverse)
library(tseries)
library(forecast)
library(zoo)

options(dplyr.summarise.inform = FALSE)
```

# Question your team will address

What will your team do with the data? You can do many things with the data. The only constraints are that you

* fit ARIMA models (note you'll want to log the abundance data). You can fit other models in addition ot ARIMA if you want.
* do diagnostics for ARIMA models
* make forecasts
* test how good your forecasts or compare forecasts (many options here)

# Method you will use

## Initial plan

Describe what you plan to do to address your question. Note this example is with Ruggerone & Irvine data but your team will use the Bristol Bay data.

Example, "We will fit ARIMA models to 1960-1980 data on pink salmon in 2 regions in Alaska and 2 regions in E Asia. We will make 1981-1985  forecasts (5 year) and compare the accuracy of the forecasts to the actual values. We will measure accuracy with mean squared error. We will use the forecast package to fit the ARIMA models."

## What you actually did

Example, "We were able to do our plan fairly quickly, so after writing the basic code, we divided up all 12 regions in Ruggerone & Irvine and each team member did 4 regions. We compared the accuracy of forecasts for different time periods using 20-years for training and 5-year forecasts each time. We compared the RMSE, MAE, and MAPE accuracy measures."

# START CODING

## Read in and explore data (LIZ)

Bristol Bay Data. Discuss what part of the data set you will work with.

Read in the data 
```{r}

bb_data <- readRDS(here::here("Lab-1", "Data_Images", "bristol_bay_data_plus_covariates.rds"))

cat("colnames: ", colnames(bb_data), "\n")
cat("system (river): ", unique(bb_data$system), "\n")
cat("age groups: ", unique(bb_data$age_group), "\n")

```

Explore the data 
```{r}
bb_data %>% 
  group_by(system, ret_yr) %>%
  summarize(total = sum(ret, na.rm=TRUE)) %>%
  ggplot(aes(x=ret_yr, y=log(total))) + 
    geom_line() + 
    ggtitle("log abundance by river") +
    facet_wrap(~system)

bb_data %>%
  group_by(system, ret_yr) %>%
  summarize(total = sum(forecast.adfw, na.rm=TRUE)) %>%
  ggplot(aes(x=ret_yr, y=log(total))) +
    geom_line() +
    ggtitle("ADFW log abundance by river") +
    facet_wrap(~system)

bb_data %>% 
  group_by(system, ret_yr) %>%
  summarize(total = sum(forecast.fri, na.rm=TRUE)) %>%
  ggplot(aes(x=ret_yr, y=log(total))) + 
    geom_line() + 
    ggtitle("FRI log abundance by river") +
    facet_wrap(~system)

```

Based on this, we chose XXX insert three rivers XXXX to explore 1) total abundance, 2) compare ARIMA forecasts/accuracy, and 3) visually compare to these forecasts to forecasts from UW Fisheries Research Institute. 

# DIAGNOSTICS AND PRELIMARY EXPLORATION (LIZ)

## Plot the data

Plot the data and discuss any obvious problems with stationarity from your visual test.

```{r}

#Sum and log returns for each river and year
lndata <- bb_data %>%
  group_by(system, ret_yr) %>%
  summarize(lntotal = log(sum(ret, na.rm=TRUE)))

# Choosing sites CHANGE THIS BASED ON WHAT WE PICK
our_rivers <- filter(lndata, system %in% c("Egegik","Igushik", 
                                           'Kvichak', 'Wood', 'Nushagak'))

# Plotting three rivers
our_rivers %>% 
  ggplot(aes(x=ret_yr, y=lntotal)) + 
    geom_line() + 
    ggtitle("log abundance by river") +
    facet_wrap(~system)+theme_bw()

```

Based on these plots, we hypothesize that data will be non-stationary for XXX, and stationary for Wood around a trend. 

## Use ACF and PACF (MARIA)

Use the ACF and PACF plots to explore the time series. What did you learn? Also try decomposition.

```{r}


data_ts_Kv <- ts(our_rivers$lntotal[our_rivers$system == "Kvichak"],
                      start=our_rivers$ret_yr[our_rivers$system == "Kvichak"][1])

data_ts_Wood <- ts(our_rivers$lntotal[our_rivers$system == "Wood"],
                      start=our_rivers$ret_yr[our_rivers$system == "Wood"][1])

data_ts_Nu <- ts(our_rivers$lntotal[our_rivers$system == "Nushagak"],
                      start=our_rivers$ret_yr[our_rivers$system == "Nushagak"][1])



acf(data_ts_Wood)

pacf(data_ts_Wood)



acf(data_ts_Kv)

pacf(data_ts_Kv)


acf(data_ts_Nu)

pacf(data_ts_Nu)

```

The acf plots for Wood river is slowly decaying and the pacf plot shows significance at lag 1. There might be AR1 structure in the data.

The pacf plots for Kvichak river is slowly decaying and the pacf plot shows significance at lags 1,2,4, and 6. There might be MA structure in the data.

The acf plots for Nushagak river is slowly decaying and the pacf plot shows significance at lags 1 and 6. There might be AR structure in the data.

## Test for stationarity (NICK)

Run tests and discuss any stationarity issues and how these were addressed.

```{r}

```

## Difference tests (LIZ)

```{r}

# CHANGE NAMES ONCE RIVERS ARE CHOSEN

eg <- filter(lndata, system %in% c("Egegik"))
ndiffs(eg$lntotal, test='kpss')
ndiffs(eg$lntotal, test='adf')

## testing the others in case
ig <- filter(lndata, system %in% c("Igushik"))
ndiffs(ig$lntotal, test='kpss')
ndiffs(ig$lntotal, test='adf')

kv <- filter(lndata, system %in% c("Kvichak"))
ndiffs(kv$lntotal, test='kpss')
ndiffs(kv$lntotal, test='adf')


wo <- filter(lndata, system %in% c("Wood"))
ndiffs(wo$lntotal, test='kpss')
ndiffs(wo$lntotal, test='adf')

```

# MODELING AND RESULTS

## Dividing the data into test and train (MARIA)

```{r}


data_ts_Wood <- ts(our_rivers$lntotal[our_rivers$system == "Wood"],
                      start=our_rivers$ret_yr[our_rivers$system == "Wood"][1])

train_Wood <- window(data_ts_Wood, 1963, 2015)
test_Wood <- window(data_ts_Wood, 2015, 2020)

data_ts_Kv <- ts(our_rivers$lntotal[our_rivers$system == "Kvichak"],
                      start=our_rivers$ret_yr[our_rivers$system == "Kvichak"][1])


train_Kv <- window(data_ts_Kv, 1963, 2015)
test_Kv <- window(data_ts_Kv, 2015, 2020)


data_ts_Nu <- ts(our_rivers$lntotal[our_rivers$system == "Nushagak"],
                      start=our_rivers$ret_yr[our_rivers$system == "Nushagak"][1])

train_Nu <- window(data_ts_Nu, 1963, 2015)
test_Nu <- window(data_ts_Nu, 2015, 2020)

```

## Fit ARIMA models (MARIA)
Fit a model with `auto.arima()` in the forecast package.

```{r}

mod_Wood <- auto.arima(data_ts_Wood)
mod_Wood

mod_Kv <- auto.arima(data_ts_Kv)
mod_Kv

mod_Nu <- auto.arima(data_ts_Nu)
mod_Nu
#mod_Wood <- auto.arima(data_ts_Wood)
```

## Plot forecasts (LIZ)
```{r}

# CHANGE NAMES ONCE RIVERS ARE CHOSEN

fri_fore <- bb_data %>%
  group_by(system, ret_yr) %>%
  summarize(lntotal = log(sum(forecast.fri, na.rm=TRUE)))

eg_fri_fore <- fri_fore %>% filter(system %in% 'Egegik')
fr <- forecast(mod.eg, h=5)
autoplot(fr) + geom_point(aes(x=x, y=y), data=fortify(e.test))+
  geom_point(aes(x=ret_yr, y=lntotal), data = eg_fri_fore, col='red')

ig_fri_fore <- fri_fore %>% filter(system %in% 'Igushik')
i.fr <- forecast(mod.ig, h=5)
autoplot(i.fr) + geom_point(aes(x=x, y=y), data=fortify(i.test))+
  geom_point(aes(x=ret_yr, y=lntotal), data = ig_fri_fore, col = "red")

kv_fri_fore <- fri_fore %>% filter(system %in% 'Kvichak')
k.fr <- forecast(mod.kv, h=5)
autoplot(k.fr) + geom_point(aes(x=x, y=y), data=fortify(kv.test))+
  geom_point(aes(x=ret_yr, y=lntotal), data = kv_fri_fore, col = "red")

```

## Check accuracy (NICK)
```{r}

```

## Check residuals (NICK)

```{r}

```

# DISCUSSION

# Description of each team member's contributions

Example: "All team members helped decide on the goal and ran the analyses for the individual regions. Team members 2 & 3 wrote most of the code for the analysis of the regions. Team member 4 researched approaches for measuring accuracy of forecasts in [Hyndman & Athanasopoulos[OTexts.com/fpp2] and team member 2 added code for that to the methods. Team member 4 also researched tests for stationarity and worked with team member 2 to code that up. Team member 1 worked on the plotting section of the report using and adapting code that team member 3 wrote. All team members helped edit the report and wrote the discussion together."

