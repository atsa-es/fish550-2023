---
title: Lab 1 Forecasting with ARIMA models
author: Veggerby, Wang
date: April 10, 2023
output: 
  html_document:
    code-folding: true
    toc: true
    toc_float: true
---

```{r include=FALSE}
library(tidyverse)
library(here)
options(dplyr.summarise.inform = FALSE)
```

# Lab 1: ARIMA models

Team member names: Terrance Wang (SAFS), Josh Zahner (SAFS), Karl Veggerby (SAFS)


# Data

Ruggerone & Irvine Data. We will focus on sockeye salmon and all their 15 regional stocks in the North Pacific. 

# Question your team will address

What is the autoregressive structure for sockeye salmon? Is there a general autoregressive structure to describe all sockeye salmon regional stocks? Are there similarities and differences within and between the Eastern and Western North regional Pacific stocks? 

* fit ARIMA models (note you'll want to log the abundance data). You can fit other models in addition ot ARIMA if you want.
* do diagnostics for ARIMA models
* make forecasts
* test how good your forecasts or compare forecasts (many options here)

Example, "Our team decided to compare the accuracy of forecasts using best fit ARIMA models for pink salmon using 4 regions in the Ruggerone & Irvine data. Our question is whether forecast accuracy is different for different regions."

# Method you will use

ARIMA for individual regional stock time series trends. ANOVA for comparing ARIMA parameters. 

## Initial plan

We will fit ARIMA models for each of the sockeye regional stocks with the Box Jenkins method, which includes selecting the model form, estimating the parameters, and diagnosing the model. We will then compare the parameters of the individual ARIMA model structure among regional stocks and larger regional aggregations through ANOVA. We w 

## What you actually did

Example, "We were able to do our plan fairly quickly, so after writing the basic code, we divided up all 12 regions in Ruggerone & Irvine and each team member did 4 regions. We compared the accuracy of forecasts for different time periods using 20-years for training and 5-year forecasts each time. We compared the RMSE, MAE, and MAPE accuracy measures."

# Diagnostics and preliminary exploration
```{r}
# read in data
rug_path = file.path(here(), 'Lab-1','Data_Images','ruggerone_data.rds')
ruggerone_data = readRDS(rug_path)

# get sockeye data per region
sockeye_data=ruggerone_data %>% 
  mutate(lnreturns=log(returns)) %>%
  filter(species=="sockeye" & !region %in% c("korea","japan")) # do not include NA or all 0 data

# summarise data by area
subdata <- ruggerone_data %>% 
  mutate(
    area = case_match(
      region, 
      c("japan", "korea", "m_i", "e_kam", "w_kam") ~ "East_Asia",
      c("wak", "s_pen", "kod", "ci", "pws", "seak") ~ "Alaska",
      c("nbc", "sbc", "wa", "wc") ~ "WC",
      .default = region
    )) %>%
  group_by(area, species, year) %>%
  summarize(lntotal = log(sum(returns, na.rm=TRUE)))

    ```
## Plot the data
```{r}
sockeye_data %>% 
  ggplot(aes(x=year, y=lnreturns)) + 
    geom_line() + 
    ggtitle("log abundance by region")+
    facet_wrap(~region,scales = "free")

subdata %>% filter(species=="sockeye")%>%
  ggplot(aes(x=year, y=lntotal)) + 
    geom_line() + 
    ggtitle("log abundance by region")+
    facet_wrap(~area)

```
# Regional stocks 
Systematic changes in the mean are present in many of the stocks (e.g., nbc, w_kam, kod). There are a few increasing means and some random-walk-like ones. There is a strong linear trend in the ci, kod, and s_pen regions. Changes in the variance may also be present in a few stocks (e.g., wak, kod). 2-year periodic variations are possible in several regions (e.g., wak, sbc). 

## Use ACF and PACF
```{r}
library(forecast)
# run ACF and PACF for each region, massage data into longer format for ggplotting
sockeye_acf_pacf = sockeye_data %>% 
  group_by(region) %>% 
  summarise(list_acf=list(acf(lnreturns, plot=FALSE)),
            list_pacf=list(pacf(lnreturns, plot=FALSE))) %>%
  mutate(acf_lnreturns=purrr::map(list_acf, ~as.numeric(.x$acf)),
         # add 1 to first value of PCF, one of the weird things Mark mentioned
         pacf_lnreturns=purrr::map(list_pacf, ~as.numeric(c(0,.x$acf)))) %>% 
  select(-c(list_acf,list_pacf)) %>% 
  unnest(c(acf_lnreturns,pacf_lnreturns)) %>% 
  group_by(region) %>% 
  mutate(lag=row_number() - 1) %>%
  pivot_longer(cols=c(acf_lnreturns,pacf_lnreturns),
               values_to = "cf",
               names_to = "cf_type")

sockeye_ci = sockeye_data %>% 
  group_by(region) %>% 
  summarise(ci = qnorm((1 + 0.95)/2)/sqrt(n()))

ggplot(sockeye_acf_pacf,aes(x=lag, y=cf, fill=cf_type)) +
  geom_bar(stat="identity", position = 'dodge',width=1) +
  geom_hline(yintercept = 0) +
  geom_hline(data = sockeye_ci, aes(yintercept = -ci), color="blue", linetype="dotted") +
  geom_hline(data = sockeye_ci, aes(yintercept = ci), color="blue", linetype="dotted") +
  labs(x="Lag", y="ACF") +
  facet_wrap(~region) + theme_bw()
```
A handful of regions (e.g., ci, seak) show ACF with a long tail and PACFs that cut off at 1-3 orders, which may indicate some autoregressive structure. Other regions (e.g., pws, m_i) have a sharp cut off with ACF and tailing PACFs, which may suggest a moving average structure. Some regions (s_pen,w_kam,kod) show long tails for both ACF and PACF, suggesting ARMA structure. A few regions show periodic trends (negative AR parameters) from their oscillating correlations factors. 

Use the ACF and PACF plots to explore the time series. What did you learn? Also try decomposition.

## Test for stationarity

Run tests and discuss any stationarity issues and how these were addressed.

Doing a visual inspection of sockeye in the three regions shows that the raw data do not appear to be stationary. The Alaska region could potencilly be moving around a linear trend, but unclear. East Asia clearly does not show stationarity. The West Coast data may be stationary, but the variance may be increasing over time. 

```{r}
library(tseries)

subdata_sockeye<-subdata %>% filter(species=="sockeye")

# can't get select to work here
alaska_sockeye<-subdata_sockeye %>% 
  filter(area=="Alaska") %>%
  select(lntotal)

# dickey fuller test for stationarity alaska
alaska_sockeye_vec<-alaska_sockeye$lntotal

adf.test(alaska_sockeye_vec)

# do first difference to see if we can get to stationarity
alaska_sockeye_vec_1diff<-diff(alaska_sockeye_vec)

adf.test(alaska_sockeye_vec_1diff)
# doing a first difference successful for Alaska


# dickey fuller test for stationarity east asia
asia_sockeye<-subdata_sockeye %>% 
  filter(area=="East_Asia") %>%
  select(lntotal)

asia_sockeye_vec<-asia_sockeye$lntotal

adf.test(asia_sockeye_vec)

asia_sockeye_vec_1diff<-diff(asia_sockeye_vec)
adf.test(asia_sockeye_vec_1diff)

# dickey fuller test for stationarity west coast
wc_sockeye<-subdata_sockeye %>% 
  filter(area=="WC") %>%
  select(lntotal)

wc_sockeye_vec<-wc_sockeye$lntotal

adf.test(wc_sockeye_vec)


wc_sockeye_vec_1diff<-diff(wc_sockeye_vec)
adf.test(wc_sockeye_vec_1diff)

# confirm with forcast 
forecast::ndiffs(asia_sockeye_vec)
forecast::ndiffs(asia_sockeye_vec)
forecast::ndiffs(wc_sockeye_vec)

```




# Results

A handful of regions (e.g., ci, seak) show ACF with a long tail and PACFs that cut off at 1-3 orders, which may indicate some autoregressive structure. Other regions (e.g., pws, m_i) have a sharp cut off with ACF and tailing PACFs, which may suggest a moving average structure. Some regions (s_pen,w_kam,kod) show long tails for both ACF and PACF, suggesting ARMA structure. A few regions show periodic trends (negative AR parameters) from their oscillating correlations factors. 

Sockeye salmon in East Asia and Alaska appear to have random walk characteristics. Using a random walk style model, or differenced in order to use a Box Jenkins approach seems necessary. First differencing successfully removes the random walk characteristics for all three regions. West coast sockeye do not appear to need differencing, while manually doing differencing and a dickey fuller test initially appeared to suggest differencing, the forcast package indicated that this population group did not actually need differencing.  

# Discussion



# Description of each team member's contributions

Terrance did most of it, Karl did stationarity section.
