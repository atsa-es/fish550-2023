---
title: Lab 1 Forecasting with ARIMA models
author: Veggerby, Wang
date: April 10, 2023
output: 
  html_document:
    code-folding: true
    toc: true
    toc_float: true
---

```{r include=FALSE}
library(tidyverse)
library(here)
options(dplyr.summarise.inform = FALSE)
```

# Lab 1: ARIMA models

Team member names: Terrance Wang (SAFS), Josh Zahner (SAFS), Karl Veggerby (SAFS)


# Data

Ruggerone & Irvine Data. We will focus on sockeye salmon and all their 15 regional stocks in the North Pacific. 

# Question your team will address

What is the autoregressive structure for sockeye salmon? Is there a general autoregressive structure to describe all sockeye salmon regional stocks? Are there similarities and differences within and between the Eastern and Western North regional Pacific stocks? 

* fit ARIMA models (note you'll want to log the abundance data). You can fit other models in addition ot ARIMA if you want.
* do diagnostics for ARIMA models
* make forecasts
* test how good your forecasts or compare forecasts (many options here)

Example, "Our team decided to compare the accuracy of forecasts using best fit ARIMA models for pink salmon using 4 regions in the Ruggerone & Irvine data. Our question is whether forecast accuracy is different for different regions."

# Method you will use

ARIMA for individual regional stock time series trends. ANOVA for comparing ARIMA parameters. 

## Initial plan

We will fit ARIMA models for each of the sockeye regional stocks with the Box Jenkins method, which includes selecting the model form, estimating the parameters, and diagnosing the model. We will then compare the parameters of the individual ARIMA model structure among regional stocks and larger regional aggregations through ANOVA. We w 

## What you actually did

Example, "We were able to do our plan fairly quickly, so after writing the basic code, we divided up all 12 regions in Ruggerone & Irvine and each team member did 4 regions. We compared the accuracy of forecasts for different time periods using 20-years for training and 5-year forecasts each time. We compared the RMSE, MAE, and MAPE accuracy measures."

# Diagnostics and preliminary exploration
```{r}
# read in data
rug_path = file.path(here(), 'Lab-1','Data_Images','ruggerone_data.rds')
ruggerone_data = readRDS(rug_path)

# get sockeye data per region
sockeye_data=ruggerone_data %>% 
  mutate(lnreturns=log(returns)) %>%
  filter(species=="sockeye" & !region %in% c("korea","japan")) # do not include NA or all 0 data

# summarise data by area
subdata <- ruggerone_data %>% 
  mutate(
    area = case_match(
      region, 
      c("japan", "korea", "m_i", "e_kam", "w_kam") ~ "East_Asia",
      c("wak", "s_pen", "kod", "ci", "pws", "seak") ~ "Alaska",
      c("nbc", "sbc", "wa", "wc") ~ "WC",
      .default = region
    )) %>%
  group_by(area, species, year) %>%
  summarize(lntotal = log(sum(returns, na.rm=TRUE)))

    ```
## Plot the data
```{r}
sockeye_data %>% 
  ggplot(aes(x=year, y=lnreturns)) + 
    geom_line() + 
    ggtitle("log abundance by region")+
    facet_wrap(~region,scales = "free")

subdata %>% filter(species=="sockeye")%>%
  ggplot(aes(x=year, y=lntotal)) + 
    geom_line() + 
    ggtitle("log abundance by region")+
    facet_wrap(~area)

```
# Regional stocks 
Systematic changes in the mean are present in many of the stocks (e.g., nbc, w_kam, kod). There are a few increasing means and some random-walk-like ones. There is a strong linear trend in the ci, kod, and s_pen regions. Changes in the variance may also be present in a few stocks (e.g., wak, kod). 2-year periodic variations are possible in several regions (e.g., wak, sbc). 

## Use ACF and PACF
```{r}
library(forecast)
# run ACF and PACF for each region, massage data into longer format for ggplotting
sockeye_acf_pacf = sockeye_data %>% 
  group_by(region) %>% 
  summarise(list_acf=list(acf(lnreturns, plot=FALSE)),
            list_pacf=list(pacf(lnreturns, plot=FALSE))) %>%
  mutate(acf_lnreturns=purrr::map(list_acf, ~as.numeric(.x$acf)),
         # add 1 to first value of PCF, one of the weird things Mark mentioned
         pacf_lnreturns=purrr::map(list_pacf, ~as.numeric(c(0,.x$acf)))) %>% 
  select(-c(list_acf,list_pacf)) %>% 
  unnest(c(acf_lnreturns,pacf_lnreturns)) %>% 
  group_by(region) %>% 
  mutate(lag=row_number() - 1) %>%
  pivot_longer(cols=c(acf_lnreturns,pacf_lnreturns),
               values_to = "cf",
               names_to = "cf_type")

sockeye_ci = sockeye_data %>% 
  group_by(region) %>% 
  summarise(ci = qnorm((1 + 0.95)/2)/sqrt(n()))

ggplot(sockeye_acf_pacf,aes(x=lag, y=cf, fill=cf_type)) +
  geom_bar(stat="identity", position = 'dodge',width=1) +
  geom_hline(yintercept = 0) +
  geom_hline(data = sockeye_ci, aes(yintercept = -ci), color="blue", linetype="dotted") +
  geom_hline(data = sockeye_ci, aes(yintercept = ci), color="blue", linetype="dotted") +
  labs(x="Lag", y="ACF") +
  facet_wrap(~region) + theme_bw()
```
A handful of regions (e.g., ci, seak) show ACF with a long tail and PACFs that cut off at 1-3 orders, which may indicate some autoregressive structure. Other regions (e.g., pws, m_i) have a sharp cut off with ACF and tailing PACFs, which may suggest a moving average structure. Some regions (s_pen,w_kam,kod) show long tails for both ACF and PACF, suggesting ARMA structure. A few regions show periodic trends (negative AR parameters) from their oscillating correlations factors. 

Use the ACF and PACF plots to explore the time series. What did you learn? Also try decomposition.

## Test for stationarity

Run tests and discuss any stationarity issues and how these were addressed.

# Results

# Discussion

# Description of each team member's contributions

Example: "All team members helped decide on the goal and ran the analyses for the individual regions. Team members 2 & 3 wrote most of the code for the analysis of the regions. Team member 4 researched approaches for measuring accuracy of forecasts in [Hyndman & Athanasopoulos[OTexts.com/fpp2] and team member 2 added code for that to the methods. Team member 4 also researched tests for stationarity and worked with team member 2 to code that up. Team member 1 worked on the plotting section of the report using and adapting code that team member 3 wrote. All team members helped edit the report and wrote the discussion together."

