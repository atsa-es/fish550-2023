<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Liz Elmstrom, Terrance Wang, Eric French">
<meta name="dcterms.date" content="2023-04-20">

<title>9&nbsp; Team 2 - Lab 2 – Fish 550 Spring 2023</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../Lab-2/Final_Write_ups/Lab-2-team-3_final.html" rel="next">
<link href="../../Lab-2/Final_Write_ups/Lab-2-team-1_final.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-626149efe8f5d16e1d391ba177679bf0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../Lab-2/Lab2-MARSS.html">Analyzing multivariate salmon data with MARSS</a></li><li class="breadcrumb-item"><a href="../../Lab-2/Final_Write_ups/Lab-2-team-2_final.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Team 2 - Lab 2</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">Fish 550 Spring 2023</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/atsa-es/fish550-2023" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Labs</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Forecasting with ARIMA models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-1/Lab1-ARIMA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Lab Intro</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-1/Final_Write_ups/Lab-1-team-1_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Team 1 - Lab 1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-1/Final_Write_ups/Lab-1-team-2_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Team 2 - Lab 1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-1/Final_Write_ups/Lab-1-team-3_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Team 3 - Lab 1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-1/Final_Write_ups/Lab-1-team-4_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Team 4 - Lab 1</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Analyzing multivariate salmon data with MARSS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-2/Lab2-MARSS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Lab Intro</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-2/Final_Write_ups/Lab-2-team-1_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Team 1 - Lab 2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-2/Final_Write_ups/Lab-2-team-2_final.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Team 2 - Lab 2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-2/Final_Write_ups/Lab-2-team-3_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Team 3 - Lab 2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-2/Final_Write_ups/Lab-2-team-4_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Team 4 - Lab 2</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Dynamic Factor Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-3/Lab-3-DFA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Lab Intro</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-3/Final_Write_ups/Lab-3-team-1_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Team 1 - Lab 3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-3/Final_Write_ups/Lab-3-team-2_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Team 2 - Lab 3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-3/Final_Write_ups/Lab-3-team-3_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Team 3 - Lab 3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-3/Final_Write_ups/Lab-3-team-4_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Team 4 - Lab 3</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Hidden Markov Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-4/Lab-4-HMM.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Lab Intro</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-4/Final_Write_ups/Lab-4-team-1_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Team 1 - Lab 4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-4/Final_Write_ups/Lab-4-team-2_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Team 2 - Lab 4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-4/Final_Write_ups/Lab-4-team-3_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Team 3 - Lab 4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-4/Final_Write_ups/Lab-4-team-4_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Team 4 - Lab 4</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Dynamic Linear Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-5/Lab-5-DLM.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Lab 5 - Dynamic Linear Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-5/Final_Write_ups/Lab-5-team-1_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Team 1 - Lab 5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-5/Final_Write_ups/Lab-5-team-2_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Team 2 - Lab 5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-5/Final_Write_ups/Lab-5-team-3_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Team 3 - Lab 5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-5/Final_Write_ups/Lab-5-team-4_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Team 3 - Lab 5</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#general-questions" id="toc-general-questions" class="nav-link active" data-scroll-target="#general-questions">General Questions</a></li>
  <li><a href="#methods" id="toc-methods" class="nav-link" data-scroll-target="#methods">Methods</a></li>
  <li><a href="#data-exploration" id="toc-data-exploration" class="nav-link" data-scroll-target="#data-exploration">Data exploration</a></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a>
  <ul class="collapse">
  <li><a href="#the-simplest-model" id="toc-the-simplest-model" class="nav-link" data-scroll-target="#the-simplest-model">The simplest model</a></li>
  <li><a href="#the-most-flexible-model" id="toc-the-most-flexible-model" class="nav-link" data-scroll-target="#the-most-flexible-model">The most flexible model</a></li>
  <li><a href="#model-assumptions" id="toc-model-assumptions" class="nav-link" data-scroll-target="#model-assumptions">Model Assumptions</a></li>
  <li><a href="#marss-model-selection" id="toc-marss-model-selection" class="nav-link" data-scroll-target="#marss-model-selection">MARSS Model Selection</a></li>
  <li><a href="#inspecting-the-best-model-spatial-group-unconstrained-q-equal-u" id="toc-inspecting-the-best-model-spatial-group-unconstrained-q-equal-u" class="nav-link" data-scroll-target="#inspecting-the-best-model-spatial-group-unconstrained-q-equal-u">Inspecting the best model (spatial group, unconstrained Q, equal U)</a></li>
  <li><a href="#comparing-best-model-to-the-most-flexible-model" id="toc-comparing-best-model-to-the-most-flexible-model" class="nav-link" data-scroll-target="#comparing-best-model-to-the-most-flexible-model">Comparing best model to the most flexible model</a></li>
  </ul></li>
  <li><a href="#seasonality-as-a-covariate" id="toc-seasonality-as-a-covariate" class="nav-link" data-scroll-target="#seasonality-as-a-covariate">Seasonality as a covariate</a>
  <ul class="collapse">
  <li><a href="#initial-model-fitting" id="toc-initial-model-fitting" class="nav-link" data-scroll-target="#initial-model-fitting">Initial model fitting</a></li>
  <li><a href="#evaluating-the-effect-of-different-cycles" id="toc-evaluating-the-effect-of-different-cycles" class="nav-link" data-scroll-target="#evaluating-the-effect-of-different-cycles">Evaluating the effect of different cycles</a></li>
  <li><a href="#comparing-models-with-and-without-5-year-cycles" id="toc-comparing-models-with-and-without-5-year-cycles" class="nav-link" data-scroll-target="#comparing-models-with-and-without-5-year-cycles">Comparing models with and without 5 year cycles</a></li>
  </ul></li>
  <li><a href="#discussion" id="toc-discussion" class="nav-link" data-scroll-target="#discussion">Discussion</a></li>
  <li><a href="#description-of-each-team-members-contributions" id="toc-description-of-each-team-members-contributions" class="nav-link" data-scroll-target="#description-of-each-team-members-contributions">Description of each team member’s contributions</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/atsa-es/fish550-2023/edit/main/Lab-2/Final_Write_ups/Lab-2-team-2_final.Rmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/atsa-es/fish550-2023/blob/main/Lab-2/Final_Write_ups/Lab-2-team-2_final.Rmd" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/atsa-es/fish550-2023/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../Lab-2/Lab2-MARSS.html">Analyzing multivariate salmon data with MARSS</a></li><li class="breadcrumb-item"><a href="../../Lab-2/Final_Write_ups/Lab-2-team-2_final.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Team 2 - Lab 2</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Team 2 - Lab 2</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Lab 2 MARSS Models</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Liz Elmstrom, Terrance Wang, Eric French </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 20, 2023</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="general-questions" class="level1">
<h1>General Questions</h1>
<p>Each group has the same general tasks, but you will adapt them as you work on the data.</p>
<ol type="1">
<li><p>Create estimates of spawner abundance for all missing years and provide estimates of the decline from the historical abundance.</p></li>
<li><p>Evaluate support for the major population groups. Are the populations in the groups more correlated than outside the groups?</p></li>
<li><p>Evaluate the evidence of cycling in the data. <em>We will talk about how to do this on the Tuesday after lab.</em></p></li>
</ol>
<p>We analyzed the Steelhead (Lower Columbia ESU). We decided to exclude the Gorge Tributary winter run because there was only 1 short time series, and focused the 9 remaining runs that belonged to Cascade major population group.</p>
</section>
<section id="methods" class="level1">
<h1>Methods</h1>
<p>We tested 5 different population groups hypotheses: one population, individual populations, run timing groups, spatial groups, and correlation groups.</p>
<p>One population <span class="math display">\[
\begin{bmatrix} y_{1} \\ y_{2} \\ \vdots \\y_{9} \end{bmatrix}_{t} =
\begin{bmatrix}1\\
1\\
\vdots\\
\\
1\end{bmatrix}
x_{t}  + \mathbf{a} + \mathbf{v_t} \text{ where } \mathbf{v_t} \sim MVN(0, \mathbf{R})
\]</span></p>
<p><span class="math display">\[
\begin{bmatrix} x \end{bmatrix}_{t} =
\begin{bmatrix}1\\
\end{bmatrix}
x_{t-1}  + u + w_t \text{ where } w_t \sim N(0,q)
\]</span></p>
<p>Individual populations <span class="math display">\[
\begin{bmatrix} y_{1} \\ y_{2} \\ \vdots \\y_{9} \end{bmatrix}_{t} =
I_{9}
\begin{bmatrix} x_{1} \\ x_{2} \\ \vdots \\x_{9} \end{bmatrix}_{t} + \mathbf{a} + \mathbf{v_t} \text{ where } \mathbf{v_t} \sim MVN(0, \mathbf{R})
\]</span> <span class="math display">\[
\begin{bmatrix} x_{1} \\
x_{2} \\
\vdots \\
x_{9}
\end{bmatrix}_{t}
=
I_{9}
\begin{bmatrix} x_{1} \\
x_{2} \\
\vdots \\
x_{9}
\end{bmatrix}_{t-1}  + \begin{bmatrix}u_{1}\\u_{2}\\ \vdots \\u_{9} \end{bmatrix}  + \mathbf{w_t} \text{ where } \mathbf{w_t} \sim MVN(0, \mathbf{Q})
\]</span> Run Timing Groups, Spatial Groups, Correlation Groups We provide the Z matrices for the 3 groupings below. <span class="math display">\[
\begin{equation*}
\begin{array}{rcccc}
&amp;Run Timing&amp;Spatial&amp;Correlation\\
&amp;\text{summer winter}&amp;\text{Coweeman E-Fork-Lewis Kalama Cowlitz Washougal}&amp;\text{Coweeman Kalama Cowlitz}\\
\hline
\begin{array}{r}\text{Coweeman - W}\\ \text{Fork E Lewis - W} \\ \text{Kalama - S} \\ \text{Kalama - W} \\
\text{Lower Cowlitz - W} \\ \text{Toutle - W} \\ \text{Tilton - W} \\ \text{Upper Cowlitz - W} \\ \text{Washougal - W}\end{array}&amp;
\begin{bmatrix}
0 &amp; 1 \\
0 &amp; 1 \\
1 &amp; 0 \\
0 &amp; 1 \\
0 &amp; 1 \\
0 &amp; 1 \\
0 &amp; 1 \\
0 &amp; 1 \\
0 &amp; 1 \\
\end{bmatrix}&amp;
\begin{bmatrix}
1 &amp; 0 &amp; 0 &amp; 0 &amp;0 \\
0 &amp; 1 &amp; 0 &amp; 0 &amp;0 \\
0 &amp; 0 &amp; 1 &amp; 0 &amp;0 \\
0 &amp; 0 &amp; 1 &amp; 0 &amp;0 \\
0 &amp; 0 &amp; 0 &amp; 1 &amp;0 \\
1 &amp; 0 &amp; 0 &amp; 0 &amp;0 \\
0 &amp; 0 &amp; 0 &amp; 1 &amp;0 \\
1 &amp; 0 &amp; 0 &amp; 0 &amp;0 \\
0 &amp; 0 &amp; 0 &amp; 0 &amp;1 \\
\end{bmatrix}&amp;
\begin{bmatrix}
1 &amp; 0 &amp; 0 \\
1 &amp; 0 &amp; 0 \\
0 &amp; 1 &amp; 0 \\
0 &amp; 1 &amp; 0 \\
0 &amp; 0 &amp; 1 \\
1 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 1 \\
0 &amp; 0 &amp; 1 \\
1 &amp; 0 &amp; 0
\end{bmatrix}&amp;
\end{array}
\end{equation*}
\]</span></p>
<p>We assume that all models have identical observation errors, thus a diagonal and equal R matrix. <span class="math display">\[
\mathbf{R} =
\begin{bmatrix} r &amp; 0  &amp; ...&amp; 0\\
0 &amp; r &amp;  ...&amp; 0\\
\vdots &amp; 0 &amp; \ddots &amp; \vdots\\
0 &amp; 0 &amp; 0  &amp; r \end{bmatrix}
\]</span> For each model we test both equal and unequal biases for the states. We also assumed all states were correlated over time and test both equal var-cov and unconstrained process errors for each state.</p>
<p>Equal Bias <span class="math display">\[
\mathbf{u} =
\begin{bmatrix} u\\
\vdots\\
u\end{bmatrix}
\]</span> Unequal Bias <span class="math display">\[
\mathbf{u} =
\begin{bmatrix} u_{1}\\
\vdots\\
u_{i}\end{bmatrix} \text{where i is # of states}
\]</span></p>
<p>Equal Variance-Covariance <span class="math display">\[
\begin{equation}
\mathbf{Q}=\begin{bmatrix}
    q &amp; c &amp; ... &amp; c \\
    c &amp; q &amp; \ddots &amp; \vdots\\
    \vdots &amp; c &amp; \ddots &amp; c \\
    c &amp; c &amp; ... &amp; q \end{bmatrix}
\end{equation}
\text{where # of rows is equal to # of states}
\]</span> Unconstrained <span class="math display">\[
\begin{equation}
\mathbf{Q}=\begin{bmatrix}
    q_{1}&amp; c_{1,2} &amp; ... &amp; c_{1,i} \\
    c_{1,2} &amp; q_{2} &amp; \ddots &amp; c_{2,i}\\
    \vdots &amp; \ddots &amp; \ddots &amp; \vdots \\
    c_{1,i} &amp; ... &amp; c_{i-1,i} &amp; q_{i} \end{bmatrix}
\end{equation}
\text{where # of rows is equal to # of states}
\]</span></p>
</section>
<section id="data-exploration" class="level1">
<h1>Data exploration</h1>
<p>Load the data.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.2     ✔ readr     2.1.4
✔ forcats   1.0.0     ✔ stringr   1.5.0
✔ ggplot2   3.4.2     ✔ tibble    3.2.1
✔ lubridate 1.9.2     ✔ tidyr     1.3.0
✔ purrr     1.0.1     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'janitor'

The following objects are masked from 'package:stats':

    chisq.test, fisher.test</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MARSS)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Registered S3 method overwritten by 'quantmod':
  method            from
  as.zoo.data.frame zoo </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"Lab-2"</span>, <span class="st">"Data_Images"</span>, <span class="st">"columbia-river.rda"</span>))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Evolutionary Significant Units</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>esu <span class="ot">&lt;-</span> <span class="fu">unique</span>(columbia.river<span class="sc">$</span>esu_dps)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>esu</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Steelhead (Middle Columbia River DPS)"     
[2] "Steelhead (Upper Columbia River DPS)"      
[3] "Steelhead (Lower Columbia River DPS)"      
[4] "Salmon, coho (Lower Columbia River ESU)"   
[5] "Salmon, Chinook (Lower Columbia River ESU)"</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> columbia.river <span class="sc">%&gt;%</span> <span class="fu">subset</span>(esu_dps <span class="sc">%in%</span> <span class="st">"Steelhead (Lower Columbia River DPS)"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"colnames: "</span>, <span class="fu">colnames</span>(df), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>colnames:  species esu_dps majorpopgroup esapopname commonpopname run spawningyear value value_type </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(df<span class="sc">$</span>esapopname)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Steelhead (Lower Columbia River DPS) Kalama River - summer"           
 [2] "Steelhead (Lower Columbia River DPS) Coweeman River - winter"         
 [3] "Steelhead (Lower Columbia River DPS) East Fork Lewis River - winter"  
 [4] "Steelhead (Lower Columbia River DPS) Kalama River - winter"           
 [5] "Steelhead (Lower Columbia River DPS) Lower Cowlitz River - winter"    
 [6] "Steelhead (Lower Columbia River DPS) South Fork Toutle River - winter"
 [7] "Steelhead (Lower Columbia River DPS) Tilton River - winter"           
 [8] "Steelhead (Lower Columbia River DPS) Upper Cowlitz River - winter"    
 [9] "Steelhead (Lower Columbia River DPS) Washougal River - winter"        
[10] "Steelhead (Lower Columbia River DPS) Upper Gorge Tributaries - winter"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(df<span class="sc">$</span>commonpopname)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Kalama Summer Steelhead"                  
 [2] "Coweeman Winter Steelhead"                
 [3] "East Fork Lewis Winter Steelhead"         
 [4] "Kalama Winter Steelhead"                  
 [5] "Lower Cowlitz Winter Steelhead"           
 [6] "South Fork Toutle Winter Steelhead"       
 [7] "Tilton Winter Steelhead"                  
 [8] "Upper Cowlitz and Cispus Winter Steelhead"
 [9] "Washougal Winter Steelhead"               
[10] "Upper Gorge (Columbia) Winter Steelhead"  </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>esapopname2 <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(df<span class="sc">$</span>esapopname, <span class="st">"Steelhead [(]Lower Columbia River DPS[)] "</span>, <span class="st">""</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(df<span class="sc">$</span>esapopname2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Kalama River - summer"            "Coweeman River - winter"         
 [3] "East Fork Lewis River - winter"   "Kalama River - winter"           
 [5] "Lower Cowlitz River - winter"     "South Fork Toutle River - winter"
 [7] "Tilton River - winter"            "Upper Cowlitz River - winter"    
 [9] "Washougal River - winter"         "Upper Gorge Tributaries - winter"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x=</span>spawningyear, <span class="at">y=</span><span class="fu">log</span>(value), <span class="at">color=</span>majorpopgroup)) <span class="sc">+</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size=</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">5</span>, <span class="at">angle =</span> <span class="dv">90</span>)) <span class="sc">+</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>esapopname2) <span class="sc">+</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">'Lower Columbia Steelhead Populations'</span>)<span class="sc">+</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-2-team-2_final_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Wrangle the data.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>esuname <span class="ot">&lt;-</span> esu[<span class="dv">3</span>]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> columbia.river <span class="sc">%&gt;%</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(esu_dps <span class="sc">==</span> esuname) <span class="sc">%&gt;%</span> <span class="co"># get only this ESU</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log.spawner =</span> <span class="fu">log</span>(value)) <span class="sc">%&gt;%</span> <span class="co"># create a column called log.spawner</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(esapopname, spawningyear, log.spawner) <span class="sc">%&gt;%</span> <span class="co"># get just the columns that I need</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"esapopname"</span>, <span class="at">values_from =</span> <span class="st">"log.spawner"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_to_rownames</span>(<span class="at">var =</span> <span class="st">"spawningyear"</span>) <span class="sc">%&gt;%</span> <span class="co"># make the years rownames</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">%&gt;%</span> <span class="co"># turn into a matrix with year down the rows</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>() <span class="co"># make time across the columns</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>dat[<span class="fu">is.na</span>(dat)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="do">## Fixing row names</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">rownames</span>(dat)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(tmp, <span class="st">"Steelhead [(]Lower Columbia River DPS[)]"</span>, <span class="st">""</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">make_clean_names</span>(tmp)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(dat) <span class="ot">&lt;-</span> tmp</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>,]<span class="co"># remove upper gorge</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat[ <span class="fu">order</span>(<span class="fu">row.names</span>(dat)), ]<span class="do">## sort</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="results" class="level1">
<h1>Results</h1>
<section id="the-simplest-model" class="level2">
<h2 class="anchored" data-anchor-id="the-simplest-model">The simplest model</h2>
<p>Fitting the most simple model to help determine the need to group populations: One big population with different observations (populations).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>mod.list<span class="fl">.0</span> <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">B =</span> <span class="fu">matrix</span>(<span class="dv">1</span>), <span class="at">U =</span> <span class="fu">matrix</span>(<span class="st">"u"</span>), <span class="at">Q =</span> <span class="fu">matrix</span>(<span class="st">"q"</span>), </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">Z =</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="dv">9</span>, <span class="dv">1</span>), <span class="at">A =</span> <span class="st">"scaling"</span>, <span class="at">R =</span> <span class="st">"diagonal and equal"</span>, </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">x0 =</span> <span class="fu">matrix</span>(<span class="st">"mu"</span>), <span class="at">tinitx =</span> <span class="dv">0</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>fit_simple <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(dat, <span class="at">model=</span>mod.list<span class="fl">.0</span>, <span class="at">control=</span><span class="fu">list</span>(<span class="at">maxit=</span><span class="dv">1000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Success! abstol and log-log tests passed at 38 iterations.
Alert: conv.test.slope.tol is 0.5.
Test with smaller values (&lt;0.1) to ensure convergence.

MARSS fit is
Estimation method: kem 
Convergence test: conv.test.slope.tol = 0.5, abstol = 0.001
Estimation converged in 38 iterations. 
Log-likelihood: -247.9172 
AIC: 519.8343   AICc: 521.1792   
 
                                 Estimate
A.east_fork_lewis_river_winter   -0.51303
A.kalama_river_summer             0.58517
A.kalama_river_winter             0.82974
A.lower_cowlitz_river_winter      0.28048
A.south_fork_toutle_river_winter  0.33119
A.tilton_river_winter            -0.21650
A.upper_cowlitz_river_winter      0.21896
A.washougal_river_winter         -0.38030
R.diag                            0.38503
U.u                              -0.00853
Q.q                               0.04702
x0.mu                             5.81906
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit_simple, <span class="at">plot.type=</span><span class="st">"fitted.ytT"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-2-team-2_final_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>plot type =  fitted.ytT  Observations with fitted values</code></pre>
</div>
</div>
<p>We see that the simple model is not the best at fitting the population estimates for many of the populations (e.g., Upper Cowlitz winter, East Fork Lewis winter). Many of the residuals do not appear to be stationary.</p>
</section>
<section id="the-most-flexible-model" class="level2">
<h2 class="anchored" data-anchor-id="the-most-flexible-model">The most flexible model</h2>
<p>Fitting the most flexible model to help determine spatial Z hypotheses: Individual populations with an unconstrained Q matrix and unequal U</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>mod.list1 <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">U =</span> <span class="st">"unequal"</span>,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="st">"diagonal and equal"</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q =</span> <span class="st">"unconstrained"</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(dat, <span class="at">model=</span>mod.list1, <span class="at">control=</span><span class="fu">list</span>(<span class="at">maxit=</span><span class="dv">800</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Success! abstol and log-log tests passed at 792 iterations.
Alert: conv.test.slope.tol is 0.5.
Test with smaller values (&lt;0.1) to ensure convergence.

MARSS fit is
Estimation method: kem 
Convergence test: conv.test.slope.tol = 0.5, abstol = 0.001
Estimation converged in 792 iterations. 
Log-likelihood: -162.2543 
AIC: 452.5085   AICc: 498.7308   
 
                                    Estimate
R.diag                               0.07004
U.X.coweeman_river_winter            0.05643
U.X.east_fork_lewis_river_winter     0.06603
U.X.kalama_river_summer              0.05382
U.X.kalama_river_winter              0.01357
U.X.lower_cowlitz_river_winter       0.05480
U.X.south_fork_toutle_river_winter   0.05081
U.X.tilton_river_winter              0.03231
U.X.upper_cowlitz_river_winter       0.10266
U.X.washougal_river_winter           0.08353
Q.(1,1)                              0.18254
Q.(2,1)                              0.20888
Q.(3,1)                             -0.06669
Q.(4,1)                             -0.01073
Q.(5,1)                              0.07385
Q.(6,1)                              0.21461
Q.(7,1)                              0.01004
Q.(8,1)                             -0.00336
Q.(9,1)                              0.20057
Q.(2,2)                              0.30487
Q.(3,2)                             -0.16277
Q.(4,2)                             -0.03323
Q.(5,2)                              0.18199
Q.(6,2)                              0.23406
Q.(7,2)                              0.13516
Q.(8,2)                              0.10168
Q.(9,2)                              0.23761
Q.(3,3)                              0.21954
Q.(4,3)                              0.11641
Q.(5,3)                             -0.08252
Q.(6,3)                             -0.01588
Q.(7,3)                             -0.04973
Q.(8,3)                              0.00917
Q.(9,3)                             -0.04761
Q.(4,4)                              0.09583
Q.(5,4)                              0.04185
Q.(6,4)                              0.04127
Q.(7,4)                              0.08378
Q.(8,4)                              0.11758
Q.(9,4)                              0.02286
Q.(5,5)                              0.28695
Q.(6,5)                              0.13628
Q.(7,5)                              0.36189
Q.(8,5)                              0.24063
Q.(9,5)                              0.11017
Q.(6,6)                              0.29428
Q.(7,6)                              0.09380
Q.(8,6)                              0.04003
Q.(9,6)                              0.24779
Q.(7,7)                              0.50421
Q.(8,7)                              0.34139
Q.(9,7)                              0.05553
Q.(8,8)                              0.47369
Q.(9,8)                              0.08841
Q.(9,9)                              0.24231
x0.X.coweeman_river_winter           3.59695
x0.X.east_fork_lewis_river_winter    2.23471
x0.X.kalama_river_summer             6.15197
x0.X.kalama_river_winter             6.56522
x0.X.lower_cowlitz_river_winter      2.71630
x0.X.south_fork_toutle_river_winter  3.85807
x0.X.tilton_river_winter             2.83736
x0.X.upper_cowlitz_river_winter      1.29622
x0.X.washougal_river_winter          2.30745
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit1, <span class="at">plot.type=</span><span class="st">"fitted.ytT"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MARSSresiduals.tT reported warnings. See msg element or attribute of returned residuals object.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-2-team-2_final_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>plot type =  fitted.ytT  Observations with fitted values</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>corrplot 0.92 loaded</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>Q <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit1, <span class="at">type=</span><span class="st">"matrix"</span>)<span class="sc">$</span>Q</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>corrmat <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">diag</span>(Q))) <span class="sc">%*%</span> Q <span class="sc">%*%</span> <span class="fu">diag</span>(<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">diag</span>(Q)))</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">corrplot</span>(corrmat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-2-team-2_final_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Some of the populations are correlated. This implies it would be reasonable to test for equal variance covariance, along with some other population structures.</p>
<p>We opted to test this in a for loop to compare multiple spatial structures, u options, and two options for Q.</p>
</section>
<section id="model-assumptions" class="level2">
<h2 class="anchored" data-anchor-id="model-assumptions">Model Assumptions</h2>
<p>Below we setting up population grouping hypotheses (Z matrices), correlation structures, drift or “bias” terms, and the fixed model list.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we evaluated the data support for the following hypotheses about Lower Columbia salmon river trends</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Each Z model is a hypothesis</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Simple run timing groupings</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co"># summer = kalama_river_summer</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co"># winter = remaining population</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Simple spatial groupings</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co"># coweeman = coweeman and sf toutle</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ef_lewis = east fork lewis</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co"># kalama = kalama summer and winter</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co"># cowlitz = lower cowlitz, tilton, and upper cowlitz</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co"># washougal = washougal</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Correlation spatial groupings</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co"># coweeman = coweema, ef_lewis, sf toutle, washougal</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="co"># kalama = kalama summer and winter</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="co"># cowlitz = lower cowlitz, tilton, and upper cowlitz</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>Z.models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">H1 =</span> <span class="fu">matrix</span>(<span class="dv">1</span>,<span class="dv">9</span>,<span class="dv">1</span>), <span class="co">#one hidden population state</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">H2 =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"coweeman"</span>,<span class="st">"ef_lewis"</span>, <span class="st">"kalama_sum"</span>,</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">'kalama_win'</span>, <span class="st">"low_cowlitz"</span>, <span class="st">"sf_toutle"</span>,</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">"tilton"</span>, <span class="st">"up_cowlitz"</span>, <span class="st">"washougal"</span>)), <span class="co">#states are defined by individual population</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">H3 =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"winter"</span>,<span class="st">"winter"</span>, <span class="st">"summer"</span>,</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">'winter'</span>, <span class="st">"winter"</span>, <span class="st">"winter"</span>,</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">"winter"</span>, <span class="st">"winter"</span>, <span class="st">"winter"</span>)),<span class="co"># states defined by running timing grouping (n = 2)</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">H4 =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"coweeman"</span>,<span class="st">"ef_lewis"</span>, <span class="st">"kalama"</span>,</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">'kalama'</span>, <span class="st">"cowlitz"</span>, <span class="st">"coweeman"</span>,</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>                <span class="st">"cowlitz"</span>, <span class="st">"cowlitz"</span>, <span class="st">"washougal"</span>)),<span class="co"># states defined by spatial grouping (n = 5)</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">H5 =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"coweeman"</span>,<span class="st">"coweeman"</span>, <span class="st">"kalama"</span>,</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>                <span class="st">'kalama'</span>, <span class="st">"cowlitz"</span>, <span class="st">"coweeman"</span>,</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>                <span class="st">"cowlitz"</span>, <span class="st">"cowlitz"</span>, <span class="st">"coweeman"</span>))<span class="co"># states defined by correlation (n = 3)</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(Z.models) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"one_population"</span>,<span class="st">"indiv_population"</span>,<span class="st">"run_timing_groups"</span>,<span class="st">'spatial_groups'</span>,<span class="st">"corr_groups"</span>)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Also testing different process error varcovar matrices</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>Q.models2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"equalvarcov"</span>,<span class="st">"unconstrained"</span>)</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Bias terms</span></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>u2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"unequal"</span>, <span class="st">'equal'</span>)</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting fixed portion of mod list</span></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>mod.list <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">A =</span> <span class="st">"scaling"</span>,</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="st">"diagonal and equal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="marss-model-selection" class="level2">
<h2 class="anchored" data-anchor-id="marss-model-selection">MARSS Model Selection</h2>
<p>Run MARSS models.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>out.tab <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>fits <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(Z.models)){</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(Q.model <span class="cf">in</span> Q.models2){</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(U.model <span class="cf">in</span> u2){</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>      fit.model <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">list</span>(<span class="at">Z=</span>Z.models[[i]], <span class="at">Q=</span>Q.model, <span class="at">U=</span>U.model), mod.list)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>      fit <span class="ot">=</span> <span class="fu">MARSS</span>(dat, <span class="at">model=</span>fit.model,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">silent=</span><span class="cn">TRUE</span>, <span class="at">control=</span><span class="fu">list</span>(<span class="at">maxit=</span><span class="dv">3000</span>))</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>      out<span class="ot">=</span><span class="fu">data.frame</span>(<span class="at">H=</span><span class="fu">names</span>(Z.models)[i],<span class="at">Q=</span>Q.model,<span class="at">U=</span>U.model,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">logLik=</span>fit<span class="sc">$</span>logLik, <span class="at">AICc=</span>fit<span class="sc">$</span>AICc, <span class="at">num.param=</span>fit<span class="sc">$</span>num.params,</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">m=</span><span class="fu">length</span>(<span class="fu">unique</span>(Z.models[[i]])),</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">num.iter=</span>fit<span class="sc">$</span>numIter, <span class="at">converged=</span><span class="sc">!</span>fit<span class="sc">$</span>convergence,</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>      out.tab<span class="ot">=</span><span class="fu">rbind</span>(out.tab,out)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>      fits<span class="ot">=</span><span class="fu">c</span>(fits,<span class="fu">list</span>(fit))</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>      } </span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>min.AICc <span class="ot">&lt;-</span> <span class="fu">order</span>(out.tab<span class="sc">$</span>AICc)</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>out.tab<span class="fl">.1</span> <span class="ot">&lt;-</span> out.tab[min.AICc, ]</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>out.tab<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">cbind</span>(out.tab<span class="fl">.1</span>, <span class="at">delta.AICc =</span> out.tab<span class="fl">.1</span><span class="sc">$</span>AICc <span class="sc">-</span> out.tab<span class="fl">.1</span><span class="sc">$</span>AICc[<span class="dv">1</span>])</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>out.tab<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">cbind</span>(out.tab<span class="fl">.1</span>, <span class="at">rel.like =</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> out.tab<span class="fl">.1</span><span class="sc">$</span>delta.AICc<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>out.tab<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">cbind</span>(out.tab<span class="fl">.1</span>, <span class="at">AIC.weight =</span> out.tab<span class="fl">.1</span><span class="sc">$</span>rel.like<span class="sc">/</span><span class="fu">sum</span>(out.tab<span class="fl">.1</span><span class="sc">$</span>rel.like))</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>out.tab<span class="fl">.1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                   H             Q       U    logLik     AICc num.param m
16    spatial_groups unconstrained   equal -200.3077 459.0557        26 5
15    spatial_groups unconstrained unequal -199.6277 467.9469        30 5
14    spatial_groups   equalvarcov   equal -221.5804 470.7365        13 5
6   indiv_population   equalvarcov   equal -223.3296 474.2350        13 9
13    spatial_groups   equalvarcov unequal -221.2383 479.1726        17 5
8   indiv_population unconstrained   equal -167.4589 480.8753        56 9
5   indiv_population   equalvarcov unequal -221.2639 488.6713        21 9
18       corr_groups   equalvarcov   equal -233.1729 493.9216        13 3
20       corr_groups unconstrained   equal -229.2451 495.1862        17 3
17       corr_groups   equalvarcov unequal -232.9357 497.9674        15 3
7   indiv_population unconstrained unequal -162.2543 498.7308        64 9
19       corr_groups unconstrained unequal -229.1000 499.5778        19 3
10 run_timing_groups   equalvarcov   equal -244.9572 517.4901        13 2
12 run_timing_groups unconstrained   equal -244.8224 519.4708        14 2
9  run_timing_groups   equalvarcov unequal -244.8625 519.5512        14 2
1     one_population   equalvarcov unequal -247.9172 521.1792        12 1
2     one_population   equalvarcov   equal -247.9172 521.1792        12 1
3     one_population unconstrained unequal -247.9172 521.1792        12 1
4     one_population unconstrained   equal -247.9172 521.1792        12 1
11 run_timing_groups unconstrained unequal -244.7254 521.5469        15 2
   num.iter converged delta.AICc     rel.like   AIC.weight
16      378      TRUE   0.000000 1.000000e+00 9.850231e-01
15      374      TRUE   8.891254 1.172975e-02 1.155407e-02
14       63      TRUE  11.680779 2.907709e-03 2.864161e-03
6        77      TRUE  15.179270 5.056657e-04 4.980924e-04
13       75      TRUE  20.116881 4.282276e-05 4.218141e-05
8       797      TRUE  21.819604 1.827819e-05 1.800444e-05
5       683      TRUE  29.615606 3.707258e-07 3.651735e-07
18       69      TRUE  34.865945 2.685073e-08 2.644859e-08
20       60      TRUE  36.130531 1.426773e-08 1.405405e-08
17       87      TRUE  38.911736 3.551599e-09 3.498407e-09
7       792      TRUE  39.675076 2.424749e-09 2.388433e-09
19       60      TRUE  40.522114 1.587577e-09 1.563800e-09
10       31      TRUE  58.434441 2.047021e-13 2.016363e-13
12       57      TRUE  60.415106 7.603724e-14 7.489844e-14
9        31      TRUE  60.495478 7.304222e-14 7.194827e-14
1        38      TRUE  62.123467 3.236387e-14 3.187916e-14
2        38      TRUE  62.123467 3.236387e-14 3.187916e-14
3        38      TRUE  62.123467 3.236387e-14 3.187916e-14
4        38      TRUE  62.123467 3.236387e-14 3.187916e-14
11       57      TRUE  62.491240 2.692773e-14 2.652443e-14</code></pre>
</div>
</div>
<p>The best model (as supported by AICc) includes 5 states (our “spatial populations” model) that are correlated with unique variance and covariance terms (unconstrained Q) with the same drift term (U)</p>
</section>
<section id="inspecting-the-best-model-spatial-group-unconstrained-q-equal-u" class="level2">
<h2 class="anchored" data-anchor-id="inspecting-the-best-model-spatial-group-unconstrained-q-equal-u">Inspecting the best model (spatial group, unconstrained Q, equal U)</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>best_mod <span class="ot">&lt;-</span> fits[[<span class="dv">16</span>]]</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>best_mod</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
MARSS fit is
Estimation method: kem 
Convergence test: conv.test.slope.tol = 0.5, abstol = 0.001
Estimation converged in 378 iterations. 
Log-likelihood: -200.3077 
AIC: 452.6153   AICc: 459.0557   
 
                                 Estimate
A.kalama_river_winter             0.24416
A.south_fork_toutle_river_winter  0.38706
A.tilton_river_winter            -0.75459
A.upper_cowlitz_river_winter     -0.19777
R.diag                            0.15851
U.1                               0.03097
Q.(1,1)                           0.22524
Q.(2,1)                           0.17195
Q.(3,1)                          -0.01570
Q.(4,1)                           0.02272
Q.(5,1)                           0.17217
Q.(2,2)                           0.19999
Q.(3,2)                          -0.07064
Q.(4,2)                           0.12119
Q.(5,2)                           0.16006
Q.(3,3)                           0.09252
Q.(4,3)                           0.00657
Q.(5,3)                          -0.01488
Q.(4,4)                           0.38669
Q.(5,4)                           0.11117
Q.(5,5)                           0.15486
x0.coweeman                       3.81220
x0.ef_lewis                       2.92567
x0.kalama                         6.30723
x0.cowlitz                        2.50039
x0.washougal                      3.25935
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(best_mod, <span class="at">plot.type =</span> <span class="st">"fitted.ytT"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MARSSresiduals.tT reported warnings. See msg element or attribute of returned residuals object.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-2-team-2_final_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>plot type =  fitted.ytT  Observations with fitted values</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(best_mod, <span class="at">plot.type =</span> <span class="st">"acf.std.model.resids.ytt1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MARSSresiduals.tt1 reported warnings. See msg element of returned residuals object.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-2-team-2_final_files/figure-html/unnamed-chunk-9-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>plot type = acf.std.model.resids.ytt1</code></pre>
</div>
</div>
<p>In our best model, we do see some autocorrelation in our residuals. In the next section, we will try to include a covariate of season into our best model and see if this improves the model fit.</p>
</section>
<section id="comparing-best-model-to-the-most-flexible-model" class="level2">
<h2 class="anchored" data-anchor-id="comparing-best-model-to-the-most-flexible-model">Comparing best model to the most flexible model</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit1, <span class="at">plot.type=</span><span class="st">"fitted.ytT"</span>)<span class="co">#flexible</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MARSSresiduals.tT reported warnings. See msg element or attribute of returned residuals object.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-2-team-2_final_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>plot type =  fitted.ytT  Observations with fitted values</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(best_mod, <span class="at">plot.type=</span><span class="st">"fitted.ytT"</span>)<span class="co">#best</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MARSSresiduals.tT reported warnings. See msg element or attribute of returned residuals object.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-2-team-2_final_files/figure-html/unnamed-chunk-10-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>plot type =  fitted.ytT  Observations with fitted values</code></pre>
</div>
</div>
<p>Do our estimates differ depending on the assumptions of the structure of the data, i.e.&nbsp;our assumptions about the x’s, Q, and U?</p>
<p>Definitely! The more flexible model (individual states, unequal bias term) produces more variable forecasts (with some populations increasing or decreasing through time). Our spatial model (5 states, equal bias term) provides relatively stable forecasts across populations, likely due to the “equal” bias term.</p>
</section>
</section>
<section id="seasonality-as-a-covariate" class="level1">
<h1>Seasonality as a covariate</h1>
<p>In this next section, we test for age structured cycling of steelhead populations or “season” in our best “spatial” model.</p>
<section id="initial-model-fitting" class="level2">
<h2 class="anchored" data-anchor-id="initial-model-fitting">Initial model fitting</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>Z.mat <span class="ot">&lt;-</span>  <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"coweeman"</span>,<span class="st">"ef_lewis"</span>, <span class="st">"kalama"</span>,</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>                <span class="st">'kalama'</span>, <span class="st">"cowlitz"</span>, <span class="st">"coweeman"</span>,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>                <span class="st">"cowlitz"</span>, <span class="st">"cowlitz"</span>, <span class="st">"washougal"</span>)) <span class="co">#Our best model Z matrix</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting up 3-5 year cycles as a covariate</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>TT <span class="ot">&lt;-</span> <span class="fu">dim</span>(dat)[<span class="dv">2</span>]</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>covariates <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  forecast<span class="sc">::</span><span class="fu">fourier</span>(<span class="fu">ts</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">freq=</span><span class="dv">3</span>), <span class="at">K=</span><span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">t</span>(),</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  forecast<span class="sc">::</span><span class="fu">fourier</span>(<span class="fu">ts</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">freq=</span><span class="dv">4</span>), <span class="at">K=</span><span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">t</span>(),</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>  forecast<span class="sc">::</span><span class="fu">fourier</span>(<span class="fu">ts</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">freq=</span><span class="dv">5</span>), <span class="at">K=</span><span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">t</span>()</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>mod.list2 <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">U =</span> <span class="st">"equal"</span>,</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q =</span> <span class="st">"unconstrained"</span>, </span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> Z.mat,</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">A =</span> <span class="st">"scaling"</span>,</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="st">"diagonal and equal"</span>,</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> <span class="st">"unconstrained"</span>, <span class="co"># We include these in the D matrix because the age structure cycling of salmon typically affects our observations rather than the state</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">d =</span> covariates)</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>fit_season <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(dat, <span class="at">model=</span>mod.list2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Success! abstol and log-log tests passed at 393 iterations.
Alert: conv.test.slope.tol is 0.5.
Test with smaller values (&lt;0.1) to ensure convergence.

MARSS fit is
Estimation method: kem 
Convergence test: conv.test.slope.tol = 0.5, abstol = 0.001
Estimation converged in 393 iterations. 
Log-likelihood: -171.8029 
AIC: 503.6058   AICc: 582.6302   
 
                                         Estimate
A.kalama_river_winter                    0.252970
A.south_fork_toutle_river_winter         0.343256
A.tilton_river_winter                   -0.903094
A.upper_cowlitz_river_winter            -0.320282
R.diag                                   0.122966
U.1                                      0.031019
Q.(1,1)                                  0.151655
Q.(2,1)                                  0.103304
Q.(3,1)                                 -0.006630
Q.(4,1)                                  0.048822
Q.(5,1)                                  0.076574
Q.(2,2)                                  0.137173
Q.(3,2)                                 -0.063070
Q.(4,2)                                  0.146876
Q.(5,2)                                  0.073604
Q.(3,3)                                  0.094141
Q.(4,3)                                 -0.012518
Q.(5,3)                                  0.003246
Q.(4,4)                                  0.396928
Q.(5,4)                                  0.114513
Q.(5,5)                                  0.060789
x0.coweeman                              4.260305
x0.ef_lewis                              3.498555
x0.kalama                                6.221230
x0.cowlitz                               2.861678
x0.washougal                             3.978254
D.(coweeman_river_winter,S1-3)           0.186021
D.(east_fork_lewis_river_winter,S1-3)    0.157392
D.(kalama_river_summer,S1-3)            -0.072940
D.(kalama_river_winter,S1-3)             0.022498
D.(lower_cowlitz_river_winter,S1-3)     -0.184966
D.(south_fork_toutle_river_winter,S1-3)  0.144443
D.(tilton_river_winter,S1-3)            -0.052278
D.(upper_cowlitz_river_winter,S1-3)     -0.160372
D.(washougal_river_winter,S1-3)          0.197520
D.(coweeman_river_winter,C1-3)          -0.044046
D.(east_fork_lewis_river_winter,C1-3)    0.089743
D.(kalama_river_summer,C1-3)            -0.000429
D.(kalama_river_winter,C1-3)            -0.021383
D.(lower_cowlitz_river_winter,C1-3)     -0.275540
D.(south_fork_toutle_river_winter,C1-3)  0.127018
D.(tilton_river_winter,C1-3)             0.088516
D.(upper_cowlitz_river_winter,C1-3)      0.266990
D.(washougal_river_winter,C1-3)          0.040757
D.(coweeman_river_winter,S1-4)          -0.117197
D.(east_fork_lewis_river_winter,S1-4)   -0.040715
D.(kalama_river_summer,S1-4)            -0.022386
D.(kalama_river_winter,S1-4)             0.071430
D.(lower_cowlitz_river_winter,S1-4)     -0.451392
D.(south_fork_toutle_river_winter,S1-4) -0.068067
D.(tilton_river_winter,S1-4)             0.122578
D.(upper_cowlitz_river_winter,S1-4)      0.059695
D.(washougal_river_winter,S1-4)         -0.219913
D.(coweeman_river_winter,C1-4)           0.124410
D.(east_fork_lewis_river_winter,C1-4)    0.127488
D.(kalama_river_summer,C1-4)            -0.066523
D.(kalama_river_winter,C1-4)             0.155787
D.(lower_cowlitz_river_winter,C1-4)     -0.246952
D.(south_fork_toutle_river_winter,C1-4)  0.068655
D.(tilton_river_winter,C1-4)             0.125492
D.(upper_cowlitz_river_winter,C1-4)      0.103936
D.(washougal_river_winter,C1-4)          0.195852
D.(coweeman_river_winter,S1-5)          -0.163883
D.(east_fork_lewis_river_winter,S1-5)   -0.082063
D.(kalama_river_summer,S1-5)             0.128463
D.(kalama_river_winter,S1-5)             0.068320
D.(lower_cowlitz_river_winter,S1-5)      0.409315
D.(south_fork_toutle_river_winter,S1-5) -0.009286
D.(tilton_river_winter,S1-5)            -0.386147
D.(upper_cowlitz_river_winter,S1-5)      0.087418
D.(washougal_river_winter,S1-5)         -0.069609
D.(coweeman_river_winter,C1-5)          -0.120105
D.(east_fork_lewis_river_winter,C1-5)   -0.286216
D.(kalama_river_summer,C1-5)             0.054608
D.(kalama_river_winter,C1-5)             0.173239
D.(lower_cowlitz_river_winter,C1-5)      0.255956
D.(south_fork_toutle_river_winter,C1-5) -0.358093
D.(tilton_river_winter,C1-5)            -0.154457
D.(upper_cowlitz_river_winter,C1-5)     -0.001424
D.(washougal_river_winter,C1-5)         -0.363120
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.</code></pre>
</div>
</div>
</section>
<section id="evaluating-the-effect-of-different-cycles" class="level2">
<h2 class="anchored" data-anchor-id="evaluating-the-effect-of-different-cycles">Evaluating the effect of different cycles</h2>
<p>We can then plot the effects of each cycle estimate.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tidy</span>(fit_season) <span class="sc">%&gt;%</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(stringr<span class="sc">::</span><span class="fu">str_sub</span>(term,<span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">==</span><span class="st">"D"</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>lag <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">each=</span><span class="dv">18</span>))</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>river <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">rownames</span>(dat),<span class="dv">3</span>))</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>sc <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"S"</span>,<span class="st">"C"</span>), <span class="at">each=</span><span class="dv">9</span>), <span class="dv">3</span>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="fu">paste0</span>(df<span class="sc">$</span>sc,df<span class="sc">$</span>lag)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x=</span>type, <span class="at">y=</span>estimate, <span class="at">col=</span>lag)) <span class="sc">+</span> </span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>conf.low, <span class="at">ymax=</span>conf.up), <span class="at">width=</span>.<span class="dv">2</span>, <span class="at">position=</span><span class="fu">position_dodge</span>(.<span class="dv">9</span>)) <span class="sc">+</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>river) <span class="sc">+</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"The cycle estimates with CIs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-2-team-2_final_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>These estimates suggest that there is some evidence of cycling at the 5 year interval in the East Fork Lewis, the South Fork Toutle, the Tilton, and the Washougal River steelhead populations.</p>
<p>This, however, increases our AICc quite a bit, from 459.0557 in our original best model to 582.6302. Now let’s try just including 5 year cycles and compare this AICc to our best model.</p>
</section>
<section id="comparing-models-with-and-without-5-year-cycles" class="level2">
<h2 class="anchored" data-anchor-id="comparing-models-with-and-without-5-year-cycles">Comparing models with and without 5 year cycles</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>mod.list3 <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">U =</span> <span class="st">"equal"</span>,</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q =</span> <span class="st">"unconstrained"</span>, </span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> Z.mat,</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">A =</span> <span class="st">"scaling"</span>,</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="st">"diagonal and equal"</span>,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> <span class="st">"unconstrained"</span>, <span class="co"># We include these in the D matrix because the age structure cycling of salmon typically affects our observations rather than the state</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">d =</span> covariates[<span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>,]) <span class="co"># Specifying just 5 year cycles </span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>fit_5season <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(dat, <span class="at">model=</span>mod.list3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Success! abstol and log-log tests passed at 386 iterations.
Alert: conv.test.slope.tol is 0.5.
Test with smaller values (&lt;0.1) to ensure convergence.

MARSS fit is
Estimation method: kem 
Convergence test: conv.test.slope.tol = 0.5, abstol = 0.001
Estimation converged in 386 iterations. 
Log-likelihood: -187.2444 
AIC: 462.4888   AICc: 482.2888   
 
                                        Estimate
A.kalama_river_winter                    0.24684
A.south_fork_toutle_river_winter         0.36821
A.tilton_river_winter                   -0.78743
A.upper_cowlitz_river_winter            -0.19833
R.diag                                   0.14171
U.1                                      0.03266
Q.(1,1)                                  0.18084
Q.(2,1)                                  0.12142
Q.(3,1)                                 -0.00192
Q.(4,1)                                  0.00550
Q.(5,1)                                  0.11653
Q.(2,2)                                  0.14378
Q.(3,2)                                 -0.05419
Q.(4,2)                                  0.11406
Q.(5,2)                                  0.10159
Q.(3,3)                                  0.08860
Q.(4,3)                                  0.00342
Q.(5,3)                                  0.00379
Q.(4,4)                                  0.41381
Q.(5,4)                                  0.10054
Q.(5,5)                                  0.09813
x0.coweeman                              4.00994
x0.ef_lewis                              3.25543
x0.kalama                                6.23754
x0.cowlitz                               2.83372
x0.washougal                             3.65518
D.(coweeman_river_winter,S1-5)          -0.12553
D.(east_fork_lewis_river_winter,S1-5)   -0.01908
D.(kalama_river_summer,S1-5)             0.12381
D.(kalama_river_winter,S1-5)             0.06702
D.(lower_cowlitz_river_winter,S1-5)      0.01015
D.(south_fork_toutle_river_winter,S1-5)  0.02201
D.(tilton_river_winter,S1-5)            -0.40277
D.(upper_cowlitz_river_winter,S1-5)      0.07656
D.(washougal_river_winter,S1-5)         -0.04601
D.(coweeman_river_winter,C1-5)          -0.12431
D.(east_fork_lewis_river_winter,C1-5)   -0.27756
D.(kalama_river_summer,C1-5)             0.05680
D.(kalama_river_winter,C1-5)             0.16503
D.(lower_cowlitz_river_winter,C1-5)     -0.10268
D.(south_fork_toutle_river_winter,C1-5) -0.34589
D.(tilton_river_winter,C1-5)            -0.09048
D.(upper_cowlitz_river_winter,C1-5)      0.06995
D.(washougal_river_winter,C1-5)         -0.30581
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>(mod_AICc <span class="ot">&lt;-</span> <span class="fu">c</span>(fit_5season<span class="sc">$</span>AICc, best_mod<span class="sc">$</span>AICc))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 482.2888 459.0557</code></pre>
</div>
</div>
<p>Interesting– This greatly improves our AICc, but the model without cycles still test as the best model.</p>
<p>Next we compare the fits of the best spatial model and the spatial model with cycling.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(best_mod, <span class="at">plot.type=</span><span class="st">"fitted.ytT"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MARSSresiduals.tT reported warnings. See msg element or attribute of returned residuals object.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-2-team-2_final_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>plot type =  fitted.ytT  Observations with fitted values</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit_5season, <span class="at">plot.type=</span><span class="st">"fitted.ytT"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MARSSresiduals.tT reported warnings. See msg element or attribute of returned residuals object.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-2-team-2_final_files/figure-html/unnamed-chunk-14-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>plot type =  fitted.ytT  Observations with fitted values</code></pre>
</div>
</div>
<p>Adding a 5 year cycling component does not have significant changes to the fit during years of data, but it does have a big impact on the hindcast and forecast fits.</p>
<p>Next we compare the residuals of our best model and our model with 5 year cycles.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Residuals of best model</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>))</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>resids <span class="ot">&lt;-</span> <span class="fu">MARSSresiduals</span>(best_mod, <span class="at">type =</span> <span class="st">"tt1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MARSSresiduals.tt1 reported warnings. See msg element of returned residuals object.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>) {</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(resids<span class="sc">$</span>model.residuals[i, ], <span class="at">ylab =</span> <span class="st">"model residuals"</span>, </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">""</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">title</span>(<span class="fu">rownames</span>(dat)[i])</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-2-team-2_final_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Residuals of best model + cycling</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>))</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>resids <span class="ot">&lt;-</span> <span class="fu">MARSSresiduals</span>(fit_5season, <span class="at">type =</span> <span class="st">"tt1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MARSSresiduals.tt1 reported warnings. See msg element of returned residuals object.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>) {</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(resids<span class="sc">$</span>model.residuals[i, ], <span class="at">ylab =</span> <span class="st">"model residuals"</span>, </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">""</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">title</span>(<span class="fu">rownames</span>(dat)[i])</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-2-team-2_final_files/figure-html/unnamed-chunk-15-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ACF of residuals</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(best_mod, <span class="at">plot.type =</span> <span class="st">"acf.std.model.resids.ytt1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MARSSresiduals.tt1 reported warnings. See msg element of returned residuals object.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-2-team-2_final_files/figure-html/unnamed-chunk-15-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>plot type = acf.std.model.resids.ytt1</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit_5season, <span class="at">plot.type =</span> <span class="st">"acf.std.model.resids.ytt1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MARSSresiduals.tt1 reported warnings. See msg element of returned residuals object.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-2-team-2_final_files/figure-html/unnamed-chunk-15-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>plot type = acf.std.model.resids.ytt1</code></pre>
</div>
</div>
<p>When comparing the residual and ACF plots of the spatial model w/o cycling and the spatial model w/ cycling, we do see some of the residual and ACF plots improve. For example, around lag 10 in the Kalama River winter population, the autocorrelation reduces relative the spatial model w/o cycling. The residual plots also remove some of the cycling patterns in a few groups (e.g., Tilton River, South Fork Toutle). However, the cyclic covariates in the process does not completely remove the residuals’ cycling patterns; positive values tend to follow positive ones.</p>
</section>
</section>
<section id="discussion" class="level1">
<h1>Discussion</h1>
<p>Our best model was our “spatial” group model, which was designed based on the spatial proximity of the subwatersheds of study and their steelhead populations. This grouped 9 steelhead populations together to form 5 populations or 5 “hidden states” of steelhead abundance dynamics through time. This implies that steelhead populations located closer in space or within the same catchment share temporal variation in their abundance dynamics, suggesting that populations are largely influenced by similar river or watershed characteristics (e.g., habitat quality or availability) and not so much run timing. All run populations seem to have increased since the earliest year of data, though some populations seem to have decreased slightly in recent years (e.g., Washougal, Cowlitz, East Fork Lewis). Our best performing model seems to fit the data well with no major problems in the residuals, with the exception of cycling.</p>
<p>We found some evidence for 5 year cycles, though it did not lower the AIC relative to the spatial model. This makes sense since steelhead (relative to other salmonids) do not exhibit as much cycling. Even within these 9 runs, we see some runs (e.g.&nbsp;Kalama winter) show more cycling patterns than others (e.g.&nbsp;Upper Cowlitz winter) do. A reason why AIC does not support adding 5 year cycles to all runs is that not all runs need cycling and the addition of parameters for these runs is superfluous. Cycling did somewhat improve autocorrelation in our model residuals by reducing the number of statistically significant ACF lags.</p>
<p>Future improvements to our best performing spatial model would be to include cycling in only populations that strong seasonal patterns. This, however, involves “hand-baking” a series of upper C matrices and was outside the scope of this study.</p>
</section>
<section id="description-of-each-team-members-contributions" class="level1">
<h1>Description of each team member’s contributions</h1>
<p>Liz worked on the model with 9 states, the spatial model, correlation model, model selection process, and cycling model. Terrance worked on the methods, matrix notations, simple model with 1 state, and run timing model. Eric worked on adding the cycling component and model selection of cycling period. All group members worked on the discussion and interpretation.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/atsa-es\.github\.io\/fish550-2023\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="atsa-es/fish550-2023" data-repo-id="R_kgDOJGNymQ" data-category="General" data-category-id="DIC_kwDOJGNymc4CUsbe" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../Lab-2/Final_Write_ups/Lab-2-team-1_final.html" class="pagination-link" aria-label="Team 1 - Lab 2">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Team 1 - Lab 2</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../Lab-2/Final_Write_ups/Lab-2-team-3_final.html" class="pagination-link" aria-label="Team 3 - Lab 2">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Team 3 - Lab 2</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb73" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> Team 2 - Lab 2</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> Lab 2 MARSS Models</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> Liz Elmstrom, Terrance Wang, Eric French</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> April 20, 2023</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="an">output:</span><span class="co"> </span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html_document:</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-folding: true</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="co">    toc_float: true</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="fu"># General Questions</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>Each group has the same general tasks, but you will adapt them as you work on the data.</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Create estimates of spawner abundance for all missing years and provide estimates of the decline from the historical abundance.</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Evaluate support for the major population groups. Are the populations in the groups more correlated than outside the groups?</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Evaluate the evidence of cycling in the data. *We will talk about how to do this on the Tuesday after lab.*</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>We analyzed the Steelhead (Lower Columbia ESU). We decided to exclude the Gorge Tributary winter run because there was only 1 short time series, and focused the 9 remaining runs that belonged to Cascade major population group. </span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a><span class="fu"># Methods</span></span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>We tested 5 different population groups hypotheses: one population, individual populations, run timing groups, spatial groups, and correlation groups. </span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>One population</span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix} y_{1} <span class="sc">\\</span> y_{2} <span class="sc">\\</span> \vdots <span class="sc">\\</span>y_{9} \end{bmatrix}_{t} = </span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}1<span class="sc">\\</span></span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a>1<span class="sc">\\</span></span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>\vdots<span class="sc">\\</span></span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a><span class="sc">\\</span> </span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a>1\end{bmatrix} </span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a> x_{t}  + \mathbf{a} + \mathbf{v_t} \text{ where } \mathbf{v_t} \sim MVN(0, \mathbf{R})</span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix} x \end{bmatrix}_{t} = </span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}1<span class="sc">\\</span></span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a>\end{bmatrix} </span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a> x_{t-1}  + u + w_t \text{ where } w_t \sim N(0,q)</span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a>Individual populations</span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix} y_{1} <span class="sc">\\</span> y_{2} <span class="sc">\\</span> \vdots <span class="sc">\\</span>y_{9} \end{bmatrix}_{t} = </span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a>I_{9}</span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix} x_{1} <span class="sc">\\</span> x_{2} <span class="sc">\\</span> \vdots <span class="sc">\\</span>x_{9} \end{bmatrix}_{t} + \mathbf{a} + \mathbf{v_t} \text{ where } \mathbf{v_t} \sim MVN(0, \mathbf{R})</span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-53"><a href="#cb73-53" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-54"><a href="#cb73-54" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix} x_{1} <span class="sc">\\</span></span>
<span id="cb73-55"><a href="#cb73-55" aria-hidden="true" tabindex="-1"></a>x_{2} <span class="sc">\\</span> </span>
<span id="cb73-56"><a href="#cb73-56" aria-hidden="true" tabindex="-1"></a>\vdots <span class="sc">\\</span></span>
<span id="cb73-57"><a href="#cb73-57" aria-hidden="true" tabindex="-1"></a>x_{9}</span>
<span id="cb73-58"><a href="#cb73-58" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}_{t}</span>
<span id="cb73-59"><a href="#cb73-59" aria-hidden="true" tabindex="-1"></a>= </span>
<span id="cb73-60"><a href="#cb73-60" aria-hidden="true" tabindex="-1"></a>I_{9}</span>
<span id="cb73-61"><a href="#cb73-61" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix} x_{1} <span class="sc">\\</span></span>
<span id="cb73-62"><a href="#cb73-62" aria-hidden="true" tabindex="-1"></a>x_{2} <span class="sc">\\</span> </span>
<span id="cb73-63"><a href="#cb73-63" aria-hidden="true" tabindex="-1"></a>\vdots <span class="sc">\\</span></span>
<span id="cb73-64"><a href="#cb73-64" aria-hidden="true" tabindex="-1"></a>x_{9}</span>
<span id="cb73-65"><a href="#cb73-65" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}_{t-1}  + \begin{bmatrix}u_{1}\\u_{2}\\ \vdots \\u_{9} \end{bmatrix}  + \mathbf{w_t} \text{ where } \mathbf{w_t} \sim MVN(0, \mathbf{Q})</span>
<span id="cb73-66"><a href="#cb73-66" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-67"><a href="#cb73-67" aria-hidden="true" tabindex="-1"></a>Run Timing Groups, Spatial Groups, Correlation Groups</span>
<span id="cb73-68"><a href="#cb73-68" aria-hidden="true" tabindex="-1"></a>We provide the Z matrices for the 3 groupings below. </span>
<span id="cb73-69"><a href="#cb73-69" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-70"><a href="#cb73-70" aria-hidden="true" tabindex="-1"></a>\begin{equation*}</span>
<span id="cb73-71"><a href="#cb73-71" aria-hidden="true" tabindex="-1"></a>\begin{array}{rcccc}</span>
<span id="cb73-72"><a href="#cb73-72" aria-hidden="true" tabindex="-1"></a>&amp;Run Timing&amp;Spatial&amp;Correlation<span class="sc">\\</span></span>
<span id="cb73-73"><a href="#cb73-73" aria-hidden="true" tabindex="-1"></a>&amp;\text{summer winter}&amp;\text{Coweeman E-Fork-Lewis Kalama Cowlitz Washougal}&amp;\text{Coweeman Kalama Cowlitz}<span class="sc">\\</span></span>
<span id="cb73-74"><a href="#cb73-74" aria-hidden="true" tabindex="-1"></a>\hline</span>
<span id="cb73-75"><a href="#cb73-75" aria-hidden="true" tabindex="-1"></a>\begin{array}{r}\text{Coweeman - W}<span class="sc">\\</span> \text{Fork E Lewis - W} <span class="sc">\\</span> \text{Kalama - S} <span class="sc">\\</span> \text{Kalama - W} <span class="sc">\\</span> </span>
<span id="cb73-76"><a href="#cb73-76" aria-hidden="true" tabindex="-1"></a>\text{Lower Cowlitz - W} <span class="sc">\\</span> \text{Toutle - W} <span class="sc">\\</span> \text{Tilton - W} <span class="sc">\\</span> \text{Upper Cowlitz - W} <span class="sc">\\</span> \text{Washougal - W}\end{array}&amp;</span>
<span id="cb73-77"><a href="#cb73-77" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}</span>
<span id="cb73-78"><a href="#cb73-78" aria-hidden="true" tabindex="-1"></a>0 &amp; 1 <span class="sc">\\</span></span>
<span id="cb73-79"><a href="#cb73-79" aria-hidden="true" tabindex="-1"></a>0 &amp; 1 <span class="sc">\\</span></span>
<span id="cb73-80"><a href="#cb73-80" aria-hidden="true" tabindex="-1"></a>1 &amp; 0 <span class="sc">\\</span></span>
<span id="cb73-81"><a href="#cb73-81" aria-hidden="true" tabindex="-1"></a>0 &amp; 1 <span class="sc">\\</span></span>
<span id="cb73-82"><a href="#cb73-82" aria-hidden="true" tabindex="-1"></a>0 &amp; 1 <span class="sc">\\</span></span>
<span id="cb73-83"><a href="#cb73-83" aria-hidden="true" tabindex="-1"></a>0 &amp; 1 <span class="sc">\\</span></span>
<span id="cb73-84"><a href="#cb73-84" aria-hidden="true" tabindex="-1"></a>0 &amp; 1 <span class="sc">\\</span></span>
<span id="cb73-85"><a href="#cb73-85" aria-hidden="true" tabindex="-1"></a>0 &amp; 1 <span class="sc">\\</span></span>
<span id="cb73-86"><a href="#cb73-86" aria-hidden="true" tabindex="-1"></a>0 &amp; 1 <span class="sc">\\</span></span>
<span id="cb73-87"><a href="#cb73-87" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}&amp;</span>
<span id="cb73-88"><a href="#cb73-88" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}</span>
<span id="cb73-89"><a href="#cb73-89" aria-hidden="true" tabindex="-1"></a>1 &amp; 0 &amp; 0 &amp; 0 &amp;0 <span class="sc">\\</span></span>
<span id="cb73-90"><a href="#cb73-90" aria-hidden="true" tabindex="-1"></a>0 &amp; 1 &amp; 0 &amp; 0 &amp;0 <span class="sc">\\</span></span>
<span id="cb73-91"><a href="#cb73-91" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; 1 &amp; 0 &amp;0 <span class="sc">\\</span></span>
<span id="cb73-92"><a href="#cb73-92" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; 1 &amp; 0 &amp;0 <span class="sc">\\</span></span>
<span id="cb73-93"><a href="#cb73-93" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; 0 &amp; 1 &amp;0 <span class="sc">\\</span></span>
<span id="cb73-94"><a href="#cb73-94" aria-hidden="true" tabindex="-1"></a>1 &amp; 0 &amp; 0 &amp; 0 &amp;0 <span class="sc">\\</span></span>
<span id="cb73-95"><a href="#cb73-95" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; 0 &amp; 1 &amp;0 <span class="sc">\\</span></span>
<span id="cb73-96"><a href="#cb73-96" aria-hidden="true" tabindex="-1"></a>1 &amp; 0 &amp; 0 &amp; 0 &amp;0 <span class="sc">\\</span></span>
<span id="cb73-97"><a href="#cb73-97" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; 0 &amp; 0 &amp;1 <span class="sc">\\</span> </span>
<span id="cb73-98"><a href="#cb73-98" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}&amp;</span>
<span id="cb73-99"><a href="#cb73-99" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}</span>
<span id="cb73-100"><a href="#cb73-100" aria-hidden="true" tabindex="-1"></a>1 &amp; 0 &amp; 0 <span class="sc">\\</span></span>
<span id="cb73-101"><a href="#cb73-101" aria-hidden="true" tabindex="-1"></a>1 &amp; 0 &amp; 0 <span class="sc">\\</span></span>
<span id="cb73-102"><a href="#cb73-102" aria-hidden="true" tabindex="-1"></a>0 &amp; 1 &amp; 0 <span class="sc">\\</span></span>
<span id="cb73-103"><a href="#cb73-103" aria-hidden="true" tabindex="-1"></a>0 &amp; 1 &amp; 0 <span class="sc">\\</span></span>
<span id="cb73-104"><a href="#cb73-104" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; 1 <span class="sc">\\</span></span>
<span id="cb73-105"><a href="#cb73-105" aria-hidden="true" tabindex="-1"></a>1 &amp; 0 &amp; 0 <span class="sc">\\</span></span>
<span id="cb73-106"><a href="#cb73-106" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; 1 <span class="sc">\\</span></span>
<span id="cb73-107"><a href="#cb73-107" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; 1 <span class="sc">\\</span></span>
<span id="cb73-108"><a href="#cb73-108" aria-hidden="true" tabindex="-1"></a>1 &amp; 0 &amp; 0</span>
<span id="cb73-109"><a href="#cb73-109" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}&amp;</span>
<span id="cb73-110"><a href="#cb73-110" aria-hidden="true" tabindex="-1"></a>\end{array}</span>
<span id="cb73-111"><a href="#cb73-111" aria-hidden="true" tabindex="-1"></a>\end{equation*}</span>
<span id="cb73-112"><a href="#cb73-112" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-113"><a href="#cb73-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-114"><a href="#cb73-114" aria-hidden="true" tabindex="-1"></a>We assume that all models have identical observation errors, thus a diagonal and equal R matrix. </span>
<span id="cb73-115"><a href="#cb73-115" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-116"><a href="#cb73-116" aria-hidden="true" tabindex="-1"></a>\mathbf{R} = </span>
<span id="cb73-117"><a href="#cb73-117" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix} r &amp; 0  &amp; ...&amp; 0<span class="sc">\\</span></span>
<span id="cb73-118"><a href="#cb73-118" aria-hidden="true" tabindex="-1"></a>0 &amp; r &amp;  ...&amp; 0<span class="sc">\\</span></span>
<span id="cb73-119"><a href="#cb73-119" aria-hidden="true" tabindex="-1"></a>\vdots &amp; 0 &amp; \ddots &amp; \vdots<span class="sc">\\</span></span>
<span id="cb73-120"><a href="#cb73-120" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; 0  &amp; r \end{bmatrix}</span>
<span id="cb73-121"><a href="#cb73-121" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-122"><a href="#cb73-122" aria-hidden="true" tabindex="-1"></a>For each model we test both equal and unequal biases for the states. We also assumed all states were correlated over time and test both equal var-cov and unconstrained process errors for each state.</span>
<span id="cb73-123"><a href="#cb73-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-124"><a href="#cb73-124" aria-hidden="true" tabindex="-1"></a>Equal Bias</span>
<span id="cb73-125"><a href="#cb73-125" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-126"><a href="#cb73-126" aria-hidden="true" tabindex="-1"></a>\mathbf{u} = </span>
<span id="cb73-127"><a href="#cb73-127" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix} u<span class="sc">\\</span></span>
<span id="cb73-128"><a href="#cb73-128" aria-hidden="true" tabindex="-1"></a>\vdots<span class="sc">\\</span></span>
<span id="cb73-129"><a href="#cb73-129" aria-hidden="true" tabindex="-1"></a>u\end{bmatrix}</span>
<span id="cb73-130"><a href="#cb73-130" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-131"><a href="#cb73-131" aria-hidden="true" tabindex="-1"></a>Unequal Bias</span>
<span id="cb73-132"><a href="#cb73-132" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-133"><a href="#cb73-133" aria-hidden="true" tabindex="-1"></a>\mathbf{u} = </span>
<span id="cb73-134"><a href="#cb73-134" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix} u_{1}<span class="sc">\\</span></span>
<span id="cb73-135"><a href="#cb73-135" aria-hidden="true" tabindex="-1"></a>\vdots<span class="sc">\\</span></span>
<span id="cb73-136"><a href="#cb73-136" aria-hidden="true" tabindex="-1"></a>u_{i}\end{bmatrix} \text{where i is # of states} </span>
<span id="cb73-137"><a href="#cb73-137" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-138"><a href="#cb73-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-139"><a href="#cb73-139" aria-hidden="true" tabindex="-1"></a>Equal Variance-Covariance</span>
<span id="cb73-140"><a href="#cb73-140" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-141"><a href="#cb73-141" aria-hidden="true" tabindex="-1"></a>\begin{equation}</span>
<span id="cb73-142"><a href="#cb73-142" aria-hidden="true" tabindex="-1"></a>\mathbf{Q}=\begin{bmatrix}</span>
<span id="cb73-143"><a href="#cb73-143" aria-hidden="true" tabindex="-1"></a>    q &amp; c &amp; ... &amp; c <span class="sc">\\</span></span>
<span id="cb73-144"><a href="#cb73-144" aria-hidden="true" tabindex="-1"></a>    c &amp; q &amp; \ddots &amp; \vdots<span class="sc">\\</span></span>
<span id="cb73-145"><a href="#cb73-145" aria-hidden="true" tabindex="-1"></a>    \vdots &amp; c &amp; \ddots &amp; c <span class="sc">\\</span></span>
<span id="cb73-146"><a href="#cb73-146" aria-hidden="true" tabindex="-1"></a>    c &amp; c &amp; ... &amp; q \end{bmatrix}</span>
<span id="cb73-147"><a href="#cb73-147" aria-hidden="true" tabindex="-1"></a>\end{equation} </span>
<span id="cb73-148"><a href="#cb73-148" aria-hidden="true" tabindex="-1"></a>\text{where # of rows is equal to # of states} </span>
<span id="cb73-149"><a href="#cb73-149" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-150"><a href="#cb73-150" aria-hidden="true" tabindex="-1"></a>Unconstrained</span>
<span id="cb73-151"><a href="#cb73-151" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-152"><a href="#cb73-152" aria-hidden="true" tabindex="-1"></a>\begin{equation}</span>
<span id="cb73-153"><a href="#cb73-153" aria-hidden="true" tabindex="-1"></a>\mathbf{Q}=\begin{bmatrix}</span>
<span id="cb73-154"><a href="#cb73-154" aria-hidden="true" tabindex="-1"></a>    q_{1}&amp; c_{1,2} &amp; ... &amp; c_{1,i} <span class="sc">\\</span></span>
<span id="cb73-155"><a href="#cb73-155" aria-hidden="true" tabindex="-1"></a>    c_{1,2} &amp; q_{2} &amp; \ddots &amp; c_{2,i}<span class="sc">\\</span></span>
<span id="cb73-156"><a href="#cb73-156" aria-hidden="true" tabindex="-1"></a>    \vdots &amp; \ddots &amp; \ddots &amp; \vdots <span class="sc">\\</span></span>
<span id="cb73-157"><a href="#cb73-157" aria-hidden="true" tabindex="-1"></a>    c_{1,i} &amp; ... &amp; c_{i-1,i} &amp; q_{i} \end{bmatrix}</span>
<span id="cb73-158"><a href="#cb73-158" aria-hidden="true" tabindex="-1"></a>\end{equation} </span>
<span id="cb73-159"><a href="#cb73-159" aria-hidden="true" tabindex="-1"></a>\text{where # of rows is equal to # of states} </span>
<span id="cb73-160"><a href="#cb73-160" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-161"><a href="#cb73-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-162"><a href="#cb73-162" aria-hidden="true" tabindex="-1"></a><span class="fu"># Data exploration</span></span>
<span id="cb73-163"><a href="#cb73-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-164"><a href="#cb73-164" aria-hidden="true" tabindex="-1"></a>Load the data.</span>
<span id="cb73-165"><a href="#cb73-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-168"><a href="#cb73-168" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb73-169"><a href="#cb73-169" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb73-170"><a href="#cb73-170" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb73-171"><a href="#cb73-171" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb73-172"><a href="#cb73-172" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MARSS)</span>
<span id="cb73-173"><a href="#cb73-173" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb73-174"><a href="#cb73-174" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb73-175"><a href="#cb73-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-176"><a href="#cb73-176" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"Lab-2"</span>, <span class="st">"Data_Images"</span>, <span class="st">"columbia-river.rda"</span>))</span>
<span id="cb73-177"><a href="#cb73-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-178"><a href="#cb73-178" aria-hidden="true" tabindex="-1"></a><span class="co">#Evolutionary Significant Units</span></span>
<span id="cb73-179"><a href="#cb73-179" aria-hidden="true" tabindex="-1"></a>esu <span class="ot">&lt;-</span> <span class="fu">unique</span>(columbia.river<span class="sc">$</span>esu_dps)</span>
<span id="cb73-180"><a href="#cb73-180" aria-hidden="true" tabindex="-1"></a>esu</span>
<span id="cb73-181"><a href="#cb73-181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-182"><a href="#cb73-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-185"><a href="#cb73-185" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb73-186"><a href="#cb73-186" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> columbia.river <span class="sc">%&gt;%</span> <span class="fu">subset</span>(esu_dps <span class="sc">%in%</span> <span class="st">"Steelhead (Lower Columbia River DPS)"</span>)</span>
<span id="cb73-187"><a href="#cb73-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-188"><a href="#cb73-188" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"colnames: "</span>, <span class="fu">colnames</span>(df), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb73-189"><a href="#cb73-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-190"><a href="#cb73-190" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(df<span class="sc">$</span>esapopname)</span>
<span id="cb73-191"><a href="#cb73-191" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(df<span class="sc">$</span>commonpopname)</span>
<span id="cb73-192"><a href="#cb73-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-193"><a href="#cb73-193" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>esapopname2 <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(df<span class="sc">$</span>esapopname, <span class="st">"Steelhead [(]Lower Columbia River DPS[)] "</span>, <span class="st">""</span>)</span>
<span id="cb73-194"><a href="#cb73-194" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(df<span class="sc">$</span>esapopname2)</span>
<span id="cb73-195"><a href="#cb73-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-196"><a href="#cb73-196" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x=</span>spawningyear, <span class="at">y=</span><span class="fu">log</span>(value), <span class="at">color=</span>majorpopgroup)) <span class="sc">+</span> </span>
<span id="cb73-197"><a href="#cb73-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size=</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb73-198"><a href="#cb73-198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb73-199"><a href="#cb73-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">5</span>, <span class="at">angle =</span> <span class="dv">90</span>)) <span class="sc">+</span></span>
<span id="cb73-200"><a href="#cb73-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>esapopname2) <span class="sc">+</span></span>
<span id="cb73-201"><a href="#cb73-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">'Lower Columbia Steelhead Populations'</span>)<span class="sc">+</span></span>
<span id="cb73-202"><a href="#cb73-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>))</span>
<span id="cb73-203"><a href="#cb73-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-204"><a href="#cb73-204" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-205"><a href="#cb73-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-206"><a href="#cb73-206" aria-hidden="true" tabindex="-1"></a>Wrangle the data.</span>
<span id="cb73-207"><a href="#cb73-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-210"><a href="#cb73-210" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb73-211"><a href="#cb73-211" aria-hidden="true" tabindex="-1"></a>esuname <span class="ot">&lt;-</span> esu[<span class="dv">3</span>]</span>
<span id="cb73-212"><a href="#cb73-212" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> columbia.river <span class="sc">%&gt;%</span> </span>
<span id="cb73-213"><a href="#cb73-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(esu_dps <span class="sc">==</span> esuname) <span class="sc">%&gt;%</span> <span class="co"># get only this ESU</span></span>
<span id="cb73-214"><a href="#cb73-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log.spawner =</span> <span class="fu">log</span>(value)) <span class="sc">%&gt;%</span> <span class="co"># create a column called log.spawner</span></span>
<span id="cb73-215"><a href="#cb73-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(esapopname, spawningyear, log.spawner) <span class="sc">%&gt;%</span> <span class="co"># get just the columns that I need</span></span>
<span id="cb73-216"><a href="#cb73-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"esapopname"</span>, <span class="at">values_from =</span> <span class="st">"log.spawner"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb73-217"><a href="#cb73-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_to_rownames</span>(<span class="at">var =</span> <span class="st">"spawningyear"</span>) <span class="sc">%&gt;%</span> <span class="co"># make the years rownames</span></span>
<span id="cb73-218"><a href="#cb73-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">%&gt;%</span> <span class="co"># turn into a matrix with year down the rows</span></span>
<span id="cb73-219"><a href="#cb73-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>() <span class="co"># make time across the columns</span></span>
<span id="cb73-220"><a href="#cb73-220" aria-hidden="true" tabindex="-1"></a>dat[<span class="fu">is.na</span>(dat)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb73-221"><a href="#cb73-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-222"><a href="#cb73-222" aria-hidden="true" tabindex="-1"></a><span class="do">## Fixing row names</span></span>
<span id="cb73-223"><a href="#cb73-223" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">rownames</span>(dat)</span>
<span id="cb73-224"><a href="#cb73-224" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(tmp, <span class="st">"Steelhead [(]Lower Columbia River DPS[)]"</span>, <span class="st">""</span>)</span>
<span id="cb73-225"><a href="#cb73-225" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">make_clean_names</span>(tmp)</span>
<span id="cb73-226"><a href="#cb73-226" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(dat) <span class="ot">&lt;-</span> tmp</span>
<span id="cb73-227"><a href="#cb73-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-228"><a href="#cb73-228" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>,]<span class="co"># remove upper gorge</span></span>
<span id="cb73-229"><a href="#cb73-229" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat[ <span class="fu">order</span>(<span class="fu">row.names</span>(dat)), ]<span class="do">## sort</span></span>
<span id="cb73-230"><a href="#cb73-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-231"><a href="#cb73-231" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-232"><a href="#cb73-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-233"><a href="#cb73-233" aria-hidden="true" tabindex="-1"></a><span class="fu"># Results</span></span>
<span id="cb73-234"><a href="#cb73-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-235"><a href="#cb73-235" aria-hidden="true" tabindex="-1"></a><span class="fu">## The simplest model</span></span>
<span id="cb73-236"><a href="#cb73-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-237"><a href="#cb73-237" aria-hidden="true" tabindex="-1"></a>Fitting the most simple model to help determine the need to group populations: One big population with different observations (populations). </span>
<span id="cb73-238"><a href="#cb73-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-241"><a href="#cb73-241" aria-hidden="true" tabindex="-1"></a><span class="in">```{R}</span></span>
<span id="cb73-242"><a href="#cb73-242" aria-hidden="true" tabindex="-1"></a>mod.list<span class="fl">.0</span> <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">B =</span> <span class="fu">matrix</span>(<span class="dv">1</span>), <span class="at">U =</span> <span class="fu">matrix</span>(<span class="st">"u"</span>), <span class="at">Q =</span> <span class="fu">matrix</span>(<span class="st">"q"</span>), </span>
<span id="cb73-243"><a href="#cb73-243" aria-hidden="true" tabindex="-1"></a>    <span class="at">Z =</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="dv">9</span>, <span class="dv">1</span>), <span class="at">A =</span> <span class="st">"scaling"</span>, <span class="at">R =</span> <span class="st">"diagonal and equal"</span>, </span>
<span id="cb73-244"><a href="#cb73-244" aria-hidden="true" tabindex="-1"></a>    <span class="at">x0 =</span> <span class="fu">matrix</span>(<span class="st">"mu"</span>), <span class="at">tinitx =</span> <span class="dv">0</span>)</span>
<span id="cb73-245"><a href="#cb73-245" aria-hidden="true" tabindex="-1"></a>fit_simple <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(dat, <span class="at">model=</span>mod.list<span class="fl">.0</span>, <span class="at">control=</span><span class="fu">list</span>(<span class="at">maxit=</span><span class="dv">1000</span>))</span>
<span id="cb73-246"><a href="#cb73-246" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit_simple, <span class="at">plot.type=</span><span class="st">"fitted.ytT"</span>)</span>
<span id="cb73-247"><a href="#cb73-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-248"><a href="#cb73-248" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-249"><a href="#cb73-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-250"><a href="#cb73-250" aria-hidden="true" tabindex="-1"></a>We see that the simple model is not the best at fitting the population estimates for many of the populations (e.g., Upper Cowlitz winter, East Fork Lewis winter). Many of the residuals do not appear to be stationary.</span>
<span id="cb73-251"><a href="#cb73-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-252"><a href="#cb73-252" aria-hidden="true" tabindex="-1"></a><span class="fu">## The most flexible model</span></span>
<span id="cb73-253"><a href="#cb73-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-254"><a href="#cb73-254" aria-hidden="true" tabindex="-1"></a>Fitting the most flexible model to help determine spatial Z hypotheses: Individual populations with an unconstrained Q matrix and unequal U</span>
<span id="cb73-255"><a href="#cb73-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-258"><a href="#cb73-258" aria-hidden="true" tabindex="-1"></a><span class="in">```{R}</span></span>
<span id="cb73-259"><a href="#cb73-259" aria-hidden="true" tabindex="-1"></a>mod.list1 <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb73-260"><a href="#cb73-260" aria-hidden="true" tabindex="-1"></a>  <span class="at">U =</span> <span class="st">"unequal"</span>,</span>
<span id="cb73-261"><a href="#cb73-261" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="st">"diagonal and equal"</span>,</span>
<span id="cb73-262"><a href="#cb73-262" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q =</span> <span class="st">"unconstrained"</span></span>
<span id="cb73-263"><a href="#cb73-263" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-264"><a href="#cb73-264" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(dat, <span class="at">model=</span>mod.list1, <span class="at">control=</span><span class="fu">list</span>(<span class="at">maxit=</span><span class="dv">800</span>))</span>
<span id="cb73-265"><a href="#cb73-265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-266"><a href="#cb73-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-269"><a href="#cb73-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb73-270"><a href="#cb73-270" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit1, <span class="at">plot.type=</span><span class="st">"fitted.ytT"</span>)</span>
<span id="cb73-271"><a href="#cb73-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-272"><a href="#cb73-272" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span>
<span id="cb73-273"><a href="#cb73-273" aria-hidden="true" tabindex="-1"></a>Q <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit1, <span class="at">type=</span><span class="st">"matrix"</span>)<span class="sc">$</span>Q</span>
<span id="cb73-274"><a href="#cb73-274" aria-hidden="true" tabindex="-1"></a>corrmat <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">diag</span>(Q))) <span class="sc">%*%</span> Q <span class="sc">%*%</span> <span class="fu">diag</span>(<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">diag</span>(Q)))</span>
<span id="cb73-275"><a href="#cb73-275" aria-hidden="true" tabindex="-1"></a><span class="fu">corrplot</span>(corrmat)</span>
<span id="cb73-276"><a href="#cb73-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-277"><a href="#cb73-277" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-278"><a href="#cb73-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-279"><a href="#cb73-279" aria-hidden="true" tabindex="-1"></a>Some of the populations are correlated. This implies it would be reasonable to test for equal variance covariance, along with some other population structures.</span>
<span id="cb73-280"><a href="#cb73-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-281"><a href="#cb73-281" aria-hidden="true" tabindex="-1"></a>We opted to test this in a for loop to compare multiple spatial structures, u options, and two options for Q.</span>
<span id="cb73-282"><a href="#cb73-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-283"><a href="#cb73-283" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model Assumptions</span></span>
<span id="cb73-284"><a href="#cb73-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-285"><a href="#cb73-285" aria-hidden="true" tabindex="-1"></a>Below we setting up population grouping hypotheses (Z matrices), correlation structures, drift or "bias" terms, and the fixed model list.</span>
<span id="cb73-286"><a href="#cb73-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-289"><a href="#cb73-289" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb73-290"><a href="#cb73-290" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we evaluated the data support for the following hypotheses about Lower Columbia salmon river trends</span></span>
<span id="cb73-291"><a href="#cb73-291" aria-hidden="true" tabindex="-1"></a><span class="co"># Each Z model is a hypothesis</span></span>
<span id="cb73-292"><a href="#cb73-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-293"><a href="#cb73-293" aria-hidden="true" tabindex="-1"></a><span class="do">## Simple run timing groupings</span></span>
<span id="cb73-294"><a href="#cb73-294" aria-hidden="true" tabindex="-1"></a><span class="co"># summer = kalama_river_summer</span></span>
<span id="cb73-295"><a href="#cb73-295" aria-hidden="true" tabindex="-1"></a><span class="co"># winter = remaining population</span></span>
<span id="cb73-296"><a href="#cb73-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-297"><a href="#cb73-297" aria-hidden="true" tabindex="-1"></a><span class="do">## Simple spatial groupings</span></span>
<span id="cb73-298"><a href="#cb73-298" aria-hidden="true" tabindex="-1"></a><span class="co"># coweeman = coweeman and sf toutle</span></span>
<span id="cb73-299"><a href="#cb73-299" aria-hidden="true" tabindex="-1"></a><span class="co"># ef_lewis = east fork lewis</span></span>
<span id="cb73-300"><a href="#cb73-300" aria-hidden="true" tabindex="-1"></a><span class="co"># kalama = kalama summer and winter</span></span>
<span id="cb73-301"><a href="#cb73-301" aria-hidden="true" tabindex="-1"></a><span class="co"># cowlitz = lower cowlitz, tilton, and upper cowlitz</span></span>
<span id="cb73-302"><a href="#cb73-302" aria-hidden="true" tabindex="-1"></a><span class="co"># washougal = washougal</span></span>
<span id="cb73-303"><a href="#cb73-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-304"><a href="#cb73-304" aria-hidden="true" tabindex="-1"></a><span class="do">## Correlation spatial groupings</span></span>
<span id="cb73-305"><a href="#cb73-305" aria-hidden="true" tabindex="-1"></a><span class="co"># coweeman = coweema, ef_lewis, sf toutle, washougal</span></span>
<span id="cb73-306"><a href="#cb73-306" aria-hidden="true" tabindex="-1"></a><span class="co"># kalama = kalama summer and winter</span></span>
<span id="cb73-307"><a href="#cb73-307" aria-hidden="true" tabindex="-1"></a><span class="co"># cowlitz = lower cowlitz, tilton, and upper cowlitz</span></span>
<span id="cb73-308"><a href="#cb73-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-309"><a href="#cb73-309" aria-hidden="true" tabindex="-1"></a>Z.models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb73-310"><a href="#cb73-310" aria-hidden="true" tabindex="-1"></a>  <span class="at">H1 =</span> <span class="fu">matrix</span>(<span class="dv">1</span>,<span class="dv">9</span>,<span class="dv">1</span>), <span class="co">#one hidden population state</span></span>
<span id="cb73-311"><a href="#cb73-311" aria-hidden="true" tabindex="-1"></a>  <span class="at">H2 =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"coweeman"</span>,<span class="st">"ef_lewis"</span>, <span class="st">"kalama_sum"</span>,</span>
<span id="cb73-312"><a href="#cb73-312" aria-hidden="true" tabindex="-1"></a>                <span class="st">'kalama_win'</span>, <span class="st">"low_cowlitz"</span>, <span class="st">"sf_toutle"</span>,</span>
<span id="cb73-313"><a href="#cb73-313" aria-hidden="true" tabindex="-1"></a>                <span class="st">"tilton"</span>, <span class="st">"up_cowlitz"</span>, <span class="st">"washougal"</span>)), <span class="co">#states are defined by individual population</span></span>
<span id="cb73-314"><a href="#cb73-314" aria-hidden="true" tabindex="-1"></a>  <span class="at">H3 =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"winter"</span>,<span class="st">"winter"</span>, <span class="st">"summer"</span>,</span>
<span id="cb73-315"><a href="#cb73-315" aria-hidden="true" tabindex="-1"></a>                <span class="st">'winter'</span>, <span class="st">"winter"</span>, <span class="st">"winter"</span>,</span>
<span id="cb73-316"><a href="#cb73-316" aria-hidden="true" tabindex="-1"></a>                <span class="st">"winter"</span>, <span class="st">"winter"</span>, <span class="st">"winter"</span>)),<span class="co"># states defined by running timing grouping (n = 2)</span></span>
<span id="cb73-317"><a href="#cb73-317" aria-hidden="true" tabindex="-1"></a>  <span class="at">H4 =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"coweeman"</span>,<span class="st">"ef_lewis"</span>, <span class="st">"kalama"</span>,</span>
<span id="cb73-318"><a href="#cb73-318" aria-hidden="true" tabindex="-1"></a>                <span class="st">'kalama'</span>, <span class="st">"cowlitz"</span>, <span class="st">"coweeman"</span>,</span>
<span id="cb73-319"><a href="#cb73-319" aria-hidden="true" tabindex="-1"></a>                <span class="st">"cowlitz"</span>, <span class="st">"cowlitz"</span>, <span class="st">"washougal"</span>)),<span class="co"># states defined by spatial grouping (n = 5)</span></span>
<span id="cb73-320"><a href="#cb73-320" aria-hidden="true" tabindex="-1"></a>  <span class="at">H5 =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"coweeman"</span>,<span class="st">"coweeman"</span>, <span class="st">"kalama"</span>,</span>
<span id="cb73-321"><a href="#cb73-321" aria-hidden="true" tabindex="-1"></a>                <span class="st">'kalama'</span>, <span class="st">"cowlitz"</span>, <span class="st">"coweeman"</span>,</span>
<span id="cb73-322"><a href="#cb73-322" aria-hidden="true" tabindex="-1"></a>                <span class="st">"cowlitz"</span>, <span class="st">"cowlitz"</span>, <span class="st">"coweeman"</span>))<span class="co"># states defined by correlation (n = 3)</span></span>
<span id="cb73-323"><a href="#cb73-323" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-324"><a href="#cb73-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-325"><a href="#cb73-325" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(Z.models) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"one_population"</span>,<span class="st">"indiv_population"</span>,<span class="st">"run_timing_groups"</span>,<span class="st">'spatial_groups'</span>,<span class="st">"corr_groups"</span>)</span>
<span id="cb73-326"><a href="#cb73-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-327"><a href="#cb73-327" aria-hidden="true" tabindex="-1"></a><span class="co"># Also testing different process error varcovar matrices</span></span>
<span id="cb73-328"><a href="#cb73-328" aria-hidden="true" tabindex="-1"></a>Q.models2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"equalvarcov"</span>,<span class="st">"unconstrained"</span>)</span>
<span id="cb73-329"><a href="#cb73-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-330"><a href="#cb73-330" aria-hidden="true" tabindex="-1"></a><span class="co"># Bias terms</span></span>
<span id="cb73-331"><a href="#cb73-331" aria-hidden="true" tabindex="-1"></a>u2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"unequal"</span>, <span class="st">'equal'</span>)</span>
<span id="cb73-332"><a href="#cb73-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-333"><a href="#cb73-333" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting fixed portion of mod list</span></span>
<span id="cb73-334"><a href="#cb73-334" aria-hidden="true" tabindex="-1"></a>mod.list <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb73-335"><a href="#cb73-335" aria-hidden="true" tabindex="-1"></a>  <span class="at">A =</span> <span class="st">"scaling"</span>,</span>
<span id="cb73-336"><a href="#cb73-336" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="st">"diagonal and equal"</span>)</span>
<span id="cb73-337"><a href="#cb73-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-338"><a href="#cb73-338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-339"><a href="#cb73-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-340"><a href="#cb73-340" aria-hidden="true" tabindex="-1"></a><span class="fu">## MARSS Model Selection</span></span>
<span id="cb73-341"><a href="#cb73-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-342"><a href="#cb73-342" aria-hidden="true" tabindex="-1"></a>Run MARSS models. </span>
<span id="cb73-343"><a href="#cb73-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-346"><a href="#cb73-346" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb73-347"><a href="#cb73-347" aria-hidden="true" tabindex="-1"></a>out.tab <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb73-348"><a href="#cb73-348" aria-hidden="true" tabindex="-1"></a>fits <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb73-349"><a href="#cb73-349" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(Z.models)){</span>
<span id="cb73-350"><a href="#cb73-350" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(Q.model <span class="cf">in</span> Q.models2){</span>
<span id="cb73-351"><a href="#cb73-351" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(U.model <span class="cf">in</span> u2){</span>
<span id="cb73-352"><a href="#cb73-352" aria-hidden="true" tabindex="-1"></a>      fit.model <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">list</span>(<span class="at">Z=</span>Z.models[[i]], <span class="at">Q=</span>Q.model, <span class="at">U=</span>U.model), mod.list)</span>
<span id="cb73-353"><a href="#cb73-353" aria-hidden="true" tabindex="-1"></a>      fit <span class="ot">=</span> <span class="fu">MARSS</span>(dat, <span class="at">model=</span>fit.model,</span>
<span id="cb73-354"><a href="#cb73-354" aria-hidden="true" tabindex="-1"></a>                <span class="at">silent=</span><span class="cn">TRUE</span>, <span class="at">control=</span><span class="fu">list</span>(<span class="at">maxit=</span><span class="dv">3000</span>))</span>
<span id="cb73-355"><a href="#cb73-355" aria-hidden="true" tabindex="-1"></a>      out<span class="ot">=</span><span class="fu">data.frame</span>(<span class="at">H=</span><span class="fu">names</span>(Z.models)[i],<span class="at">Q=</span>Q.model,<span class="at">U=</span>U.model,</span>
<span id="cb73-356"><a href="#cb73-356" aria-hidden="true" tabindex="-1"></a>                   <span class="at">logLik=</span>fit<span class="sc">$</span>logLik, <span class="at">AICc=</span>fit<span class="sc">$</span>AICc, <span class="at">num.param=</span>fit<span class="sc">$</span>num.params,</span>
<span id="cb73-357"><a href="#cb73-357" aria-hidden="true" tabindex="-1"></a>                   <span class="at">m=</span><span class="fu">length</span>(<span class="fu">unique</span>(Z.models[[i]])),</span>
<span id="cb73-358"><a href="#cb73-358" aria-hidden="true" tabindex="-1"></a>                   <span class="at">num.iter=</span>fit<span class="sc">$</span>numIter, <span class="at">converged=</span><span class="sc">!</span>fit<span class="sc">$</span>convergence,</span>
<span id="cb73-359"><a href="#cb73-359" aria-hidden="true" tabindex="-1"></a>                   <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb73-360"><a href="#cb73-360" aria-hidden="true" tabindex="-1"></a>      out.tab<span class="ot">=</span><span class="fu">rbind</span>(out.tab,out)</span>
<span id="cb73-361"><a href="#cb73-361" aria-hidden="true" tabindex="-1"></a>      fits<span class="ot">=</span><span class="fu">c</span>(fits,<span class="fu">list</span>(fit))</span>
<span id="cb73-362"><a href="#cb73-362" aria-hidden="true" tabindex="-1"></a>      } </span>
<span id="cb73-363"><a href="#cb73-363" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb73-364"><a href="#cb73-364" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb73-365"><a href="#cb73-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-366"><a href="#cb73-366" aria-hidden="true" tabindex="-1"></a>min.AICc <span class="ot">&lt;-</span> <span class="fu">order</span>(out.tab<span class="sc">$</span>AICc)</span>
<span id="cb73-367"><a href="#cb73-367" aria-hidden="true" tabindex="-1"></a>out.tab<span class="fl">.1</span> <span class="ot">&lt;-</span> out.tab[min.AICc, ]</span>
<span id="cb73-368"><a href="#cb73-368" aria-hidden="true" tabindex="-1"></a>out.tab<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">cbind</span>(out.tab<span class="fl">.1</span>, <span class="at">delta.AICc =</span> out.tab<span class="fl">.1</span><span class="sc">$</span>AICc <span class="sc">-</span> out.tab<span class="fl">.1</span><span class="sc">$</span>AICc[<span class="dv">1</span>])</span>
<span id="cb73-369"><a href="#cb73-369" aria-hidden="true" tabindex="-1"></a>out.tab<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">cbind</span>(out.tab<span class="fl">.1</span>, <span class="at">rel.like =</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> out.tab<span class="fl">.1</span><span class="sc">$</span>delta.AICc<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb73-370"><a href="#cb73-370" aria-hidden="true" tabindex="-1"></a>out.tab<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">cbind</span>(out.tab<span class="fl">.1</span>, <span class="at">AIC.weight =</span> out.tab<span class="fl">.1</span><span class="sc">$</span>rel.like<span class="sc">/</span><span class="fu">sum</span>(out.tab<span class="fl">.1</span><span class="sc">$</span>rel.like))</span>
<span id="cb73-371"><a href="#cb73-371" aria-hidden="true" tabindex="-1"></a>out.tab<span class="fl">.1</span></span>
<span id="cb73-372"><a href="#cb73-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-373"><a href="#cb73-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-374"><a href="#cb73-374" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-375"><a href="#cb73-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-376"><a href="#cb73-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-377"><a href="#cb73-377" aria-hidden="true" tabindex="-1"></a>The best model (as supported by AICc) includes 5 states (our "spatial populations" model) that are correlated with unique variance and covariance terms (unconstrained Q) with the same drift term (U)</span>
<span id="cb73-378"><a href="#cb73-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-379"><a href="#cb73-379" aria-hidden="true" tabindex="-1"></a><span class="fu">## Inspecting the best model (spatial group, unconstrained Q, equal U)</span></span>
<span id="cb73-382"><a href="#cb73-382" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb73-383"><a href="#cb73-383" aria-hidden="true" tabindex="-1"></a>best_mod <span class="ot">&lt;-</span> fits[[<span class="dv">16</span>]]</span>
<span id="cb73-384"><a href="#cb73-384" aria-hidden="true" tabindex="-1"></a>best_mod</span>
<span id="cb73-385"><a href="#cb73-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-386"><a href="#cb73-386" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(best_mod, <span class="at">plot.type =</span> <span class="st">"fitted.ytT"</span>)</span>
<span id="cb73-387"><a href="#cb73-387" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(best_mod, <span class="at">plot.type =</span> <span class="st">"acf.std.model.resids.ytt1"</span>)</span>
<span id="cb73-388"><a href="#cb73-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-389"><a href="#cb73-389" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-390"><a href="#cb73-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-391"><a href="#cb73-391" aria-hidden="true" tabindex="-1"></a>In our best model, we do see some autocorrelation in our residuals. In the next section, we will try to include a covariate of season into our best model and see if this improves the model fit. </span>
<span id="cb73-392"><a href="#cb73-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-393"><a href="#cb73-393" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparing best model to the most flexible model</span></span>
<span id="cb73-394"><a href="#cb73-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-397"><a href="#cb73-397" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb73-398"><a href="#cb73-398" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit1, <span class="at">plot.type=</span><span class="st">"fitted.ytT"</span>)<span class="co">#flexible</span></span>
<span id="cb73-399"><a href="#cb73-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-400"><a href="#cb73-400" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(best_mod, <span class="at">plot.type=</span><span class="st">"fitted.ytT"</span>)<span class="co">#best</span></span>
<span id="cb73-401"><a href="#cb73-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-402"><a href="#cb73-402" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-403"><a href="#cb73-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-404"><a href="#cb73-404" aria-hidden="true" tabindex="-1"></a>Do our estimates differ depending on the assumptions of the structure of the data, i.e. our assumptions about the x's, Q, and U?</span>
<span id="cb73-405"><a href="#cb73-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-406"><a href="#cb73-406" aria-hidden="true" tabindex="-1"></a>Definitely! The more flexible model (individual states, unequal bias term) produces more variable forecasts (with some populations increasing or decreasing through time). Our spatial model (5 states, equal bias term) provides relatively stable forecasts across populations, likely due to the "equal" bias term. </span>
<span id="cb73-407"><a href="#cb73-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-408"><a href="#cb73-408" aria-hidden="true" tabindex="-1"></a><span class="fu"># Seasonality as a covariate</span></span>
<span id="cb73-409"><a href="#cb73-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-410"><a href="#cb73-410" aria-hidden="true" tabindex="-1"></a>In this next section, we test for age structured cycling of steelhead populations or "season" in our best "spatial" model. </span>
<span id="cb73-411"><a href="#cb73-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-412"><a href="#cb73-412" aria-hidden="true" tabindex="-1"></a><span class="fu">## Initial model fitting</span></span>
<span id="cb73-415"><a href="#cb73-415" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb73-416"><a href="#cb73-416" aria-hidden="true" tabindex="-1"></a>Z.mat <span class="ot">&lt;-</span>  <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"coweeman"</span>,<span class="st">"ef_lewis"</span>, <span class="st">"kalama"</span>,</span>
<span id="cb73-417"><a href="#cb73-417" aria-hidden="true" tabindex="-1"></a>                <span class="st">'kalama'</span>, <span class="st">"cowlitz"</span>, <span class="st">"coweeman"</span>,</span>
<span id="cb73-418"><a href="#cb73-418" aria-hidden="true" tabindex="-1"></a>                <span class="st">"cowlitz"</span>, <span class="st">"cowlitz"</span>, <span class="st">"washougal"</span>)) <span class="co">#Our best model Z matrix</span></span>
<span id="cb73-419"><a href="#cb73-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-420"><a href="#cb73-420" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting up 3-5 year cycles as a covariate</span></span>
<span id="cb73-421"><a href="#cb73-421" aria-hidden="true" tabindex="-1"></a>TT <span class="ot">&lt;-</span> <span class="fu">dim</span>(dat)[<span class="dv">2</span>]</span>
<span id="cb73-422"><a href="#cb73-422" aria-hidden="true" tabindex="-1"></a>covariates <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb73-423"><a href="#cb73-423" aria-hidden="true" tabindex="-1"></a>  forecast<span class="sc">::</span><span class="fu">fourier</span>(<span class="fu">ts</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">freq=</span><span class="dv">3</span>), <span class="at">K=</span><span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">t</span>(),</span>
<span id="cb73-424"><a href="#cb73-424" aria-hidden="true" tabindex="-1"></a>  forecast<span class="sc">::</span><span class="fu">fourier</span>(<span class="fu">ts</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">freq=</span><span class="dv">4</span>), <span class="at">K=</span><span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">t</span>(),</span>
<span id="cb73-425"><a href="#cb73-425" aria-hidden="true" tabindex="-1"></a>  forecast<span class="sc">::</span><span class="fu">fourier</span>(<span class="fu">ts</span>(<span class="dv">1</span><span class="sc">:</span>TT, <span class="at">freq=</span><span class="dv">5</span>), <span class="at">K=</span><span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">t</span>()</span>
<span id="cb73-426"><a href="#cb73-426" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-427"><a href="#cb73-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-428"><a href="#cb73-428" aria-hidden="true" tabindex="-1"></a>mod.list2 <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb73-429"><a href="#cb73-429" aria-hidden="true" tabindex="-1"></a>  <span class="at">U =</span> <span class="st">"equal"</span>,</span>
<span id="cb73-430"><a href="#cb73-430" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q =</span> <span class="st">"unconstrained"</span>, </span>
<span id="cb73-431"><a href="#cb73-431" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> Z.mat,</span>
<span id="cb73-432"><a href="#cb73-432" aria-hidden="true" tabindex="-1"></a>  <span class="at">A =</span> <span class="st">"scaling"</span>,</span>
<span id="cb73-433"><a href="#cb73-433" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="st">"diagonal and equal"</span>,</span>
<span id="cb73-434"><a href="#cb73-434" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> <span class="st">"unconstrained"</span>, <span class="co"># We include these in the D matrix because the age structure cycling of salmon typically affects our observations rather than the state</span></span>
<span id="cb73-435"><a href="#cb73-435" aria-hidden="true" tabindex="-1"></a>  <span class="at">d =</span> covariates)</span>
<span id="cb73-436"><a href="#cb73-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-437"><a href="#cb73-437" aria-hidden="true" tabindex="-1"></a>fit_season <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(dat, <span class="at">model=</span>mod.list2)</span>
<span id="cb73-438"><a href="#cb73-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-439"><a href="#cb73-439" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-440"><a href="#cb73-440" aria-hidden="true" tabindex="-1"></a><span class="fu">## Evaluating the effect of different cycles</span></span>
<span id="cb73-441"><a href="#cb73-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-442"><a href="#cb73-442" aria-hidden="true" tabindex="-1"></a>We can then plot the effects of each cycle estimate. </span>
<span id="cb73-443"><a href="#cb73-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-446"><a href="#cb73-446" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb73-447"><a href="#cb73-447" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tidy</span>(fit_season) <span class="sc">%&gt;%</span></span>
<span id="cb73-448"><a href="#cb73-448" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(stringr<span class="sc">::</span><span class="fu">str_sub</span>(term,<span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">==</span><span class="st">"D"</span>)</span>
<span id="cb73-449"><a href="#cb73-449" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>lag <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">each=</span><span class="dv">18</span>))</span>
<span id="cb73-450"><a href="#cb73-450" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>river <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">rownames</span>(dat),<span class="dv">3</span>))</span>
<span id="cb73-451"><a href="#cb73-451" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>sc <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"S"</span>,<span class="st">"C"</span>), <span class="at">each=</span><span class="dv">9</span>), <span class="dv">3</span>)</span>
<span id="cb73-452"><a href="#cb73-452" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="fu">paste0</span>(df<span class="sc">$</span>sc,df<span class="sc">$</span>lag)</span>
<span id="cb73-453"><a href="#cb73-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-454"><a href="#cb73-454" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x=</span>type, <span class="at">y=</span>estimate, <span class="at">col=</span>lag)) <span class="sc">+</span> </span>
<span id="cb73-455"><a href="#cb73-455" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb73-456"><a href="#cb73-456" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>conf.low, <span class="at">ymax=</span>conf.up), <span class="at">width=</span>.<span class="dv">2</span>, <span class="at">position=</span><span class="fu">position_dodge</span>(.<span class="dv">9</span>)) <span class="sc">+</span></span>
<span id="cb73-457"><a href="#cb73-457" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb73-458"><a href="#cb73-458" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>river) <span class="sc">+</span></span>
<span id="cb73-459"><a href="#cb73-459" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"The cycle estimates with CIs"</span>)</span>
<span id="cb73-460"><a href="#cb73-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-461"><a href="#cb73-461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-462"><a href="#cb73-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-463"><a href="#cb73-463" aria-hidden="true" tabindex="-1"></a>These estimates suggest that there is some evidence of cycling at the 5 year interval in the East Fork Lewis, the South Fork Toutle, the Tilton, and the Washougal River steelhead populations. </span>
<span id="cb73-464"><a href="#cb73-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-465"><a href="#cb73-465" aria-hidden="true" tabindex="-1"></a>This, however, increases our AICc quite a bit, from 459.0557 in our original best model to 582.6302. Now let's try just including 5 year cycles and compare this AICc to our best model. </span>
<span id="cb73-466"><a href="#cb73-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-467"><a href="#cb73-467" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparing models with and without 5 year cycles</span></span>
<span id="cb73-468"><a href="#cb73-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-471"><a href="#cb73-471" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb73-472"><a href="#cb73-472" aria-hidden="true" tabindex="-1"></a>mod.list3 <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb73-473"><a href="#cb73-473" aria-hidden="true" tabindex="-1"></a>  <span class="at">U =</span> <span class="st">"equal"</span>,</span>
<span id="cb73-474"><a href="#cb73-474" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q =</span> <span class="st">"unconstrained"</span>, </span>
<span id="cb73-475"><a href="#cb73-475" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> Z.mat,</span>
<span id="cb73-476"><a href="#cb73-476" aria-hidden="true" tabindex="-1"></a>  <span class="at">A =</span> <span class="st">"scaling"</span>,</span>
<span id="cb73-477"><a href="#cb73-477" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="st">"diagonal and equal"</span>,</span>
<span id="cb73-478"><a href="#cb73-478" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> <span class="st">"unconstrained"</span>, <span class="co"># We include these in the D matrix because the age structure cycling of salmon typically affects our observations rather than the state</span></span>
<span id="cb73-479"><a href="#cb73-479" aria-hidden="true" tabindex="-1"></a>  <span class="at">d =</span> covariates[<span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>,]) <span class="co"># Specifying just 5 year cycles </span></span>
<span id="cb73-480"><a href="#cb73-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-481"><a href="#cb73-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-482"><a href="#cb73-482" aria-hidden="true" tabindex="-1"></a>fit_5season <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(dat, <span class="at">model=</span>mod.list3)</span>
<span id="cb73-483"><a href="#cb73-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-484"><a href="#cb73-484" aria-hidden="true" tabindex="-1"></a>(mod_AICc <span class="ot">&lt;-</span> <span class="fu">c</span>(fit_5season<span class="sc">$</span>AICc, best_mod<span class="sc">$</span>AICc))</span>
<span id="cb73-485"><a href="#cb73-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-486"><a href="#cb73-486" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-487"><a href="#cb73-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-488"><a href="#cb73-488" aria-hidden="true" tabindex="-1"></a>Interesting-- This greatly improves our AICc, but the model without cycles still test as the best model. </span>
<span id="cb73-489"><a href="#cb73-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-490"><a href="#cb73-490" aria-hidden="true" tabindex="-1"></a>Next we compare the fits of the best spatial model and the spatial model with cycling.</span>
<span id="cb73-493"><a href="#cb73-493" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb73-494"><a href="#cb73-494" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(best_mod, <span class="at">plot.type=</span><span class="st">"fitted.ytT"</span>)</span>
<span id="cb73-495"><a href="#cb73-495" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit_5season, <span class="at">plot.type=</span><span class="st">"fitted.ytT"</span>)</span>
<span id="cb73-496"><a href="#cb73-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-497"><a href="#cb73-497" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-498"><a href="#cb73-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-499"><a href="#cb73-499" aria-hidden="true" tabindex="-1"></a>Adding a 5 year cycling component does not have significant changes to the fit during years of data, but it does have a big impact on the hindcast and forecast fits.</span>
<span id="cb73-500"><a href="#cb73-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-501"><a href="#cb73-501" aria-hidden="true" tabindex="-1"></a>Next we compare the residuals of our best model and our model with 5 year cycles.</span>
<span id="cb73-502"><a href="#cb73-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-505"><a href="#cb73-505" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb73-506"><a href="#cb73-506" aria-hidden="true" tabindex="-1"></a><span class="co"># Residuals of best model</span></span>
<span id="cb73-507"><a href="#cb73-507" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>))</span>
<span id="cb73-508"><a href="#cb73-508" aria-hidden="true" tabindex="-1"></a>resids <span class="ot">&lt;-</span> <span class="fu">MARSSresiduals</span>(best_mod, <span class="at">type =</span> <span class="st">"tt1"</span>)</span>
<span id="cb73-509"><a href="#cb73-509" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>) {</span>
<span id="cb73-510"><a href="#cb73-510" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(resids<span class="sc">$</span>model.residuals[i, ], <span class="at">ylab =</span> <span class="st">"model residuals"</span>, </span>
<span id="cb73-511"><a href="#cb73-511" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">""</span>)</span>
<span id="cb73-512"><a href="#cb73-512" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>)</span>
<span id="cb73-513"><a href="#cb73-513" aria-hidden="true" tabindex="-1"></a>    <span class="fu">title</span>(<span class="fu">rownames</span>(dat)[i])</span>
<span id="cb73-514"><a href="#cb73-514" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb73-515"><a href="#cb73-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-516"><a href="#cb73-516" aria-hidden="true" tabindex="-1"></a><span class="co"># Residuals of best model + cycling</span></span>
<span id="cb73-517"><a href="#cb73-517" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>))</span>
<span id="cb73-518"><a href="#cb73-518" aria-hidden="true" tabindex="-1"></a>resids <span class="ot">&lt;-</span> <span class="fu">MARSSresiduals</span>(fit_5season, <span class="at">type =</span> <span class="st">"tt1"</span>)</span>
<span id="cb73-519"><a href="#cb73-519" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>) {</span>
<span id="cb73-520"><a href="#cb73-520" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(resids<span class="sc">$</span>model.residuals[i, ], <span class="at">ylab =</span> <span class="st">"model residuals"</span>, </span>
<span id="cb73-521"><a href="#cb73-521" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">""</span>)</span>
<span id="cb73-522"><a href="#cb73-522" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>)</span>
<span id="cb73-523"><a href="#cb73-523" aria-hidden="true" tabindex="-1"></a>    <span class="fu">title</span>(<span class="fu">rownames</span>(dat)[i])</span>
<span id="cb73-524"><a href="#cb73-524" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb73-525"><a href="#cb73-525" aria-hidden="true" tabindex="-1"></a><span class="co"># ACF of residuals</span></span>
<span id="cb73-526"><a href="#cb73-526" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(best_mod, <span class="at">plot.type =</span> <span class="st">"acf.std.model.resids.ytt1"</span>)</span>
<span id="cb73-527"><a href="#cb73-527" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit_5season, <span class="at">plot.type =</span> <span class="st">"acf.std.model.resids.ytt1"</span>)</span>
<span id="cb73-528"><a href="#cb73-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-529"><a href="#cb73-529" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-530"><a href="#cb73-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-531"><a href="#cb73-531" aria-hidden="true" tabindex="-1"></a>When comparing the residual and ACF plots of the spatial model w/o cycling and the spatial model w/ cycling, we do see some of the residual and ACF plots improve. For example, around lag 10 in the Kalama River winter population, the autocorrelation reduces relative the spatial model w/o cycling. The residual plots also remove some of the cycling patterns in a few groups (e.g., Tilton River, South Fork Toutle). However, the cyclic covariates in the process does not completely remove the residuals' cycling patterns; positive values tend to follow positive ones. </span>
<span id="cb73-532"><a href="#cb73-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-533"><a href="#cb73-533" aria-hidden="true" tabindex="-1"></a><span class="fu"># Discussion</span></span>
<span id="cb73-534"><a href="#cb73-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-535"><a href="#cb73-535" aria-hidden="true" tabindex="-1"></a>Our best model was our "spatial" group model, which was designed based on the spatial proximity of the subwatersheds of study and their steelhead populations. This grouped 9 steelhead populations together to form 5 populations or 5 "hidden states" of steelhead abundance dynamics through time. This implies that steelhead populations located closer in space or within the same catchment share temporal variation in their abundance dynamics, suggesting that populations are largely influenced by similar river or watershed characteristics (e.g., habitat quality or availability) and not so much run timing. All run populations seem to have increased since the earliest year of data, though some populations seem to have decreased slightly in recent years (e.g., Washougal, Cowlitz, East Fork Lewis). Our best performing model seems to fit the data well with no major problems in the residuals, with the exception of cycling.   </span>
<span id="cb73-536"><a href="#cb73-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-537"><a href="#cb73-537" aria-hidden="true" tabindex="-1"></a>We found some evidence for 5 year cycles, though it did not lower the AIC relative to the spatial model. This makes sense since steelhead (relative to other salmonids) do not exhibit as much cycling. Even within these 9 runs, we see some runs (e.g. Kalama winter) show more cycling patterns than others (e.g. Upper Cowlitz winter) do. A reason why AIC does not support adding 5 year cycles to all runs is that not all runs need cycling and the addition of parameters for these runs is superfluous. Cycling did somewhat improve autocorrelation in our model residuals by reducing the number of statistically significant ACF lags. </span>
<span id="cb73-538"><a href="#cb73-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-539"><a href="#cb73-539" aria-hidden="true" tabindex="-1"></a>Future improvements to our best performing spatial model would be to include cycling in only populations that strong seasonal patterns. This, however, involves "hand-baking" a series of upper C matrices and was outside the scope of this study. </span>
<span id="cb73-540"><a href="#cb73-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-541"><a href="#cb73-541" aria-hidden="true" tabindex="-1"></a><span class="fu"># Description of each team member's contributions</span></span>
<span id="cb73-542"><a href="#cb73-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-543"><a href="#cb73-543" aria-hidden="true" tabindex="-1"></a>Liz worked on the model with 9 states, the spatial model, correlation model, model selection process, and cycling model. Terrance worked on the methods, matrix notations, simple model with 1 state, and run timing model. Eric worked on adding the cycling component and model selection of cycling period. All group members worked on the discussion and interpretation. </span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/atsa-es/fish550-2023/edit/main/Lab-2/Final_Write_ups/Lab-2-team-2_final.Rmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/atsa-es/fish550-2023/blob/main/Lab-2/Final_Write_ups/Lab-2-team-2_final.Rmd" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/atsa-es/fish550-2023/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>