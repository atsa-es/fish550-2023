<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Miranda Mudge, Karl Veggerby, Emma Timmins-Schiffman">
<meta name="dcterms.date" content="2023-04-20">

<title>16&nbsp; Team 4 - Lab 3 – Fish 550 Spring 2023</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../Lab-4/Lab-4-HMM.html" rel="next">
<link href="../../Lab-3/Final_Write_ups/Lab-3-team-3_final.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-626149efe8f5d16e1d391ba177679bf0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../Lab-3/Lab-3-DFA.html">Dynamic Factor Analysis</a></li><li class="breadcrumb-item"><a href="../../Lab-3/Final_Write_ups/Lab-3-team-4_final.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Team 4 - Lab 3</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">Fish 550 Spring 2023</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/atsa-es/fish550-2023" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Labs</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Forecasting with ARIMA models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-1/Lab1-ARIMA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Lab Intro</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-1/Final_Write_ups/Lab-1-team-1_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Team 1 - Lab 1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-1/Final_Write_ups/Lab-1-team-2_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Team 2 - Lab 1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-1/Final_Write_ups/Lab-1-team-3_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Team 3 - Lab 1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-1/Final_Write_ups/Lab-1-team-4_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Team 4 - Lab 1</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Analyzing multivariate salmon data with MARSS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-2/Lab2-MARSS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Lab Intro</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-2/Final_Write_ups/Lab-2-team-1_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Team 1 - Lab 2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-2/Final_Write_ups/Lab-2-team-2_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Team 2 - Lab 2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-2/Final_Write_ups/Lab-2-team-3_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Team 3 - Lab 2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-2/Final_Write_ups/Lab-2-team-4_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Team 4 - Lab 2</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Dynamic Factor Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-3/Lab-3-DFA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Lab Intro</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-3/Final_Write_ups/Lab-3-team-1_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Team 1 - Lab 3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-3/Final_Write_ups/Lab-3-team-2_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Team 2 - Lab 3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-3/Final_Write_ups/Lab-3-team-3_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Team 3 - Lab 3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-3/Final_Write_ups/Lab-3-team-4_final.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Team 4 - Lab 3</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Hidden Markov Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-4/Lab-4-HMM.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Lab Intro</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-4/Final_Write_ups/Lab-4-team-1_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Team 1 - Lab 4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-4/Final_Write_ups/Lab-4-team-2_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Team 2 - Lab 4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-4/Final_Write_ups/Lab-4-team-3_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Team 3 - Lab 4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-4/Final_Write_ups/Lab-4-team-4_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Team 4 - Lab 4</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#data" id="toc-data" class="nav-link active" data-scroll-target="#data">Data</a></li>
  <li><a href="#methods" id="toc-methods" class="nav-link" data-scroll-target="#methods">Methods</a>
  <ul class="collapse">
  <li><a href="#load-the-data" id="toc-load-the-data" class="nav-link" data-scroll-target="#load-the-data">Load the data</a></li>
  <li><a href="#wrangle-the-data" id="toc-wrangle-the-data" class="nav-link" data-scroll-target="#wrangle-the-data">Wrangle the data</a></li>
  <li><a href="#fitting-a-model" id="toc-fitting-a-model" class="nav-link" data-scroll-target="#fitting-a-model">Fitting a Model</a></li>
  <li><a href="#adding-covariates-to-the-model" id="toc-adding-covariates-to-the-model" class="nav-link" data-scroll-target="#adding-covariates-to-the-model">Adding covariates to the model</a></li>
  <li><a href="#adding-seasonality-to-the-model" id="toc-adding-seasonality-to-the-model" class="nav-link" data-scroll-target="#adding-seasonality-to-the-model">Adding seasonality to the model</a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a>
  <ul class="collapse">
  <li><a href="#what-happens-if-we-try-to-fit-a-similar-model-after-the-period-of-high-tp-in-lake-washington" id="toc-what-happens-if-we-try-to-fit-a-similar-model-after-the-period-of-high-tp-in-lake-washington" class="nav-link" data-scroll-target="#what-happens-if-we-try-to-fit-a-similar-model-after-the-period-of-high-tp-in-lake-washington">What happens if we try to fit a similar model after the period of high TP in Lake Washington?</a></li>
  </ul></li>
  <li><a href="#discussion" id="toc-discussion" class="nav-link" data-scroll-target="#discussion">Discussion</a></li>
  <li><a href="#team-contributions" id="toc-team-contributions" class="nav-link" data-scroll-target="#team-contributions">Team contributions</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/atsa-es/fish550-2023/edit/main/Lab-3/Final_Write_ups/Lab-3-team-4_final.Rmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/atsa-es/fish550-2023/blob/main/Lab-3/Final_Write_ups/Lab-3-team-4_final.Rmd" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/atsa-es/fish550-2023/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../Lab-3/Lab-3-DFA.html">Dynamic Factor Analysis</a></li><li class="breadcrumb-item"><a href="../../Lab-3/Final_Write_ups/Lab-3-team-4_final.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Team 4 - Lab 3</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Team 4 - Lab 3</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Dynamic Factor Analysis (DFA)</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Miranda Mudge, Karl Veggerby, Emma Timmins-Schiffman </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 20, 2023</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<hr>
<section id="data" class="level1">
<h1>Data</h1>
<p>We chose to use the plankton groups that had the most complete datasets over the course of the time series. This included the zooplankton Cyclops, Diaptomus, and Non-colonial rotifers. The phytoplankton groups were unicells and other algae. Of course, this approach excluded many other groups which might have been resulted in better model fits, or more suitable data for our hypothesis. We chose temperature and TP as our covariates since they both have a strong influence on phytoplankton and temperature has an influence on zooplankton. We created a seasonality dummy variable.</p>
</section>
<section id="methods" class="level1">
<h1>Methods</h1>
<section id="load-the-data" class="level2">
<h2 class="anchored" data-anchor-id="load-the-data">Load the data</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## load MARSS for data and analyses</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MARSS)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="do">## load the raw data (there are 3 datasets contained here)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(lakeWAplankton, <span class="at">package =</span> <span class="st">"MARSS"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="do">## we want `lakeWAplanktonTrans`, which has been transformed</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="do">## so the 0's are replaced with NA's and the data z-scored</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>all_dat <span class="ot">&lt;-</span> lakeWAplanktonTrans</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="wrangle-the-data" class="level2">
<h2 class="anchored" data-anchor-id="wrangle-the-data">Wrangle the data</h2>
<p>We chose taxa that had mostly complete data for the entire time series. We wanted to investigate possible links between fluctuations in phytoplankton and impacts on zooplankton grazers, so we only included zooplankton that graze on phytoplankton. Later, we investigated if the models fit the data better for a shorter time series with a stronger apparent seasonal signal (1962-1972).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">## assign colors for plotting</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>clr <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"orange"</span>,  <span class="st">"green"</span>, <span class="st">"blue"</span>, <span class="st">"purple"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#subset data to taxa of interest and pH, temp, and TP</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>plank.for.DFA<span class="ot">&lt;-</span><span class="fu">subset</span>(all_dat, <span class="at">select=</span><span class="fu">c</span>(<span class="st">"Year"</span>, <span class="st">'Unicells'</span>, <span class="st">'Other.algae'</span>, <span class="st">'Cyclops'</span>, <span class="st">'Diaptomus'</span>, <span class="st">'Non.colonial.rotifers'</span>))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#transpose data</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>plank.t<span class="ot">&lt;-</span><span class="fu">t</span>(plank.for.DFA)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>year.cols<span class="ot">&lt;-</span>plank.t[<span class="dv">1</span>,]</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>plank.t<span class="ot">&lt;-</span>plank.t[<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>,]</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(plank.t)<span class="ot">&lt;-</span>year.cols</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>N.ts<span class="ot">&lt;-</span><span class="fu">nrow</span>(plank.t)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>TT<span class="ot">&lt;-</span><span class="fu">ncol</span>(plank.t)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>yr_frst <span class="ot">&lt;-</span> <span class="dv">1962</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="fitting-a-model" class="level2">
<h2 class="anchored" data-anchor-id="fitting-a-model">Fitting a Model</h2>
<p>We have 5 time series and will start with assuming 3 hidden trends. We assume that there are different observation errors for the different plankton given differences in size and feeding behavior. The Z matrix can be seen in the code below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#set matrices for the DFA model</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>Z.vals<span class="ot">&lt;-</span><span class="fu">list</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"z11"</span>, <span class="dv">0</span>, <span class="dv">0</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"z21"</span>, <span class="st">"z22"</span>, <span class="dv">0</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"z31"</span>, <span class="st">"z32"</span>, <span class="st">"z33"</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"z41"</span>, <span class="st">"z42"</span>, <span class="st">"z43"</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"z51"</span>, <span class="st">"z52"</span>, <span class="st">"z53"</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>Z<span class="ot">&lt;-</span><span class="fu">matrix</span>(Z.vals, <span class="at">nrow=</span>N.ts, <span class="at">ncol=</span><span class="dv">3</span>, <span class="at">byrow=</span>T)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>Z</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1]  [,2]  [,3] 
[1,] "z11" 0     0    
[2,] "z21" "z22" 0    
[3,] "z31" "z32" "z33"
[4,] "z41" "z42" "z43"
[5,] "z51" "z52" "z53"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Q and B are equal to identity matrix</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>Q<span class="ot">&lt;-</span>B<span class="ot">&lt;-</span><span class="fu">diag</span>(<span class="dv">1</span>,<span class="dv">3</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>Q </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,]    1    0    0
[2,]    0    1    0
[3,]    0    0    1</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>B</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,]    1    0    0
[2,]    0    1    0
[3,]    0    0    1</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>R<span class="ot">&lt;-</span><span class="st">"diagonal and unequal"</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>x0<span class="ot">&lt;-</span>U<span class="ot">&lt;-</span>A<span class="ot">&lt;-</span><span class="st">"zero"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>V0<span class="ot">&lt;-</span><span class="fu">diag</span>(<span class="dv">5</span>,<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here is the model for 3 hidden trends:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>dfa.model1<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">Z=</span>Z, <span class="at">A=</span><span class="st">"zero"</span>, <span class="at">R=</span>R, <span class="at">B=</span>B, <span class="at">U=</span>U, <span class="at">Q=</span>Q, <span class="at">x0=</span>x0, <span class="at">V0=</span>V0)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>cntl.list<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">maxit=</span><span class="dv">3000</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>dfa.fit1<span class="ot">&lt;-</span><span class="fu">MARSS</span>(plank.t, <span class="at">model=</span>dfa.model1, <span class="at">control=</span>cntl.list, <span class="at">silent =</span> <span class="cn">TRUE</span>,<span class="at">method =</span> <span class="st">"BFGS"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(dfa.fit1, <span class="at">plot.type=</span><span class="st">'acf.std.model.resids.ytt1'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MARSSresiduals.tt1 reported warnings. See msg element of returned residuals object.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This model has a lot of autocorrelation in the residuals. We tried the same model with 2 or 4 underlying trends.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#2 trends</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>model.list<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">m=</span><span class="dv">2</span>, <span class="at">R=</span><span class="st">"diagonal and unequal"</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>dfa.fit2<span class="ot">&lt;-</span><span class="fu">MARSS</span>(plank.t, <span class="at">model=</span>model.list, <span class="at">z.score=</span>T, <span class="at">form=</span><span class="st">'dfa'</span>, <span class="at">control=</span>cntl.list, <span class="at">silent =</span> <span class="cn">TRUE</span>, <span class="at">method =</span> <span class="st">"BFGS"</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(dfa.fit2, <span class="at">plot.type=</span><span class="st">'acf.std.model.resids.ytt1'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#4 trends</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>model.list<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">m=</span><span class="dv">4</span>, <span class="at">R=</span><span class="st">"diagonal and unequal"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>dfa.fit3<span class="ot">&lt;-</span><span class="fu">MARSS</span>(plank.t, <span class="at">model=</span>model.list, <span class="at">z.score=</span>T, <span class="at">form=</span><span class="st">'dfa'</span>, <span class="at">control=</span>cntl.list, <span class="at">silent =</span> <span class="cn">TRUE</span>,<span class="at">method =</span> <span class="st">"BFGS"</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(dfa.fit3, <span class="at">plot.type=</span><span class="st">'acf.std.model.resids.ytt1'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MARSSresiduals.tt1 reported warnings. See msg element of returned residuals object.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Compare the AICc of the 3 options for underlying trends. The model with 4 hidden trends has the lowest AICc.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">cbind</span>(<span class="at">model=</span><span class="fu">c</span>(<span class="st">"3 trends"</span>, <span class="st">"2 trends"</span>, <span class="st">"4 trends"</span>), <span class="at">AICc=</span><span class="fu">round</span>(<span class="fu">c</span>(dfa.fit1<span class="sc">$</span>AICc, dfa.fit2<span class="sc">$</span>AICc, dfa.fit3<span class="sc">$</span>AICc))), <span class="at">quote=</span>F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     model    AICc
[1,] 3 trends 4777
[2,] 2 trends 4962
[3,] 4 trends 4698</code></pre>
</div>
</div>
</section>
<section id="adding-covariates-to-the-model" class="level2">
<h2 class="anchored" data-anchor-id="adding-covariates-to-the-model">Adding covariates to the model</h2>
<p>We will start with the assumption that our best model with have 4 hidden trends. We hypothesize that zooplankton will respond to fluctuations in the population of phytoplankton and that both plankton groups will respond strongly to temperature - a main driver of biological response in the ocean - and phytoplankton will respond strongly to changes in total phosphorus since increased TP typically causes phytoplankton growth.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#set up covariates and compare models with different combinations of covariates</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">t</span>(all_dat[,<span class="st">"Temp"</span>, <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>TP <span class="ot">&lt;-</span> <span class="fu">t</span>(all_dat[,<span class="st">"TP"</span>, <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>mod_list <span class="ot">=</span> <span class="fu">list</span>(<span class="at">m =</span> <span class="dv">4</span>, <span class="at">R =</span> <span class="st">"diagonal and unequal"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>dfa_temp <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(plank.t, <span class="at">model =</span> mod_list, <span class="at">form =</span> <span class="st">"dfa"</span>, <span class="at">z.score =</span> <span class="cn">FALSE</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control=</span>cntl.list, <span class="at">covariates =</span> temp, <span class="at">silent =</span> <span class="cn">TRUE</span>,<span class="at">method =</span> <span class="st">"BFGS"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>dfa_TP <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(plank.t, <span class="at">model =</span> mod_list, <span class="at">form =</span> <span class="st">"dfa"</span>, <span class="at">z.score =</span> <span class="cn">FALSE</span>,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">control=</span>cntl.list, <span class="at">covariates =</span> TP, <span class="at">silent =</span> <span class="cn">TRUE</span>,<span class="at">method =</span> <span class="st">"BFGS"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>dfa_both <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(plank.t, <span class="at">model =</span> mod_list, <span class="at">form =</span> <span class="st">"dfa"</span>, <span class="at">z.score =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control=</span>cntl.list, <span class="at">covariates =</span> <span class="fu">rbind</span>(temp, TP), <span class="at">silent =</span> <span class="cn">TRUE</span>,<span class="at">method =</span> <span class="st">"BFGS"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>dfa_AICc <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"no covars"</span>, <span class="st">"Temp"</span>, <span class="st">"TP"</span>, <span class="st">"Temp &amp; TP"</span>),</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">AICc =</span> <span class="fu">round</span>(<span class="fu">c</span>(dfa.fit3<span class="sc">$</span>AICc,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                           dfa_temp<span class="sc">$</span>AICc,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                           dfa_TP<span class="sc">$</span>AICc,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                           dfa_both<span class="sc">$</span>AICc)))</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>dfa_AICc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     model       AICc  
[1,] "no covars" "4698"
[2,] "Temp"      "4459"
[3,] "TP"        "4572"
[4,] "Temp &amp; TP" "4438"</code></pre>
</div>
</div>
<p>The “best” model (lowest AICc) includes both temperature and TP, supporting our hypothesis that both of these covariates drive biological response.</p>
</section>
<section id="adding-seasonality-to-the-model" class="level2">
<h2 class="anchored" data-anchor-id="adding-seasonality-to-the-model">Adding seasonality to the model</h2>
<p>Seasonal influences likely affect the plankton community as well. We create a dummy model for the seasonal influence to test its impact on model fit. We are not including all iterations here, but we tested seasons alone, seasons + TP, seasons + temperature, and seasons + temp + TP. The models that included seasons + TP and seasons + TP + temperature had the lowest and similar AICc (less than 10 units apart).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>cos_t <span class="ot">&lt;-</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">seq</span>(TT) <span class="sc">/</span> <span class="dv">12</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>sin_t <span class="ot">&lt;-</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">seq</span>(TT) <span class="sc">/</span> <span class="dv">12</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>dd <span class="ot">&lt;-</span> <span class="fu">rbind</span>(cos_t, sin_t)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="do">## fit model</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>dfa_TPseas <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(plank.t, <span class="at">model =</span> mod_list, <span class="at">form =</span> <span class="st">"dfa"</span>, <span class="at">z.score =</span> <span class="cn">FALSE</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control=</span>cntl.list, <span class="at">covariates =</span> <span class="fu">rbind</span>(TP, dd), <span class="at">silent =</span> <span class="cn">TRUE</span>,<span class="at">method =</span> <span class="st">"BFGS"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>dfa_TPtempseas <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(plank.t, <span class="at">model =</span> mod_list, <span class="at">form =</span> <span class="st">"dfa"</span>, <span class="at">z.score =</span> <span class="cn">FALSE</span>,</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">control=</span>cntl.list, <span class="at">covariates =</span> <span class="fu">rbind</span>(temp,TP, dd), <span class="at">silent =</span> <span class="cn">TRUE</span>,<span class="at">method =</span> <span class="st">"BFGS"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="results" class="level1">
<h1>Results</h1>
<p>Plot of the model fits for each of the seasonal models:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get estimated ZZ</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>Z_est <span class="ot">&lt;-</span> <span class="fu">coef</span>(dfa_TPseas, <span class="at">type =</span> <span class="st">"matrix"</span>)<span class="sc">$</span>Z</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>H_inv <span class="ot">&lt;-</span> <span class="fu">varimax</span>(Z_est)<span class="sc">$</span>rotmat</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># rotate factor loadings</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>Z.rot <span class="ot">=</span> Z_est <span class="sc">%*%</span> H_inv</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>trends.rot <span class="ot">=</span> <span class="fu">solve</span>(H_inv) <span class="sc">%*%</span> dfa_TPseas<span class="sc">$</span>states</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>w_ts <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">dim</span>(plank.t)[<span class="dv">2</span>])</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>ylbl <span class="ot">&lt;-</span> <span class="fu">rownames</span>(plank.t)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co">#This function will return the fits and CIs if no missing values</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>getDFAfits <span class="ot">&lt;-</span> <span class="cf">function</span>(MLEobj, <span class="at">alpha =</span> <span class="fl">0.05</span>, <span class="at">dd =</span> <span class="cn">NULL</span>) { <span class="co">#dd = covariates</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  fits <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  Ey <span class="ot">&lt;-</span> <span class="fu">MARSShatyt</span>(MLEobj) <span class="co"># for var() calcs</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  ZZ <span class="ot">&lt;-</span> <span class="fu">coef</span>(MLEobj, <span class="at">type =</span> <span class="st">"matrix"</span>)<span class="sc">$</span>Z <span class="co"># estimated Z</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  nn <span class="ot">&lt;-</span> <span class="fu">dim</span>(Ey<span class="sc">$</span>ytT) <span class="co"># number of obs ts</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a> <span class="co"># mm &lt;- ncol(ZZ) # number of factors/states</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  TT <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Ey<span class="sc">$</span>ytT) <span class="co"># number of time steps</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="do">## check for covars</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(dd)) {</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    DD <span class="ot">&lt;-</span> <span class="fu">coef</span>(MLEobj, <span class="at">type =</span> <span class="st">"matrix"</span>)<span class="sc">$</span>D</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    cov_eff <span class="ot">&lt;-</span> DD <span class="sc">%*%</span> dd</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    cov_eff <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, nn, TT)</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>  <span class="do">## model expectation</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>  fits<span class="sc">$</span>ex <span class="ot">&lt;-</span> ZZ <span class="sc">%*%</span> H_inv <span class="sc">%*%</span> MLEobj<span class="sc">$</span>states <span class="sc">+</span> cov_eff</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Var in model fits</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>  VtT <span class="ot">&lt;-</span> <span class="fu">MARSSkfss</span>(MLEobj)<span class="sc">$</span>VtT</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  VV <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (tt <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>TT) {</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    RZVZ <span class="ot">&lt;-</span> <span class="fu">coef</span>(MLEobj, <span class="at">type =</span> <span class="st">"matrix"</span>)<span class="sc">$</span>R <span class="sc">-</span> ZZ <span class="sc">%*%</span> VtT[, , tt] <span class="sc">%*%</span> <span class="fu">t</span>(ZZ)</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    SS <span class="ot">&lt;-</span> Ey<span class="sc">$</span>yxtT[, , tt] <span class="sc">-</span> Ey<span class="sc">$</span>ytT[, tt, drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">%*%</span> <span class="fu">t</span>(MLEobj<span class="sc">$</span>states[, tt, <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    VV <span class="ot">&lt;-</span> <span class="fu">cbind</span>(VV, <span class="fu">diag</span>(RZVZ <span class="sc">+</span> SS <span class="sc">%*%</span> <span class="fu">t</span>(ZZ) <span class="sc">+</span> ZZ <span class="sc">%*%</span> <span class="fu">t</span>(SS)))</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>  SE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(VV)</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>  <span class="do">## upper &amp; lower (1-alpha)% CI</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>  fits<span class="sc">$</span>up <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(<span class="dv">1</span> <span class="sc">-</span> alpha <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">*</span> SE <span class="sc">+</span> fits<span class="sc">$</span>ex</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>  fits<span class="sc">$</span>lo <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(alpha <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">*</span> SE <span class="sc">+</span> fits<span class="sc">$</span>ex</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(fits)</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>mod_fit <span class="ot">&lt;-</span> <span class="fu">getDFAfits</span>(dfa_TPseas)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in sqrt(VV): NaNs produced</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(N.ts, <span class="dv">1</span>), <span class="at">mai =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>), <span class="at">omi =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N.ts) {</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  up <span class="ot">&lt;-</span> mod_fit<span class="sc">$</span>up[i,]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  mn <span class="ot">&lt;-</span> mod_fit<span class="sc">$</span>ex[i,]</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  lo <span class="ot">&lt;-</span> mod_fit<span class="sc">$</span>lo[i,]</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(w_ts, mn, <span class="at">type =</span> <span class="st">"n"</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> ylbl[i],</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">cex.lab =</span> <span class="fl">1.2</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(lo, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="fu">max</span>(up, <span class="at">na.rm=</span><span class="cn">TRUE</span>)))</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">1</span>, <span class="dv">12</span> <span class="sc">*</span> (<span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(plank.t)[<span class="dv">2</span>]) <span class="sc">+</span> <span class="dv">1</span>, yr_frst <span class="sc">+</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(plank.t)[<span class="dv">2</span>])</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(w_ts, plank.t[i,], <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> clr[i])</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, up, <span class="at">col =</span> <span class="st">"darkgray"</span>)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, mn, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, lo, <span class="at">col =</span> <span class="st">"darkgray"</span>)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Table of AICc for all fitted models</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">cbind</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"no covars"</span>, <span class="st">"Temp"</span>, <span class="st">"TP"</span>, <span class="st">"Temp &amp; TP"</span>, <span class="st">"TP Seas"</span>, <span class="st">"TP &amp; temp &amp; Seas"</span>),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">AICc =</span> <span class="fu">round</span>(<span class="fu">c</span>(dfa.fit3<span class="sc">$</span>AICc,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                           dfa_temp<span class="sc">$</span>AICc,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>                           dfa_TP<span class="sc">$</span>AICc,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>                           dfa_both<span class="sc">$</span>AICc,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>                           dfa_TPseas<span class="sc">$</span>AICc,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>                           dfa_TPtempseas<span class="sc">$</span>AICc))),</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">quote =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     model            AICc
[1,] no covars        4698
[2,] Temp             4459
[3,] TP               4572
[4,] Temp &amp; TP        4438
[5,] TP Seas          4337
[6,] TP &amp; temp &amp; Seas 4341</code></pre>
</div>
</div>
<p>Both fits look similar, suggesting that temperature has little affect on the model when seasonality and TP are included. Since temperature and season are highly correlated (temperature changes with seasons), it makes sense that the most parimonious model only needs one of these two covariates.</p>
<p>Check the residuals of our favorite model:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(dfa_TPseas, <span class="at">plot.type=</span><span class="st">'acf.std.model.resids.ytt1'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MARSSresiduals.tt1 reported warnings. See msg element of returned residuals object.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The ACFs of the residuals don’t look amazing.</p>
<p>Let’s look at the overall fit of the model:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>mm <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="do">## plot the processes</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>mm) {</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  ylm <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(trends.rot[i,]))</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up plot area</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(w_ts,trends.rot[i,], <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">bty =</span> <span class="st">"L"</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">ylim =</span> ylm, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">xaxt =</span> <span class="st">"n"</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## draw zero-line</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"gray"</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## plot trend line</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, trends.rot[i,], <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, trends.rot[i,], <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add panel labels</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mtext</span>(<span class="fu">paste</span>(<span class="st">"State"</span>,i), <span class="at">side =</span> <span class="dv">3</span>, <span class="at">line =</span> <span class="fl">0.5</span>)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">1</span>, <span class="dv">12</span> <span class="sc">*</span> (<span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(plank.t)[<span class="dv">2</span>]) <span class="sc">+</span> <span class="dv">1</span>, yr_frst <span class="sc">+</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(plank.t)[<span class="dv">2</span>])</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-10-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-10-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-10-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>State 1 has two big dips: ~1974 and ~1988. The first may be related to the decrease in TP in the lake. State 2 shows some seasonal pattern ~6 years and a steady increase starting in 1978. State 3 is relatively steady over time with possible seasonality. State 4 decreases until about 1977 and then rebounds and remains stable, with possible seasonal patterns.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>spp <span class="ot">&lt;-</span> <span class="fu">rownames</span>(plank.t)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>minZ <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">dim</span>(trends.rot)[<span class="dv">1</span>]</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>ylims <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.1</span> <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(Z.rot)), <span class="fl">1.1</span> <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(Z.rot)))</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="fu">ceiling</span>(m <span class="sc">/</span> <span class="dv">2</span>), <span class="dv">2</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="fl">1.5</span>, <span class="fl">0.5</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N.ts)[<span class="fu">abs</span>(Z.rot[, i]) <span class="sc">&gt;</span> minZ], <span class="fu">as.vector</span>(Z.rot[<span class="fu">abs</span>(Z.rot[, i]) <span class="sc">&gt;</span> minZ, i]),</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">type =</span> <span class="st">"h"</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">ylim =</span> ylims, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, N.ts <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N.ts) {</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (Z.rot[j, i] <span class="sc">&gt;</span> minZ) {</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">text</span>(j, <span class="sc">-</span><span class="fl">0.05</span>, spp[j], <span class="at">srt =</span> <span class="dv">90</span>, <span class="at">adj =</span> <span class="dv">1</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (Z.rot[j, i] <span class="sc">&lt;</span> <span class="sc">-</span>minZ) {</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">text</span>(j, <span class="fl">0.05</span>, spp[j], <span class="at">srt =</span> <span class="dv">90</span>, <span class="at">adj =</span> <span class="dv">0</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">col =</span> clr[i])</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  } <span class="co"># end j loop</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mtext</span>(<span class="fu">paste</span>(<span class="st">"Factor loadings on trend"</span>, i, <span class="at">sep =</span> <span class="st">" "</span>), <span class="at">side =</span> <span class="dv">3</span>, <span class="at">line =</span> .<span class="dv">5</span>)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>} </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>All taxa are positively associated with state 1. Unicells, algae and rotifers have a positive association with state 2. Cyclops has a strong positive loading on state 3, with weaker loadings from unicells, algae, and rotifers. Diaptomus has the strongest positive loading on state 4, with weak loadings from unicells, algae, and cyclops. The phytoplankton have loadings on all states, suggesting that we did not quite capture their trends effectively with our model. The strongest associations were for the copepods Diaptomus and Cyclops, suggesting that our model does a decent job of capturing their population dynamics.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the fits</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">1</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="fl">1.5</span>, <span class="fl">0.5</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N.ts) {</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  up <span class="ot">&lt;-</span> mod_fit<span class="sc">$</span>up[i, ]</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  mn <span class="ot">&lt;-</span> mod_fit<span class="sc">$</span>ex[i, ]</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  lo <span class="ot">&lt;-</span> mod_fit<span class="sc">$</span>lo[i, ]</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(w_ts, mn,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> ylbl[i], <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">cex.lab =</span> <span class="fl">1.2</span>,</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(lo, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="fu">max</span>(up, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">1</span>, <span class="dv">12</span> <span class="sc">*</span> (<span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(plank.t)[<span class="dv">2</span>]) <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">1980</span> <span class="sc">+</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(plank.t)[<span class="dv">2</span>])</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(w_ts, plank.t[i, ], <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> clr[i])</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, up, <span class="at">col =</span> <span class="st">"darkgray"</span>)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, mn, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, lo, <span class="at">col =</span> <span class="st">"darkgray"</span>)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="what-happens-if-we-try-to-fit-a-similar-model-after-the-period-of-high-tp-in-lake-washington" class="level2">
<h2 class="anchored" data-anchor-id="what-happens-if-we-try-to-fit-a-similar-model-after-the-period-of-high-tp-in-lake-washington">What happens if we try to fit a similar model after the period of high TP in Lake Washington?</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">#prepare the new dataset</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>all_dat2 <span class="ot">&lt;-</span> lakeWAplanktonRaw</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.ts</span>(all_dat2[,<span class="dv">4</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>TP.sub<span class="ot">&lt;-</span><span class="fu">subset</span>(all_dat2, <span class="at">select=</span><span class="fu">c</span>(<span class="st">"Year"</span>, <span class="st">"TP"</span>), all_dat[,<span class="dv">1</span>]<span class="sc">&lt;</span><span class="dv">1991</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>TP.sub<span class="ot">&lt;-</span><span class="fu">subset</span>(all_dat2, <span class="at">select=</span><span class="fu">c</span>(<span class="st">"Year"</span>, <span class="st">"TP"</span>), all_dat[,<span class="dv">1</span>]<span class="sc">&gt;</span><span class="dv">1979</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>TP.sub[,<span class="dv">1</span>], <span class="at">y=</span>TP.sub[,<span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-13-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>plank<span class="fl">.10</span>yr<span class="ot">&lt;-</span><span class="fu">subset</span>(all_dat2, <span class="at">select=</span><span class="fu">c</span>(<span class="st">"Year"</span>, <span class="st">'Unicells'</span>, <span class="st">'Other.algae'</span>, <span class="st">'Cyclops'</span>, <span class="st">'Diaptomus'</span>, <span class="st">'Non.colonial.rotifers'</span>), all_dat[,<span class="dv">1</span>]<span class="sc">&lt;</span><span class="dv">1991</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>plank<span class="fl">.10</span>yr<span class="ot">&lt;-</span><span class="fu">subset</span>(all_dat2, <span class="at">select=</span><span class="fu">c</span>(<span class="st">"Year"</span>, <span class="st">'Unicells'</span>, <span class="st">'Other.algae'</span>, <span class="st">'Cyclops'</span>, <span class="st">'Diaptomus'</span>, <span class="st">'Non.colonial.rotifers'</span>), all_dat[,<span class="dv">1</span>]<span class="sc">&gt;</span><span class="dv">1979</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co">#transpose data</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>plank.t10<span class="ot">&lt;-</span><span class="fu">t</span>(plank<span class="fl">.10</span>yr)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>year.cols<span class="ot">&lt;-</span>plank.t10[<span class="dv">1</span>,]</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>plank.t10<span class="ot">&lt;-</span>plank.t10[<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>,]</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(plank.t10)<span class="ot">&lt;-</span>year.cols</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>N.ts<span class="ot">&lt;-</span><span class="fu">nrow</span>(plank.t10)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>TT<span class="ot">&lt;-</span><span class="fu">ncol</span>(plank.t10)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="co"># re-do z-score</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>dat.z<span class="ot">&lt;-</span><span class="fu">zscore</span>(plank.t10)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>temp<span class="fl">.10</span>yr <span class="ot">&lt;-</span> <span class="fu">t</span>(all_dat2[<span class="dv">1</span><span class="sc">:</span><span class="dv">180</span>,<span class="st">"Temp"</span>, <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>TP<span class="fl">.10</span>yr <span class="ot">&lt;-</span> <span class="fu">t</span>(all_dat2[<span class="dv">1</span><span class="sc">:</span><span class="dv">180</span>,<span class="st">"TP"</span>, <span class="at">drop =</span> T])</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>temp.z<span class="ot">&lt;-</span><span class="fu">zscore</span>(temp<span class="fl">.10</span>yr)</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>TP.z<span class="ot">&lt;-</span><span class="fu">zscore</span>(TP<span class="fl">.10</span>yr)</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a><span class="co">#replace NA with 0 in TP.z</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>TP.z[<span class="fu">is.na</span>(TP.z)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>cos_t <span class="ot">&lt;-</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">seq</span>(TT) <span class="sc">/</span> <span class="dv">12</span>)</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>sin_t <span class="ot">&lt;-</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">seq</span>(TT) <span class="sc">/</span> <span class="dv">12</span>)</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>dd<span class="fl">.10</span> <span class="ot">&lt;-</span> <span class="fu">rbind</span>(cos_t, sin_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>When we looked at 4 hidden trends for our data subset, the 4th trend was just a straight horizontal line, so we moved forward with 3 hidden trends. TP + seasons had a lower AICc than temperature alone.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>mod_list <span class="ot">=</span> <span class="fu">list</span>(<span class="at">m =</span> <span class="dv">3</span>, <span class="at">R =</span> <span class="st">"diagonal and unequal"</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>dfa_TPseas<span class="fl">.10</span> <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(plank.t10, <span class="at">model =</span> mod_list, <span class="at">form =</span> <span class="st">"dfa"</span>, <span class="at">z.score =</span> <span class="cn">TRUE</span>,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">control=</span>cntl.list, <span class="at">covariates =</span> <span class="fu">rbind</span>(TP.z,dd<span class="fl">.10</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>,<span class="at">method =</span> <span class="st">"BFGS"</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co">#mod_fit.TPseas.10 &lt;- getDFAfits(dfa_TPseas.10)</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(dfa_TPseas<span class="fl">.10</span>, <span class="at">plot.type=</span><span class="st">'acf.std.model.resids.ytt1'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>w_ts_10 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">dim</span>(plank.t10)[<span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The data do not look well represented by this model.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>Z_est<span class="fl">.10</span> <span class="ot">&lt;-</span> <span class="fu">coef</span>(dfa_TPseas<span class="fl">.10</span>, <span class="at">type =</span> <span class="st">"matrix"</span>)<span class="sc">$</span>Z</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>H_inv<span class="fl">.10</span> <span class="ot">&lt;-</span> <span class="fu">varimax</span>(Z_est<span class="fl">.10</span>)<span class="sc">$</span>rotmat</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># rotate factor loadings</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>Z.rot<span class="fl">.10</span> <span class="ot">=</span> Z_est<span class="fl">.10</span> <span class="sc">%*%</span> H_inv<span class="fl">.10</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>trends.rot<span class="fl">.10</span> <span class="ot">=</span> <span class="fu">solve</span>(H_inv<span class="fl">.10</span>) <span class="sc">%*%</span> dfa_TPseas<span class="fl">.10</span><span class="sc">$</span>states</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>m10 <span class="ot">&lt;-</span> <span class="fu">dim</span>(trends.rot<span class="fl">.10</span>)[<span class="dv">1</span>]</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>ylims <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.1</span> <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(Z.rot<span class="fl">.10</span>), <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="fl">1.1</span> <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(Z.rot<span class="fl">.10</span>), <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="fu">ceiling</span>(m10 <span class="sc">/</span> <span class="dv">2</span>), <span class="dv">2</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="fl">1.5</span>, <span class="fl">0.5</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m10) {</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N.ts)[<span class="fu">abs</span>(Z.rot<span class="fl">.10</span>[, i]) <span class="sc">&gt;</span> minZ], <span class="fu">as.vector</span>(Z.rot<span class="fl">.10</span>[<span class="fu">abs</span>(Z.rot<span class="fl">.10</span>[, i]) <span class="sc">&gt;</span> minZ, i]),</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">type =</span> <span class="st">"h"</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">ylim =</span> ylims, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, N.ts <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N.ts) {</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (Z.rot<span class="fl">.10</span>[j, i] <span class="sc">&gt;</span> minZ) {</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">text</span>(j, <span class="sc">-</span><span class="fl">0.05</span>, spp[j], <span class="at">srt =</span> <span class="dv">90</span>, <span class="at">adj =</span> <span class="dv">1</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (Z.rot<span class="fl">.10</span>[j, i] <span class="sc">&lt;</span> <span class="sc">-</span>minZ) {</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">text</span>(j, <span class="fl">0.05</span>, spp[j], <span class="at">srt =</span> <span class="dv">90</span>, <span class="at">adj =</span> <span class="dv">0</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">col =</span> clr[i])</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  } <span class="co"># end j loop</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mtext</span>(<span class="fu">paste</span>(<span class="st">"Factor loadings on trend"</span>, i, <span class="at">sep =</span> <span class="st">" "</span>), <span class="at">side =</span> <span class="dv">3</span>, <span class="at">line =</span> .<span class="dv">5</span>)</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>mm<span class="ot">&lt;-</span><span class="dv">3</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>mm) {</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  ylm <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(trends.rot<span class="fl">.10</span>[i,]), <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up plot area</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(w_ts_10,trends.rot<span class="fl">.10</span>[i,], <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">bty =</span> <span class="st">"L"</span>,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">ylim =</span> ylm, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">xaxt =</span> <span class="st">"n"</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="do">## draw zero-line</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"gray"</span>)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="do">## plot trend line</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts_10, trends.rot<span class="fl">.10</span>[i,], <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts_10, trends.rot<span class="fl">.10</span>[i,], <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add panel labels</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mtext</span>(<span class="fu">paste</span>(<span class="st">"State"</span>,i), <span class="at">side =</span> <span class="dv">3</span>, <span class="at">line =</span> <span class="fl">0.5</span>)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">1</span>, <span class="dv">12</span> <span class="sc">*</span> (<span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(plank.t10)[<span class="dv">2</span>]) <span class="sc">+</span> <span class="dv">1</span>, yr_frst <span class="sc">+</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(plank.t10)[<span class="dv">2</span>])</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-17-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-4_final_files/figure-html/unnamed-chunk-17-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="discussion" class="level1">
<h1>Discussion</h1>
<p>We chose to first analyze data from the full time series with the assumption that more data would yield stronger associations between covariates and plankton abundance. We first determined the optimal number of states by fitting multiple models, each with different numbers of states. The models were then compared via AICc to determine what number of states best fit the time series.</p>
<p>The best fitting model had 4 hidden states over the full period of time; there were no other competing models based on delta AICc. Since we have just 5 ts and 4 hidden trends (our m is close to our n) we should probably reconsider the data we are monitoring!</p>
<p>We then chose covariates (TP and temperature) and compared models with different combinations of temperature, total phosphorus, a combination of temperature and total phosphorus, dummy sine and cosine waves to simulate seasonality, and total phosphorus combined with seasonality. We did not fit a model with temperature and seasonality, as it was assumed that these two variables would be highly correlated, and thus shouldn’t be modeled together as their effects would not be distinguishable.</p>
<p>A model with total phosphorus combined with seasonality was the best fit according to delta AICc.</p>
<p>However, the model fits do not appear to fit the data well when plotted. This perhaps indicates that across the entire time series, there is no model that performs well over all areas. We created a subset of the time series (~ 10 years) and followed a similar workflow.</p>
<p>We chose a time period for the shorter time series when raw sewage was no longer being pumped into the lake, therefore TP was lower overall (with some seasonal variance) and there was less eutrophication. We hypothesized that this state would better reveal the “true”, biological links between the plankton taxa. We found that it is likely that TP and seasonality/temperature are still strong regulating factors of plankton dynamics, however our model was not a great fit.</p>
<p>Neither one of our models fit the data very well. This may be because 1) we are missing important covariates that strongly influence plankton dynamics; 2) phytoplankton and zooplankton in the lake are not strongly influencing each other and should not be modeled with the same methods; or 3) similar to (2), we chose the wrong plankton taxa to include in a model. It would be best to consult freshwater plankton ecologists to determine which species are strongly associated with each other and which covariates are the most important in determine their abundances.</p>
</section>
<section id="team-contributions" class="level1">
<h1>Team contributions</h1>
<p>ETS explored the data to find usable parts for the analysis; she also did the first attempt at fitting a DFA with different trends. MM refined the DFA and added analyses for assessing model fit and covariates. MM and KV discussed covariates and seasonal effects on the model. ETS selected the subset of data to analyze and applied the previous code developed by all team members to the new subset of the data. ETS drafted the final lab report with very minor changes from MM. Code was de-bugged and the lab report was finalized by all.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/atsa-es\.github\.io\/fish550-2023\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="atsa-es/fish550-2023" data-repo-id="R_kgDOJGNymQ" data-category="General" data-category-id="DIC_kwDOJGNymc4CUsbe" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../Lab-3/Final_Write_ups/Lab-3-team-3_final.html" class="pagination-link" aria-label="Team 3 - Lab 3">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Team 3 - Lab 3</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../Lab-4/Lab-4-HMM.html" class="pagination-link" aria-label="Lab Intro">
        <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Lab Intro</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb41" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Team 4 - Lab 3"</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Dynamic Factor Analysis (DFA)"</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Miranda Mudge, Karl Veggerby, Emma Timmins-Schiffman"</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> April 20, 2023</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="an">output:</span><span class="co"> </span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html_document:</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-folding: true</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co">    toc_float: true</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include = FALSE}</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="in">options(dplyr.summarise.inform = FALSE)</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>***</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="fu"># Data</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>We chose to use the plankton groups that had the most complete datasets over the course of the time series. This included the zooplankton Cyclops, Diaptomus, and Non-colonial rotifers. The phytoplankton groups were unicells and other algae. Of course, this approach excluded many other groups which might have been resulted in better model fits, or more suitable data for our hypothesis. We chose temperature and TP as our covariates since they both have a strong influence on phytoplankton and temperature has an influence on zooplankton. We created a seasonality dummy variable.</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a><span class="fu"># Methods</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="fu">## Load the data</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load_data}</span></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a><span class="in">## load MARSS for data and analyses</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a><span class="in">library(MARSS)</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a><span class="in">## load the raw data (there are 3 datasets contained here)</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a><span class="in">data(lakeWAplankton, package = "MARSS")</span></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a><span class="in">## we want `lakeWAplanktonTrans`, which has been transformed</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a><span class="in">## so the 0's are replaced with NA's and the data z-scored</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a><span class="in">all_dat &lt;- lakeWAplanktonTrans</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a><span class="fu">## Wrangle the data</span></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>We chose taxa that had mostly complete data for the entire time series. We wanted to investigate possible links between fluctuations in phytoplankton and impacts on zooplankton grazers, so we only included zooplankton that graze on phytoplankton. Later, we investigated if the models fit the data better for a shorter time series with a stronger apparent seasonal signal (1962-1972).</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a><span class="in">```{r wrangle_data}</span></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a><span class="in">## assign colors for plotting</span></span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a><span class="in">clr &lt;- c("red", "orange",  "green", "blue", "purple")</span></span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a><span class="in">#subset data to taxa of interest and pH, temp, and TP</span></span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a><span class="in">plank.for.DFA&lt;-subset(all_dat, select=c("Year", 'Unicells', 'Other.algae', 'Cyclops', 'Diaptomus', 'Non.colonial.rotifers'))</span></span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a><span class="in">#transpose data</span></span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a><span class="in">plank.t&lt;-t(plank.for.DFA)</span></span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a><span class="in">year.cols&lt;-plank.t[1,]</span></span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a><span class="in">plank.t&lt;-plank.t[2:6,]</span></span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a><span class="in">colnames(plank.t)&lt;-year.cols</span></span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a><span class="in">N.ts&lt;-nrow(plank.t)</span></span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a><span class="in">TT&lt;-ncol(plank.t)</span></span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a><span class="in">yr_frst &lt;- 1962</span></span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fitting a Model</span></span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a>We have 5 time series and will start with assuming 3 hidden trends. We assume that there are different observation errors for the different plankton given differences in size and feeding behavior.</span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a>The Z matrix can be seen in the code below. </span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a><span class="co">#set matrices for the DFA model</span></span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a>Z.vals<span class="ot">&lt;-</span><span class="fu">list</span>(</span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a>  <span class="st">"z11"</span>, <span class="dv">0</span>, <span class="dv">0</span>,</span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a>  <span class="st">"z21"</span>, <span class="st">"z22"</span>, <span class="dv">0</span>,</span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a>  <span class="st">"z31"</span>, <span class="st">"z32"</span>, <span class="st">"z33"</span>,</span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a>  <span class="st">"z41"</span>, <span class="st">"z42"</span>, <span class="st">"z43"</span>,</span>
<span id="cb41-74"><a href="#cb41-74" aria-hidden="true" tabindex="-1"></a>  <span class="st">"z51"</span>, <span class="st">"z52"</span>, <span class="st">"z53"</span></span>
<span id="cb41-75"><a href="#cb41-75" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-76"><a href="#cb41-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-77"><a href="#cb41-77" aria-hidden="true" tabindex="-1"></a>Z<span class="ot">&lt;-</span><span class="fu">matrix</span>(Z.vals, <span class="at">nrow=</span>N.ts, <span class="at">ncol=</span><span class="dv">3</span>, <span class="at">byrow=</span>T)</span>
<span id="cb41-78"><a href="#cb41-78" aria-hidden="true" tabindex="-1"></a>Z</span>
<span id="cb41-79"><a href="#cb41-79" aria-hidden="true" tabindex="-1"></a><span class="co">#Q and B are equal to identity matrix</span></span>
<span id="cb41-80"><a href="#cb41-80" aria-hidden="true" tabindex="-1"></a>Q<span class="ot">&lt;-</span>B<span class="ot">&lt;-</span><span class="fu">diag</span>(<span class="dv">1</span>,<span class="dv">3</span>)</span>
<span id="cb41-81"><a href="#cb41-81" aria-hidden="true" tabindex="-1"></a>Q </span>
<span id="cb41-82"><a href="#cb41-82" aria-hidden="true" tabindex="-1"></a>B</span>
<span id="cb41-83"><a href="#cb41-83" aria-hidden="true" tabindex="-1"></a>R<span class="ot">&lt;-</span><span class="st">"diagonal and unequal"</span></span>
<span id="cb41-84"><a href="#cb41-84" aria-hidden="true" tabindex="-1"></a>x0<span class="ot">&lt;-</span>U<span class="ot">&lt;-</span>A<span class="ot">&lt;-</span><span class="st">"zero"</span></span>
<span id="cb41-85"><a href="#cb41-85" aria-hidden="true" tabindex="-1"></a>V0<span class="ot">&lt;-</span><span class="fu">diag</span>(<span class="dv">5</span>,<span class="dv">3</span>)</span>
<span id="cb41-86"><a href="#cb41-86" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-87"><a href="#cb41-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-88"><a href="#cb41-88" aria-hidden="true" tabindex="-1"></a>Here is the model for 3 hidden trends:</span>
<span id="cb41-89"><a href="#cb41-89" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache = TRUE}</span></span>
<span id="cb41-90"><a href="#cb41-90" aria-hidden="true" tabindex="-1"></a><span class="in">dfa.model1&lt;-list(Z=Z, A="zero", R=R, B=B, U=U, Q=Q, x0=x0, V0=V0)</span></span>
<span id="cb41-91"><a href="#cb41-91" aria-hidden="true" tabindex="-1"></a><span class="in">cntl.list&lt;-list(maxit=3000)</span></span>
<span id="cb41-92"><a href="#cb41-92" aria-hidden="true" tabindex="-1"></a><span class="in">dfa.fit1&lt;-MARSS(plank.t, model=dfa.model1, control=cntl.list, silent = TRUE,method = "BFGS")</span></span>
<span id="cb41-93"><a href="#cb41-93" aria-hidden="true" tabindex="-1"></a><span class="in">autoplot(dfa.fit1, plot.type='acf.std.model.resids.ytt1')</span></span>
<span id="cb41-94"><a href="#cb41-94" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-95"><a href="#cb41-95" aria-hidden="true" tabindex="-1"></a>This model has a lot of autocorrelation in the residuals.</span>
<span id="cb41-96"><a href="#cb41-96" aria-hidden="true" tabindex="-1"></a>We tried the same model with 2 or 4 underlying trends.</span>
<span id="cb41-97"><a href="#cb41-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-98"><a href="#cb41-98" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache = TRUE}</span></span>
<span id="cb41-99"><a href="#cb41-99" aria-hidden="true" tabindex="-1"></a><span class="in">#2 trends</span></span>
<span id="cb41-100"><a href="#cb41-100" aria-hidden="true" tabindex="-1"></a><span class="in">model.list&lt;-list(m=2, R="diagonal and unequal")</span></span>
<span id="cb41-101"><a href="#cb41-101" aria-hidden="true" tabindex="-1"></a><span class="in">dfa.fit2&lt;-MARSS(plank.t, model=model.list, z.score=T, form='dfa', control=cntl.list, silent = TRUE, method = "BFGS")</span></span>
<span id="cb41-102"><a href="#cb41-102" aria-hidden="true" tabindex="-1"></a><span class="in">autoplot(dfa.fit2, plot.type='acf.std.model.resids.ytt1')</span></span>
<span id="cb41-103"><a href="#cb41-103" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-104"><a href="#cb41-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-105"><a href="#cb41-105" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache = TRUE}</span></span>
<span id="cb41-106"><a href="#cb41-106" aria-hidden="true" tabindex="-1"></a><span class="in">#4 trends</span></span>
<span id="cb41-107"><a href="#cb41-107" aria-hidden="true" tabindex="-1"></a><span class="in">model.list&lt;-list(m=4, R="diagonal and unequal")</span></span>
<span id="cb41-108"><a href="#cb41-108" aria-hidden="true" tabindex="-1"></a><span class="in">dfa.fit3&lt;-MARSS(plank.t, model=model.list, z.score=T, form='dfa', control=cntl.list, silent = TRUE,method = "BFGS")</span></span>
<span id="cb41-109"><a href="#cb41-109" aria-hidden="true" tabindex="-1"></a><span class="in">autoplot(dfa.fit3, plot.type='acf.std.model.resids.ytt1')</span></span>
<span id="cb41-110"><a href="#cb41-110" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-111"><a href="#cb41-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-112"><a href="#cb41-112" aria-hidden="true" tabindex="-1"></a>Compare the AICc of the 3 options for underlying trends. The model with 4 hidden trends has the lowest AICc.</span>
<span id="cb41-115"><a href="#cb41-115" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-116"><a href="#cb41-116" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">cbind</span>(<span class="at">model=</span><span class="fu">c</span>(<span class="st">"3 trends"</span>, <span class="st">"2 trends"</span>, <span class="st">"4 trends"</span>), <span class="at">AICc=</span><span class="fu">round</span>(<span class="fu">c</span>(dfa.fit1<span class="sc">$</span>AICc, dfa.fit2<span class="sc">$</span>AICc, dfa.fit3<span class="sc">$</span>AICc))), <span class="at">quote=</span>F)</span>
<span id="cb41-117"><a href="#cb41-117" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-118"><a href="#cb41-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-119"><a href="#cb41-119" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adding covariates to the model</span></span>
<span id="cb41-120"><a href="#cb41-120" aria-hidden="true" tabindex="-1"></a>We will start with the assumption that our best model with have 4 hidden trends. We hypothesize that zooplankton will respond to fluctuations in the population of phytoplankton and that both plankton groups will respond strongly to temperature - a main driver of biological response in the ocean - and phytoplankton will respond strongly to changes in total phosphorus since increased TP typically causes phytoplankton growth.</span>
<span id="cb41-121"><a href="#cb41-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-122"><a href="#cb41-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-123"><a href="#cb41-123" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dfa_temp, cache = TRUE}</span></span>
<span id="cb41-124"><a href="#cb41-124" aria-hidden="true" tabindex="-1"></a><span class="in">#set up covariates and compare models with different combinations of covariates</span></span>
<span id="cb41-125"><a href="#cb41-125" aria-hidden="true" tabindex="-1"></a><span class="in">temp &lt;- t(all_dat[,"Temp", drop = FALSE])</span></span>
<span id="cb41-126"><a href="#cb41-126" aria-hidden="true" tabindex="-1"></a><span class="in">TP &lt;- t(all_dat[,"TP", drop = FALSE])</span></span>
<span id="cb41-127"><a href="#cb41-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-128"><a href="#cb41-128" aria-hidden="true" tabindex="-1"></a><span class="in">mod_list = list(m = 4, R = "diagonal and unequal")</span></span>
<span id="cb41-129"><a href="#cb41-129" aria-hidden="true" tabindex="-1"></a><span class="in">dfa_temp &lt;- MARSS(plank.t, model = mod_list, form = "dfa", z.score = FALSE,</span></span>
<span id="cb41-130"><a href="#cb41-130" aria-hidden="true" tabindex="-1"></a><span class="in">                  control=cntl.list, covariates = temp, silent = TRUE,method = "BFGS")</span></span>
<span id="cb41-131"><a href="#cb41-131" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-132"><a href="#cb41-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-133"><a href="#cb41-133" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dfa_TP, cache = TRUE}</span></span>
<span id="cb41-134"><a href="#cb41-134" aria-hidden="true" tabindex="-1"></a><span class="in">dfa_TP &lt;- MARSS(plank.t, model = mod_list, form = "dfa", z.score = FALSE,</span></span>
<span id="cb41-135"><a href="#cb41-135" aria-hidden="true" tabindex="-1"></a><span class="in">                control=cntl.list, covariates = TP, silent = TRUE,method = "BFGS")</span></span>
<span id="cb41-136"><a href="#cb41-136" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-137"><a href="#cb41-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-138"><a href="#cb41-138" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dfa_both, cache = TRUE}</span></span>
<span id="cb41-139"><a href="#cb41-139" aria-hidden="true" tabindex="-1"></a><span class="in">dfa_both &lt;- MARSS(plank.t, model = mod_list, form = "dfa", z.score = FALSE,</span></span>
<span id="cb41-140"><a href="#cb41-140" aria-hidden="true" tabindex="-1"></a><span class="in">                  control=cntl.list, covariates = rbind(temp, TP), silent = TRUE,method = "BFGS")</span></span>
<span id="cb41-141"><a href="#cb41-141" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-142"><a href="#cb41-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-143"><a href="#cb41-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-146"><a href="#cb41-146" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-147"><a href="#cb41-147" aria-hidden="true" tabindex="-1"></a>dfa_AICc <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"no covars"</span>, <span class="st">"Temp"</span>, <span class="st">"TP"</span>, <span class="st">"Temp &amp; TP"</span>),</span>
<span id="cb41-148"><a href="#cb41-148" aria-hidden="true" tabindex="-1"></a>            <span class="at">AICc =</span> <span class="fu">round</span>(<span class="fu">c</span>(dfa.fit3<span class="sc">$</span>AICc,</span>
<span id="cb41-149"><a href="#cb41-149" aria-hidden="true" tabindex="-1"></a>                           dfa_temp<span class="sc">$</span>AICc,</span>
<span id="cb41-150"><a href="#cb41-150" aria-hidden="true" tabindex="-1"></a>                           dfa_TP<span class="sc">$</span>AICc,</span>
<span id="cb41-151"><a href="#cb41-151" aria-hidden="true" tabindex="-1"></a>                           dfa_both<span class="sc">$</span>AICc)))</span>
<span id="cb41-152"><a href="#cb41-152" aria-hidden="true" tabindex="-1"></a>dfa_AICc</span>
<span id="cb41-153"><a href="#cb41-153" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-154"><a href="#cb41-154" aria-hidden="true" tabindex="-1"></a>The "best" model (lowest AICc) includes both temperature and TP, supporting our hypothesis that both of these covariates drive biological response.</span>
<span id="cb41-155"><a href="#cb41-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-156"><a href="#cb41-156" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adding seasonality to the model</span></span>
<span id="cb41-157"><a href="#cb41-157" aria-hidden="true" tabindex="-1"></a>Seasonal influences likely affect the plankton community as well. We create a dummy model for the seasonal influence to test its impact on model fit. We are not including all iterations here, but we tested seasons alone, seasons + TP, seasons + temperature, and seasons + temp + TP. The models that included seasons + TP and seasons + TP + temperature had the lowest and similar AICc (less than 10 units apart).</span>
<span id="cb41-158"><a href="#cb41-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-159"><a href="#cb41-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-160"><a href="#cb41-160" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dfa_TPseas, warning=FALSE, cache = TRUE}</span></span>
<span id="cb41-161"><a href="#cb41-161" aria-hidden="true" tabindex="-1"></a><span class="in">cos_t &lt;- cos(2 * pi * seq(TT) / 12)</span></span>
<span id="cb41-162"><a href="#cb41-162" aria-hidden="true" tabindex="-1"></a><span class="in">sin_t &lt;- sin(2 * pi * seq(TT) / 12)</span></span>
<span id="cb41-163"><a href="#cb41-163" aria-hidden="true" tabindex="-1"></a><span class="in">dd &lt;- rbind(cos_t, sin_t)</span></span>
<span id="cb41-164"><a href="#cb41-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-165"><a href="#cb41-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-166"><a href="#cb41-166" aria-hidden="true" tabindex="-1"></a><span class="in">## fit model</span></span>
<span id="cb41-167"><a href="#cb41-167" aria-hidden="true" tabindex="-1"></a><span class="in">dfa_TPseas &lt;- MARSS(plank.t, model = mod_list, form = "dfa", z.score = FALSE,</span></span>
<span id="cb41-168"><a href="#cb41-168" aria-hidden="true" tabindex="-1"></a><span class="in">                  control=cntl.list, covariates = rbind(TP, dd), silent = TRUE,method = "BFGS")</span></span>
<span id="cb41-169"><a href="#cb41-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-170"><a href="#cb41-170" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-171"><a href="#cb41-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-172"><a href="#cb41-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-173"><a href="#cb41-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-174"><a href="#cb41-174" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dfa_TPtempseas, warning=FALSE, cache = TRUE}</span></span>
<span id="cb41-175"><a href="#cb41-175" aria-hidden="true" tabindex="-1"></a><span class="in">dfa_TPtempseas &lt;- MARSS(plank.t, model = mod_list, form = "dfa", z.score = FALSE,</span></span>
<span id="cb41-176"><a href="#cb41-176" aria-hidden="true" tabindex="-1"></a><span class="in">                    control=cntl.list, covariates = rbind(temp,TP, dd), silent = TRUE,method = "BFGS")</span></span>
<span id="cb41-177"><a href="#cb41-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-178"><a href="#cb41-178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-179"><a href="#cb41-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-180"><a href="#cb41-180" aria-hidden="true" tabindex="-1"></a><span class="fu"># Results</span></span>
<span id="cb41-181"><a href="#cb41-181" aria-hidden="true" tabindex="-1"></a>Plot of the model fits for each of the seasonal models:</span>
<span id="cb41-184"><a href="#cb41-184" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-185"><a href="#cb41-185" aria-hidden="true" tabindex="-1"></a><span class="co"># get estimated ZZ</span></span>
<span id="cb41-186"><a href="#cb41-186" aria-hidden="true" tabindex="-1"></a>Z_est <span class="ot">&lt;-</span> <span class="fu">coef</span>(dfa_TPseas, <span class="at">type =</span> <span class="st">"matrix"</span>)<span class="sc">$</span>Z</span>
<span id="cb41-187"><a href="#cb41-187" aria-hidden="true" tabindex="-1"></a>H_inv <span class="ot">&lt;-</span> <span class="fu">varimax</span>(Z_est)<span class="sc">$</span>rotmat</span>
<span id="cb41-188"><a href="#cb41-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-189"><a href="#cb41-189" aria-hidden="true" tabindex="-1"></a><span class="co"># rotate factor loadings</span></span>
<span id="cb41-190"><a href="#cb41-190" aria-hidden="true" tabindex="-1"></a>Z.rot <span class="ot">=</span> Z_est <span class="sc">%*%</span> H_inv</span>
<span id="cb41-191"><a href="#cb41-191" aria-hidden="true" tabindex="-1"></a>trends.rot <span class="ot">=</span> <span class="fu">solve</span>(H_inv) <span class="sc">%*%</span> dfa_TPseas<span class="sc">$</span>states</span>
<span id="cb41-192"><a href="#cb41-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-193"><a href="#cb41-193" aria-hidden="true" tabindex="-1"></a>w_ts <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">dim</span>(plank.t)[<span class="dv">2</span>])</span>
<span id="cb41-194"><a href="#cb41-194" aria-hidden="true" tabindex="-1"></a>ylbl <span class="ot">&lt;-</span> <span class="fu">rownames</span>(plank.t)</span>
<span id="cb41-195"><a href="#cb41-195" aria-hidden="true" tabindex="-1"></a><span class="co">#This function will return the fits and CIs if no missing values</span></span>
<span id="cb41-196"><a href="#cb41-196" aria-hidden="true" tabindex="-1"></a>getDFAfits <span class="ot">&lt;-</span> <span class="cf">function</span>(MLEobj, <span class="at">alpha =</span> <span class="fl">0.05</span>, <span class="at">dd =</span> <span class="cn">NULL</span>) { <span class="co">#dd = covariates</span></span>
<span id="cb41-197"><a href="#cb41-197" aria-hidden="true" tabindex="-1"></a>  fits <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb41-198"><a href="#cb41-198" aria-hidden="true" tabindex="-1"></a>  Ey <span class="ot">&lt;-</span> <span class="fu">MARSShatyt</span>(MLEobj) <span class="co"># for var() calcs</span></span>
<span id="cb41-199"><a href="#cb41-199" aria-hidden="true" tabindex="-1"></a>  ZZ <span class="ot">&lt;-</span> <span class="fu">coef</span>(MLEobj, <span class="at">type =</span> <span class="st">"matrix"</span>)<span class="sc">$</span>Z <span class="co"># estimated Z</span></span>
<span id="cb41-200"><a href="#cb41-200" aria-hidden="true" tabindex="-1"></a>  nn <span class="ot">&lt;-</span> <span class="fu">dim</span>(Ey<span class="sc">$</span>ytT) <span class="co"># number of obs ts</span></span>
<span id="cb41-201"><a href="#cb41-201" aria-hidden="true" tabindex="-1"></a> <span class="co"># mm &lt;- ncol(ZZ) # number of factors/states</span></span>
<span id="cb41-202"><a href="#cb41-202" aria-hidden="true" tabindex="-1"></a>  TT <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Ey<span class="sc">$</span>ytT) <span class="co"># number of time steps</span></span>
<span id="cb41-203"><a href="#cb41-203" aria-hidden="true" tabindex="-1"></a>  <span class="do">## check for covars</span></span>
<span id="cb41-204"><a href="#cb41-204" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(dd)) {</span>
<span id="cb41-205"><a href="#cb41-205" aria-hidden="true" tabindex="-1"></a>    DD <span class="ot">&lt;-</span> <span class="fu">coef</span>(MLEobj, <span class="at">type =</span> <span class="st">"matrix"</span>)<span class="sc">$</span>D</span>
<span id="cb41-206"><a href="#cb41-206" aria-hidden="true" tabindex="-1"></a>    cov_eff <span class="ot">&lt;-</span> DD <span class="sc">%*%</span> dd</span>
<span id="cb41-207"><a href="#cb41-207" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb41-208"><a href="#cb41-208" aria-hidden="true" tabindex="-1"></a>    cov_eff <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, nn, TT)</span>
<span id="cb41-209"><a href="#cb41-209" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb41-210"><a href="#cb41-210" aria-hidden="true" tabindex="-1"></a>  <span class="do">## model expectation</span></span>
<span id="cb41-211"><a href="#cb41-211" aria-hidden="true" tabindex="-1"></a>  fits<span class="sc">$</span>ex <span class="ot">&lt;-</span> ZZ <span class="sc">%*%</span> H_inv <span class="sc">%*%</span> MLEobj<span class="sc">$</span>states <span class="sc">+</span> cov_eff</span>
<span id="cb41-212"><a href="#cb41-212" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Var in model fits</span></span>
<span id="cb41-213"><a href="#cb41-213" aria-hidden="true" tabindex="-1"></a>  VtT <span class="ot">&lt;-</span> <span class="fu">MARSSkfss</span>(MLEobj)<span class="sc">$</span>VtT</span>
<span id="cb41-214"><a href="#cb41-214" aria-hidden="true" tabindex="-1"></a>  VV <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb41-215"><a href="#cb41-215" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (tt <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>TT) {</span>
<span id="cb41-216"><a href="#cb41-216" aria-hidden="true" tabindex="-1"></a>    RZVZ <span class="ot">&lt;-</span> <span class="fu">coef</span>(MLEobj, <span class="at">type =</span> <span class="st">"matrix"</span>)<span class="sc">$</span>R <span class="sc">-</span> ZZ <span class="sc">%*%</span> VtT[, , tt] <span class="sc">%*%</span> <span class="fu">t</span>(ZZ)</span>
<span id="cb41-217"><a href="#cb41-217" aria-hidden="true" tabindex="-1"></a>    SS <span class="ot">&lt;-</span> Ey<span class="sc">$</span>yxtT[, , tt] <span class="sc">-</span> Ey<span class="sc">$</span>ytT[, tt, drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">%*%</span> <span class="fu">t</span>(MLEobj<span class="sc">$</span>states[, tt, <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb41-218"><a href="#cb41-218" aria-hidden="true" tabindex="-1"></a>    VV <span class="ot">&lt;-</span> <span class="fu">cbind</span>(VV, <span class="fu">diag</span>(RZVZ <span class="sc">+</span> SS <span class="sc">%*%</span> <span class="fu">t</span>(ZZ) <span class="sc">+</span> ZZ <span class="sc">%*%</span> <span class="fu">t</span>(SS)))</span>
<span id="cb41-219"><a href="#cb41-219" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb41-220"><a href="#cb41-220" aria-hidden="true" tabindex="-1"></a>  SE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(VV)</span>
<span id="cb41-221"><a href="#cb41-221" aria-hidden="true" tabindex="-1"></a>  <span class="do">## upper &amp; lower (1-alpha)% CI</span></span>
<span id="cb41-222"><a href="#cb41-222" aria-hidden="true" tabindex="-1"></a>  fits<span class="sc">$</span>up <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(<span class="dv">1</span> <span class="sc">-</span> alpha <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">*</span> SE <span class="sc">+</span> fits<span class="sc">$</span>ex</span>
<span id="cb41-223"><a href="#cb41-223" aria-hidden="true" tabindex="-1"></a>  fits<span class="sc">$</span>lo <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(alpha <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">*</span> SE <span class="sc">+</span> fits<span class="sc">$</span>ex</span>
<span id="cb41-224"><a href="#cb41-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(fits)</span>
<span id="cb41-225"><a href="#cb41-225" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-226"><a href="#cb41-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-227"><a href="#cb41-227" aria-hidden="true" tabindex="-1"></a>mod_fit <span class="ot">&lt;-</span> <span class="fu">getDFAfits</span>(dfa_TPseas)</span>
<span id="cb41-228"><a href="#cb41-228" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(N.ts, <span class="dv">1</span>), <span class="at">mai =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>), <span class="at">omi =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb41-229"><a href="#cb41-229" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N.ts) {</span>
<span id="cb41-230"><a href="#cb41-230" aria-hidden="true" tabindex="-1"></a>  up <span class="ot">&lt;-</span> mod_fit<span class="sc">$</span>up[i,]</span>
<span id="cb41-231"><a href="#cb41-231" aria-hidden="true" tabindex="-1"></a>  mn <span class="ot">&lt;-</span> mod_fit<span class="sc">$</span>ex[i,]</span>
<span id="cb41-232"><a href="#cb41-232" aria-hidden="true" tabindex="-1"></a>  lo <span class="ot">&lt;-</span> mod_fit<span class="sc">$</span>lo[i,]</span>
<span id="cb41-233"><a href="#cb41-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(w_ts, mn, <span class="at">type =</span> <span class="st">"n"</span>,</span>
<span id="cb41-234"><a href="#cb41-234" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> ylbl[i],</span>
<span id="cb41-235"><a href="#cb41-235" aria-hidden="true" tabindex="-1"></a>       <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">cex.lab =</span> <span class="fl">1.2</span>,</span>
<span id="cb41-236"><a href="#cb41-236" aria-hidden="true" tabindex="-1"></a>       <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(lo, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="fu">max</span>(up, <span class="at">na.rm=</span><span class="cn">TRUE</span>)))</span>
<span id="cb41-237"><a href="#cb41-237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">1</span>, <span class="dv">12</span> <span class="sc">*</span> (<span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(plank.t)[<span class="dv">2</span>]) <span class="sc">+</span> <span class="dv">1</span>, yr_frst <span class="sc">+</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(plank.t)[<span class="dv">2</span>])</span>
<span id="cb41-238"><a href="#cb41-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(w_ts, plank.t[i,], <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> clr[i])</span>
<span id="cb41-239"><a href="#cb41-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, up, <span class="at">col =</span> <span class="st">"darkgray"</span>)</span>
<span id="cb41-240"><a href="#cb41-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, mn, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb41-241"><a href="#cb41-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, lo, <span class="at">col =</span> <span class="st">"darkgray"</span>)</span>
<span id="cb41-242"><a href="#cb41-242" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-243"><a href="#cb41-243" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-244"><a href="#cb41-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-245"><a href="#cb41-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-248"><a href="#cb41-248" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-249"><a href="#cb41-249" aria-hidden="true" tabindex="-1"></a><span class="co">#Table of AICc for all fitted models</span></span>
<span id="cb41-250"><a href="#cb41-250" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">cbind</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"no covars"</span>, <span class="st">"Temp"</span>, <span class="st">"TP"</span>, <span class="st">"Temp &amp; TP"</span>, <span class="st">"TP Seas"</span>, <span class="st">"TP &amp; temp &amp; Seas"</span>),</span>
<span id="cb41-251"><a href="#cb41-251" aria-hidden="true" tabindex="-1"></a>            <span class="at">AICc =</span> <span class="fu">round</span>(<span class="fu">c</span>(dfa.fit3<span class="sc">$</span>AICc,</span>
<span id="cb41-252"><a href="#cb41-252" aria-hidden="true" tabindex="-1"></a>                           dfa_temp<span class="sc">$</span>AICc,</span>
<span id="cb41-253"><a href="#cb41-253" aria-hidden="true" tabindex="-1"></a>                           dfa_TP<span class="sc">$</span>AICc,</span>
<span id="cb41-254"><a href="#cb41-254" aria-hidden="true" tabindex="-1"></a>                           dfa_both<span class="sc">$</span>AICc,</span>
<span id="cb41-255"><a href="#cb41-255" aria-hidden="true" tabindex="-1"></a>                           dfa_TPseas<span class="sc">$</span>AICc,</span>
<span id="cb41-256"><a href="#cb41-256" aria-hidden="true" tabindex="-1"></a>                           dfa_TPtempseas<span class="sc">$</span>AICc))),</span>
<span id="cb41-257"><a href="#cb41-257" aria-hidden="true" tabindex="-1"></a>      <span class="at">quote =</span> <span class="cn">FALSE</span>)</span>
<span id="cb41-258"><a href="#cb41-258" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-259"><a href="#cb41-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-260"><a href="#cb41-260" aria-hidden="true" tabindex="-1"></a>Both fits look similar, suggesting that temperature has little affect on the model when seasonality and TP are included. Since temperature and season are highly correlated (temperature changes with seasons), it makes sense that the most parimonious model only needs one of these two covariates.</span>
<span id="cb41-261"><a href="#cb41-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-262"><a href="#cb41-262" aria-hidden="true" tabindex="-1"></a>Check the residuals of our favorite model:</span>
<span id="cb41-265"><a href="#cb41-265" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-266"><a href="#cb41-266" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(dfa_TPseas, <span class="at">plot.type=</span><span class="st">'acf.std.model.resids.ytt1'</span>)</span>
<span id="cb41-267"><a href="#cb41-267" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-268"><a href="#cb41-268" aria-hidden="true" tabindex="-1"></a>The ACFs of the residuals don't look amazing.</span>
<span id="cb41-269"><a href="#cb41-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-270"><a href="#cb41-270" aria-hidden="true" tabindex="-1"></a>Let's look at the overall fit of the model:</span>
<span id="cb41-271"><a href="#cb41-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-274"><a href="#cb41-274" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-275"><a href="#cb41-275" aria-hidden="true" tabindex="-1"></a>mm <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb41-276"><a href="#cb41-276" aria-hidden="true" tabindex="-1"></a><span class="do">## plot the processes</span></span>
<span id="cb41-277"><a href="#cb41-277" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>mm) {</span>
<span id="cb41-278"><a href="#cb41-278" aria-hidden="true" tabindex="-1"></a>  ylm <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(trends.rot[i,]))</span>
<span id="cb41-279"><a href="#cb41-279" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up plot area</span></span>
<span id="cb41-280"><a href="#cb41-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(w_ts,trends.rot[i,], <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">bty =</span> <span class="st">"L"</span>,</span>
<span id="cb41-281"><a href="#cb41-281" aria-hidden="true" tabindex="-1"></a>       <span class="at">ylim =</span> ylm, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">xaxt =</span> <span class="st">"n"</span>)</span>
<span id="cb41-282"><a href="#cb41-282" aria-hidden="true" tabindex="-1"></a>  <span class="do">## draw zero-line</span></span>
<span id="cb41-283"><a href="#cb41-283" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"gray"</span>)</span>
<span id="cb41-284"><a href="#cb41-284" aria-hidden="true" tabindex="-1"></a>  <span class="do">## plot trend line</span></span>
<span id="cb41-285"><a href="#cb41-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, trends.rot[i,], <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb41-286"><a href="#cb41-286" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, trends.rot[i,], <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb41-287"><a href="#cb41-287" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add panel labels</span></span>
<span id="cb41-288"><a href="#cb41-288" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mtext</span>(<span class="fu">paste</span>(<span class="st">"State"</span>,i), <span class="at">side =</span> <span class="dv">3</span>, <span class="at">line =</span> <span class="fl">0.5</span>)</span>
<span id="cb41-289"><a href="#cb41-289" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">1</span>, <span class="dv">12</span> <span class="sc">*</span> (<span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(plank.t)[<span class="dv">2</span>]) <span class="sc">+</span> <span class="dv">1</span>, yr_frst <span class="sc">+</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(plank.t)[<span class="dv">2</span>])</span>
<span id="cb41-290"><a href="#cb41-290" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-291"><a href="#cb41-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-292"><a href="#cb41-292" aria-hidden="true" tabindex="-1"></a>State 1 has two big dips: ~1974 and ~1988. The first may be related to the decrease in TP in the lake. State 2 shows some seasonal pattern ~6 years and a steady increase starting in 1978. State 3 is relatively steady over time with possible seasonality. State 4 decreases until about 1977 and then rebounds and remains stable, with possible seasonal patterns.</span>
<span id="cb41-295"><a href="#cb41-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-296"><a href="#cb41-296" aria-hidden="true" tabindex="-1"></a>spp <span class="ot">&lt;-</span> <span class="fu">rownames</span>(plank.t)</span>
<span id="cb41-297"><a href="#cb41-297" aria-hidden="true" tabindex="-1"></a>minZ <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb41-298"><a href="#cb41-298" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">dim</span>(trends.rot)[<span class="dv">1</span>]</span>
<span id="cb41-299"><a href="#cb41-299" aria-hidden="true" tabindex="-1"></a>ylims <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.1</span> <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(Z.rot)), <span class="fl">1.1</span> <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(Z.rot)))</span>
<span id="cb41-300"><a href="#cb41-300" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="fu">ceiling</span>(m <span class="sc">/</span> <span class="dv">2</span>), <span class="dv">2</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="fl">1.5</span>, <span class="fl">0.5</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb41-301"><a href="#cb41-301" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb41-302"><a href="#cb41-302" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N.ts)[<span class="fu">abs</span>(Z.rot[, i]) <span class="sc">&gt;</span> minZ], <span class="fu">as.vector</span>(Z.rot[<span class="fu">abs</span>(Z.rot[, i]) <span class="sc">&gt;</span> minZ, i]),</span>
<span id="cb41-303"><a href="#cb41-303" aria-hidden="true" tabindex="-1"></a>       <span class="at">type =</span> <span class="st">"h"</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">ylim =</span> ylims, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, N.ts <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb41-304"><a href="#cb41-304" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-305"><a href="#cb41-305" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N.ts) {</span>
<span id="cb41-306"><a href="#cb41-306" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (Z.rot[j, i] <span class="sc">&gt;</span> minZ) {</span>
<span id="cb41-307"><a href="#cb41-307" aria-hidden="true" tabindex="-1"></a>      <span class="fu">text</span>(j, <span class="sc">-</span><span class="fl">0.05</span>, spp[j], <span class="at">srt =</span> <span class="dv">90</span>, <span class="at">adj =</span> <span class="dv">1</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span>
<span id="cb41-308"><a href="#cb41-308" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb41-309"><a href="#cb41-309" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (Z.rot[j, i] <span class="sc">&lt;</span> <span class="sc">-</span>minZ) {</span>
<span id="cb41-310"><a href="#cb41-310" aria-hidden="true" tabindex="-1"></a>      <span class="fu">text</span>(j, <span class="fl">0.05</span>, spp[j], <span class="at">srt =</span> <span class="dv">90</span>, <span class="at">adj =</span> <span class="dv">0</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span>
<span id="cb41-311"><a href="#cb41-311" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb41-312"><a href="#cb41-312" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">col =</span> clr[i])</span>
<span id="cb41-313"><a href="#cb41-313" aria-hidden="true" tabindex="-1"></a>  } <span class="co"># end j loop</span></span>
<span id="cb41-314"><a href="#cb41-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mtext</span>(<span class="fu">paste</span>(<span class="st">"Factor loadings on trend"</span>, i, <span class="at">sep =</span> <span class="st">" "</span>), <span class="at">side =</span> <span class="dv">3</span>, <span class="at">line =</span> .<span class="dv">5</span>)</span>
<span id="cb41-315"><a href="#cb41-315" aria-hidden="true" tabindex="-1"></a>} </span>
<span id="cb41-316"><a href="#cb41-316" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-317"><a href="#cb41-317" aria-hidden="true" tabindex="-1"></a>All taxa are positively associated with state 1. Unicells, algae and rotifers have a positive association with state 2. Cyclops has a strong positive loading on state 3, with weaker loadings from unicells, algae, and rotifers. Diaptomus has the strongest positive loading on state 4, with weak loadings from unicells, algae, and cyclops. </span>
<span id="cb41-318"><a href="#cb41-318" aria-hidden="true" tabindex="-1"></a>The phytoplankton have loadings on all states, suggesting that we did not quite capture their trends effectively with our model. The strongest associations were for the copepods Diaptomus and Cyclops, suggesting that our model does a decent job of capturing their population dynamics.</span>
<span id="cb41-321"><a href="#cb41-321" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-322"><a href="#cb41-322" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the fits</span></span>
<span id="cb41-323"><a href="#cb41-323" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">1</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="fl">1.5</span>, <span class="fl">0.5</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb41-324"><a href="#cb41-324" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N.ts) {</span>
<span id="cb41-325"><a href="#cb41-325" aria-hidden="true" tabindex="-1"></a>  up <span class="ot">&lt;-</span> mod_fit<span class="sc">$</span>up[i, ]</span>
<span id="cb41-326"><a href="#cb41-326" aria-hidden="true" tabindex="-1"></a>  mn <span class="ot">&lt;-</span> mod_fit<span class="sc">$</span>ex[i, ]</span>
<span id="cb41-327"><a href="#cb41-327" aria-hidden="true" tabindex="-1"></a>  lo <span class="ot">&lt;-</span> mod_fit<span class="sc">$</span>lo[i, ]</span>
<span id="cb41-328"><a href="#cb41-328" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(w_ts, mn,</span>
<span id="cb41-329"><a href="#cb41-329" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> ylbl[i], <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">cex.lab =</span> <span class="fl">1.2</span>,</span>
<span id="cb41-330"><a href="#cb41-330" aria-hidden="true" tabindex="-1"></a>       <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(lo, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="fu">max</span>(up, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb41-331"><a href="#cb41-331" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-332"><a href="#cb41-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">1</span>, <span class="dv">12</span> <span class="sc">*</span> (<span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(plank.t)[<span class="dv">2</span>]) <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">1980</span> <span class="sc">+</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(plank.t)[<span class="dv">2</span>])</span>
<span id="cb41-333"><a href="#cb41-333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(w_ts, plank.t[i, ], <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> clr[i])</span>
<span id="cb41-334"><a href="#cb41-334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, up, <span class="at">col =</span> <span class="st">"darkgray"</span>)</span>
<span id="cb41-335"><a href="#cb41-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, mn, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb41-336"><a href="#cb41-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, lo, <span class="at">col =</span> <span class="st">"darkgray"</span>)</span>
<span id="cb41-337"><a href="#cb41-337" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-338"><a href="#cb41-338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-339"><a href="#cb41-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-340"><a href="#cb41-340" aria-hidden="true" tabindex="-1"></a><span class="fu">## What happens if we try to fit a similar model after the period of high TP in Lake Washington?</span></span>
<span id="cb41-343"><a href="#cb41-343" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-344"><a href="#cb41-344" aria-hidden="true" tabindex="-1"></a><span class="co">#prepare the new dataset</span></span>
<span id="cb41-345"><a href="#cb41-345" aria-hidden="true" tabindex="-1"></a>all_dat2 <span class="ot">&lt;-</span> lakeWAplanktonRaw</span>
<span id="cb41-346"><a href="#cb41-346" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.ts</span>(all_dat2[,<span class="dv">4</span>])</span>
<span id="cb41-347"><a href="#cb41-347" aria-hidden="true" tabindex="-1"></a>TP.sub<span class="ot">&lt;-</span><span class="fu">subset</span>(all_dat2, <span class="at">select=</span><span class="fu">c</span>(<span class="st">"Year"</span>, <span class="st">"TP"</span>), all_dat[,<span class="dv">1</span>]<span class="sc">&lt;</span><span class="dv">1991</span>)</span>
<span id="cb41-348"><a href="#cb41-348" aria-hidden="true" tabindex="-1"></a>TP.sub<span class="ot">&lt;-</span><span class="fu">subset</span>(all_dat2, <span class="at">select=</span><span class="fu">c</span>(<span class="st">"Year"</span>, <span class="st">"TP"</span>), all_dat[,<span class="dv">1</span>]<span class="sc">&gt;</span><span class="dv">1979</span>)</span>
<span id="cb41-349"><a href="#cb41-349" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x=</span>TP.sub[,<span class="dv">1</span>], <span class="at">y=</span>TP.sub[,<span class="dv">2</span>])</span>
<span id="cb41-350"><a href="#cb41-350" aria-hidden="true" tabindex="-1"></a>plank<span class="fl">.10</span>yr<span class="ot">&lt;-</span><span class="fu">subset</span>(all_dat2, <span class="at">select=</span><span class="fu">c</span>(<span class="st">"Year"</span>, <span class="st">'Unicells'</span>, <span class="st">'Other.algae'</span>, <span class="st">'Cyclops'</span>, <span class="st">'Diaptomus'</span>, <span class="st">'Non.colonial.rotifers'</span>), all_dat[,<span class="dv">1</span>]<span class="sc">&lt;</span><span class="dv">1991</span>)</span>
<span id="cb41-351"><a href="#cb41-351" aria-hidden="true" tabindex="-1"></a>plank<span class="fl">.10</span>yr<span class="ot">&lt;-</span><span class="fu">subset</span>(all_dat2, <span class="at">select=</span><span class="fu">c</span>(<span class="st">"Year"</span>, <span class="st">'Unicells'</span>, <span class="st">'Other.algae'</span>, <span class="st">'Cyclops'</span>, <span class="st">'Diaptomus'</span>, <span class="st">'Non.colonial.rotifers'</span>), all_dat[,<span class="dv">1</span>]<span class="sc">&gt;</span><span class="dv">1979</span>)</span>
<span id="cb41-352"><a href="#cb41-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-353"><a href="#cb41-353" aria-hidden="true" tabindex="-1"></a><span class="co">#transpose data</span></span>
<span id="cb41-354"><a href="#cb41-354" aria-hidden="true" tabindex="-1"></a>plank.t10<span class="ot">&lt;-</span><span class="fu">t</span>(plank<span class="fl">.10</span>yr)</span>
<span id="cb41-355"><a href="#cb41-355" aria-hidden="true" tabindex="-1"></a>year.cols<span class="ot">&lt;-</span>plank.t10[<span class="dv">1</span>,]</span>
<span id="cb41-356"><a href="#cb41-356" aria-hidden="true" tabindex="-1"></a>plank.t10<span class="ot">&lt;-</span>plank.t10[<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>,]</span>
<span id="cb41-357"><a href="#cb41-357" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(plank.t10)<span class="ot">&lt;-</span>year.cols</span>
<span id="cb41-358"><a href="#cb41-358" aria-hidden="true" tabindex="-1"></a>N.ts<span class="ot">&lt;-</span><span class="fu">nrow</span>(plank.t10)</span>
<span id="cb41-359"><a href="#cb41-359" aria-hidden="true" tabindex="-1"></a>TT<span class="ot">&lt;-</span><span class="fu">ncol</span>(plank.t10)</span>
<span id="cb41-360"><a href="#cb41-360" aria-hidden="true" tabindex="-1"></a><span class="co"># re-do z-score</span></span>
<span id="cb41-361"><a href="#cb41-361" aria-hidden="true" tabindex="-1"></a>dat.z<span class="ot">&lt;-</span><span class="fu">zscore</span>(plank.t10)</span>
<span id="cb41-362"><a href="#cb41-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-363"><a href="#cb41-363" aria-hidden="true" tabindex="-1"></a>temp<span class="fl">.10</span>yr <span class="ot">&lt;-</span> <span class="fu">t</span>(all_dat2[<span class="dv">1</span><span class="sc">:</span><span class="dv">180</span>,<span class="st">"Temp"</span>, <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb41-364"><a href="#cb41-364" aria-hidden="true" tabindex="-1"></a>TP<span class="fl">.10</span>yr <span class="ot">&lt;-</span> <span class="fu">t</span>(all_dat2[<span class="dv">1</span><span class="sc">:</span><span class="dv">180</span>,<span class="st">"TP"</span>, <span class="at">drop =</span> T])</span>
<span id="cb41-365"><a href="#cb41-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-366"><a href="#cb41-366" aria-hidden="true" tabindex="-1"></a>temp.z<span class="ot">&lt;-</span><span class="fu">zscore</span>(temp<span class="fl">.10</span>yr)</span>
<span id="cb41-367"><a href="#cb41-367" aria-hidden="true" tabindex="-1"></a>TP.z<span class="ot">&lt;-</span><span class="fu">zscore</span>(TP<span class="fl">.10</span>yr)</span>
<span id="cb41-368"><a href="#cb41-368" aria-hidden="true" tabindex="-1"></a><span class="co">#replace NA with 0 in TP.z</span></span>
<span id="cb41-369"><a href="#cb41-369" aria-hidden="true" tabindex="-1"></a>TP.z[<span class="fu">is.na</span>(TP.z)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb41-370"><a href="#cb41-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-371"><a href="#cb41-371" aria-hidden="true" tabindex="-1"></a>cos_t <span class="ot">&lt;-</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">seq</span>(TT) <span class="sc">/</span> <span class="dv">12</span>)</span>
<span id="cb41-372"><a href="#cb41-372" aria-hidden="true" tabindex="-1"></a>sin_t <span class="ot">&lt;-</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">seq</span>(TT) <span class="sc">/</span> <span class="dv">12</span>)</span>
<span id="cb41-373"><a href="#cb41-373" aria-hidden="true" tabindex="-1"></a>dd<span class="fl">.10</span> <span class="ot">&lt;-</span> <span class="fu">rbind</span>(cos_t, sin_t)</span>
<span id="cb41-374"><a href="#cb41-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-375"><a href="#cb41-375" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-376"><a href="#cb41-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-377"><a href="#cb41-377" aria-hidden="true" tabindex="-1"></a>When we looked at 4 hidden trends for our data subset, the 4th trend was just a straight horizontal line, so we moved forward with 3 hidden trends. TP + seasons had a lower AICc than temperature alone.</span>
<span id="cb41-378"><a href="#cb41-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-379"><a href="#cb41-379" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, cache = TRUE}</span></span>
<span id="cb41-380"><a href="#cb41-380" aria-hidden="true" tabindex="-1"></a><span class="in">mod_list = list(m = 3, R = "diagonal and unequal")</span></span>
<span id="cb41-381"><a href="#cb41-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-382"><a href="#cb41-382" aria-hidden="true" tabindex="-1"></a><span class="in">dfa_TPseas.10 &lt;- MARSS(plank.t10, model = mod_list, form = "dfa", z.score = TRUE,</span></span>
<span id="cb41-383"><a href="#cb41-383" aria-hidden="true" tabindex="-1"></a><span class="in">              control=cntl.list, covariates = rbind(TP.z,dd.10), silent = TRUE,method = "BFGS")</span></span>
<span id="cb41-384"><a href="#cb41-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-385"><a href="#cb41-385" aria-hidden="true" tabindex="-1"></a><span class="in">#mod_fit.TPseas.10 &lt;- getDFAfits(dfa_TPseas.10)</span></span>
<span id="cb41-386"><a href="#cb41-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-387"><a href="#cb41-387" aria-hidden="true" tabindex="-1"></a><span class="in">autoplot(dfa_TPseas.10, plot.type='acf.std.model.resids.ytt1')</span></span>
<span id="cb41-388"><a href="#cb41-388" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-389"><a href="#cb41-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-392"><a href="#cb41-392" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-393"><a href="#cb41-393" aria-hidden="true" tabindex="-1"></a>w_ts_10 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">dim</span>(plank.t10)[<span class="dv">2</span>])</span>
<span id="cb41-394"><a href="#cb41-394" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-395"><a href="#cb41-395" aria-hidden="true" tabindex="-1"></a>The data do not look well represented by this model.</span>
<span id="cb41-396"><a href="#cb41-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-399"><a href="#cb41-399" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-400"><a href="#cb41-400" aria-hidden="true" tabindex="-1"></a>Z_est<span class="fl">.10</span> <span class="ot">&lt;-</span> <span class="fu">coef</span>(dfa_TPseas<span class="fl">.10</span>, <span class="at">type =</span> <span class="st">"matrix"</span>)<span class="sc">$</span>Z</span>
<span id="cb41-401"><a href="#cb41-401" aria-hidden="true" tabindex="-1"></a>H_inv<span class="fl">.10</span> <span class="ot">&lt;-</span> <span class="fu">varimax</span>(Z_est<span class="fl">.10</span>)<span class="sc">$</span>rotmat</span>
<span id="cb41-402"><a href="#cb41-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-403"><a href="#cb41-403" aria-hidden="true" tabindex="-1"></a><span class="co"># rotate factor loadings</span></span>
<span id="cb41-404"><a href="#cb41-404" aria-hidden="true" tabindex="-1"></a>Z.rot<span class="fl">.10</span> <span class="ot">=</span> Z_est<span class="fl">.10</span> <span class="sc">%*%</span> H_inv<span class="fl">.10</span></span>
<span id="cb41-405"><a href="#cb41-405" aria-hidden="true" tabindex="-1"></a>trends.rot<span class="fl">.10</span> <span class="ot">=</span> <span class="fu">solve</span>(H_inv<span class="fl">.10</span>) <span class="sc">%*%</span> dfa_TPseas<span class="fl">.10</span><span class="sc">$</span>states</span>
<span id="cb41-406"><a href="#cb41-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-407"><a href="#cb41-407" aria-hidden="true" tabindex="-1"></a>m10 <span class="ot">&lt;-</span> <span class="fu">dim</span>(trends.rot<span class="fl">.10</span>)[<span class="dv">1</span>]</span>
<span id="cb41-408"><a href="#cb41-408" aria-hidden="true" tabindex="-1"></a>ylims <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.1</span> <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(Z.rot<span class="fl">.10</span>), <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="fl">1.1</span> <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(Z.rot<span class="fl">.10</span>), <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb41-409"><a href="#cb41-409" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="fu">ceiling</span>(m10 <span class="sc">/</span> <span class="dv">2</span>), <span class="dv">2</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="fl">1.5</span>, <span class="fl">0.5</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb41-410"><a href="#cb41-410" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m10) {</span>
<span id="cb41-411"><a href="#cb41-411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N.ts)[<span class="fu">abs</span>(Z.rot<span class="fl">.10</span>[, i]) <span class="sc">&gt;</span> minZ], <span class="fu">as.vector</span>(Z.rot<span class="fl">.10</span>[<span class="fu">abs</span>(Z.rot<span class="fl">.10</span>[, i]) <span class="sc">&gt;</span> minZ, i]),</span>
<span id="cb41-412"><a href="#cb41-412" aria-hidden="true" tabindex="-1"></a>       <span class="at">type =</span> <span class="st">"h"</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">ylim =</span> ylims, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, N.ts <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb41-413"><a href="#cb41-413" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-414"><a href="#cb41-414" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N.ts) {</span>
<span id="cb41-415"><a href="#cb41-415" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (Z.rot<span class="fl">.10</span>[j, i] <span class="sc">&gt;</span> minZ) {</span>
<span id="cb41-416"><a href="#cb41-416" aria-hidden="true" tabindex="-1"></a>      <span class="fu">text</span>(j, <span class="sc">-</span><span class="fl">0.05</span>, spp[j], <span class="at">srt =</span> <span class="dv">90</span>, <span class="at">adj =</span> <span class="dv">1</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span>
<span id="cb41-417"><a href="#cb41-417" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb41-418"><a href="#cb41-418" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (Z.rot<span class="fl">.10</span>[j, i] <span class="sc">&lt;</span> <span class="sc">-</span>minZ) {</span>
<span id="cb41-419"><a href="#cb41-419" aria-hidden="true" tabindex="-1"></a>      <span class="fu">text</span>(j, <span class="fl">0.05</span>, spp[j], <span class="at">srt =</span> <span class="dv">90</span>, <span class="at">adj =</span> <span class="dv">0</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span>
<span id="cb41-420"><a href="#cb41-420" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb41-421"><a href="#cb41-421" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">col =</span> clr[i])</span>
<span id="cb41-422"><a href="#cb41-422" aria-hidden="true" tabindex="-1"></a>  } <span class="co"># end j loop</span></span>
<span id="cb41-423"><a href="#cb41-423" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mtext</span>(<span class="fu">paste</span>(<span class="st">"Factor loadings on trend"</span>, i, <span class="at">sep =</span> <span class="st">" "</span>), <span class="at">side =</span> <span class="dv">3</span>, <span class="at">line =</span> .<span class="dv">5</span>)</span>
<span id="cb41-424"><a href="#cb41-424" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-425"><a href="#cb41-425" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-426"><a href="#cb41-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-429"><a href="#cb41-429" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-430"><a href="#cb41-430" aria-hidden="true" tabindex="-1"></a>mm<span class="ot">&lt;-</span><span class="dv">3</span></span>
<span id="cb41-431"><a href="#cb41-431" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>mm) {</span>
<span id="cb41-432"><a href="#cb41-432" aria-hidden="true" tabindex="-1"></a>  ylm <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(trends.rot<span class="fl">.10</span>[i,]), <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb41-433"><a href="#cb41-433" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up plot area</span></span>
<span id="cb41-434"><a href="#cb41-434" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(w_ts_10,trends.rot<span class="fl">.10</span>[i,], <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">bty =</span> <span class="st">"L"</span>,</span>
<span id="cb41-435"><a href="#cb41-435" aria-hidden="true" tabindex="-1"></a>       <span class="at">ylim =</span> ylm, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">xaxt =</span> <span class="st">"n"</span>)</span>
<span id="cb41-436"><a href="#cb41-436" aria-hidden="true" tabindex="-1"></a>  <span class="do">## draw zero-line</span></span>
<span id="cb41-437"><a href="#cb41-437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"gray"</span>)</span>
<span id="cb41-438"><a href="#cb41-438" aria-hidden="true" tabindex="-1"></a>  <span class="do">## plot trend line</span></span>
<span id="cb41-439"><a href="#cb41-439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts_10, trends.rot<span class="fl">.10</span>[i,], <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb41-440"><a href="#cb41-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts_10, trends.rot<span class="fl">.10</span>[i,], <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb41-441"><a href="#cb41-441" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add panel labels</span></span>
<span id="cb41-442"><a href="#cb41-442" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mtext</span>(<span class="fu">paste</span>(<span class="st">"State"</span>,i), <span class="at">side =</span> <span class="dv">3</span>, <span class="at">line =</span> <span class="fl">0.5</span>)</span>
<span id="cb41-443"><a href="#cb41-443" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">1</span>, <span class="dv">12</span> <span class="sc">*</span> (<span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(plank.t10)[<span class="dv">2</span>]) <span class="sc">+</span> <span class="dv">1</span>, yr_frst <span class="sc">+</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(plank.t10)[<span class="dv">2</span>])</span>
<span id="cb41-444"><a href="#cb41-444" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-445"><a href="#cb41-445" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-446"><a href="#cb41-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-447"><a href="#cb41-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-448"><a href="#cb41-448" aria-hidden="true" tabindex="-1"></a><span class="fu"># Discussion</span></span>
<span id="cb41-449"><a href="#cb41-449" aria-hidden="true" tabindex="-1"></a>We chose to first analyze data from the full time series with the assumption that more data would yield stronger associations between covariates and plankton abundance. We first determined the optimal number of states by fitting multiple models, each with different numbers of states. The models were then compared via AICc to determine what number of states best fit the time series. </span>
<span id="cb41-450"><a href="#cb41-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-451"><a href="#cb41-451" aria-hidden="true" tabindex="-1"></a>The best fitting model had 4 hidden states over the full period of time; there were no other competing models based on delta AICc. Since we have just 5 ts and 4 hidden trends (our m is close to our n) we should probably reconsider the data we are monitoring!</span>
<span id="cb41-452"><a href="#cb41-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-453"><a href="#cb41-453" aria-hidden="true" tabindex="-1"></a>We then chose covariates (TP and temperature) and compared models with different combinations of temperature, total phosphorus, a combination of temperature and total phosphorus, dummy sine and cosine waves to simulate seasonality, and total phosphorus combined with seasonality. We did not fit a model with temperature and seasonality, as it was assumed that these two variables would be highly correlated, and thus shouldn't be modeled together as their effects would not be distinguishable.</span>
<span id="cb41-454"><a href="#cb41-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-455"><a href="#cb41-455" aria-hidden="true" tabindex="-1"></a>A model with total phosphorus combined with seasonality was the best fit according to delta AICc. </span>
<span id="cb41-456"><a href="#cb41-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-457"><a href="#cb41-457" aria-hidden="true" tabindex="-1"></a>However, the model fits do not appear to fit the data well when plotted. This perhaps indicates that across the entire time series, there is no model that performs well over all areas. We created a subset of the time series (~ 10 years) and followed a similar workflow.  </span>
<span id="cb41-458"><a href="#cb41-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-459"><a href="#cb41-459" aria-hidden="true" tabindex="-1"></a>We chose a time period for the shorter time series when raw sewage was no longer being pumped into the lake, therefore TP was lower overall (with some seasonal variance) and there was less eutrophication. We hypothesized that this state would better reveal the "true", biological links between the plankton taxa. We found that it is likely that TP and seasonality/temperature are still strong regulating factors of plankton dynamics, however our model was not a great fit. </span>
<span id="cb41-460"><a href="#cb41-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-461"><a href="#cb41-461" aria-hidden="true" tabindex="-1"></a>Neither one of our models fit the data very well. This may be because 1) we are missing important covariates that strongly influence plankton dynamics; 2) phytoplankton and zooplankton in the lake are not strongly influencing each other and should not be modeled with the same methods; or 3) similar to (2), we chose the wrong plankton taxa to include in a model. It would be best to consult freshwater plankton ecologists to determine which species are strongly associated with each other and which covariates are the most important in determine their abundances.</span>
<span id="cb41-462"><a href="#cb41-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-463"><a href="#cb41-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-464"><a href="#cb41-464" aria-hidden="true" tabindex="-1"></a><span class="fu"># Team contributions</span></span>
<span id="cb41-465"><a href="#cb41-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-466"><a href="#cb41-466" aria-hidden="true" tabindex="-1"></a>ETS explored the data to find usable parts for the analysis; she also did the first attempt at fitting a DFA with different trends. MM refined the DFA and added analyses for assessing model fit and covariates. MM and KV discussed covariates and seasonal effects on the model. ETS selected the subset of data to analyze and applied the previous code developed by all team members to the new subset of the data. ETS drafted the final lab report with very minor changes from MM. Code was de-bugged and the lab report was finalized by all.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/atsa-es/fish550-2023/edit/main/Lab-3/Final_Write_ups/Lab-3-team-4_final.Rmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/atsa-es/fish550-2023/blob/main/Lab-3/Final_Write_ups/Lab-3-team-4_final.Rmd" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/atsa-es/fish550-2023/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>