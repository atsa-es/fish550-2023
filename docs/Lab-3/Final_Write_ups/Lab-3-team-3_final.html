<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nick Chambers, Terrance Wang, Zoe Rand">
<meta name="dcterms.date" content="2023-05-02">

<title>15&nbsp; Team 3 - Lab 3 – Fish 550 Spring 2023</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../Lab-3/Final_Write_ups/Lab-3-team-4_final.html" rel="next">
<link href="../../Lab-3/Final_Write_ups/Lab-3-team-2_final.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-626149efe8f5d16e1d391ba177679bf0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../Lab-3/Lab-3-DFA.html">Dynamic Factor Analysis</a></li><li class="breadcrumb-item"><a href="../../Lab-3/Final_Write_ups/Lab-3-team-3_final.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Team 3 - Lab 3</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">Fish 550 Spring 2023</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/atsa-es/fish550-2023" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Labs</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Forecasting with ARIMA models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-1/Lab1-ARIMA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Lab Intro</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-1/Final_Write_ups/Lab-1-team-1_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Team 1 - Lab 1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-1/Final_Write_ups/Lab-1-team-2_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Team 2 - Lab 1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-1/Final_Write_ups/Lab-1-team-3_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Team 3 - Lab 1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-1/Final_Write_ups/Lab-1-team-4_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Team 4 - Lab 1</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Analyzing multivariate salmon data with MARSS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-2/Lab2-MARSS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Lab Intro</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-2/Final_Write_ups/Lab-2-team-1_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Team 1 - Lab 2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-2/Final_Write_ups/Lab-2-team-2_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Team 2 - Lab 2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-2/Final_Write_ups/Lab-2-team-3_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Team 3 - Lab 2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-2/Final_Write_ups/Lab-2-team-4_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Team 4 - Lab 2</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Dynamic Factor Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-3/Lab-3-DFA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Lab Intro</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-3/Final_Write_ups/Lab-3-team-1_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Team 1 - Lab 3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-3/Final_Write_ups/Lab-3-team-2_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Team 2 - Lab 3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-3/Final_Write_ups/Lab-3-team-3_final.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Team 3 - Lab 3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-3/Final_Write_ups/Lab-3-team-4_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Team 4 - Lab 3</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Hidden Markov Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-4/Lab-4-HMM.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Lab Intro</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-4/Final_Write_ups/Lab-4-team-1_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Team 1 - Lab 4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-4/Final_Write_ups/Lab-4-team-2_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Team 2 - Lab 4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-4/Final_Write_ups/Lab-4-team-3_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Team 3 - Lab 4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-4/Final_Write_ups/Lab-4-team-4_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Team 4 - Lab 4</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Dynamic Linear Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-5/Lab-5-DLM.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Lab 5 - Dynamic Linear Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-5/Final_Write_ups/Lab-5-team-1_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Team 1 - Lab 5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-5/Final_Write_ups/Lab-5-team-2_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Team 2 - Lab 5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-5/Final_Write_ups/Lab-5-team-3_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Team 3 - Lab 5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Lab-5/Final_Write_ups/Lab-5-team-4_final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Team 3 - Lab 5</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#data" id="toc-data" class="nav-link active" data-scroll-target="#data">Data</a>
  <ul class="collapse">
  <li><a href="#load-the-data" id="toc-load-the-data" class="nav-link" data-scroll-target="#load-the-data">Load the data</a></li>
  <li><a href="#wrangle-the-data" id="toc-wrangle-the-data" class="nav-link" data-scroll-target="#wrangle-the-data">Wrangle the data</a>
  <ul class="collapse">
  <li><a href="#zooplankton" id="toc-zooplankton" class="nav-link" data-scroll-target="#zooplankton">Zooplankton</a></li>
  <li><a href="#covariates" id="toc-covariates" class="nav-link" data-scroll-target="#covariates">Covariates</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#estimating-missing-values" id="toc-estimating-missing-values" class="nav-link" data-scroll-target="#estimating-missing-values">estimating missing values</a></li>
  <li><a href="#general-tasks" id="toc-general-tasks" class="nav-link" data-scroll-target="#general-tasks">General tasks</a></li>
  <li><a href="#methods" id="toc-methods" class="nav-link" data-scroll-target="#methods">Methods</a>
  <ul class="collapse">
  <li><a href="#data-1" id="toc-data-1" class="nav-link" data-scroll-target="#data-1">Data:</a></li>
  <li><a href="#model" id="toc-model" class="nav-link" data-scroll-target="#model">Model:</a></li>
  </ul></li>
  <li><a href="#observation-model" id="toc-observation-model" class="nav-link" data-scroll-target="#observation-model">Observation Model</a>
  <ul class="collapse">
  <li><a href="#zz-is-loadings-matrix" id="toc-zz-is-loadings-matrix" class="nav-link" data-scroll-target="#zz-is-loadings-matrix">ZZ is loadings matrix</a></li>
  </ul></li>
  <li><a href="#process-model" id="toc-process-model" class="nav-link" data-scroll-target="#process-model">Process Model</a></li>
  <li><a href="#fit-with-marss" id="toc-fit-with-marss" class="nav-link" data-scroll-target="#fit-with-marss">Fit with MARSS</a></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a></li>
  <li><a href="#discussion" id="toc-discussion" class="nav-link" data-scroll-target="#discussion">Discussion</a></li>
  <li><a href="#team-contributions" id="toc-team-contributions" class="nav-link" data-scroll-target="#team-contributions">Team Contributions</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/atsa-es/fish550-2023/edit/main/Lab-3/Final_Write_ups/Lab-3-team-3_final.Rmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/atsa-es/fish550-2023/blob/main/Lab-3/Final_Write_ups/Lab-3-team-3_final.Rmd" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/atsa-es/fish550-2023/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../Lab-3/Lab-3-DFA.html">Dynamic Factor Analysis</a></li><li class="breadcrumb-item"><a href="../../Lab-3/Final_Write_ups/Lab-3-team-3_final.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Team 3 - Lab 3</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Team 3 - Lab 3</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Dynamic Factor Analysis (DFA)</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Nick Chambers, Terrance Wang, Zoe Rand </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 2, 2023</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<hr>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zoo)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>get_DFA_fits <span class="ot">&lt;-</span> <span class="cf">function</span>(MLEobj, <span class="at">dd =</span> <span class="cn">NULL</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>) {</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="do">## empty list for results</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    fits <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="do">## extra stuff for var() calcs</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    Ey <span class="ot">&lt;-</span> MARSS<span class="sc">:::</span><span class="fu">MARSShatyt</span>(MLEobj)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="do">## model params</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    ZZ <span class="ot">&lt;-</span> <span class="fu">coef</span>(MLEobj, <span class="at">type =</span> <span class="st">"matrix"</span>)<span class="sc">$</span>Z</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="do">## number of obs ts</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    nn <span class="ot">&lt;-</span> <span class="fu">dim</span>(Ey<span class="sc">$</span>ytT)[<span class="dv">1</span>]</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="do">## number of time steps</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    TT <span class="ot">&lt;-</span> <span class="fu">dim</span>(Ey<span class="sc">$</span>ytT)[<span class="dv">2</span>]</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="do">## get the inverse of the rotation matrix</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    H_inv <span class="ot">&lt;-</span> <span class="fu">varimax</span>(ZZ)<span class="sc">$</span>rotmat</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="do">## check for covars</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(dd)) {</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        DD <span class="ot">&lt;-</span> <span class="fu">coef</span>(MLEobj, <span class="at">type =</span> <span class="st">"matrix"</span>)<span class="sc">$</span>D</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        <span class="do">## model expectation</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        fits<span class="sc">$</span>ex <span class="ot">&lt;-</span> ZZ <span class="sc">%*%</span> H_inv <span class="sc">%*%</span> MLEobj<span class="sc">$</span>states <span class="sc">+</span> DD <span class="sc">%*%</span> dd</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>        <span class="do">## model expectation</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        fits<span class="sc">$</span>ex <span class="ot">&lt;-</span> ZZ <span class="sc">%*%</span> H_inv <span class="sc">%*%</span> MLEobj<span class="sc">$</span>states</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Var in model fits</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    VtT <span class="ot">&lt;-</span> <span class="fu">MARSSkfss</span>(MLEobj)<span class="sc">$</span>VtT</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    VV <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (tt <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>TT) {</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>        RZVZ <span class="ot">&lt;-</span> <span class="fu">coef</span>(MLEobj, <span class="at">type =</span> <span class="st">"matrix"</span>)<span class="sc">$</span>R <span class="sc">-</span> ZZ <span class="sc">%*%</span> VtT[, </span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>            , tt] <span class="sc">%*%</span> <span class="fu">t</span>(ZZ)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>        SS <span class="ot">&lt;-</span> Ey<span class="sc">$</span>yxtT[, , tt] <span class="sc">-</span> Ey<span class="sc">$</span>ytT[, tt, drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">%*%</span> </span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>            <span class="fu">t</span>(MLEobj<span class="sc">$</span>states[, tt, <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>        VV <span class="ot">&lt;-</span> <span class="fu">cbind</span>(VV, <span class="fu">diag</span>(RZVZ <span class="sc">+</span> SS <span class="sc">%*%</span> <span class="fu">t</span>(ZZ) <span class="sc">+</span> ZZ <span class="sc">%*%</span> <span class="fu">t</span>(SS)))</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    SE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(VV)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="do">## upper &amp; lower (1-alpha)% CI</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    fits<span class="sc">$</span>up <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(<span class="dv">1</span> <span class="sc">-</span> alpha<span class="sc">/</span><span class="dv">2</span>) <span class="sc">*</span> SE <span class="sc">+</span> fits<span class="sc">$</span>ex</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    fits<span class="sc">$</span>lo <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(alpha<span class="sc">/</span><span class="dv">2</span>) <span class="sc">*</span> SE <span class="sc">+</span> fits<span class="sc">$</span>ex</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(fits)</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="data" class="level1">
<h1>Data</h1>
<p>We decided to model 4 groups of zooplankton: Cyclops, Diaptomus, Epischura, and Neomysis. We chose to test environmental covariates (temp, pH, TP), as well as phytoplankton abundances as covariates(cryptomonas, diatoms, greens, unicells, other.algae) since the zooplankton we chose are copepods and mysids, and therefore may be impacted by the type of phytoplankton present. We used data from the start of the time series (1962) until 1985, because the Neomysis data gets very patchy after the 1980s and we didn’t want this to cause issues with model fitting.</p>
<section id="load-the-data" class="level2">
<h2 class="anchored" data-anchor-id="load-the-data">Load the data</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">## load MARSS for data and analyses</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MARSS)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="do">## load the raw data (there are 3 datasets contained here)</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(lakeWAplankton, <span class="at">package =</span> <span class="st">"MARSS"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="do">## we want `lakeWAplanktonTrans`, which has been transformed</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="do">## so the 0's are replaced with NA's and the data z-scored</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>all_dat <span class="ot">&lt;-</span> lakeWAplanktonTrans</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="wrangle-the-data" class="level2">
<h2 class="anchored" data-anchor-id="wrangle-the-data">Wrangle the data</h2>
<ul>
<li><p>You can choose any taxa to include in your analyses, but make sure there are at least 5 groups. You can mix phytoplankton and zooplankton, if you’d like, but justify any choices you make.</p></li>
<li><p>You will want to subset the data to a time period with adequate observations for the taxa of interest. Your time window should include at lest 5 years (60 months).</p></li>
</ul>
<section id="zooplankton" class="level3">
<h3 class="anchored" data-anchor-id="zooplankton">Zooplankton</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## plotting the taxa of interest</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>all_dat <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as.yearmon</span>(<span class="fu">paste</span>(Year, Month), <span class="st">"%Y %m"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(<span class="st">"Date"</span>, <span class="st">"Cyclops"</span>, <span class="st">"Diaptomus"</span>, <span class="st">"Epischura"</span>, <span class="st">"Neomysis"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(Date), <span class="at">names_to =</span> <span class="st">"Species"</span>, <span class="at">values_to =</span> <span class="st">"Vals"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Date, <span class="at">y =</span> Vals, <span class="at">color =</span> Species)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span>Species) <span class="sc">+</span> <span class="fu">scale_x_yearmon</span>(<span class="at">format =</span> <span class="st">"%Y"</span>) <span class="sc">+</span> </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Abundance Index"</span>, <span class="at">x =</span> <span class="st">"Year"</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span>  <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-3_final_files/figure-html/plot_data-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#using data up to 1985</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>spp<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"Cyclops"</span>, <span class="st">"Diaptomus"</span>, <span class="st">"Epischura"</span>, <span class="st">"Neomysis"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>dat_1985<span class="ot">&lt;-</span>all_dat[all_dat[, <span class="st">"Year"</span>] <span class="sc">&lt;=</span> <span class="dv">1985</span>,]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>dat_zoo_1985<span class="ot">&lt;-</span>dat_1985[, spp]</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">#head(dat_zoo_1985)</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>dat_zoo<span class="ot">&lt;-</span><span class="fu">t</span>(dat_zoo_1985)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>yr_frst <span class="ot">&lt;-</span> <span class="fu">min</span>(dat_1985[,<span class="st">"Year"</span>])</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>yr_last <span class="ot">&lt;-</span> <span class="fu">max</span>(dat_1985[,<span class="st">"Year"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">## get number of time series</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>N_ts <span class="ot">&lt;-</span> <span class="fu">dim</span>(dat_zoo)[<span class="dv">1</span>]</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="do">## get length of time series</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>TT <span class="ot">&lt;-</span> <span class="fu">dim</span>(dat_zoo)[<span class="dv">2</span>] </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="do">## mean of each taxon</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>y_bar <span class="ot">&lt;-</span> <span class="fu">apply</span>(dat_zoo, <span class="dv">1</span>, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="do">## subtract the means</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat_zoo <span class="sc">-</span> y_bar</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="do">## assign new row names</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(dat) <span class="ot">&lt;-</span> spp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="covariates" class="level3">
<h3 class="anchored" data-anchor-id="covariates">Covariates</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#temp, pH, TP, cryptomonas, diatoms, greens, unicells, other.algae </span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>covs<span class="ot">&lt;-</span><span class="fu">colnames</span>(dat_1985)[<span class="fu">c</span>(<span class="dv">3</span><span class="sc">:</span><span class="dv">8</span>,<span class="dv">10</span><span class="sc">:</span><span class="dv">11</span>)]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>cov_dat<span class="ot">&lt;-</span><span class="fu">t</span>(dat_1985[,covs])</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">#head(cov_dat)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">#dummy seasonal affect</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>cos_t <span class="ot">&lt;-</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">seq</span>(TT) <span class="sc">/</span> <span class="dv">12</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>sin_t <span class="ot">&lt;-</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">seq</span>(TT) <span class="sc">/</span> <span class="dv">12</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>dd <span class="ot">&lt;-</span> <span class="fu">rbind</span>(cos_t, sin_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#looking at any correlation issues for covariates</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(<span class="fu">cbind</span>(dat_1985[,covs],<span class="fu">t</span>(dd)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-3_final_files/figure-html/cov_corr-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>corrplot 0.92 loaded</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">corrplot</span>(<span class="fu">cor</span>(<span class="fu">cbind</span>(dat_1985[,covs],<span class="fu">t</span>(dd)), <span class="at">use =</span> <span class="st">"pairwise.complete.obs"</span>), <span class="at">addCoef.col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-3_final_files/figure-html/cov_corr-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="estimating-missing-values" class="level1">
<h1>estimating missing values</h1>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Best way is in Ch13 to fill out NA, https://cran.r-project.org/web/packages/MARSS/vignettes/UserGuide.pdf</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Easy way is just to fill in with mean for purposes of this lab</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>cov_df <span class="ot">&lt;-</span> <span class="fu">cbind</span>(dat_1985[,covs],<span class="fu">t</span>(dd)) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()  <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># replace na values with simply mean</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>         <span class="fu">mutate_all</span>(<span class="sc">~</span><span class="fu">ifelse</span>(<span class="fu">is.na</span>(.x), <span class="fu">mean</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), .x))  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="general-tasks" class="level1">
<h1>General tasks</h1>
<p>Each group has the same general tasks, but you will adapt them as you work on the data.</p>
<ol type="1">
<li><p>Find the most parsimonious model among a set that examines the effects of environmental covariates and/or an indicator of seasonality, varying numbers of trends, and different forms of variance-covariance matrices for the observation errors.</p></li>
<li><p>Plot trends and individual loadings for the model identified in task (1) above.</p></li>
<li><p>Plot model fits and uncertainty intervals for the model identified in task (1) above.</p></li>
<li><p>Describe the effects of environmental or dummy variables on (possibly seasonal) patterns in the data.</p></li>
</ol>
</section>
<section id="methods" class="level1">
<h1>Methods</h1>
<p>Please address the following in your methods:</p>
<ul>
<li><p>Which plankton taxa did you choose and how did you choose them?</p></li>
<li><p>What time period(s) did you examine and why?</p></li>
<li><p>What environmental or dummy variables did you include and why?</p></li>
<li><p>What forms of models did you fit (ie, write them out in matrix form)?</p></li>
<li><p>What sort of model diagnostics did you use to examine model assumptions?</p></li>
</ul>
<section id="data-1" class="level3">
<h3 class="anchored" data-anchor-id="data-1">Data:</h3>
<p>We chose to model four zooplankton taxa :Cyclops, Diaptomus, Epischura, and Neomysis. We chose these because they are similar types of zooplankton (copepods and mysids) which are known to be selective about the types of phytoplankton they consume <span class="citation" data-cites="hansen1997">(<a href="#ref-hansen1997" role="doc-biblioref">Hansen, Bjørnsen, and Hansen 1997</a>)</span>. We used data from 1962-1985, because there is very little Neomysis data after 1985. We tested environmental covariates, including temperature, pH, and phosphorus concentrations as well as a seasonal dummy variable. We were also interested in the affect of phytoplankton abundance on these species, so we tested abundance indexes of diatoms, greens, unicells, and other.algae as potential covariates as well.</p>
</section>
<section id="model" class="level3">
<h3 class="anchored" data-anchor-id="model">Model:</h3>
</section>
</section>
<section id="observation-model" class="level1">
<h1>Observation Model</h1>
<p><span class="math display">\[
\begin{bmatrix}
y_1\\
y_2\\
y_3\\
y_4\\
y_5\\
\end{bmatrix}_t=
\begin{bmatrix}
Z_{11} &amp;  Z_{12} &amp;  Z_{13}\\
Z_{21} &amp;  Z_{22} &amp;  Z_{23}\\
Z_{31} &amp;  Z_{32} &amp;  Z_{33}\\
Z_{41} &amp;  Z_{42} &amp;  Z_{43}\\
Z_{51} &amp;  Z_{52} &amp;  Z_{53}\\
\end{bmatrix}*
\begin{bmatrix}
x_1\\
x_2\\
x_3\\
\end{bmatrix}_t+
\begin{bmatrix}
a_{1} \\
a_{2}\\
a_{3}\\
a_{4}\\
a_{5}\\
\end{bmatrix}*
\begin{bmatrix}
d_{Temp}\\
d_{TP}\\
d_{pH}\\
d_{cos}\\
d_{sin}\\
\end{bmatrix}_t+
\begin{bmatrix}
w_1\\
w_2\\
w_3\\
w_4\\
w_5\\
\end{bmatrix}_t
\]</span></p>
<p><span class="math display">\[
\text{Where }w_i \sim MVN
\begin{pmatrix}
\text{0,}\begin{bmatrix}
R&amp;0&amp;0&amp;0&amp;0\\
0&amp;R&amp;0&amp;0&amp;0\\
0&amp;0&amp;R&amp;0&amp;0\\
0&amp;0&amp;0&amp;R&amp;0\\
0&amp;0&amp;0&amp;0&amp;R\\
\end{bmatrix}
\end{pmatrix}
\]</span></p>
<section id="zz-is-loadings-matrix" class="level2">
<h2 class="anchored" data-anchor-id="zz-is-loadings-matrix">ZZ is loadings matrix</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>ZZ <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define different ZZ hypotheses </span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 state</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>Z_vals <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"z11"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z21"</span>, </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z31"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z41"</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>ZZ[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">matrix</span>(Z_vals, <span class="at">nrow =</span> N_ts, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 states</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>Z_vals <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"z11"</span>,  <span class="dv">0</span>  , </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z21"</span>,<span class="st">"z22"</span>, </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z31"</span>,<span class="st">"z32"</span>,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z41"</span>,<span class="st">"z42"</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>ZZ[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">matrix</span>(Z_vals, <span class="at">nrow =</span> N_ts, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 states</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>Z_vals <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"z11"</span>,  <span class="dv">0</span>  ,  <span class="dv">0</span>  ,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z21"</span>,<span class="st">"z22"</span>,  <span class="dv">0</span>  ,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z31"</span>,<span class="st">"z32"</span>,<span class="st">"z33"</span>,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z41"</span>,<span class="st">"z42"</span>,<span class="st">"z43"</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>ZZ[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">matrix</span>(Z_vals, <span class="at">nrow =</span> N_ts, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 states--removing this because we only have 4 sp groups</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="co">#Z_vals &lt;- list("z11",  0  ,  0  , 0,</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>               <span class="co">#"z21","z22",  0  , 0,</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>               <span class="co">#"z31","z32","z33", 0,</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>               <span class="co">#"z41","z42","z43","z44")</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="co">#ZZ[[4]] &lt;- matrix(Z_vals, nrow = N_ts, ncol = 4, byrow = TRUE)</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="do">## 'aa' is the offset/scaling</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>aa <span class="ot">&lt;-</span> <span class="st">"zero"</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="do">## 'DD' and 'd' are for covariates</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>DD <span class="ot">&lt;-</span> <span class="st">"zero"</span>  <span class="co"># matrix(0,mm,1)</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>dd <span class="ot">&lt;-</span> <span class="st">"zero"</span>  <span class="co"># matrix(0,1,wk_last)</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="do">## 'RR' is var-cov matrix for obs errors</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>RR <span class="ot">&lt;-</span> <span class="st">"diagonal and equal"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="process-model" class="level1">
<h1>Process Model</h1>
<p>Process model: <span class="math display">\[
\begin{bmatrix}
x_1\\
x_2\\
x_3\\
\end{bmatrix}_t=
\begin{bmatrix}
1 &amp;  0 &amp;  0\\
0 &amp;  1 &amp;  0\\
0 &amp; 0 &amp; 1\\
\end{bmatrix}*
\begin{bmatrix}
x_1\\
x_2\\
x_3\\
\end{bmatrix}_{t-1}+
\begin{bmatrix}
v_1\\
v_2\\
v_3\\
v_4\\
v_5\\
\end{bmatrix}_t
\]</span></p>
<p><span class="math display">\[
\text{Where }v_i \sim MVN
\begin{pmatrix}
\text{0,}\begin{bmatrix}
1&amp;0&amp;0\\
0&amp;1&amp;0\\
0&amp;0&amp;1\\
\end{bmatrix}
\end{pmatrix}
\]</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">## number of processes</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>mm <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># this is just a placeholder, as we loop through # of states we will update this</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 'BB' is identity: 1's along the diagonal &amp; 0's elsewhere</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>BB <span class="ot">&lt;-</span> <span class="st">"identity"</span>  <span class="co"># diag(mm)</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 'uu' is a column vector of 0's</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>uu <span class="ot">&lt;-</span> <span class="st">"zero"</span>  <span class="co"># matrix(0, mm, 1)</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 'CC' and 'cc' are for covariates</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>CC <span class="ot">&lt;-</span> <span class="st">"zero"</span>  <span class="co"># matrix(0, mm, 1)</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>cc <span class="ot">&lt;-</span> <span class="st">"zero"</span>  <span class="co"># matrix(0, 1, wk_last)</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 'QQ' is identity</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>QQ <span class="ot">&lt;-</span> <span class="st">"identity"</span>  <span class="co"># diag(mm)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="fit-with-marss" class="level1">
<h1>Fit with MARSS</h1>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="do">## list with specifications for model vectors/matrices</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>mod_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Z =</span> ZZ[[<span class="dv">2</span>]], <span class="at">A =</span> aa, <span class="at">D =</span> DD, <span class="at">d =</span> dd, <span class="at">R =</span> RR,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">B =</span> BB, <span class="at">U =</span> uu, <span class="at">C =</span> CC, <span class="at">c =</span> cc, <span class="at">Q =</span> QQ)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="do">## list with model inits</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x0 =</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="dv">0</span>, mm), mm, <span class="dv">1</span>))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="do">## list with model control parameters</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">#con_list &lt;- list(maxit = 3000, allow.degen = FALSE) #allow.degen not allowed for BFGS</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>con_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">maxit =</span> <span class="dv">3000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>Z_AIC <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">states =</span> <span class="cn">NA</span>,<span class="at">AICc=</span><span class="cn">NA</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (z <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ZZ)){</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="do">## list with specifications for model vectors/matrices</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the first mod_list is the long way of writing it out</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># mod_list &lt;- list(Z = ZZ[[z]], A = aa, D = DD, d = dd, R = RR,</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">#                  B = BB, U = uu, C = CC, c = cc, Q = QQ)  </span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>mm <span class="ot">&lt;-</span> z</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># model_list specification </span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>mod_list <span class="ot">=</span> <span class="fu">list</span>(<span class="at">m =</span> mm, <span class="at">R =</span> <span class="st">"diagonal and equal"</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="do">## list with model inits</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x0 =</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="dv">0</span>, mm), mm, <span class="dv">1</span>))</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="do">## list with model control parameters</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co">#con_list &lt;- list(maxit = 3000, allow.degen = TRUE)</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>con_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">maxit =</span> <span class="dv">3000</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="do">## fit MARSS</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>dfa <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(<span class="at">y =</span> dat, <span class="at">model =</span> mod_list, <span class="at">inits =</span> init_list, <span class="at">control =</span> con_list, <span class="at">covariates =</span> <span class="fu">t</span>(cov_df),<span class="at">form=</span><span class="st">"dfa"</span>,</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">method=</span><span class="st">"BFGS"</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="co"># get model results</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>Z_AIC[z,<span class="st">"states"</span>] <span class="ot">=</span> z</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>Z_AIC[z,<span class="st">"AICc"</span>] <span class="ot">=</span> dfa<span class="sc">$</span>AICc</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Success! Converged in 249 iterations.
Function MARSSkfas used for likelihood calculation.

MARSS fit is
Estimation method: BFGS 
Estimation converged in 249 iterations. 
Log-likelihood: -1024.354 
AIC: 2138.707   AICc: 2143.636   
 
                           Estimate
Z.11                      -0.409256
Z.21                      -0.085674
Z.31                       0.037819
Z.41                      -0.123284
R.diag                     0.488030
D.(Cyclops,Temp)          -0.065049
D.(Diaptomus,Temp)        -0.523167
D.(Epischura,Temp)         0.316483
D.(Neomysis,Temp)         -0.303331
D.(Cyclops,TP)            -0.095264
D.(Diaptomus,TP)           0.231892
D.(Epischura,TP)           0.033164
D.(Neomysis,TP)            0.131168
D.(Cyclops,pH)             0.056657
D.(Diaptomus,pH)           0.236882
D.(Epischura,pH)           0.029319
D.(Neomysis,pH)            0.160363
D.(Cyclops,Cryptomonas)    0.039220
D.(Diaptomus,Cryptomonas) -0.121052
D.(Epischura,Cryptomonas) -0.112211
D.(Neomysis,Cryptomonas)   0.073532
D.(Cyclops,Diatoms)        0.163895
D.(Diaptomus,Diatoms)     -0.069667
D.(Epischura,Diatoms)     -0.048028
D.(Neomysis,Diatoms)       0.213371
D.(Cyclops,Greens)         0.053764
D.(Diaptomus,Greens)      -0.028448
D.(Epischura,Greens)      -0.113465
D.(Neomysis,Greens)       -0.000335
D.(Cyclops,Unicells)       0.140911
D.(Diaptomus,Unicells)     0.063897
D.(Epischura,Unicells)     0.072608
D.(Neomysis,Unicells)      0.408725
D.(Cyclops,Other.algae)    0.179521
D.(Diaptomus,Other.algae)  0.150101
D.(Epischura,Other.algae)  0.110116
D.(Neomysis,Other.algae)   0.012215
D.(Cyclops,cos_t)         -0.063268
D.(Diaptomus,cos_t)       -0.859093
D.(Epischura,cos_t)       -0.249775
D.(Neomysis,cos_t)         0.164887
D.(Cyclops,sin_t)          0.018376
D.(Diaptomus,sin_t)       -0.166333
D.(Epischura,sin_t)       -0.261342
D.(Neomysis,sin_t)        -0.458475
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.

Success! Converged in 149 iterations.
Function MARSSkfas used for likelihood calculation.

MARSS fit is
Estimation method: BFGS 
Estimation converged in 149 iterations. 
Log-likelihood: -996.0389 
AIC: 2088.078   AICc: 2093.698   
 
                          Estimate
Z.11                       0.51102
Z.21                       0.09199
Z.31                      -0.02876
Z.41                       0.17171
Z.22                       0.21251
Z.32                       0.26970
Z.42                       0.35452
R.diag                     0.34476
D.(Cyclops,Temp)          -0.06169
D.(Diaptomus,Temp)        -0.25739
D.(Epischura,Temp)         0.64454
D.(Neomysis,Temp)         -0.20214
D.(Cyclops,TP)            -0.05364
D.(Diaptomus,TP)           0.15449
D.(Epischura,TP)          -0.09795
D.(Neomysis,TP)           -0.11774
D.(Cyclops,pH)             0.08388
D.(Diaptomus,pH)           0.25524
D.(Epischura,pH)           0.04539
D.(Neomysis,pH)            0.12654
D.(Cyclops,Cryptomonas)    0.01336
D.(Diaptomus,Cryptomonas) -0.04458
D.(Epischura,Cryptomonas) -0.01202
D.(Neomysis,Cryptomonas)   0.14311
D.(Cyclops,Diatoms)        0.17870
D.(Diaptomus,Diatoms)     -0.07581
D.(Epischura,Diatoms)     -0.05458
D.(Neomysis,Diatoms)       0.17580
D.(Cyclops,Greens)         0.04206
D.(Diaptomus,Greens)      -0.04019
D.(Epischura,Greens)      -0.12482
D.(Neomysis,Greens)       -0.03046
D.(Cyclops,Unicells)       0.13016
D.(Diaptomus,Unicells)     0.14890
D.(Epischura,Unicells)     0.18534
D.(Neomysis,Unicells)      0.38306
D.(Cyclops,Other.algae)    0.16850
D.(Diaptomus,Other.algae)  0.11865
D.(Epischura,Other.algae)  0.06715
D.(Neomysis,Other.algae)   0.08263
D.(Cyclops,cos_t)         -0.04527
D.(Diaptomus,cos_t)       -0.63731
D.(Epischura,cos_t)        0.02794
D.(Neomysis,cos_t)         0.27837
D.(Cyclops,sin_t)         -0.00718
D.(Diaptomus,sin_t)        0.13341
D.(Epischura,sin_t)        0.11016
D.(Neomysis,sin_t)        -0.55392
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.

Success! Converged in 98 iterations.
Function MARSSkfas used for likelihood calculation.

MARSS fit is
Estimation method: BFGS 
Estimation converged in 98 iterations. 
Log-likelihood: -987.4889 
AIC: 2074.978   AICc: 2081.086   
 
                          Estimate
Z.11                       0.56026
Z.21                       0.04680
Z.31                      -0.00770
Z.41                      -0.04569
Z.22                       0.25015
Z.32                       0.19845
Z.42                      -0.01738
Z.33                       0.26252
Z.43                      -0.42960
R.diag                     0.27253
D.(Cyclops,Temp)          -0.03206
D.(Diaptomus,Temp)        -0.14084
D.(Epischura,Temp)         0.60999
D.(Neomysis,Temp)         -0.43617
D.(Cyclops,TP)            -0.07321
D.(Diaptomus,TP)           0.07316
D.(Epischura,TP)          -0.32876
D.(Neomysis,TP)            0.59368
D.(Cyclops,pH)             0.10745
D.(Diaptomus,pH)           0.17570
D.(Epischura,pH)           0.05978
D.(Neomysis,pH)           -0.08374
D.(Cyclops,Cryptomonas)   -0.00454
D.(Diaptomus,Cryptomonas) -0.00743
D.(Epischura,Cryptomonas) -0.04024
D.(Neomysis,Cryptomonas)   0.22687
D.(Cyclops,Diatoms)        0.19107
D.(Diaptomus,Diatoms)     -0.08444
D.(Epischura,Diatoms)     -0.01549
D.(Neomysis,Diatoms)      -0.06037
D.(Cyclops,Greens)         0.03182
D.(Diaptomus,Greens)      -0.03804
D.(Epischura,Greens)      -0.12765
D.(Neomysis,Greens)       -0.08265
D.(Cyclops,Unicells)       0.12570
D.(Diaptomus,Unicells)     0.20328
D.(Epischura,Unicells)     0.16806
D.(Neomysis,Unicells)      0.64863
D.(Cyclops,Other.algae)    0.15741
D.(Diaptomus,Other.algae)  0.11430
D.(Epischura,Other.algae)  0.03705
D.(Neomysis,Other.algae)  -0.09653
D.(Cyclops,cos_t)         -0.00337
D.(Diaptomus,cos_t)       -0.60106
D.(Epischura,cos_t)        0.05494
D.(Neomysis,cos_t)        -0.38579
D.(Cyclops,sin_t)          0.00975
D.(Diaptomus,sin_t)        0.30047
D.(Epischura,sin_t)        0.04593
D.(Neomysis,sin_t)        -0.47729
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>Z_AIC<span class="sc">$</span>AICc <span class="ot">=</span> Z_AIC<span class="sc">$</span>AICc<span class="sc">-</span> <span class="fu">min</span>(Z_AIC<span class="sc">$</span>AICc)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>Z_AIC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  states     AICc
1      1 62.55018
2      2 12.61220
3      3  0.00000</code></pre>
</div>
</div>
<p>Best performing based on AICc is the one with 3 states.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">## list with specifications for model vectors/matrices</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># mod_list &lt;- list(Z = ZZ[[2]], A = aa, D = DD, d = dd, R = RR,</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">#                  B = BB, U = uu, C = CC, c = cc, Q = QQ)</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>mm <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># model_list specification </span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>mod_list <span class="ot">=</span> <span class="fu">list</span>(<span class="at">m =</span> mm, <span class="at">R =</span> <span class="st">"diagonal and equal"</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="do">## list with model inits</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x0 =</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="dv">0</span>, mm), mm, <span class="dv">1</span>))</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="do">## fit MARSS</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>dfa_2 <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(<span class="at">y =</span> dat, <span class="at">model =</span> mod_list, <span class="at">inits =</span> init_list, <span class="at">control =</span> con_list, <span class="at">covariates =</span> <span class="fu">t</span>(cov_df),<span class="at">form=</span><span class="st">"dfa"</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">method=</span><span class="st">"BFGS"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Success! Converged in 98 iterations.
Function MARSSkfas used for likelihood calculation.

MARSS fit is
Estimation method: BFGS 
Estimation converged in 98 iterations. 
Log-likelihood: -987.4889 
AIC: 2074.978   AICc: 2081.086   
 
                          Estimate
Z.11                       0.56026
Z.21                       0.04680
Z.31                      -0.00770
Z.41                      -0.04569
Z.22                       0.25015
Z.32                       0.19845
Z.42                      -0.01738
Z.33                       0.26252
Z.43                      -0.42960
R.diag                     0.27253
D.(Cyclops,Temp)          -0.03206
D.(Diaptomus,Temp)        -0.14084
D.(Epischura,Temp)         0.60999
D.(Neomysis,Temp)         -0.43617
D.(Cyclops,TP)            -0.07321
D.(Diaptomus,TP)           0.07316
D.(Epischura,TP)          -0.32876
D.(Neomysis,TP)            0.59368
D.(Cyclops,pH)             0.10745
D.(Diaptomus,pH)           0.17570
D.(Epischura,pH)           0.05978
D.(Neomysis,pH)           -0.08374
D.(Cyclops,Cryptomonas)   -0.00454
D.(Diaptomus,Cryptomonas) -0.00743
D.(Epischura,Cryptomonas) -0.04024
D.(Neomysis,Cryptomonas)   0.22687
D.(Cyclops,Diatoms)        0.19107
D.(Diaptomus,Diatoms)     -0.08444
D.(Epischura,Diatoms)     -0.01549
D.(Neomysis,Diatoms)      -0.06037
D.(Cyclops,Greens)         0.03182
D.(Diaptomus,Greens)      -0.03804
D.(Epischura,Greens)      -0.12765
D.(Neomysis,Greens)       -0.08265
D.(Cyclops,Unicells)       0.12570
D.(Diaptomus,Unicells)     0.20328
D.(Epischura,Unicells)     0.16806
D.(Neomysis,Unicells)      0.64863
D.(Cyclops,Other.algae)    0.15741
D.(Diaptomus,Other.algae)  0.11430
D.(Epischura,Other.algae)  0.03705
D.(Neomysis,Other.algae)  -0.09653
D.(Cyclops,cos_t)         -0.00337
D.(Diaptomus,cos_t)       -0.60106
D.(Epischura,cos_t)        0.05494
D.(Neomysis,cos_t)        -0.38579
D.(Cyclops,sin_t)          0.00975
D.(Diaptomus,sin_t)        0.30047
D.(Epischura,sin_t)        0.04593
D.(Neomysis,sin_t)        -0.47729
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.</code></pre>
</div>
</div>
<p>#Rotating trends and loadings</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">## get the estimated ZZ</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>Z_est <span class="ot">&lt;-</span> <span class="fu">coef</span>(dfa_2, <span class="at">type =</span> <span class="st">"matrix"</span>)<span class="sc">$</span>Z</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="do">## get the inverse of the rotation matrix</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>H_inv <span class="ot">&lt;-</span> <span class="fu">varimax</span>(Z_est)<span class="sc">$</span>rotmat</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Now rotate both Z and x</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="do">## rotate factor loadings</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>Z_rot <span class="ot">=</span> Z_est <span class="sc">%*%</span> H_inv   </span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="do">## rotate processes</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>proc_rot <span class="ot">=</span> <span class="fu">solve</span>(H_inv) <span class="sc">%*%</span> dfa_2<span class="sc">$</span>states</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>#Estimated States and Loadings of Model with 3 states</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="do">## plot labels</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>zooplankton_names <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Cyclops"</span>, <span class="st">"Diaptomus"</span>, <span class="st">"Epischura"</span>, <span class="st">"Neomysis"</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>ylbl <span class="ot">&lt;-</span> zooplankton_names</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>w_ts <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">dim</span>(dat)[<span class="dv">2</span>])</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co"># plot colors</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>clr <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"brown"</span>, <span class="st">"blue"</span>, <span class="st">"darkgreen"</span>, <span class="st">"darkred"</span>, <span class="st">"purple"</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="do">## set up plot area</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>), mm, <span class="dv">2</span>), <span class="at">widths =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span>), <span class="at">omi =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="do">## plot the processes</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>mm) {</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  ylm <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(proc_rot[i,]))</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up plot area</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(w_ts,proc_rot[i,], <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">bty =</span> <span class="st">"L"</span>,</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">ylim =</span> ylm, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">xaxt =</span> <span class="st">"n"</span>)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="do">## draw zero-line</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"gray"</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="do">## plot trend line</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(w_ts, proc_rot[i,], <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(w_ts, proc_rot[i,], <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    <span class="do">## add panel labels</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mtext</span>(<span class="fu">paste</span>(<span class="st">"State"</span>,i), <span class="at">side =</span> <span class="dv">3</span>, <span class="at">line =</span> <span class="fl">0.5</span>)</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axis</span>(<span class="dv">1</span>, <span class="dv">12</span> <span class="sc">*</span> (<span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(dat)[<span class="dv">2</span>]) <span class="sc">+</span> <span class="dv">1</span>, yr_frst <span class="sc">+</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(dat)[<span class="dv">2</span>])</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="do">## plot the loadings</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>minZ <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>ylm <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(Z_rot))</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>mm) {</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(i)</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N_ts)[<span class="fu">abs</span>(Z_rot[,i])<span class="sc">&gt;</span>minZ],</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">as.vector</span>(Z_rot[<span class="fu">abs</span>(Z_rot[,i])<span class="sc">&gt;</span>minZ,i]),</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>       <span class="at">type =</span> <span class="st">"h"</span>,</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">ylim =</span> ylm,</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlim =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, N_ts <span class="sc">+</span> <span class="fl">0.5</span>), <span class="at">col =</span> clr)</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N_ts) {</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(Z_rot[j,i] <span class="sc">&gt;</span> minZ) {<span class="fu">text</span>(j, <span class="sc">-</span><span class="fl">0.03</span>, ylbl[j], <span class="at">srt =</span> <span class="dv">90</span>, <span class="at">adj =</span> <span class="dv">1</span>, <span class="at">cex =</span> <span class="fl">1.2</span>, <span class="at">col =</span> clr[j])}</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(Z_rot[j,i] <span class="sc">&lt;</span> <span class="sc">-</span>minZ) {<span class="fu">text</span>(j, <span class="fl">0.03</span>, ylbl[j], <span class="at">srt =</span> <span class="dv">90</span>, <span class="at">adj =</span> <span class="dv">0</span>, <span class="at">cex =</span> <span class="fl">1.2</span>, <span class="at">col =</span> clr[j])}</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lwd =</span> <span class="fl">1.5</span>, <span class="at">col =</span> <span class="st">"gray"</span>)</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>      } </span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mtext</span>(<span class="fu">paste</span>(<span class="st">"Factor loadings on state"</span>, i), <span class="at">side =</span> <span class="dv">3</span>, <span class="at">line =</span> <span class="fl">0.5</span>)</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-3_final_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="do">## list with specifications for model vectors/matrices</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># mod_list &lt;- list(Z = ZZ[[3]], A = aa, D = DD, d = dd, R = RR,</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">#                  B = BB, U = uu, C = CC, c = cc, Q = QQ)</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>mm <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>mod_list <span class="ot">=</span> <span class="fu">list</span>(<span class="at">m =</span> mm, <span class="at">R =</span> <span class="st">"diagonal and equal"</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="do">## list with model inits</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x0 =</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="dv">0</span>, mm), mm, <span class="dv">1</span>))</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="do">## list with model control parameters</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co">#con_list &lt;- list(maxit = 3000, allow.degen = F)</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>con_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">maxit =</span> <span class="dv">3000</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Forward stepwise model selection</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a table of indicators as to whether that predictor is include</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="co">#cov.terms &lt;- c(covs,"seasonality")</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>cov.terms<span class="ot">&lt;-</span>covs <span class="co">#seasonality is causing an issue so running without this</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>mod.ind <span class="ot">&lt;-</span> <span class="fu">matrix</span>(F, <span class="at">ncol =</span> <span class="fu">length</span>(cov.terms), <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>mod.tab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(mod.ind)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(mod.tab) <span class="ot">&lt;-</span> cov.terms</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a columns for storing model selection</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>mod.tab<span class="sc">$</span>AICc <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a><span class="co"># to keep track of the best model so far</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>k_counter <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a><span class="co"># save the fits in a list</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>DFA_fits <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(cov.terms)<span class="sc">+</span><span class="dv">1</span>)){</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(i)</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>  model_i <span class="ot">&lt;-</span> i</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>  ind_on<span class="ot">=</span><span class="fu">as.matrix</span>(mod.tab[i,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(cov.terms)])</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ind_off=as.matrix(!mod.tab[i,1:length(mod.terms)])</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ind_off &lt;- !mod.ind[model_i, ]</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ind_on &lt;- mod.ind[model_i, ]</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set which covariates should be included</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(cov.terms[ind_on])<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>    cov_data <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    cov_data <span class="ot">=</span>  cov_df <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">matches</span>(cov.terms[ind_on])) <span class="sc">%&gt;%</span> <span class="fu">t</span>()</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">"seasonality"</span> <span class="sc">%in%</span> cov.terms[ind_on]){ <span class="co"># special case where you have 2 columns for seasonality</span></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>    cov_data <span class="ot">=</span> <span class="fu">rbind</span>(cov_data,dd)</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fit the model</span></span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>  dfa_model <span class="ot">=</span> <span class="fu">MARSS</span>(<span class="at">y =</span> dat, <span class="at">model =</span> mod_list, <span class="at">form =</span> <span class="st">"dfa"</span>,<span class="at">inits =</span> init_list, <span class="at">control =</span> con_list,<span class="at">covariates=</span>cov_data,</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>                    <span class="at">method=</span><span class="st">"BFGS"</span>)</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>  <span class="co">#save thi fit</span></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>  DFA_fits[[i]] <span class="ot">=</span> <span class="fu">get_DFA_fits</span>(dfa_model,<span class="at">dd=</span>cov_data)</span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add AICc valueto model</span></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>  mod.tab[i,]<span class="sc">$</span>AICc <span class="ot">&lt;-</span> dfa_model<span class="sc">$</span>AICc</span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add new row and reset the AICc</span></span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>  mod.tab[i<span class="sc">+</span><span class="dv">1</span>,] <span class="ot">=</span> mod.tab[i,]</span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>  mod.tab[i<span class="sc">+</span><span class="dv">1</span>,]<span class="sc">$</span>AICc <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># turn the next random effect on for next model</span></span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>  mod.tab[i<span class="sc">+</span><span class="dv">1</span>,i] <span class="ot">=</span> T</span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i<span class="sc">&gt;</span><span class="dv">1</span>){ <span class="co"># don't perform below to populate the 2nd row and 1st random effect</span></span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if model is better than the best performing model so far, keep the current random effect on for next model</span></span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((mod.tab<span class="sc">$</span>AICc[i]<span class="sc">-</span>mod.tab<span class="sc">$</span>AICc[i<span class="sc">-</span>k_counter])<span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">4</span>){</span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a>    mod.tab[i<span class="sc">+</span><span class="dv">1</span>,i<span class="dv">-1</span>] <span class="ot">=</span> T <span class="co"># redundant but just set up the code</span></span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a>    k_counter <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { <span class="co"># if not better</span></span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a>    mod.tab[i<span class="sc">+</span><span class="dv">1</span>,i<span class="dv">-1</span>] <span class="ot">=</span> F <span class="co"># turn off current random effect for next model</span></span>
<span id="cb26-73"><a href="#cb26-73" aria-hidden="true" tabindex="-1"></a>    k_counter<span class="ot">=</span>k_counter<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb26-74"><a href="#cb26-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-75"><a href="#cb26-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-76"><a href="#cb26-76" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1
Success! Converged in 44 iterations.
Function MARSSkfas used for likelihood calculation.

MARSS fit is
Estimation method: BFGS 
Estimation converged in 44 iterations. 
Log-likelihood: -1121.846 
AIC: 2263.693   AICc: 2263.944   
 
       Estimate
Z.11    -0.6812
Z.21    -0.1991
Z.31    -0.0863
Z.41    -0.3488
Z.22     0.5621
Z.32     0.1966
Z.42     0.1649
Z.33     0.6705
Z.43     0.7343
R.diag   0.1941
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.

[1] 2
Success! Converged in 38 iterations.
Function MARSSkfas used for likelihood calculation.

MARSS fit is
Estimation method: BFGS 
Estimation converged in 38 iterations. 
Log-likelihood: -1084.73 
AIC: 2197.459   AICc: 2197.942   
 
            Estimate
Z.11         -0.6596
Z.21         -0.2015
Z.31         -0.0140
Z.41         -0.0481
Z.22          0.5552
Z.32          0.1622
Z.42          0.1745
Z.33         -0.4205
Z.43          0.8209
R.diag        0.2209
D.Cyclops     0.1261
D.Diaptomus   0.0688
D.Epischura   0.6571
D.Neomysis   -0.0951
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.

[1] 3
Success! Converged in 43 iterations.
Function MARSSkfas used for likelihood calculation.

MARSS fit is
Estimation method: BFGS 
Estimation converged in 43 iterations. 
Log-likelihood: -1078.97 
AIC: 2193.941   AICc: 2194.73   
 
                    Estimate
Z.11                0.659277
Z.21                0.194425
Z.31                0.000501
Z.41                0.038917
Z.22                0.558411
Z.32                0.147317
Z.42                0.125531
Z.33               -0.421475
Z.43                0.823533
R.diag              0.215517
D.(Cyclops,Temp)    0.110790
D.(Diaptomus,Temp)  0.050490
D.(Epischura,Temp)  0.622253
D.(Neomysis,Temp)  -0.012807
D.(Cyclops,TP)     -0.121674
D.(Diaptomus,TP)   -0.150452
D.(Epischura,TP)   -0.274848
D.(Neomysis,TP)     0.626019
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.

[1] 4
Success! Converged in 65 iterations.
Function MARSSkfas used for likelihood calculation.

MARSS fit is
Estimation method: BFGS 
Estimation converged in 65 iterations. 
Log-likelihood: -1049.945 
AIC: 2135.891   AICc: 2136.68   
 
                   Estimate
Z.11                0.65212
Z.21                0.13828
Z.31                0.00429
Z.41                0.32362
Z.22                0.45997
Z.32                0.18022
Z.42                0.19750
Z.33               -0.44988
Z.43               -0.86136
R.diag              0.20655
D.(Cyclops,Temp)    0.06180
D.(Diaptomus,Temp) -0.06508
D.(Epischura,Temp)  0.61027
D.(Neomysis,Temp)   0.27165
D.(Cyclops,pH)      0.20242
D.(Diaptomus,pH)    0.43172
D.(Epischura,pH)    0.12069
D.(Neomysis,pH)     0.22910
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.

[1] 5
Success! Converged in 73 iterations.
Function MARSSkfas used for likelihood calculation.

MARSS fit is
Estimation method: BFGS 
Estimation converged in 73 iterations. 
Log-likelihood: -1048.094 
AIC: 2140.187   AICc: 2141.36   
 
                          Estimate
Z.11                       0.65214
Z.21                       0.13643
Z.31                       0.00874
Z.41                       0.30205
Z.22                       0.46086
Z.32                       0.17603
Z.42                       0.24398
Z.33                      -0.44613
Z.43                      -0.82999
R.diag                     0.20671
D.(Cyclops,Temp)           0.06537
D.(Diaptomus,Temp)        -0.06469
D.(Epischura,Temp)         0.60517
D.(Neomysis,Temp)          0.27450
D.(Cyclops,pH)             0.20336
D.(Diaptomus,pH)           0.43133
D.(Epischura,pH)           0.12576
D.(Neomysis,pH)            0.20074
D.(Cyclops,Cryptomonas)    0.03145
D.(Diaptomus,Cryptomonas)  0.00741
D.(Epischura,Cryptomonas) -0.04725
D.(Neomysis,Cryptomonas)   0.18123
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.

[1] 6
Success! Converged in 78 iterations.
Function MARSSkfas used for likelihood calculation.

MARSS fit is
Estimation method: BFGS 
Estimation converged in 78 iterations. 
Log-likelihood: -1039.78 
AIC: 2123.56   AICc: 2124.732   
 
                      Estimate
Z.11                    0.6137
Z.21                    0.1038
Z.31                    0.0101
Z.41                    0.3218
Z.22                    0.4403
Z.32                    0.1903
Z.42                    0.2234
Z.33                   -0.4350
Z.43                   -0.8227
R.diag                  0.2154
D.(Cyclops,Temp)        0.1062
D.(Diaptomus,Temp)     -0.0456
D.(Epischura,Temp)      0.6085
D.(Neomysis,Temp)       0.2877
D.(Cyclops,pH)          0.1463
D.(Diaptomus,pH)        0.4120
D.(Epischura,pH)        0.1242
D.(Neomysis,pH)         0.2033
D.(Cyclops,Diatoms)     0.2421
D.(Diaptomus,Diatoms)   0.1223
D.(Epischura,Diatoms)  -0.0158
D.(Neomysis,Diatoms)    0.0878
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.

[1] 7
Success! Converged in 84 iterations.
Function MARSSkfas used for likelihood calculation.

MARSS fit is
Estimation method: BFGS 
Estimation converged in 84 iterations. 
Log-likelihood: -1036.829 
AIC: 2125.658   AICc: 2127.292   
 
                      Estimate
Z.11                   0.60938
Z.21                   0.10170
Z.31                   0.02033
Z.41                   0.32875
Z.22                   0.43355
Z.32                   0.19481
Z.42                   0.23205
Z.33                  -0.41443
Z.43                  -0.77637
R.diag                 0.22083
D.(Cyclops,Temp)       0.09683
D.(Diaptomus,Temp)    -0.05462
D.(Epischura,Temp)     0.65018
D.(Neomysis,Temp)      0.32025
D.(Cyclops,pH)         0.14659
D.(Diaptomus,pH)       0.41604
D.(Epischura,pH)       0.12483
D.(Neomysis,pH)        0.18919
D.(Cyclops,Diatoms)    0.24149
D.(Diaptomus,Diatoms)  0.12213
D.(Epischura,Diatoms) -0.00695
D.(Neomysis,Diatoms)   0.09355
D.(Cyclops,Greens)     0.02451
D.(Diaptomus,Greens)   0.02080
D.(Epischura,Greens)  -0.11787
D.(Neomysis,Greens)   -0.07966
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.

[1] 8
Success! Converged in 55 iterations.
Function MARSSkfas used for likelihood calculation.

MARSS fit is
Estimation method: BFGS 
Estimation converged in 55 iterations. 
Log-likelihood: -1030.414 
AIC: 2112.828   AICc: 2114.462   
 
                       Estimate
Z.11                    0.55888
Z.21                    0.07382
Z.31                   -0.00313
Z.41                   -0.06586
Z.22                    0.31565
Z.32                    0.17463
Z.42                   -0.01113
Z.33                   -0.24226
Z.43                    0.43438
R.diag                  0.30465
D.(Cyclops,Temp)        0.06874
D.(Diaptomus,Temp)     -0.15302
D.(Epischura,Temp)      0.59943
D.(Neomysis,Temp)      -0.27480
D.(Cyclops,pH)          0.10872
D.(Diaptomus,pH)        0.45677
D.(Epischura,pH)        0.03487
D.(Neomysis,pH)        -0.05291
D.(Cyclops,Diatoms)     0.23175
D.(Diaptomus,Diatoms)   0.08356
D.(Epischura,Diatoms)  -0.01452
D.(Neomysis,Diatoms)   -0.03756
D.(Cyclops,Unicells)    0.14242
D.(Diaptomus,Unicells)  0.25199
D.(Epischura,Unicells)  0.14616
D.(Neomysis,Unicells)   0.61045
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.

[1] 9
Success! Converged in 97 iterations.
Function MARSSkfas used for likelihood calculation.

MARSS fit is
Estimation method: BFGS 
Estimation converged in 97 iterations. 
Log-likelihood: -1025.751 
AIC: 2111.502   AICc: 2113.677   
 
                           Estimate
Z.11                       0.546492
Z.21                       0.061655
Z.31                      -0.014601
Z.41                      -0.057123
Z.22                       0.315893
Z.32                       0.166549
Z.42                       0.000764
Z.33                      -0.246129
Z.43                       0.442295
R.diag                     0.302291
D.(Cyclops,Temp)          -0.017451
D.(Diaptomus,Temp)        -0.206436
D.(Epischura,Temp)         0.564237
D.(Neomysis,Temp)         -0.239335
D.(Cyclops,pH)             0.099450
D.(Diaptomus,pH)           0.449551
D.(Epischura,pH)           0.033059
D.(Neomysis,pH)           -0.048971
D.(Cyclops,Diatoms)        0.194209
D.(Diaptomus,Diatoms)      0.058776
D.(Epischura,Diatoms)     -0.029754
D.(Neomysis,Diatoms)      -0.024733
D.(Cyclops,Unicells)       0.121335
D.(Diaptomus,Unicells)     0.238873
D.(Epischura,Unicells)     0.137600
D.(Neomysis,Unicells)      0.630173
D.(Cyclops,Other.algae)    0.165537
D.(Diaptomus,Other.algae)  0.102159
D.(Epischura,Other.algae)  0.065119
D.(Neomysis,Other.algae)  -0.069964
Initial states (x0) defined at t=0

Standard errors have not been calculated. 
Use MARSSparamCIs to compute CIs and bias estimates.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>mod.tab</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    Temp    TP    pH Cryptomonas Diatoms Greens Unicells Other.algae     AICc
1  FALSE FALSE FALSE       FALSE   FALSE  FALSE    FALSE       FALSE 2263.944
2   TRUE FALSE FALSE       FALSE   FALSE  FALSE    FALSE       FALSE 2197.942
3   TRUE  TRUE FALSE       FALSE   FALSE  FALSE    FALSE       FALSE 2194.730
4   TRUE FALSE  TRUE       FALSE   FALSE  FALSE    FALSE       FALSE 2136.680
5   TRUE FALSE  TRUE        TRUE   FALSE  FALSE    FALSE       FALSE 2141.360
6   TRUE FALSE  TRUE       FALSE    TRUE  FALSE    FALSE       FALSE 2124.732
7   TRUE FALSE  TRUE       FALSE    TRUE   TRUE    FALSE       FALSE 2127.292
8   TRUE FALSE  TRUE       FALSE    TRUE  FALSE     TRUE       FALSE 2114.462
9   TRUE FALSE  TRUE       FALSE    TRUE  FALSE     TRUE        TRUE 2113.677
10  TRUE FALSE  TRUE       FALSE    TRUE  FALSE     TRUE       FALSE    1.000</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="do">##ZR:I don't think there should be a model #10 so I'm just removing this...</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>mod.tab<span class="ot">&lt;-</span>mod.tab[<span class="sc">-</span><span class="dv">10</span>,]</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>mod.tab<span class="sc">$</span>DeltaAICc<span class="ot">&lt;-</span>mod.tab<span class="sc">$</span>AICc <span class="sc">-</span> <span class="fu">min</span>(mod.tab<span class="sc">$</span>AICc)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="do">## get model fits &amp; CI's</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>best_model_i <span class="ot">=</span> <span class="dv">8</span> <span class="co">#number 8 is simpler and similar AICc </span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>mod_fit <span class="ot">&lt;-</span> DFA_fits[[best_model_i]]</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="do">## plot the fits</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(N_ts, <span class="dv">1</span>), <span class="at">mai =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>), <span class="at">omi =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N_ts) {</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  up <span class="ot">&lt;-</span> mod_fit<span class="sc">$</span>up[i,]</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  mn <span class="ot">&lt;-</span> mod_fit<span class="sc">$</span>ex[i,]</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  lo <span class="ot">&lt;-</span> mod_fit<span class="sc">$</span>lo[i,]</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(w_ts, mn, <span class="at">type =</span> <span class="st">"n"</span>,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> ylbl[i],</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">cex.lab =</span> <span class="fl">1.2</span>,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(lo), <span class="fu">max</span>(up)))</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">1</span>, <span class="dv">12</span> <span class="sc">*</span> (<span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(dat)[<span class="dv">2</span>]) <span class="sc">+</span> <span class="dv">1</span>, yr_frst <span class="sc">+</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(dat)[<span class="dv">2</span>])</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(w_ts, dat[i,], <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> clr[i])</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, up, <span class="at">col =</span> <span class="st">"darkgray"</span>)</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, mn, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_ts, lo, <span class="at">col =</span> <span class="st">"darkgray"</span>)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab-3-team-3_final_files/figure-html/fit the best model-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="results" class="level1">
<h1>Results</h1>
<p>Model results can be found above in the code outputs. Models 8 and 9 had similar AICcs so we chose the simpler model (#8) The best model had 3 states, and included covariates for temperature, pH, diatoms and unicells.</p>
</section>
<section id="discussion" class="level1">
<h1>Discussion</h1>
<p>Our results suggest that the best DFA model fit to time series of 4 groups of zooplankton(Cyclops, Diaptomus, Epischura, and Neomysis) included 3 states and covariates for temperature pH, diatoms and unicells. Copepods are known to prefer diatoms over other forms of phytoplankton <span class="citation" data-cites="kleppel1993">(<a href="#ref-kleppel1993" role="doc-biblioref">Kleppel 1993</a>)</span> , so it makes sense that this would be an important covariate. Using a DFA did not greatly reduce the dimensionality of our dataset (we went from 4 species groups to 3), but maybe this affect would have been greater if we had used a larger set of the zooplankton groups.</p>
</section>
<section id="team-contributions" class="level1">
<h1>Team Contributions</h1>
<p>All team members helped decide the question and plan for the analysis. ZR did the data wrangling for the zooplankton and the covariates, and checked for correlation issues with the covariates. NC wrote the matrix models in the methods section. NC and TW fit the models for different states using all the covariates. TW did the model selection for the different covariates. ZR helped with debugging the code, and wrote the discussion.</p>
</section>
<section id="references" class="level1">
<h1>References</h1>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-hansen1997" class="csl-entry" role="listitem">
Hansen, Per Juel, Peter Koefoed Bjørnsen, and Benni Winding Hansen. 1997. <span>“Zooplankton Grazing and Growth: Scaling Within the 2-2,-Μm Body Size Range.”</span> <em>Limnology and Oceanography</em> 42 (4): 687–704. <a href="https://doi.org/10.4319/lo.1997.42.4.0687">https://doi.org/10.4319/lo.1997.42.4.0687</a>.
</div>
<div id="ref-kleppel1993" class="csl-entry" role="listitem">
Kleppel, GS. 1993. <span>“On the Diets of Calanoid Copepods.”</span> <em>Marine Ecology Progress Series</em> 99: 183–95. <a href="https://doi.org/10.3354/meps099183">https://doi.org/10.3354/meps099183</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/atsa-es\.github\.io\/fish550-2023\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="atsa-es/fish550-2023" data-repo-id="R_kgDOJGNymQ" data-category="General" data-category-id="DIC_kwDOJGNymc4CUsbe" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../Lab-3/Final_Write_ups/Lab-3-team-2_final.html" class="pagination-link" aria-label="Team 2 - Lab 3">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Team 2 - Lab 3</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../Lab-3/Final_Write_ups/Lab-3-team-4_final.html" class="pagination-link" aria-label="Team 4 - Lab 3">
        <span class="nav-page-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Team 4 - Lab 3</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb31" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Team 3 - Lab 3"</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Dynamic Factor Analysis (DFA)"</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Nick Chambers, Terrance Wang, Zoe Rand"</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> May 2, 2023</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="an">output:</span><span class="co"> </span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html_document:</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-folding: true</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co">    toc_float: true</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> team3-lab3-references.bib</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include = FALSE}</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="in">options(dplyr.summarise.inform = FALSE)</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning = FALSE, message = FALSE}</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="in">library(zoo)</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="in">get_DFA_fits &lt;- function(MLEobj, dd = NULL, alpha = 0.05) {</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="in">    ## empty list for results</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="in">    fits &lt;- list()</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a><span class="in">    ## extra stuff for var() calcs</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="in">    Ey &lt;- MARSS:::MARSShatyt(MLEobj)</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="in">    ## model params</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="in">    ZZ &lt;- coef(MLEobj, type = "matrix")$Z</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a><span class="in">    ## number of obs ts</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="in">    nn &lt;- dim(Ey$ytT)[1]</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="in">    ## number of time steps</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a><span class="in">    TT &lt;- dim(Ey$ytT)[2]</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a><span class="in">    ## get the inverse of the rotation matrix</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="in">    H_inv &lt;- varimax(ZZ)$rotmat</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="in">    ## check for covars</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="in">    if (!is.null(dd)) {</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="in">        DD &lt;- coef(MLEobj, type = "matrix")$D</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a><span class="in">        ## model expectation</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a><span class="in">        fits$ex &lt;- ZZ %*% H_inv %*% MLEobj$states + DD %*% dd</span></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="in">        ## model expectation</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a><span class="in">        fits$ex &lt;- ZZ %*% H_inv %*% MLEobj$states</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a><span class="in">    ## Var in model fits</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a><span class="in">    VtT &lt;- MARSSkfss(MLEobj)$VtT</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a><span class="in">    VV &lt;- NULL</span></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a><span class="in">    for (tt in 1:TT) {</span></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a><span class="in">        RZVZ &lt;- coef(MLEobj, type = "matrix")$R - ZZ %*% VtT[, </span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a><span class="in">            , tt] %*% t(ZZ)</span></span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a><span class="in">        SS &lt;- Ey$yxtT[, , tt] - Ey$ytT[, tt, drop = FALSE] %*% </span></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a><span class="in">            t(MLEobj$states[, tt, drop = FALSE])</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a><span class="in">        VV &lt;- cbind(VV, diag(RZVZ + SS %*% t(ZZ) + ZZ %*% t(SS)))</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a><span class="in">    SE &lt;- sqrt(VV)</span></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a><span class="in">    ## upper &amp; lower (1-alpha)% CI</span></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a><span class="in">    fits$up &lt;- qnorm(1 - alpha/2) * SE + fits$ex</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a><span class="in">    fits$lo &lt;- qnorm(alpha/2) * SE + fits$ex</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a><span class="in">    return(fits)</span></span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a><span class="fu"># Data</span></span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>We decided to model 4 groups of zooplankton: Cyclops, Diaptomus, Epischura, and Neomysis. We chose to test environmental covariates (temp, pH, TP), as well as phytoplankton abundances as covariates(cryptomonas, diatoms, greens, unicells, other.algae) since the zooplankton we chose are copepods and mysids, and therefore may be impacted by the type of phytoplankton present. We used data from the start of the time series (1962) until 1985, because the Neomysis data gets very patchy after the 1980s and we didn't want this to cause issues with model fitting.</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a><span class="fu">## Load the data</span></span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load_data}</span></span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a><span class="in">## load MARSS for data and analyses</span></span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a><span class="in">library(MARSS)</span></span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a><span class="in">## load the raw data (there are 3 datasets contained here)</span></span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a><span class="in">data(lakeWAplankton, package = "MARSS")</span></span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a><span class="in">## we want `lakeWAplanktonTrans`, which has been transformed</span></span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a><span class="in">## so the 0's are replaced with NA's and the data z-scored</span></span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a><span class="in">all_dat &lt;- lakeWAplanktonTrans</span></span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a><span class="fu">## Wrangle the data</span></span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>You can choose any taxa to include in your analyses, but make sure there are at least 5 groups. You can mix phytoplankton and zooplankton, if you'd like, but justify any choices you make.</span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>You will want to subset the data to a time period with adequate observations for the taxa of interest. Your time window should include at lest 5 years (60 months).</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a><span class="fu">### Zooplankton</span></span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot_data, warning=FALSE}</span></span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a><span class="in">## plotting the taxa of interest</span></span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a><span class="in">all_dat %&gt;% as_tibble() %&gt;%</span></span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(Date = as.yearmon(paste(Year, Month), "%Y %m")) %&gt;%</span></span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a><span class="in">  select(c("Date", "Cyclops", "Diaptomus", "Epischura", "Neomysis")) %&gt;% </span></span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(-c(Date), names_to = "Species", values_to = "Vals") %&gt;%</span></span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = Date, y = Vals, color = Species)) + geom_point() + </span></span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line() + facet_wrap(~Species) + scale_x_yearmon(format = "%Y") + </span></span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal() + labs(y = "Abundance Index", x = "Year") + theme(legend.position =  "none")</span></span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a><span class="in">```{r wrangle_data_1}</span></span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a><span class="in">#using data up to 1985</span></span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a><span class="in">spp&lt;-c("Cyclops", "Diaptomus", "Epischura", "Neomysis")</span></span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a><span class="in">dat_1985&lt;-all_dat[all_dat[, "Year"] &lt;= 1985,]</span></span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a><span class="in">dat_zoo_1985&lt;-dat_1985[, spp]</span></span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a><span class="in">#head(dat_zoo_1985)</span></span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a><span class="in">dat_zoo&lt;-t(dat_zoo_1985)</span></span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a><span class="in">yr_frst &lt;- min(dat_1985[,"Year"])</span></span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a><span class="in">yr_last &lt;- max(dat_1985[,"Year"])</span></span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a><span class="in">```{r wrangle_data_2}</span></span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a><span class="in">## get number of time series</span></span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a><span class="in">N_ts &lt;- dim(dat_zoo)[1]</span></span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a><span class="in">## get length of time series</span></span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a><span class="in">TT &lt;- dim(dat_zoo)[2] </span></span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a><span class="in">## mean of each taxon</span></span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a><span class="in">y_bar &lt;- apply(dat_zoo, 1, mean, na.rm = TRUE)</span></span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a><span class="in">## subtract the means</span></span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a><span class="in">dat &lt;- dat_zoo - y_bar</span></span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a><span class="in">## assign new row names</span></span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a><span class="in">rownames(dat) &lt;- spp</span></span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a><span class="fu">### Covariates</span></span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a><span class="in">```{r wrangle_cov }</span></span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a><span class="in">#temp, pH, TP, cryptomonas, diatoms, greens, unicells, other.algae </span></span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a><span class="in">covs&lt;-colnames(dat_1985)[c(3:8,10:11)]</span></span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a><span class="in">cov_dat&lt;-t(dat_1985[,covs])</span></span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a><span class="in">#head(cov_dat)</span></span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a><span class="in">#dummy seasonal affect</span></span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a><span class="in">cos_t &lt;- cos(2 * pi * seq(TT) / 12)</span></span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a><span class="in">sin_t &lt;- sin(2 * pi * seq(TT) / 12)</span></span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a><span class="in">dd &lt;- rbind(cos_t, sin_t)</span></span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a><span class="in">```{r cov_corr}</span></span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a><span class="in">#looking at any correlation issues for covariates</span></span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a><span class="in">pairs(cbind(dat_1985[,covs],t(dd)))</span></span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a><span class="in">library(corrplot)</span></span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a><span class="in">corrplot(cor(cbind(dat_1985[,covs],t(dd)), use = "pairwise.complete.obs"), addCoef.col = "blue")</span></span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a><span class="fu"># estimating missing values</span></span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a><span class="in">```{r estimating missing values}</span></span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a><span class="in"># Best way is in Ch13 to fill out NA, https://cran.r-project.org/web/packages/MARSS/vignettes/UserGuide.pdf</span></span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a><span class="in"># Easy way is just to fill in with mean for purposes of this lab</span></span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a><span class="in">cov_df &lt;- cbind(dat_1985[,covs],t(dd)) %&gt;% as.data.frame()  %&gt;%</span></span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a><span class="in">  # replace na values with simply mean</span></span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a><span class="in">         mutate_all(~ifelse(is.na(.x), mean(.x, na.rm = TRUE), .x))  </span></span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a><span class="fu"># General tasks</span></span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a>Each group has the same general tasks, but you will adapt them as you work on the data.</span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-166"><a href="#cb31-166" aria-hidden="true" tabindex="-1"></a>1)  Find the most parsimonious model among a set that examines the effects of environmental covariates and/or an indicator of seasonality, varying numbers of trends, and different forms of variance-covariance matrices for the observation errors.</span>
<span id="cb31-167"><a href="#cb31-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-168"><a href="#cb31-168" aria-hidden="true" tabindex="-1"></a>2)  Plot trends and individual loadings for the model identified in task (1) above.</span>
<span id="cb31-169"><a href="#cb31-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-170"><a href="#cb31-170" aria-hidden="true" tabindex="-1"></a>3)  Plot model fits and uncertainty intervals for the model identified in task (1) above.</span>
<span id="cb31-171"><a href="#cb31-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-172"><a href="#cb31-172" aria-hidden="true" tabindex="-1"></a>4)  Describe the effects of environmental or dummy variables on (possibly seasonal) patterns in the data.</span>
<span id="cb31-173"><a href="#cb31-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-174"><a href="#cb31-174" aria-hidden="true" tabindex="-1"></a><span class="fu"># Methods</span></span>
<span id="cb31-175"><a href="#cb31-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-176"><a href="#cb31-176" aria-hidden="true" tabindex="-1"></a>Please address the following in your methods:</span>
<span id="cb31-177"><a href="#cb31-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-178"><a href="#cb31-178" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Which plankton taxa did you choose and how did you choose them?</span>
<span id="cb31-179"><a href="#cb31-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-180"><a href="#cb31-180" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>What time period(s) did you examine and why?</span>
<span id="cb31-181"><a href="#cb31-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-182"><a href="#cb31-182" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>What environmental or dummy variables did you include and why?</span>
<span id="cb31-183"><a href="#cb31-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-184"><a href="#cb31-184" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>What forms of models did you fit (ie, write them out in matrix form)?</span>
<span id="cb31-185"><a href="#cb31-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-186"><a href="#cb31-186" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>What sort of model diagnostics did you use to examine model assumptions?</span>
<span id="cb31-187"><a href="#cb31-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-188"><a href="#cb31-188" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data:</span></span>
<span id="cb31-189"><a href="#cb31-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-190"><a href="#cb31-190" aria-hidden="true" tabindex="-1"></a>We chose to model four zooplankton taxa :Cyclops, Diaptomus, Epischura, and Neomysis. We chose these because they are similar types of zooplankton (copepods and mysids) which are known to be selective about the types of phytoplankton they consume <span class="co">[</span><span class="ot">@hansen1997</span><span class="co">]</span>. We used data from 1962-1985, because there is very little Neomysis data after 1985. We tested environmental covariates, including temperature, pH, and phosphorus concentrations as well as a seasonal dummy variable. We were also interested in the affect of phytoplankton abundance on these species, so we tested abundance indexes of diatoms, greens, unicells, and other.algae as potential covariates as well.</span>
<span id="cb31-191"><a href="#cb31-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-192"><a href="#cb31-192" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model:</span></span>
<span id="cb31-193"><a href="#cb31-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-194"><a href="#cb31-194" aria-hidden="true" tabindex="-1"></a><span class="fu"># Observation Model</span></span>
<span id="cb31-195"><a href="#cb31-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-196"><a href="#cb31-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-197"><a href="#cb31-197" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-198"><a href="#cb31-198" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}</span>
<span id="cb31-199"><a href="#cb31-199" aria-hidden="true" tabindex="-1"></a>y_1<span class="sc">\\</span></span>
<span id="cb31-200"><a href="#cb31-200" aria-hidden="true" tabindex="-1"></a>y_2<span class="sc">\\</span></span>
<span id="cb31-201"><a href="#cb31-201" aria-hidden="true" tabindex="-1"></a>y_3<span class="sc">\\</span></span>
<span id="cb31-202"><a href="#cb31-202" aria-hidden="true" tabindex="-1"></a>y_4<span class="sc">\\</span></span>
<span id="cb31-203"><a href="#cb31-203" aria-hidden="true" tabindex="-1"></a>y_5<span class="sc">\\</span></span>
<span id="cb31-204"><a href="#cb31-204" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}_t=</span>
<span id="cb31-205"><a href="#cb31-205" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}</span>
<span id="cb31-206"><a href="#cb31-206" aria-hidden="true" tabindex="-1"></a>Z_{11} &amp;  Z_{12} &amp;  Z_{13}<span class="sc">\\</span></span>
<span id="cb31-207"><a href="#cb31-207" aria-hidden="true" tabindex="-1"></a>Z_{21} &amp;  Z_{22} &amp;  Z_{23}<span class="sc">\\</span></span>
<span id="cb31-208"><a href="#cb31-208" aria-hidden="true" tabindex="-1"></a>Z_{31} &amp;  Z_{32} &amp;  Z_{33}<span class="sc">\\</span></span>
<span id="cb31-209"><a href="#cb31-209" aria-hidden="true" tabindex="-1"></a>Z_{41} &amp;  Z_{42} &amp;  Z_{43}<span class="sc">\\</span></span>
<span id="cb31-210"><a href="#cb31-210" aria-hidden="true" tabindex="-1"></a>Z_{51} &amp;  Z_{52} &amp;  Z_{53}<span class="sc">\\</span></span>
<span id="cb31-211"><a href="#cb31-211" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}*</span>
<span id="cb31-212"><a href="#cb31-212" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}</span>
<span id="cb31-213"><a href="#cb31-213" aria-hidden="true" tabindex="-1"></a>x_1<span class="sc">\\</span></span>
<span id="cb31-214"><a href="#cb31-214" aria-hidden="true" tabindex="-1"></a>x_2<span class="sc">\\</span></span>
<span id="cb31-215"><a href="#cb31-215" aria-hidden="true" tabindex="-1"></a>x_3<span class="sc">\\</span></span>
<span id="cb31-216"><a href="#cb31-216" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}_t+</span>
<span id="cb31-217"><a href="#cb31-217" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}</span>
<span id="cb31-218"><a href="#cb31-218" aria-hidden="true" tabindex="-1"></a> a_{1} <span class="sc">\\</span></span>
<span id="cb31-219"><a href="#cb31-219" aria-hidden="true" tabindex="-1"></a> a_{2}<span class="sc">\\</span></span>
<span id="cb31-220"><a href="#cb31-220" aria-hidden="true" tabindex="-1"></a> a_{3}<span class="sc">\\</span></span>
<span id="cb31-221"><a href="#cb31-221" aria-hidden="true" tabindex="-1"></a> a_{4}<span class="sc">\\</span></span>
<span id="cb31-222"><a href="#cb31-222" aria-hidden="true" tabindex="-1"></a> a_{5}<span class="sc">\\</span></span>
<span id="cb31-223"><a href="#cb31-223" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}*</span>
<span id="cb31-224"><a href="#cb31-224" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}</span>
<span id="cb31-225"><a href="#cb31-225" aria-hidden="true" tabindex="-1"></a>d_{Temp}<span class="sc">\\</span></span>
<span id="cb31-226"><a href="#cb31-226" aria-hidden="true" tabindex="-1"></a>d_{TP}<span class="sc">\\</span></span>
<span id="cb31-227"><a href="#cb31-227" aria-hidden="true" tabindex="-1"></a>d_{pH}<span class="sc">\\</span></span>
<span id="cb31-228"><a href="#cb31-228" aria-hidden="true" tabindex="-1"></a>d_{cos}<span class="sc">\\</span></span>
<span id="cb31-229"><a href="#cb31-229" aria-hidden="true" tabindex="-1"></a>d_{sin}<span class="sc">\\</span></span>
<span id="cb31-230"><a href="#cb31-230" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}_t+</span>
<span id="cb31-231"><a href="#cb31-231" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}</span>
<span id="cb31-232"><a href="#cb31-232" aria-hidden="true" tabindex="-1"></a>w_1<span class="sc">\\</span></span>
<span id="cb31-233"><a href="#cb31-233" aria-hidden="true" tabindex="-1"></a>w_2<span class="sc">\\</span></span>
<span id="cb31-234"><a href="#cb31-234" aria-hidden="true" tabindex="-1"></a>w_3<span class="sc">\\</span></span>
<span id="cb31-235"><a href="#cb31-235" aria-hidden="true" tabindex="-1"></a>w_4<span class="sc">\\</span></span>
<span id="cb31-236"><a href="#cb31-236" aria-hidden="true" tabindex="-1"></a>w_5<span class="sc">\\</span></span>
<span id="cb31-237"><a href="#cb31-237" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}_t</span>
<span id="cb31-238"><a href="#cb31-238" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-239"><a href="#cb31-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-240"><a href="#cb31-240" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-241"><a href="#cb31-241" aria-hidden="true" tabindex="-1"></a>\text{Where }w_i \sim MVN</span>
<span id="cb31-242"><a href="#cb31-242" aria-hidden="true" tabindex="-1"></a>\begin{pmatrix}</span>
<span id="cb31-243"><a href="#cb31-243" aria-hidden="true" tabindex="-1"></a>\text{0,}\begin{bmatrix}</span>
<span id="cb31-244"><a href="#cb31-244" aria-hidden="true" tabindex="-1"></a>R&amp;0&amp;0&amp;0&amp;0<span class="sc">\\</span></span>
<span id="cb31-245"><a href="#cb31-245" aria-hidden="true" tabindex="-1"></a>0&amp;R&amp;0&amp;0&amp;0<span class="sc">\\</span></span>
<span id="cb31-246"><a href="#cb31-246" aria-hidden="true" tabindex="-1"></a>0&amp;0&amp;R&amp;0&amp;0<span class="sc">\\</span></span>
<span id="cb31-247"><a href="#cb31-247" aria-hidden="true" tabindex="-1"></a>0&amp;0&amp;0&amp;R&amp;0<span class="sc">\\</span></span>
<span id="cb31-248"><a href="#cb31-248" aria-hidden="true" tabindex="-1"></a>0&amp;0&amp;0&amp;0&amp;R<span class="sc">\\</span></span>
<span id="cb31-249"><a href="#cb31-249" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}</span>
<span id="cb31-250"><a href="#cb31-250" aria-hidden="true" tabindex="-1"></a>\end{pmatrix}</span>
<span id="cb31-251"><a href="#cb31-251" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-252"><a href="#cb31-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-253"><a href="#cb31-253" aria-hidden="true" tabindex="-1"></a><span class="fu">## ZZ is loadings matrix</span></span>
<span id="cb31-256"><a href="#cb31-256" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-257"><a href="#cb31-257" aria-hidden="true" tabindex="-1"></a>ZZ <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb31-258"><a href="#cb31-258" aria-hidden="true" tabindex="-1"></a><span class="co"># Define different ZZ hypotheses </span></span>
<span id="cb31-259"><a href="#cb31-259" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 state</span></span>
<span id="cb31-260"><a href="#cb31-260" aria-hidden="true" tabindex="-1"></a>Z_vals <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"z11"</span>,</span>
<span id="cb31-261"><a href="#cb31-261" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z21"</span>, </span>
<span id="cb31-262"><a href="#cb31-262" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z31"</span>,</span>
<span id="cb31-263"><a href="#cb31-263" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z41"</span>)</span>
<span id="cb31-264"><a href="#cb31-264" aria-hidden="true" tabindex="-1"></a>ZZ[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">matrix</span>(Z_vals, <span class="at">nrow =</span> N_ts, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-265"><a href="#cb31-265" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 states</span></span>
<span id="cb31-266"><a href="#cb31-266" aria-hidden="true" tabindex="-1"></a>Z_vals <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"z11"</span>,  <span class="dv">0</span>  , </span>
<span id="cb31-267"><a href="#cb31-267" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z21"</span>,<span class="st">"z22"</span>, </span>
<span id="cb31-268"><a href="#cb31-268" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z31"</span>,<span class="st">"z32"</span>,</span>
<span id="cb31-269"><a href="#cb31-269" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z41"</span>,<span class="st">"z42"</span>)</span>
<span id="cb31-270"><a href="#cb31-270" aria-hidden="true" tabindex="-1"></a>ZZ[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">matrix</span>(Z_vals, <span class="at">nrow =</span> N_ts, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-271"><a href="#cb31-271" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 states</span></span>
<span id="cb31-272"><a href="#cb31-272" aria-hidden="true" tabindex="-1"></a>Z_vals <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"z11"</span>,  <span class="dv">0</span>  ,  <span class="dv">0</span>  ,</span>
<span id="cb31-273"><a href="#cb31-273" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z21"</span>,<span class="st">"z22"</span>,  <span class="dv">0</span>  ,</span>
<span id="cb31-274"><a href="#cb31-274" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z31"</span>,<span class="st">"z32"</span>,<span class="st">"z33"</span>,</span>
<span id="cb31-275"><a href="#cb31-275" aria-hidden="true" tabindex="-1"></a>               <span class="st">"z41"</span>,<span class="st">"z42"</span>,<span class="st">"z43"</span>)</span>
<span id="cb31-276"><a href="#cb31-276" aria-hidden="true" tabindex="-1"></a>ZZ[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">matrix</span>(Z_vals, <span class="at">nrow =</span> N_ts, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-277"><a href="#cb31-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-278"><a href="#cb31-278" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 states--removing this because we only have 4 sp groups</span></span>
<span id="cb31-279"><a href="#cb31-279" aria-hidden="true" tabindex="-1"></a><span class="co">#Z_vals &lt;- list("z11",  0  ,  0  , 0,</span></span>
<span id="cb31-280"><a href="#cb31-280" aria-hidden="true" tabindex="-1"></a>               <span class="co">#"z21","z22",  0  , 0,</span></span>
<span id="cb31-281"><a href="#cb31-281" aria-hidden="true" tabindex="-1"></a>               <span class="co">#"z31","z32","z33", 0,</span></span>
<span id="cb31-282"><a href="#cb31-282" aria-hidden="true" tabindex="-1"></a>               <span class="co">#"z41","z42","z43","z44")</span></span>
<span id="cb31-283"><a href="#cb31-283" aria-hidden="true" tabindex="-1"></a><span class="co">#ZZ[[4]] &lt;- matrix(Z_vals, nrow = N_ts, ncol = 4, byrow = TRUE)</span></span>
<span id="cb31-284"><a href="#cb31-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-285"><a href="#cb31-285" aria-hidden="true" tabindex="-1"></a><span class="do">## 'aa' is the offset/scaling</span></span>
<span id="cb31-286"><a href="#cb31-286" aria-hidden="true" tabindex="-1"></a>aa <span class="ot">&lt;-</span> <span class="st">"zero"</span></span>
<span id="cb31-287"><a href="#cb31-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-288"><a href="#cb31-288" aria-hidden="true" tabindex="-1"></a><span class="do">## 'DD' and 'd' are for covariates</span></span>
<span id="cb31-289"><a href="#cb31-289" aria-hidden="true" tabindex="-1"></a>DD <span class="ot">&lt;-</span> <span class="st">"zero"</span>  <span class="co"># matrix(0,mm,1)</span></span>
<span id="cb31-290"><a href="#cb31-290" aria-hidden="true" tabindex="-1"></a>dd <span class="ot">&lt;-</span> <span class="st">"zero"</span>  <span class="co"># matrix(0,1,wk_last)</span></span>
<span id="cb31-291"><a href="#cb31-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-292"><a href="#cb31-292" aria-hidden="true" tabindex="-1"></a><span class="do">## 'RR' is var-cov matrix for obs errors</span></span>
<span id="cb31-293"><a href="#cb31-293" aria-hidden="true" tabindex="-1"></a>RR <span class="ot">&lt;-</span> <span class="st">"diagonal and equal"</span></span>
<span id="cb31-294"><a href="#cb31-294" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-295"><a href="#cb31-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-296"><a href="#cb31-296" aria-hidden="true" tabindex="-1"></a><span class="fu"># Process Model</span></span>
<span id="cb31-297"><a href="#cb31-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-298"><a href="#cb31-298" aria-hidden="true" tabindex="-1"></a>Process model: $$</span>
<span id="cb31-299"><a href="#cb31-299" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}</span>
<span id="cb31-300"><a href="#cb31-300" aria-hidden="true" tabindex="-1"></a>x_1<span class="sc">\\</span></span>
<span id="cb31-301"><a href="#cb31-301" aria-hidden="true" tabindex="-1"></a>x_2<span class="sc">\\</span></span>
<span id="cb31-302"><a href="#cb31-302" aria-hidden="true" tabindex="-1"></a>x_3<span class="sc">\\</span></span>
<span id="cb31-303"><a href="#cb31-303" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}_t=</span>
<span id="cb31-304"><a href="#cb31-304" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}</span>
<span id="cb31-305"><a href="#cb31-305" aria-hidden="true" tabindex="-1"></a>1 &amp;  0 &amp;  0<span class="sc">\\</span></span>
<span id="cb31-306"><a href="#cb31-306" aria-hidden="true" tabindex="-1"></a>0 &amp;  1 &amp;  0<span class="sc">\\</span></span>
<span id="cb31-307"><a href="#cb31-307" aria-hidden="true" tabindex="-1"></a>0 &amp; 0 &amp; 1<span class="sc">\\</span></span>
<span id="cb31-308"><a href="#cb31-308" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}*</span>
<span id="cb31-309"><a href="#cb31-309" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}</span>
<span id="cb31-310"><a href="#cb31-310" aria-hidden="true" tabindex="-1"></a>x_1<span class="sc">\\</span></span>
<span id="cb31-311"><a href="#cb31-311" aria-hidden="true" tabindex="-1"></a>x_2<span class="sc">\\</span></span>
<span id="cb31-312"><a href="#cb31-312" aria-hidden="true" tabindex="-1"></a>x_3<span class="sc">\\</span></span>
<span id="cb31-313"><a href="#cb31-313" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}_{t-1}+</span>
<span id="cb31-314"><a href="#cb31-314" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}</span>
<span id="cb31-315"><a href="#cb31-315" aria-hidden="true" tabindex="-1"></a>v_1<span class="sc">\\</span></span>
<span id="cb31-316"><a href="#cb31-316" aria-hidden="true" tabindex="-1"></a>v_2<span class="sc">\\</span></span>
<span id="cb31-317"><a href="#cb31-317" aria-hidden="true" tabindex="-1"></a>v_3<span class="sc">\\</span></span>
<span id="cb31-318"><a href="#cb31-318" aria-hidden="true" tabindex="-1"></a>v_4<span class="sc">\\</span></span>
<span id="cb31-319"><a href="#cb31-319" aria-hidden="true" tabindex="-1"></a>v_5<span class="sc">\\</span></span>
<span id="cb31-320"><a href="#cb31-320" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}_t </span>
<span id="cb31-321"><a href="#cb31-321" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-322"><a href="#cb31-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-323"><a href="#cb31-323" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb31-324"><a href="#cb31-324" aria-hidden="true" tabindex="-1"></a>\text{Where }v_i \sim MVN</span>
<span id="cb31-325"><a href="#cb31-325" aria-hidden="true" tabindex="-1"></a>\begin{pmatrix}</span>
<span id="cb31-326"><a href="#cb31-326" aria-hidden="true" tabindex="-1"></a>\text{0,}\begin{bmatrix}</span>
<span id="cb31-327"><a href="#cb31-327" aria-hidden="true" tabindex="-1"></a>1&amp;0&amp;0<span class="sc">\\</span></span>
<span id="cb31-328"><a href="#cb31-328" aria-hidden="true" tabindex="-1"></a>0&amp;1&amp;0<span class="sc">\\</span></span>
<span id="cb31-329"><a href="#cb31-329" aria-hidden="true" tabindex="-1"></a>0&amp;0&amp;1<span class="sc">\\</span></span>
<span id="cb31-330"><a href="#cb31-330" aria-hidden="true" tabindex="-1"></a>\end{bmatrix}</span>
<span id="cb31-331"><a href="#cb31-331" aria-hidden="true" tabindex="-1"></a>\end{pmatrix}</span>
<span id="cb31-332"><a href="#cb31-332" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-333"><a href="#cb31-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-336"><a href="#cb31-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-337"><a href="#cb31-337" aria-hidden="true" tabindex="-1"></a><span class="do">## number of processes</span></span>
<span id="cb31-338"><a href="#cb31-338" aria-hidden="true" tabindex="-1"></a>mm <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># this is just a placeholder, as we loop through # of states we will update this</span></span>
<span id="cb31-339"><a href="#cb31-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-340"><a href="#cb31-340" aria-hidden="true" tabindex="-1"></a><span class="do">## 'BB' is identity: 1's along the diagonal &amp; 0's elsewhere</span></span>
<span id="cb31-341"><a href="#cb31-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-342"><a href="#cb31-342" aria-hidden="true" tabindex="-1"></a>BB <span class="ot">&lt;-</span> <span class="st">"identity"</span>  <span class="co"># diag(mm)</span></span>
<span id="cb31-343"><a href="#cb31-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-344"><a href="#cb31-344" aria-hidden="true" tabindex="-1"></a><span class="do">## 'uu' is a column vector of 0's</span></span>
<span id="cb31-345"><a href="#cb31-345" aria-hidden="true" tabindex="-1"></a>uu <span class="ot">&lt;-</span> <span class="st">"zero"</span>  <span class="co"># matrix(0, mm, 1)</span></span>
<span id="cb31-346"><a href="#cb31-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-347"><a href="#cb31-347" aria-hidden="true" tabindex="-1"></a><span class="do">## 'CC' and 'cc' are for covariates</span></span>
<span id="cb31-348"><a href="#cb31-348" aria-hidden="true" tabindex="-1"></a>CC <span class="ot">&lt;-</span> <span class="st">"zero"</span>  <span class="co"># matrix(0, mm, 1)</span></span>
<span id="cb31-349"><a href="#cb31-349" aria-hidden="true" tabindex="-1"></a>cc <span class="ot">&lt;-</span> <span class="st">"zero"</span>  <span class="co"># matrix(0, 1, wk_last)</span></span>
<span id="cb31-350"><a href="#cb31-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-351"><a href="#cb31-351" aria-hidden="true" tabindex="-1"></a><span class="do">## 'QQ' is identity</span></span>
<span id="cb31-352"><a href="#cb31-352" aria-hidden="true" tabindex="-1"></a>QQ <span class="ot">&lt;-</span> <span class="st">"identity"</span>  <span class="co"># diag(mm)</span></span>
<span id="cb31-353"><a href="#cb31-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-354"><a href="#cb31-354" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-355"><a href="#cb31-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-356"><a href="#cb31-356" aria-hidden="true" tabindex="-1"></a><span class="fu"># Fit with MARSS</span></span>
<span id="cb31-357"><a href="#cb31-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-360"><a href="#cb31-360" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-361"><a href="#cb31-361" aria-hidden="true" tabindex="-1"></a><span class="do">## list with specifications for model vectors/matrices</span></span>
<span id="cb31-362"><a href="#cb31-362" aria-hidden="true" tabindex="-1"></a>mod_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Z =</span> ZZ[[<span class="dv">2</span>]], <span class="at">A =</span> aa, <span class="at">D =</span> DD, <span class="at">d =</span> dd, <span class="at">R =</span> RR,</span>
<span id="cb31-363"><a href="#cb31-363" aria-hidden="true" tabindex="-1"></a>                 <span class="at">B =</span> BB, <span class="at">U =</span> uu, <span class="at">C =</span> CC, <span class="at">c =</span> cc, <span class="at">Q =</span> QQ)</span>
<span id="cb31-364"><a href="#cb31-364" aria-hidden="true" tabindex="-1"></a><span class="do">## list with model inits</span></span>
<span id="cb31-365"><a href="#cb31-365" aria-hidden="true" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x0 =</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="dv">0</span>, mm), mm, <span class="dv">1</span>))</span>
<span id="cb31-366"><a href="#cb31-366" aria-hidden="true" tabindex="-1"></a><span class="do">## list with model control parameters</span></span>
<span id="cb31-367"><a href="#cb31-367" aria-hidden="true" tabindex="-1"></a><span class="co">#con_list &lt;- list(maxit = 3000, allow.degen = FALSE) #allow.degen not allowed for BFGS</span></span>
<span id="cb31-368"><a href="#cb31-368" aria-hidden="true" tabindex="-1"></a>con_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">maxit =</span> <span class="dv">3000</span>)</span>
<span id="cb31-369"><a href="#cb31-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-370"><a href="#cb31-370" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-371"><a href="#cb31-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-372"><a href="#cb31-372" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model selection of # states}</span></span>
<span id="cb31-373"><a href="#cb31-373" aria-hidden="true" tabindex="-1"></a><span class="in">Z_AIC &lt;- data.frame(states = NA,AICc=NA)</span></span>
<span id="cb31-374"><a href="#cb31-374" aria-hidden="true" tabindex="-1"></a><span class="in">for (z in 1:length(ZZ)){</span></span>
<span id="cb31-375"><a href="#cb31-375" aria-hidden="true" tabindex="-1"></a><span class="in">## list with specifications for model vectors/matrices</span></span>
<span id="cb31-376"><a href="#cb31-376" aria-hidden="true" tabindex="-1"></a><span class="in"># the first mod_list is the long way of writing it out</span></span>
<span id="cb31-377"><a href="#cb31-377" aria-hidden="true" tabindex="-1"></a><span class="in"># mod_list &lt;- list(Z = ZZ[[z]], A = aa, D = DD, d = dd, R = RR,</span></span>
<span id="cb31-378"><a href="#cb31-378" aria-hidden="true" tabindex="-1"></a><span class="in">#                  B = BB, U = uu, C = CC, c = cc, Q = QQ)  </span></span>
<span id="cb31-379"><a href="#cb31-379" aria-hidden="true" tabindex="-1"></a><span class="in">mm &lt;- z</span></span>
<span id="cb31-380"><a href="#cb31-380" aria-hidden="true" tabindex="-1"></a><span class="in"># model_list specification </span></span>
<span id="cb31-381"><a href="#cb31-381" aria-hidden="true" tabindex="-1"></a><span class="in">mod_list = list(m = mm, R = "diagonal and equal")</span></span>
<span id="cb31-382"><a href="#cb31-382" aria-hidden="true" tabindex="-1"></a><span class="in">## list with model inits</span></span>
<span id="cb31-383"><a href="#cb31-383" aria-hidden="true" tabindex="-1"></a><span class="in">init_list &lt;- list(x0 = matrix(rep(0, mm), mm, 1))</span></span>
<span id="cb31-384"><a href="#cb31-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-385"><a href="#cb31-385" aria-hidden="true" tabindex="-1"></a><span class="in">## list with model control parameters</span></span>
<span id="cb31-386"><a href="#cb31-386" aria-hidden="true" tabindex="-1"></a><span class="in">#con_list &lt;- list(maxit = 3000, allow.degen = TRUE)</span></span>
<span id="cb31-387"><a href="#cb31-387" aria-hidden="true" tabindex="-1"></a><span class="in">con_list &lt;- list(maxit = 3000)</span></span>
<span id="cb31-388"><a href="#cb31-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-389"><a href="#cb31-389" aria-hidden="true" tabindex="-1"></a><span class="in">## fit MARSS</span></span>
<span id="cb31-390"><a href="#cb31-390" aria-hidden="true" tabindex="-1"></a><span class="in">dfa &lt;- MARSS(y = dat, model = mod_list, inits = init_list, control = con_list, covariates = t(cov_df),form="dfa",</span></span>
<span id="cb31-391"><a href="#cb31-391" aria-hidden="true" tabindex="-1"></a><span class="in">             method="BFGS")</span></span>
<span id="cb31-392"><a href="#cb31-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-393"><a href="#cb31-393" aria-hidden="true" tabindex="-1"></a><span class="in"># get model results</span></span>
<span id="cb31-394"><a href="#cb31-394" aria-hidden="true" tabindex="-1"></a><span class="in">Z_AIC[z,"states"] = z</span></span>
<span id="cb31-395"><a href="#cb31-395" aria-hidden="true" tabindex="-1"></a><span class="in">Z_AIC[z,"AICc"] = dfa$AICc</span></span>
<span id="cb31-396"><a href="#cb31-396" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb31-397"><a href="#cb31-397" aria-hidden="true" tabindex="-1"></a><span class="in">Z_AIC$AICc = Z_AIC$AICc- min(Z_AIC$AICc)</span></span>
<span id="cb31-398"><a href="#cb31-398" aria-hidden="true" tabindex="-1"></a><span class="in">Z_AIC</span></span>
<span id="cb31-399"><a href="#cb31-399" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-400"><a href="#cb31-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-401"><a href="#cb31-401" aria-hidden="true" tabindex="-1"></a>Best performing based on AICc is the one with 3 states.</span>
<span id="cb31-402"><a href="#cb31-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-405"><a href="#cb31-405" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-406"><a href="#cb31-406" aria-hidden="true" tabindex="-1"></a><span class="do">## list with specifications for model vectors/matrices</span></span>
<span id="cb31-407"><a href="#cb31-407" aria-hidden="true" tabindex="-1"></a><span class="co"># mod_list &lt;- list(Z = ZZ[[2]], A = aa, D = DD, d = dd, R = RR,</span></span>
<span id="cb31-408"><a href="#cb31-408" aria-hidden="true" tabindex="-1"></a><span class="co">#                  B = BB, U = uu, C = CC, c = cc, Q = QQ)</span></span>
<span id="cb31-409"><a href="#cb31-409" aria-hidden="true" tabindex="-1"></a>mm <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb31-410"><a href="#cb31-410" aria-hidden="true" tabindex="-1"></a><span class="co"># model_list specification </span></span>
<span id="cb31-411"><a href="#cb31-411" aria-hidden="true" tabindex="-1"></a>mod_list <span class="ot">=</span> <span class="fu">list</span>(<span class="at">m =</span> mm, <span class="at">R =</span> <span class="st">"diagonal and equal"</span>)</span>
<span id="cb31-412"><a href="#cb31-412" aria-hidden="true" tabindex="-1"></a><span class="do">## list with model inits</span></span>
<span id="cb31-413"><a href="#cb31-413" aria-hidden="true" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x0 =</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="dv">0</span>, mm), mm, <span class="dv">1</span>))</span>
<span id="cb31-414"><a href="#cb31-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-415"><a href="#cb31-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-416"><a href="#cb31-416" aria-hidden="true" tabindex="-1"></a><span class="do">## fit MARSS</span></span>
<span id="cb31-417"><a href="#cb31-417" aria-hidden="true" tabindex="-1"></a>dfa_2 <span class="ot">&lt;-</span> <span class="fu">MARSS</span>(<span class="at">y =</span> dat, <span class="at">model =</span> mod_list, <span class="at">inits =</span> init_list, <span class="at">control =</span> con_list, <span class="at">covariates =</span> <span class="fu">t</span>(cov_df),<span class="at">form=</span><span class="st">"dfa"</span>,</span>
<span id="cb31-418"><a href="#cb31-418" aria-hidden="true" tabindex="-1"></a>               <span class="at">method=</span><span class="st">"BFGS"</span>)</span>
<span id="cb31-419"><a href="#cb31-419" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-420"><a href="#cb31-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-421"><a href="#cb31-421" aria-hidden="true" tabindex="-1"></a>#Rotating trends and loadings</span>
<span id="cb31-422"><a href="#cb31-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-425"><a href="#cb31-425" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-426"><a href="#cb31-426" aria-hidden="true" tabindex="-1"></a><span class="do">## get the estimated ZZ</span></span>
<span id="cb31-427"><a href="#cb31-427" aria-hidden="true" tabindex="-1"></a>Z_est <span class="ot">&lt;-</span> <span class="fu">coef</span>(dfa_2, <span class="at">type =</span> <span class="st">"matrix"</span>)<span class="sc">$</span>Z</span>
<span id="cb31-428"><a href="#cb31-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-429"><a href="#cb31-429" aria-hidden="true" tabindex="-1"></a><span class="do">## get the inverse of the rotation matrix</span></span>
<span id="cb31-430"><a href="#cb31-430" aria-hidden="true" tabindex="-1"></a>H_inv <span class="ot">&lt;-</span> <span class="fu">varimax</span>(Z_est)<span class="sc">$</span>rotmat</span>
<span id="cb31-431"><a href="#cb31-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-432"><a href="#cb31-432" aria-hidden="true" tabindex="-1"></a><span class="co">#Now rotate both Z and x</span></span>
<span id="cb31-433"><a href="#cb31-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-434"><a href="#cb31-434" aria-hidden="true" tabindex="-1"></a><span class="do">## rotate factor loadings</span></span>
<span id="cb31-435"><a href="#cb31-435" aria-hidden="true" tabindex="-1"></a>Z_rot <span class="ot">=</span> Z_est <span class="sc">%*%</span> H_inv   </span>
<span id="cb31-436"><a href="#cb31-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-437"><a href="#cb31-437" aria-hidden="true" tabindex="-1"></a><span class="do">## rotate processes</span></span>
<span id="cb31-438"><a href="#cb31-438" aria-hidden="true" tabindex="-1"></a>proc_rot <span class="ot">=</span> <span class="fu">solve</span>(H_inv) <span class="sc">%*%</span> dfa_2<span class="sc">$</span>states</span>
<span id="cb31-439"><a href="#cb31-439" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-440"><a href="#cb31-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-441"><a href="#cb31-441" aria-hidden="true" tabindex="-1"></a>#Estimated States and Loadings of Model with 3 states</span>
<span id="cb31-442"><a href="#cb31-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-445"><a href="#cb31-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-446"><a href="#cb31-446" aria-hidden="true" tabindex="-1"></a><span class="do">## plot labels</span></span>
<span id="cb31-447"><a href="#cb31-447" aria-hidden="true" tabindex="-1"></a>zooplankton_names <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Cyclops"</span>, <span class="st">"Diaptomus"</span>, <span class="st">"Epischura"</span>, <span class="st">"Neomysis"</span>)</span>
<span id="cb31-448"><a href="#cb31-448" aria-hidden="true" tabindex="-1"></a>ylbl <span class="ot">&lt;-</span> zooplankton_names</span>
<span id="cb31-449"><a href="#cb31-449" aria-hidden="true" tabindex="-1"></a>w_ts <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">dim</span>(dat)[<span class="dv">2</span>])</span>
<span id="cb31-450"><a href="#cb31-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-451"><a href="#cb31-451" aria-hidden="true" tabindex="-1"></a><span class="co"># plot colors</span></span>
<span id="cb31-452"><a href="#cb31-452" aria-hidden="true" tabindex="-1"></a>clr <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"brown"</span>, <span class="st">"blue"</span>, <span class="st">"darkgreen"</span>, <span class="st">"darkred"</span>, <span class="st">"purple"</span>)</span>
<span id="cb31-453"><a href="#cb31-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-454"><a href="#cb31-454" aria-hidden="true" tabindex="-1"></a><span class="do">## set up plot area</span></span>
<span id="cb31-455"><a href="#cb31-455" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>), mm, <span class="dv">2</span>), <span class="at">widths =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))</span>
<span id="cb31-456"><a href="#cb31-456" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span>), <span class="at">omi =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb31-457"><a href="#cb31-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-458"><a href="#cb31-458" aria-hidden="true" tabindex="-1"></a><span class="do">## plot the processes</span></span>
<span id="cb31-459"><a href="#cb31-459" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>mm) {</span>
<span id="cb31-460"><a href="#cb31-460" aria-hidden="true" tabindex="-1"></a>  ylm <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(proc_rot[i,]))</span>
<span id="cb31-461"><a href="#cb31-461" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set up plot area</span></span>
<span id="cb31-462"><a href="#cb31-462" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(w_ts,proc_rot[i,], <span class="at">type =</span> <span class="st">"n"</span>, <span class="at">bty =</span> <span class="st">"L"</span>,</span>
<span id="cb31-463"><a href="#cb31-463" aria-hidden="true" tabindex="-1"></a>         <span class="at">ylim =</span> ylm, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">xaxt =</span> <span class="st">"n"</span>)</span>
<span id="cb31-464"><a href="#cb31-464" aria-hidden="true" tabindex="-1"></a>    <span class="do">## draw zero-line</span></span>
<span id="cb31-465"><a href="#cb31-465" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"gray"</span>)</span>
<span id="cb31-466"><a href="#cb31-466" aria-hidden="true" tabindex="-1"></a>    <span class="do">## plot trend line</span></span>
<span id="cb31-467"><a href="#cb31-467" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(w_ts, proc_rot[i,], <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb31-468"><a href="#cb31-468" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(w_ts, proc_rot[i,], <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb31-469"><a href="#cb31-469" aria-hidden="true" tabindex="-1"></a>    <span class="do">## add panel labels</span></span>
<span id="cb31-470"><a href="#cb31-470" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mtext</span>(<span class="fu">paste</span>(<span class="st">"State"</span>,i), <span class="at">side =</span> <span class="dv">3</span>, <span class="at">line =</span> <span class="fl">0.5</span>)</span>
<span id="cb31-471"><a href="#cb31-471" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axis</span>(<span class="dv">1</span>, <span class="dv">12</span> <span class="sc">*</span> (<span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(dat)[<span class="dv">2</span>]) <span class="sc">+</span> <span class="dv">1</span>, yr_frst <span class="sc">+</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">dim</span>(dat)[<span class="dv">2</span>])</span>
<span id="cb31-472"><a href="#cb31-472" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-473"><a href="#cb31-473" aria-hidden="true" tabindex="-1"></a><span class="do">## plot the loadings</span></span>
<span id="cb31-474"><a href="#cb31-474" aria-hidden="true" tabindex="-1"></a>minZ <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb31-475"><a href="#cb31-475" aria-hidden="true" tabindex="-1"></a>ylm <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(Z_rot))</span>
<span id="cb31-476"><a href="#cb31-476" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>mm) {</span>
<span id="cb31-477"><a href="#cb31-477" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(i)</span>
<span id="cb31-478"><a href="#cb31-478" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N_ts)[<span class="fu">abs</span>(Z_rot[,i])<span class="sc">&gt;</span>minZ],</span>
<span id="cb31-479"><a href="#cb31-479" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">as.vector</span>(Z_rot[<span class="fu">abs</span>(Z_rot[,i])<span class="sc">&gt;</span>minZ,i]),</span>
<span id="cb31-480"><a href="#cb31-480" aria-hidden="true" tabindex="-1"></a>       <span class="at">type =</span> <span class="st">"h"</span>,</span>
<span id="cb31-481"><a href="#cb31-481" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">ylim =</span> ylm,</span>
<span id="cb31-482"><a href="#cb31-482" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlim =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, N_ts <span class="sc">+</span> <span class="fl">0.5</span>), <span class="at">col =</span> clr)</span>
<span id="cb31-483"><a href="#cb31-483" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N_ts) {</span>
<span id="cb31-484"><a href="#cb31-484" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(Z_rot[j,i] <span class="sc">&gt;</span> minZ) {<span class="fu">text</span>(j, <span class="sc">-</span><span class="fl">0.03</span>, ylbl[j], <span class="at">srt =</span> <span class="dv">90</span>, <span class="at">adj =</span> <span class="dv">1</span>, <span class="at">cex =</span> <span class="fl">1.2</span>, <span class="at">col =</span> clr[j])}</span>
<span id="cb31-485"><a href="#cb31-485" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(Z_rot[j,i] <span class="sc">&lt;</span> <span class="sc">-</span>minZ) {<span class="fu">text</span>(j, <span class="fl">0.03</span>, ylbl[j], <span class="at">srt =</span> <span class="dv">90</span>, <span class="at">adj =</span> <span class="dv">0</span>, <span class="at">cex =</span> <span class="fl">1.2</span>, <span class="at">col =</span> clr[j])}</span>
<span id="cb31-486"><a href="#cb31-486" aria-hidden="true" tabindex="-1"></a>      <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lwd =</span> <span class="fl">1.5</span>, <span class="at">col =</span> <span class="st">"gray"</span>)</span>
<span id="cb31-487"><a href="#cb31-487" aria-hidden="true" tabindex="-1"></a>      } </span>
<span id="cb31-488"><a href="#cb31-488" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mtext</span>(<span class="fu">paste</span>(<span class="st">"Factor loadings on state"</span>, i), <span class="at">side =</span> <span class="dv">3</span>, <span class="at">line =</span> <span class="fl">0.5</span>)</span>
<span id="cb31-489"><a href="#cb31-489" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-490"><a href="#cb31-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-491"><a href="#cb31-491" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-492"><a href="#cb31-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-493"><a href="#cb31-493" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model selection of covariates}</span></span>
<span id="cb31-494"><a href="#cb31-494" aria-hidden="true" tabindex="-1"></a><span class="in">## list with specifications for model vectors/matrices</span></span>
<span id="cb31-495"><a href="#cb31-495" aria-hidden="true" tabindex="-1"></a><span class="in"># mod_list &lt;- list(Z = ZZ[[3]], A = aa, D = DD, d = dd, R = RR,</span></span>
<span id="cb31-496"><a href="#cb31-496" aria-hidden="true" tabindex="-1"></a><span class="in">#                  B = BB, U = uu, C = CC, c = cc, Q = QQ)</span></span>
<span id="cb31-497"><a href="#cb31-497" aria-hidden="true" tabindex="-1"></a><span class="in">mm &lt;- 3</span></span>
<span id="cb31-498"><a href="#cb31-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-499"><a href="#cb31-499" aria-hidden="true" tabindex="-1"></a><span class="in">mod_list = list(m = mm, R = "diagonal and equal")</span></span>
<span id="cb31-500"><a href="#cb31-500" aria-hidden="true" tabindex="-1"></a><span class="in">## list with model inits</span></span>
<span id="cb31-501"><a href="#cb31-501" aria-hidden="true" tabindex="-1"></a><span class="in">init_list &lt;- list(x0 = matrix(rep(0, mm), mm, 1))</span></span>
<span id="cb31-502"><a href="#cb31-502" aria-hidden="true" tabindex="-1"></a><span class="in">## list with model control parameters</span></span>
<span id="cb31-503"><a href="#cb31-503" aria-hidden="true" tabindex="-1"></a><span class="in">#con_list &lt;- list(maxit = 3000, allow.degen = F)</span></span>
<span id="cb31-504"><a href="#cb31-504" aria-hidden="true" tabindex="-1"></a><span class="in">con_list &lt;- list(maxit = 3000)</span></span>
<span id="cb31-505"><a href="#cb31-505" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb31-506"><a href="#cb31-506" aria-hidden="true" tabindex="-1"></a><span class="in"># Forward stepwise model selection</span></span>
<span id="cb31-507"><a href="#cb31-507" aria-hidden="true" tabindex="-1"></a><span class="in"># Create a table of indicators as to whether that predictor is include</span></span>
<span id="cb31-508"><a href="#cb31-508" aria-hidden="true" tabindex="-1"></a><span class="in">#cov.terms &lt;- c(covs,"seasonality")</span></span>
<span id="cb31-509"><a href="#cb31-509" aria-hidden="true" tabindex="-1"></a><span class="in">cov.terms&lt;-covs #seasonality is causing an issue so running without this</span></span>
<span id="cb31-510"><a href="#cb31-510" aria-hidden="true" tabindex="-1"></a><span class="in">mod.ind &lt;- matrix(F, ncol = length(cov.terms), nrow = 1)</span></span>
<span id="cb31-511"><a href="#cb31-511" aria-hidden="true" tabindex="-1"></a><span class="in">mod.tab &lt;- data.frame(mod.ind)</span></span>
<span id="cb31-512"><a href="#cb31-512" aria-hidden="true" tabindex="-1"></a><span class="in">names(mod.tab) &lt;- cov.terms</span></span>
<span id="cb31-513"><a href="#cb31-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-514"><a href="#cb31-514" aria-hidden="true" tabindex="-1"></a><span class="in"># Define a columns for storing model selection</span></span>
<span id="cb31-515"><a href="#cb31-515" aria-hidden="true" tabindex="-1"></a><span class="in">mod.tab$AICc &lt;- NA</span></span>
<span id="cb31-516"><a href="#cb31-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-517"><a href="#cb31-517" aria-hidden="true" tabindex="-1"></a><span class="in"># to keep track of the best model so far</span></span>
<span id="cb31-518"><a href="#cb31-518" aria-hidden="true" tabindex="-1"></a><span class="in">k_counter &lt;- 1 </span></span>
<span id="cb31-519"><a href="#cb31-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-520"><a href="#cb31-520" aria-hidden="true" tabindex="-1"></a><span class="in"># save the fits in a list</span></span>
<span id="cb31-521"><a href="#cb31-521" aria-hidden="true" tabindex="-1"></a><span class="in">DFA_fits &lt;- NULL</span></span>
<span id="cb31-522"><a href="#cb31-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-523"><a href="#cb31-523" aria-hidden="true" tabindex="-1"></a><span class="in">for(i in 1:(length(cov.terms)+1)){</span></span>
<span id="cb31-524"><a href="#cb31-524" aria-hidden="true" tabindex="-1"></a><span class="in">  print(i)</span></span>
<span id="cb31-525"><a href="#cb31-525" aria-hidden="true" tabindex="-1"></a><span class="in">  model_i &lt;- i</span></span>
<span id="cb31-526"><a href="#cb31-526" aria-hidden="true" tabindex="-1"></a><span class="in">  ind_on=as.matrix(mod.tab[i,1:length(cov.terms)])</span></span>
<span id="cb31-527"><a href="#cb31-527" aria-hidden="true" tabindex="-1"></a><span class="in">  # ind_off=as.matrix(!mod.tab[i,1:length(mod.terms)])</span></span>
<span id="cb31-528"><a href="#cb31-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-529"><a href="#cb31-529" aria-hidden="true" tabindex="-1"></a><span class="in">  # ind_off &lt;- !mod.ind[model_i, ]</span></span>
<span id="cb31-530"><a href="#cb31-530" aria-hidden="true" tabindex="-1"></a><span class="in">  # ind_on &lt;- mod.ind[model_i, ]</span></span>
<span id="cb31-531"><a href="#cb31-531" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb31-532"><a href="#cb31-532" aria-hidden="true" tabindex="-1"></a><span class="in">  # Set which covariates should be included</span></span>
<span id="cb31-533"><a href="#cb31-533" aria-hidden="true" tabindex="-1"></a><span class="in">  if (length(cov.terms[ind_on])==0){</span></span>
<span id="cb31-534"><a href="#cb31-534" aria-hidden="true" tabindex="-1"></a><span class="in">    cov_data = NULL</span></span>
<span id="cb31-535"><a href="#cb31-535" aria-hidden="true" tabindex="-1"></a><span class="in">  }else{</span></span>
<span id="cb31-536"><a href="#cb31-536" aria-hidden="true" tabindex="-1"></a><span class="in">    cov_data =  cov_df %&gt;% select(matches(cov.terms[ind_on])) %&gt;% t()</span></span>
<span id="cb31-537"><a href="#cb31-537" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb31-538"><a href="#cb31-538" aria-hidden="true" tabindex="-1"></a><span class="in">  if("seasonality" %in% cov.terms[ind_on]){ # special case where you have 2 columns for seasonality</span></span>
<span id="cb31-539"><a href="#cb31-539" aria-hidden="true" tabindex="-1"></a><span class="in">    cov_data = rbind(cov_data,dd)</span></span>
<span id="cb31-540"><a href="#cb31-540" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb31-541"><a href="#cb31-541" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb31-542"><a href="#cb31-542" aria-hidden="true" tabindex="-1"></a><span class="in">  # fit the model</span></span>
<span id="cb31-543"><a href="#cb31-543" aria-hidden="true" tabindex="-1"></a><span class="in">  dfa_model = MARSS(y = dat, model = mod_list, form = "dfa",inits = init_list, control = con_list,covariates=cov_data,</span></span>
<span id="cb31-544"><a href="#cb31-544" aria-hidden="true" tabindex="-1"></a><span class="in">                    method="BFGS")</span></span>
<span id="cb31-545"><a href="#cb31-545" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb31-546"><a href="#cb31-546" aria-hidden="true" tabindex="-1"></a><span class="in">  #save thi fit</span></span>
<span id="cb31-547"><a href="#cb31-547" aria-hidden="true" tabindex="-1"></a><span class="in">  DFA_fits[[i]] = get_DFA_fits(dfa_model,dd=cov_data)</span></span>
<span id="cb31-548"><a href="#cb31-548" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb31-549"><a href="#cb31-549" aria-hidden="true" tabindex="-1"></a><span class="in">  # add AICc valueto model</span></span>
<span id="cb31-550"><a href="#cb31-550" aria-hidden="true" tabindex="-1"></a><span class="in">  mod.tab[i,]$AICc &lt;- dfa_model$AICc</span></span>
<span id="cb31-551"><a href="#cb31-551" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb31-552"><a href="#cb31-552" aria-hidden="true" tabindex="-1"></a><span class="in">  # add new row and reset the AICc</span></span>
<span id="cb31-553"><a href="#cb31-553" aria-hidden="true" tabindex="-1"></a><span class="in">  mod.tab[i+1,] = mod.tab[i,]</span></span>
<span id="cb31-554"><a href="#cb31-554" aria-hidden="true" tabindex="-1"></a><span class="in">  mod.tab[i+1,]$AICc &lt;- NA</span></span>
<span id="cb31-555"><a href="#cb31-555" aria-hidden="true" tabindex="-1"></a><span class="in">  # turn the next random effect on for next model</span></span>
<span id="cb31-556"><a href="#cb31-556" aria-hidden="true" tabindex="-1"></a><span class="in">  mod.tab[i+1,i] = T</span></span>
<span id="cb31-557"><a href="#cb31-557" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb31-558"><a href="#cb31-558" aria-hidden="true" tabindex="-1"></a><span class="in">  if (i&gt;1){ # don't perform below to populate the 2nd row and 1st random effect</span></span>
<span id="cb31-559"><a href="#cb31-559" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb31-560"><a href="#cb31-560" aria-hidden="true" tabindex="-1"></a><span class="in">  # if model is better than the best performing model so far, keep the current random effect on for next model</span></span>
<span id="cb31-561"><a href="#cb31-561" aria-hidden="true" tabindex="-1"></a><span class="in">  if ((mod.tab$AICc[i]-mod.tab$AICc[i-k_counter])&lt; -4){</span></span>
<span id="cb31-562"><a href="#cb31-562" aria-hidden="true" tabindex="-1"></a><span class="in">    mod.tab[i+1,i-1] = T # redundant but just set up the code</span></span>
<span id="cb31-563"><a href="#cb31-563" aria-hidden="true" tabindex="-1"></a><span class="in">    k_counter = 1</span></span>
<span id="cb31-564"><a href="#cb31-564" aria-hidden="true" tabindex="-1"></a><span class="in">  } else { # if not better</span></span>
<span id="cb31-565"><a href="#cb31-565" aria-hidden="true" tabindex="-1"></a><span class="in">    mod.tab[i+1,i-1] = F # turn off current random effect for next model</span></span>
<span id="cb31-566"><a href="#cb31-566" aria-hidden="true" tabindex="-1"></a><span class="in">    k_counter=k_counter+1</span></span>
<span id="cb31-567"><a href="#cb31-567" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb31-568"><a href="#cb31-568" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb31-569"><a href="#cb31-569" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb31-570"><a href="#cb31-570" aria-hidden="true" tabindex="-1"></a><span class="in">mod.tab</span></span>
<span id="cb31-571"><a href="#cb31-571" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-572"><a href="#cb31-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-573"><a href="#cb31-573" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fit the best model}</span></span>
<span id="cb31-574"><a href="#cb31-574" aria-hidden="true" tabindex="-1"></a><span class="in">##ZR:I don't think there should be a model #10 so I'm just removing this...</span></span>
<span id="cb31-575"><a href="#cb31-575" aria-hidden="true" tabindex="-1"></a><span class="in">mod.tab&lt;-mod.tab[-10,]</span></span>
<span id="cb31-576"><a href="#cb31-576" aria-hidden="true" tabindex="-1"></a><span class="in">mod.tab$DeltaAICc&lt;-mod.tab$AICc - min(mod.tab$AICc)</span></span>
<span id="cb31-577"><a href="#cb31-577" aria-hidden="true" tabindex="-1"></a><span class="in">## get model fits &amp; CI's</span></span>
<span id="cb31-578"><a href="#cb31-578" aria-hidden="true" tabindex="-1"></a><span class="in">best_model_i = 8 #number 8 is simpler and similar AICc </span></span>
<span id="cb31-579"><a href="#cb31-579" aria-hidden="true" tabindex="-1"></a><span class="in">mod_fit &lt;- DFA_fits[[best_model_i]]</span></span>
<span id="cb31-580"><a href="#cb31-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-581"><a href="#cb31-581" aria-hidden="true" tabindex="-1"></a><span class="in">## plot the fits</span></span>
<span id="cb31-582"><a href="#cb31-582" aria-hidden="true" tabindex="-1"></a><span class="in">par(mfrow = c(N_ts, 1), mai = c(0.5, 0.7, 0.1, 0.1), omi = c(0, 0, 0, 0))</span></span>
<span id="cb31-583"><a href="#cb31-583" aria-hidden="true" tabindex="-1"></a><span class="in">for(i in 1:N_ts) {</span></span>
<span id="cb31-584"><a href="#cb31-584" aria-hidden="true" tabindex="-1"></a><span class="in">  up &lt;- mod_fit$up[i,]</span></span>
<span id="cb31-585"><a href="#cb31-585" aria-hidden="true" tabindex="-1"></a><span class="in">  mn &lt;- mod_fit$ex[i,]</span></span>
<span id="cb31-586"><a href="#cb31-586" aria-hidden="true" tabindex="-1"></a><span class="in">  lo &lt;- mod_fit$lo[i,]</span></span>
<span id="cb31-587"><a href="#cb31-587" aria-hidden="true" tabindex="-1"></a><span class="in">  plot(w_ts, mn, type = "n",</span></span>
<span id="cb31-588"><a href="#cb31-588" aria-hidden="true" tabindex="-1"></a><span class="in">       xlab = "", ylab = ylbl[i],</span></span>
<span id="cb31-589"><a href="#cb31-589" aria-hidden="true" tabindex="-1"></a><span class="in">       xaxt = "n", cex.lab = 1.2,</span></span>
<span id="cb31-590"><a href="#cb31-590" aria-hidden="true" tabindex="-1"></a><span class="in">       ylim = c(min(lo), max(up)))</span></span>
<span id="cb31-591"><a href="#cb31-591" aria-hidden="true" tabindex="-1"></a><span class="in">  axis(1, 12 * (0:dim(dat)[2]) + 1, yr_frst + 0:dim(dat)[2])</span></span>
<span id="cb31-592"><a href="#cb31-592" aria-hidden="true" tabindex="-1"></a><span class="in">  points(w_ts, dat[i,], pch = 16, col = clr[i])</span></span>
<span id="cb31-593"><a href="#cb31-593" aria-hidden="true" tabindex="-1"></a><span class="in">  lines(w_ts, up, col = "darkgray")</span></span>
<span id="cb31-594"><a href="#cb31-594" aria-hidden="true" tabindex="-1"></a><span class="in">  lines(w_ts, mn, col = "black", lwd = 2)</span></span>
<span id="cb31-595"><a href="#cb31-595" aria-hidden="true" tabindex="-1"></a><span class="in">  lines(w_ts, lo, col = "darkgray")</span></span>
<span id="cb31-596"><a href="#cb31-596" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb31-597"><a href="#cb31-597" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-598"><a href="#cb31-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-599"><a href="#cb31-599" aria-hidden="true" tabindex="-1"></a><span class="fu"># Results</span></span>
<span id="cb31-600"><a href="#cb31-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-601"><a href="#cb31-601" aria-hidden="true" tabindex="-1"></a>Model results can be found above in the code outputs. Models 8 and 9 had similar AICcs so we chose the simpler model (#8) The best model had 3 states, and included covariates for temperature, pH, diatoms and unicells.</span>
<span id="cb31-602"><a href="#cb31-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-603"><a href="#cb31-603" aria-hidden="true" tabindex="-1"></a><span class="fu"># Discussion</span></span>
<span id="cb31-604"><a href="#cb31-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-605"><a href="#cb31-605" aria-hidden="true" tabindex="-1"></a>Our results suggest that the best DFA model fit to time series of 4 groups of zooplankton(Cyclops, Diaptomus, Epischura, and Neomysis) included 3 states and covariates for temperature pH, diatoms and unicells. Copepods are known to prefer diatoms over other forms of phytoplankton <span class="co">[</span><span class="ot">@kleppel1993</span><span class="co">]</span> , so it makes sense that this would be an important covariate. Using a DFA did not greatly reduce the dimensionality of our dataset (we went from 4 species groups to 3), but maybe this affect would have been greater if we had used a larger set of the zooplankton groups.</span>
<span id="cb31-606"><a href="#cb31-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-607"><a href="#cb31-607" aria-hidden="true" tabindex="-1"></a><span class="fu"># Team Contributions</span></span>
<span id="cb31-608"><a href="#cb31-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-609"><a href="#cb31-609" aria-hidden="true" tabindex="-1"></a>All team members helped decide the question and plan for the analysis. ZR did the data wrangling for the zooplankton and the covariates, and checked for correlation issues with the covariates. NC wrote the matrix models in the methods section. NC and TW fit the models for different states using all the covariates. TW did the model selection for the different covariates. ZR helped with debugging the code, and wrote the discussion.</span>
<span id="cb31-610"><a href="#cb31-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-611"><a href="#cb31-611" aria-hidden="true" tabindex="-1"></a><span class="fu"># References</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/atsa-es/fish550-2023/edit/main/Lab-3/Final_Write_ups/Lab-3-team-3_final.Rmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/atsa-es/fish550-2023/blob/main/Lab-3/Final_Write_ups/Lab-3-team-3_final.Rmd" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/atsa-es/fish550-2023/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>