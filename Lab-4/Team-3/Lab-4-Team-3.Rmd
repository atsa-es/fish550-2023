---
title: "Lab 4 - Hidden Markov Models"
author: "Nick Chambers, Madison Shipley, Karl Veggerby"
date: May 9, 2023
output: 
  html_document:
    code-folding: true
    toc: true
    toc_float: true
---

```{r setup, include = FALSE}
options(dplyr.summarise.inform = FALSE)
```


# Data

Describe what plankton groups and covariates you used and indicate any temporal 
subsetting you chose. Also describe any standardization, centering or scaling 
that was used. 

## Load the data

We have included the `stoplight.csv` dataset for this week. One of the
columns divides indicators into groups (e.g. Local Physical, Local
Biological, etc). 

```{r load_data}
stoplight <- read.csv(here::here("Lab-4", "stoplight.csv"))

head(stoplight)
names(stoplight)

```

## Wrangle the data

### Objective tips 

Keep this relatively simple. select five times series pick some responses, pick some drivers.

Pass the model responses in as list of formulas-- family also has to be in the list 

* Reference slides 55-60

```{r wrangle_data}
## add some code here
class(stoplight)
names(stoplight)

#ecosystem indicators
stoplight[,1]  
years<-seq(1998:2021)

#ecosystem indicators to pull
PDO_DecMarch<-stoplight[1,] 
SST<-stoplight[4,] 
Copepod_richness<-stoplight[9,] 
Ichthy_community_index<-stoplight[14,]

#Example for PDO 

pdo$Year[which(pdo$Month%in%c("Oct","Nov","Dec"))] <- pdo$Year[which(pdo$Month%in%c("Oct","Nov","Dec"))] + 1
pdo <- dplyr::group_by(pdo, Year) %>%
  dplyr::summarize(winter_pdo = mean(PDO[which(Month %in% c("Oct","Nov","Dec","Jan","Feb"))])) %>% 
  dplyr::select(winter_pdo, Year)
# The first year will be missing Oct-Dec
pdo <- pdo[-1,]

#five times series in response and keep things to your block 



#pick some plankton, pick some drivers, 
```


# General tasks

Each group has the same general tasks, but you will adapt them as you work on the data.

Please pick a type of indicators, and develop a 2- or 3-state multivariate HMM. 

# Methods

A few tips:

-   Assume all responses are Gaussian.

-   You're welcome to include covariates (year? Climate variables?) --
    but fitting a simple model without covariates is also totally fine
    
```{r}
#EXAMPLE FROM LECTURE 

set.seed(123)
mod = depmix(list(L_stilbius ~ 1, L_ochotensis~1), 
             nstates = 2, 
             family = list(gaussian(),gaussian()),
             data=calcofi)
fitmod = fit(mod)

#plotting 
#plot first object 
object<-posterior(fitmod)[,c("S1","S2")]

#plot means of species in each state 
#get a vector of elements (n=states), and use the above code and scale by the coeffients 

```

# Results

Summarize the model you've created. Specifically,

-   Does it converge?

-   How many states seem to be most supported?

-   Plot the time series of estimated states. What does this mean?

-   What are the transition probabilities?

-   If included, what are the covariate effects? What do these mean?

-   Anything else interesting that you've discovered?

# Discussion


# Team contributions

Example: "All team members helped decide on the goal and ran the analyses for the individual regions. Team members 2 & 3 wrote most of the code for the analysis. Team member 1 worked on the plotting section of the report using and adapting code that team member 3 wrote. All team members helped edit the report and wrote the discussion together."

