---
title: "Lab 4 - Hidden Markov Models"
author: "Nick Chambers, Madison Shipley, Karl Veggerby"
date: May 9, 2023
output: 
  html_document:
    code-folding: true
    toc: true
    toc_float: true
---

```{r setup, include = FALSE}
options(dplyr.summarise.inform = FALSE)
```


# Data

Describe what plankton groups and covariates you used and indicate any temporal 
subsetting you chose. Also describe any standardization, centering or scaling 
that was used. 

## Load the data

We have included the `stoplight.csv` dataset for this week. One of the
columns divides indicators into groups (e.g. Local Physical, Local
Biological, etc). 

```{r load_data}

library(hmmTMB)
library(depmixS4)

stoplight <- read.csv(here::here("Lab-4", "stoplight.csv"))

head(stoplight)
names(stoplight)

```

## Wrangle the data

```{r}

#ecosystem indicators
stoplight[,1]  
years<-seq(1998,2021,1)

#ecosystem indicators to pull
PDO_DecMarch<-unlist(as.vector(stoplight[1,3:26])) 
SST<-unlist(as.vector(stoplight[4,3:26])) 
Copepod_richness<-unlist(as.vector(stoplight[9,3:26])) 
Ichthy_community_index<-unlist(as.vector(stoplight[14,3:26]))

dat<-matrix(nrow=length(years), ncol=5)
dat[,1]<-years
dat[,2]<-PDO_DecMarch
dat[,3]<-SST
dat[,4]<-Copepod_richness
dat[,5]<-Ichthy_community_index
colnames(dat)<-c("years","PDO", "SST", "CopeRich", "FishInx")
rownames(dat)<-seq(1,24,1)

dat<-as.data.frame(dat)
print(dat)
#five times series in response and keep things to your block 


#exploring the data more 
#rule 1 plot your data 

ggplot(dat, aes(x = years)) +
  geom_line(aes(y = PDO, color = "PDO"), size = 1) +
  geom_line(aes(y = SST, color = "SST"), size = 1) +
  scale_color_manual(values = c(PDO = "blue", SST = "red", CopeRich = "green", FishInx = "purple")) +
  labs(x = "Year", y = "Value", color = "Variable") +
  theme_minimal()

# Plotting all
ggplot(dat, aes(x = years)) +
  geom_line(aes(y = PDO, color = "PDO"), size = 1) +
  geom_line(aes(y = SST, color = "SST"), size = 1) +
  geom_line(aes(y = CopeRich, color = "CopeRich"), size = 1) +
  geom_line(aes(y = FishInx, color = "FishInx"), size = 1) +
  scale_color_manual(values = c(PDO = "blue", SST = "red", CopeRich = "green", FishInx = "purple")) +
  labs(x = "Year", y = "Value", color = "Variable") +
  theme_minimal()

# Plotting Coperich and env cov
ggplot(dat, aes(x = years)) +
  geom_line(aes(y = PDO, color = "PDO"), size = 1) +
  geom_line(aes(y = SST, color = "SST"), size = 1) +
  geom_line(aes(y = CopeRich, color = "CopeRich"), size = 1) +
  scale_color_manual(values = c(PDO = "blue", SST = "red", CopeRich = "green", FishInx = "purple")) +
  labs(x = "Year", y = "Value", color = "Variable") +
  theme_minimal()

# Plotting Coperich and env cov
ggplot(dat, aes(x = years)) +
  geom_line(aes(y = PDO, color = "PDO"), size = 1) +
  geom_line(aes(y = CopeRich, color = "CopeRich"), size = 1) +
  scale_color_manual(values = c(PDO = "blue", SST = "red", CopeRich = "green", FishInx = "purple")) +
  labs(x = "Year", y = "Value", color = "Variable") +
  theme_minimal()

# PDO states 
ggplot(dat, aes(x = years)) +
  geom_line(aes(y = PDO, color = "PDO"), size = 1) +
  scale_color_manual(values = c(PDO = "blue", SST = "red", CopeRich = "green", FishInx = "purple")) +
  labs(x = "Year", y = "Value", color = "Variable") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_hline(yintercept = 2.5, linetype = "dotted") +
  geom_hline(yintercept = -2.5, linetype = "dotted") +
  theme_minimal()

#Think of weak vs strong PDO?

#CopeRichness tracks very closely with PDO
#SST seems to have a negligible correlation 

ggplot(dat, aes(x = PDO, y = CopeRich, color = CopeRich < 0)) +
  geom_point() +
  geom_line(aes(x = PDO, y = CopeRich)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  scale_color_manual(values = c("red", "blue"), labels = c("Above 0", "Below 0")) +
  labs(x = "PDO", y = "CopeRich") +
  theme_minimal()
  

#fish index is all over the place, let's not use it. 

```


### Objective tips 

Keep this relatively simple. select five times series pick some responses, pick some drivers.

Pass the model responses in as list of formulas-- family also has to be in the list 

* Reference slides 55-60



# General tasks

Each group has the same general tasks, but you will adapt them as you work on the data.

Please pick a type of indicators, and develop a 2- or 3-state multivariate HMM. 

# Methods

A few tips:

-   Assume all responses are Gaussian.

-   You're welcome to include covariates (year? Climate variables?) --
    but fitting a simple model without covariates is also totally fine
    
    
    We fit models with different numbers of PDO states to determine whether PDO seems to have 2 or 3 states.It's unclear if there is a 'neutral' state that modulates copepod richness in addition to the hot and cool phases. 
    
   We also used a few options for the transition equatation in addition to PDO to explore if PDO was more effective than several simple numeric options for controlling transition dynamics.
   
    
```{r}
# Model 1
mod1 = depmix(CopeRich ~1,
                   nstates = 2, 
                   transition = ~1, 
                   family = gaussian(),
                   data=dat)

fitmod1 = fit(mod1)
summary(fitmod1)

#Find best fit 
iter <-100
seeds<-sample(100:1000, size = iter, replace = F)
best1 <- 1e10
best_model1 <- NA
for(i in 1:iter){
  set.seed(seeds[i])
  fitmod1 <- fit(mod1)
  if(AIC(fitmod1)< best1){
    best_model1 <- fitmod1
    best1 <- AIC(fitmod1)
  }
}

# plot(ts(posterior(best_model1, type="smoothing")[,1], start=c(2003,5), deltat=1/12),ylab="probability",
#      main="Posterior probability of state 1 (copepods good?).",
#      frame=FALSE)

prstates <- apply(posterior(best_model1)[,c("S1", "S2")],1, which.max)
mu <- summary(best_model1)[,1]

pred <- tibble("Year" = dat$years, "Copepod Richness" = mu[prstates])

#predicted values
pred1<-pred %>% 
  pivot_longer(-Year, names_to = "Copepod Richness", values_to = "Fit")

ggplot() +
  geom_line(data = pred1, aes(x = years, y = Fit, color = "predicted_states"), size = 1) +
  geom_line(data = dat, aes(x = years, y = CopeRich, color = "CopeRich"), size = 1) +
  geom_line(data = dat, aes(x = years, y = PDO_DecMarch, color = "PDO" ), size = 1)+
  scale_color_manual(values = c(PDO = "blue", SST = "red", CopeRich = "green",
                                FishInx = "purple", predicted_states = "orange")) +
  labs(title = " Model 1 - Two States", x = "Year", y = "Value", color = "Variable") +
  theme_minimal()

```


```{r}
# Model 2
mod2 = depmix(CopeRich ~1,
                   nstates = 3, 
                   transition = ~1, 
                   family = gaussian(),
                   data=dat)

fitmod2 = fit(mod2)
summary(fitmod2)

#Find best fit 
iter <-100
seeds<-sample(100:1000, size = iter, replace = F)
best2 <- 1e10
best_model2 <- NA
for(i in 1:iter){
  set.seed(seeds[i])
  fitmod2 <- fit(mod2)
  if(AIC(fitmod2)< best2){
    best_model2 <- fitmod2
    best2 <- AIC(fitmod2)
  }
}

# plot(ts(posterior(best_model1, type="smoothing")[,1], start=c(2003,5), deltat=1/12),ylab="probability",
#      main="Posterior probability of state 1 (copepods good?).",
#      frame=FALSE)

prstates <- apply(posterior(best_model2)[,c("S1", "S2")],1, which.max)
mu <- summary(best_model2)[,1]

pred <- tibble("Year" = dat$years, "Copepod Richness" = mu[prstates])

#predicted values
pred2 <- pred %>% 
  pivot_longer(-Year, names_to = "Copepod Richness", values_to = "Fit")

ggplot() +
   geom_line(data = pred2, aes(x = years, y = Fit, color = "predicted_states"), size = 1) +
  geom_line(data = dat, aes(x = years, y = CopeRich, color = "CopeRich"), size = 1) +
  geom_line(data = dat, aes(x = years, y = PDO_DecMarch, color = "PDO" ), size = 1)+
  scale_color_manual(values = c(PDO = "blue", SST = "red", CopeRich = "green",
                                FishInx = "purple", predicted_states = "orange")) +
  labs(title = " Model 2 - Three States", x = "Year", y = "Value", color = "Variable") +
  theme_minimal()

```
Compared to model 1, model two produces a poor visual fit when trying to fit three states to the data

```{r} 

############## The plot here needs work ##############


#Copepods and PDO as intercepts 
mod3 = depmix(list(CopeRich ~1, PDO~1),
             nstates = 2, 
             transition = ~1, 
             family = list(gaussian(),gaussian()),
             data=dat)

fitmod3 = fit(mod3)
summary(fitmod3)

#Find best fit 
iter <-100
seeds<-sample(100:1000, size = iter, replace = F)
best3 <- 1e10
best_model3 <- NA
for(i in 1:iter){
  set.seed(seeds[i])
  fitmod3 <- fit(mod3)
  if(AIC(fitmod3)< best3){
    best_model3 <- fitmod3
    best3 <- AIC(fitmod3)
  }
}

plot(ts(posterior(best_model3, type="smoothing")[,1], start=c(2003,5), deltat=1/12),ylab="probability",
     main="Posterior probability of state 1 (copepods good?).",
     frame=FALSE)

prstates<-apply(posterior(best_model3)[,c("S1", "S2")],1, which.max)
mu<-summary(best_model3)[,1]
mu3<-summary(best_model3)[,3]
pred <- tibble("Year" = dat$years, "Copepod Richness" = mu[prstates],"PDO" = mu3[prstates])
pred3<-pred %>% pivot_longer(-Year, names_to = "Covariates", values_to = "Fit")

ggplot() +
  geom_line(data = pred3, aes(x = Year, y = Fit, group = Covariates, color = Covariates)) +
  geom_line(data = dat, aes(x = years, y = CopeRich, color = "CopeRich"), size = 1) +
  geom_line(data = dat, aes(x = years, y = PDO_DecMarch, color = "PDO" ), size = 1)+
  scale_color_manual(values = c(PDO = "blue", SST = "red", CopeRich = "green",
                                FishInx = "purple", predicted_states = "orange")) +
  labs(title = " Model 3 - transition ~ 1", x = "Year", y = "Value", color = "Variable") +
  theme_minimal()


```
```{r}

#Copepods and PDO as intercepts where the transition is informed by PDO
mod4 = depmix(list(CopeRich ~1, PDO~1),
              nstates = 2, 
              transition = ~PDO, 
              family = list(gaussian(),gaussian()),
              data=dat)
fitmod4 = fit(mod4)
summary(fitmod4)

#Find best fit 
iter <-100
seeds<-sample(100:1000, size = iter, replace = F)
best4 <- 1e10
best_model4 <- NA
for(i in 1:iter){
  set.seed(seeds[i])
  fitmod4 <- fit(mod4)
  if(AIC(fitmod4)< best4){
    best_model4 <- fitmod4
    best4 <- AIC(fitmod4)
  }
}

plot(ts(posterior(best_model4, type="smoothing")[,1], start=c(2003,5), deltat=1/12),ylab="probability",
     main="Posterior probability of state 1 (copepods good?).",
     frame=FALSE)

prstates<-apply(posterior(best_model4)[,c("S1", "S2")],1, which.max)
mu<-summary(best_model4)[,1]
mu4<-summary(best_model4)[,3]
pred <- tibble("Year" = dat$years, "Copepod Richness" = mu[prstates],"PDO" = mu4[prstates])
pred4<-pred %>% pivot_longer(-Year, names_to = "Covariates", values_to = "Fit")

ggplot() +
  geom_line(data = pred4, aes(x = Year, y = Fit, group = Covariates, color = Covariates)) +
  geom_line(data = dat, aes(x = years, y = CopeRich, color = "CopeRich"), size = 1) +
  geom_line(data = dat, aes(x = years, y = PDO_DecMarch, color = "PDO" ), size = 1)+
  scale_color_manual(values = c(PDO = "blue", SST = "red", CopeRich = "green",
                                FishInx = "purple", predicted_states = "orange")) +
  labs(title = " Model 4 - Transition ~ PDO", x = "Year", y = "Value", color = "Variable") +
  theme_minimal()

```

```{r}

#Copepods as they relate to PDO
mod5 = depmix(list(CopeRich ~PDO),
              nstates = 2, 
              transition = ~1, 
              family = list(gaussian()),
              data=dat)
fitmod5 = fit(mod5)
summary(fitmod5)

#Find best fit 
iter <-100
seeds<-sample(100:1000, size = iter, replace = F)
best5 <- 1e10
best_model5 <- NA
for(i in 1:iter){
  set.seed(seeds[i])
  fitmod5 <- fit(mod5)
  if(AIC(fitmod5)< best5){
    best_model5 <- fitmod5
    best5 <- AIC(fitmod5)
  }
}

plot(ts(posterior(best_model5, type="smoothing")[,1], start=c(2003,5), deltat=1/12),ylab="probability",
     main="Posterior probability of state 1 (copepods good?).",
     frame=FALSE)

prstates<-apply(posterior(best_model5)[,c("S1", "S2")],1, which.max)
mu<-summary(best_model5)[,1]

pred <- tibble("Year" = dat$years, "Copepod Richness" = mu[prstates])
pred5<-pred %>% pivot_longer(-Year, names_to = "Copepod Richness", values_to = "Fit")

ggplot() +
   geom_line(data = pred5, aes(x = years, y = Fit, color = "predicted_states"), size = 1) +
  geom_line(data = dat, aes(x = years, y = CopeRich, color = "CopeRich"), size = 1) +
  geom_line(data = dat, aes(x = years, y = PDO_DecMarch, color = "PDO" ), size = 1)+
  scale_color_manual(values = c(PDO = "blue", SST = "red", CopeRich = "green",
                                FishInx = "purple", predicted_states = "orange")) +
  labs(title = " Model 2 - Three States", x = "Year", y = "Value", color = "Variable") +
  theme_minimal()

# ggplot() + geom_point(data = dat, aes(x = years, y = CopeRich, color = "Copepod Richness")) + 
#   geom_line(data = pred2, aes(x = years, y = Fit, group = "Copepod Richness", color = "Copepod Richness")) + theme_classic()


```


```{r}

#Copepods as they relate to PDO where the transition is informed by PDO
mod6 = depmix(list(CopeRich ~PDO),
              nstates = 2, 
              transition = ~PDO, 
              family = list(gaussian()),
              data=dat)
fitmod6 = fit(mod6)
summary(fitmod6)

#Find best fit 
iter <-100
seeds<-sample(100:1000, size = iter, replace = F)
best6 <- 1e10
best_model6 <- NA
for(i in 1:iter){
  set.seed(seeds[i])
  fitmod6 <- fit(mod6)
  if(AIC(fitmod6)< best6){
    best_model6 <- fitmod6
    best6 <- AIC(fitmod6)
  }
}

plot(ts(posterior(best_model6, type="smoothing")[,1], start=c(2003,5), deltat=1/12),ylab="probability",
     main="Posterior probability of state 1 (copepods good?).",
     frame=FALSE)

prstates<-apply(posterior(best_model6)[,c("S1", "S2")],1, which.max)
mu<-summary(best_model6)[,1]

pred <- tibble("Year" = dat$years, "Copepod Richness" = mu[prstates])
pred6<-pred %>% pivot_longer(-Year, names_to = "Copepod Richness", values_to = "Fit")

ggplot() +
   geom_line(data = pred6, aes(x = years, y = Fit, color = "predicted_states"), size = 1) +
  geom_line(data = dat, aes(x = years, y = CopeRich, color = "CopeRich"), size = 1) +
  geom_line(data = dat, aes(x = years, y = PDO_DecMarch, color = "PDO" ), size = 1)+
  scale_color_manual(values = c(PDO = "blue", SST = "red", CopeRich = "green",
                                FishInx = "purple", predicted_states = "orange")) +
  labs(title = " Model 2 - Three States", x = "Year", y = "Value", color = "Variable") +
  theme_minimal()


```

# Results

Summarize the model you've created. Specifically,

-   Does it converge?

-   How many states seem to be most supported?

-   Plot the time series of estimated states. What does this mean?

-   What are the transition probabilities?

-   If included, what are the covariate effects? What do these mean?

-   Anything else interesting that you've discovered?

# Discussion

## what we are still confused about



# Team contributions

Example: "All team members helped decide on the goal and ran the analyses for the individual regions. Team members 2 & 3 wrote most of the code for the analysis. Team member 1 worked on the plotting section of the report using and adapting code that team member 3 wrote. All team members helped edit the report and wrote the discussion together."

