---
title: "Lab 4 - Hidden Markov Models"
author: "Maria Kuruvilla, Miranda Mudge"
date: May 9, 2023
output: 
  html_document:
    code-folding: true
    toc: true
    toc_float: true
---

```{r setup, include = FALSE}
options(dplyr.summarise.inform = FALSE)
```


# Data

Describe what plankton groups and covariates you used and indicate any temporal 
subsetting you chose. Also describe any standardization, centering or scaling 
that was used. 

First we will only look at copepod richness with 2 states. For environmental covariates, we will use PDO(Sum; Dec - 
Mar)

## Load the data

We have included the `stoplight.csv` dataset for this week. One of the
columns divides indicators into groups (e.g. Local Physical, Local
Biological, etc). 

```{r load_data}
stoplight <- read.csv(here::here("Lab-4", "stoplight.csv"))
```

## Wrangle the data

```{r wrangle_data}
## add some code here

print(stoplight)

rownames(stoplight) <- stoplight[,1]

subset_data <- stoplight[c("Copepod_richness","N_copepod","S_copepod","PDO_DecMarch"),3:26]

#column names should be years
colnames(subset_data) <- seq(1998,2021)

print(subset_data)

par(mfrow = c(2,1), mai = c(0.5, 0.7, 0.1, 0.1), omi = c(0, 0, 0, 0))
plot(seq(1998,2021),subset_data["Copepod_richness",], type = "l", xlab = "years", ylab ="Copepod richness")
plot(seq(1998,2021),subset_data["N_copepod",], type = "l", xlab = "years", ylab ="N_copepod")
plot(seq(1998,2021),subset_data["S_copepod",], type = "l", xlab = "years", ylab ="S_copepod")
plot(seq(1998,2021),subset_data["PDO_DecMarch",], type = "l", xlab = "years", ylab ="PDO_DecMarch")

```
# Reframe multivariate dataset

```{r}
subset_data_l <- subset_data
subset_data_l$ID <- rownames(subset_data_l)

subset_data_long <- subset_data_l %>%
  pivot_longer(!ID, names_to = "variable",
               values_to = "value")


subset_multi <-pivot_wider(subset_data_long, names_from = ID, values_from = value, names_repair = "check_unique")
```

# HMM on 3 states

Basic 3 state model
```{r}
set.seed(123)
mod3_1 = depmix(list(Copepod_richness ~ 1, N_copepod~1, S_copepod~1), 
             nstates = 3, 
             family = list(gaussian(),gaussian(),gaussian()),
             data=subset_multi)
fitmod3_1 = fit(mod3_1)
AIC1 <- AIC(fitmod3_1)
```

## Effect of covariate on transition parameters
3 state model with covariate effects on transition parameters
```{r}
set.seed(123)
mod3_2 = depmix(list(Copepod_richness ~ 1, N_copepod~1, S_copepod~1), 
             nstates = 3, 
             family = list(gaussian(),gaussian(),gaussian()),
             transition = ~scale(PDO_DecMarch),
             data=subset_multi)
fitmod3_2 = fit(mod3_2)

summary(fitmod3_2, which = "transition")
summary(fitmod3_2, which = "response")
AIC2 <- AIC(fitmod3_2)
```

3 state model with covariate effects on state parameters
```{r}
set.seed(123)
mod3_3 = depmix(list(Copepod_richness ~ 1 +PDO_DecMarch, 
                     N_copepod~1 +PDO_DecMarch,
                     S_copepod~1+PDO_DecMarch), 
             nstates = 3, 
             family = list(gaussian(),gaussian(),gaussian()),
             data=subset_multi)
fitmod3_3 = fit(mod3_3)

summary(fitmod3_3, which = "transition")
summary(fitmod3_3, which = "response")
AIC3 <- AIC(fitmod3_3)
```

3 state model with covariate effects on state and transition parameters
```{r}
set.seed(123)
mod3_4 = depmix(list(Copepod_richness ~ 1 +PDO_DecMarch, 
                     N_copepod~1 +PDO_DecMarch,
                     S_copepod~1+PDO_DecMarch), 
             nstates = 3, 
             family = list(gaussian(),gaussian(),gaussian()),
             transition = ~scale(PDO_DecMarch),
             data=subset_multi)
fitmod3_4 = fit(mod3_4)

summary(fitmod3_4, which = "transition")
summary(fitmod3_4, which = "response")
AIC4 <- AIC(fitmod3_4)
```

```{r}
AIC1
AIC2
AIC3
AIC4
```

Model with covariate effects on state parameters yields lowest AIC, suggesting this is the optimal 3 state model. 

# code to plot 3 state model with covariate effects on state parameters
```{r}
# plot posterior state sequence for the 3-state model
state1 <- plot(ts(posterior(fitmod3_3, type="smoothing")[,1], # [] state #
        start=c(1998)))
state2 <- plot(ts(posterior(fitmod3_3, type="smoothing")[,2], # [] state #
        start=c(1998)))
state3 <- plot(ts(posterior(fitmod3_3, type="smoothing")[,3], # [] state #
        start=c(1998)))

state1
state2
state3
```

##### Address later #################################### 

## Example code to potentially try
This should eliminate need for set.seed by providing the best framework for the model
```{r}
best = 1.0e10
best_model = NA
for(i in 1:iter) {
  # fit the model
  fitmod = fit(mod)
  
  # check to see if this is the best solution?
  if(AIC(fitmod) < best) {
    best_model = fitmod
    best = AIC(fitmod)
  }
}

best(fitmod3_1)
```
# code to plot states
```{r}
# plot posterior state sequence for the 3-state model
state1 <- plot(ts(posterior(fitmod3_3, type="smoothing")[,1], # [] state #
        start=c(1998)))
state2 <- plot(ts(posterior(fitmod3_3, type="smoothing")[,2], # [] state #
        start=c(1998)))
state3 <- plot(ts(posterior(fitmod3_3, type="smoothing")[,3], # [] state #
        start=c(1998)))

state1
state2
state3
```

# from notes
```{r}
#mu = summary(fitmod3_1)[,1]

#pred = data.frame("year"=seq(min(subset_multi$variable), 
#  max(subset_multi$variable)),
#  "fit" = mu[prstates])
#pred
```

# General tasks

Each group has the same general tasks, but you will adapt them as you work on the data.

Please pick a type of indicators, and develop a 2- or 3-state multivariate HMM. 

# Methods

A few tips:

-   Assume all responses are Gaussian.

-   You're welcome to include covariates (year? Climate variables?) --
    but fitting a simple model without covariates is also totally fine



# Results

Summarize the model you've created. Specifically,

-   Does it converge?

-   How many states seem to be most supported?

-   Plot the time series of estimated states. What does this mean?

-   What are the transition probabilities?

-   If included, what are the covariate effects? What do these mean?

-   Anything else interesting that you've discovered?

# Discussion


# Team contributions

Example: "All team members helped decide on the goal and ran the analyses for the individual regions. Team members 2 & 3 wrote most of the code for the analysis. Team member 1 worked on the plotting section of the report using and adapting code that team member 3 wrote. All team members helped edit the report and wrote the discussion together."

# code from rdocumentation website for depmixs4
```{r}
# NOT RUN {
# create a 2 state model with one continuous and one binary response
# ntimes is used to specify the lengths of 3 separate series
data(speed)	
mod <- depmix(list(rt~1,corr~1),data=speed,nstates=2,
    family=list(gaussian(),multinomial("identity")),ntimes=c(168,134,137))
# print the model, formulae and parameter values
mod
set.seed(1)
# fit the model by calling fit
fm <- fit(mod)

# Volatility of S & P 500 returns
# (thanks to Chen Haibo for providing this example)

data(sp500)

# fit some models
msp <- depmix(logret~1,nstates=2,data=sp500)
set.seed(1)
fmsp <- fit(msp)	

# plot posterior state sequence for the 2-state model
plot(ts(posterior(fmsp, type="smoothing")[,1], 
        start=c(1950,2),
        deltat=1/12),
     ylab="probability",
main="Posterior probability of state 1 (volatile, negative markets).",
frame=FALSE)

# }
# NOT RUN {
# this creates data with a single change point with Poisson data
set.seed(3)
y1 <- rpois(50,1)
y2 <- rpois(50,2)
ydf <- data.frame(y=c(y1,y2))

# fit models with 1 to 3 states
m1 <- depmix(y~1,ns=1,family=poisson(),data=ydf)
set.seed(1)
fm1 <- fit(m1)
m2 <- depmix(y~1,ns=2,family=poisson(),data=ydf)
set.seed(1)
fm2 <- fit(m2)
m3 <- depmix(y~1,ns=3,family=poisson(),data=ydf)
set.seed(1)
fm3 <- fit(m3,em=em.control(maxit=500))

# plot the BICs to select the proper model
plot(1:3,c(BIC(fm1),BIC(fm2),BIC(fm3)),ty="b")

# }
# NOT RUN {
# }
# NOT RUN {
# similar to the binomial model, data may also be entered in 
# multi-column format where the n for each row can be different
dt <- data.frame(y1=c(0,1,1,2,4,5),y2=c(1,0,1,0,1,0),y3=c(4,4,3,2,1,1))
# specify a mixture model ...
m2 <- mix(cbind(y1,y2,y3)~1,data=dt,ns=2,family=multinomial("identity"))
set.seed(1)
fm2 <- fit(m2)
# ... or dependent mixture model
dm2 <- depmix(cbind(y1,y2,y3)~1,data=dt,ns=2,family=multinomial("identity"))
set.seed(1)
fdm2 <- fit(dm2)
# }
# NOT RUN {


# }

```