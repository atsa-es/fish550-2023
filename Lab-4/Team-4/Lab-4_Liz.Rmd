---
title: "Lab 4 - Hidden Markov Models"
author: "Person 1, Person 2, Person 3"
date: May 9, 2023
output: 
  html_document:
    code-folding: true
    toc: true
    toc_float: true
---

```{r setup, include = FALSE}
options(dplyr.summarise.inform = FALSE)
```

* Team 1: Dylan Hubl, Eric French, Zoe Rand
* Team 2: Maria Kuruvilla, Miranda Mudge
* Team 3: Nick Chambers, Madison Shipley, Karl Veggerby
* Team 4: Liz Elmstrom, Terrance Wang, Emma Timmins-Schiffman

Make sure to label your final write-up with "final" in the title so we know which one is the final one.

## Notes from Liz

Please pick a type of indicators, and develop a 2- or
3-state multivariate HMM. A few tips:

Emma -- 
We are going to fit a 2-state multivariate HMM to North and South Copepod biomass and Copepod richness.

Then we fit 3 state and compare

-   Assume all responses are Gaussian.

Liz --

Liz will try deep temp or upper temperature to see if this effects the steps 

-   You're welcome to include covariates (year? Climate variables?) --
    but fitting a simple model without covariates is also totally fine

Summarize the model you've created. Specifically,

Terrance -- 

Next steps -- Add in biological transition as another response variable. This time around, zscoring the response variables and re-run the models. 

-   Does it converge?

-   How many states seem to be most supported?

-   What are the transition probabilities?

-   Anything else interesting that you've discovered?

# General tasks

Each group has the same general tasks, but you will adapt them as you work on the data.

Please pick a type of indicators, and develop a 2- or 3-state multivariate HMM. 

# Methods

A few tips:

-   Assume all responses are Gaussian.

-   You're welcome to include covariates (year? Climate variables?) --
    but fitting a simple model without covariates is also totally fine

# Data

As part of the California Current Integrated Ecosystem Report, NOAA
scientists do annual updates of [stoplight charts for ecosystem
indicators](https://www.fisheries.noaa.gov/west-coast/science-data/ocean-conditions-indicators-trends).

We have included the `stoplight.csv` dataset for this week. One of the
columns divides indicators into groups (e.g. Local Physical, Local
Biological, etc). Please pick a type of indicators, and develop a 2- or
3-state multivariate HMM. A few tips:

Describe what plankton groups and covariates you used and indicate any temporal 
subsetting you chose. Also describe any standardization, centering or scaling 
that was used. 

## Load the data

One of the
columns divides indicators into groups (e.g. Local Physical, Local
Biological, etc). 

```{r load_data}
library(depmixS4)
library(ggplot2)
library(tidyverse)

stoplight <- read.csv(here::here("Lab-4", "stoplight.csv"))
```

## Wrangle the data

```{r wrangle_data}
## add some code here
## copepod richness, North/south copepod as response variables

#we will focus on copepod richness, N cop. biomass, S cop. biomass
#rows 9-11
cop.dat<-stoplight[9:11,]
cop.row<-cop.dat[,1]
cop.dat<-cop.dat[,3:26]
rownames(cop.dat)<-cop.row

#look at the data over time
cop.t<-t(cop.dat)
rows <- gsub("X","", rownames(cop.t))
row.names(cop.t)<-rows
cop.df<-data.frame(cop.t)
cop.df$Year<-row.names(cop.df)

# to make this tidyr happy
cop.df.long = cop.df %>% pivot_longer(-Year, names_to="indicator", values_to = "value") %>%
  mutate(Year=as.numeric(Year))

cop.df.long %>% ggplot(aes(x=Year,y=value,color=indicator)) + geom_line() + theme_bw()
```

```{r covariates}
library(janitor)

covar <- stoplight %>%
  filter(Ecosystem.Indicators %in% 
    c('Copepod_richness','N_copepod','S_copepod',"Deep_temperature","SST", "PDO_DecMarch","Biological_transition"))%>%
  select(!Type)%>% 
  t() %>%
  as_tibble %>% 
  row_to_names(row_number = 1)%>%
  mutate_if(is.character, as.numeric)

covar$Year <- 1998:2021

# to make this tidyr happy
cv.df = covar %>% pivot_longer(-Year, names_to="variable", values_to="value") %>%
  # z scores
  group_by(variable) %>% mutate(z_score = scale(value)) %>% group_by(Year) %>%
  filter(variable %in% c("N_copepod","S_copepod","Copepod_richness","Biological_transition"))

# save this as the non z score version
big.df = cv.df %>%
  select(-z_score) %>%
  # repivot for data analysis 
  pivot_wider(names_from="variable", values_from="value")

# save as z score version
big.df.z = cv.df %>%
  select(-value) %>%
  # repivot for data analysis 
  pivot_wider(names_from="variable", values_from="z_score")
```

# Results

Summarize the model you've created. Specifically,

-   Does it converge?

-   How many states seem to be most supported?

-   Plot the time series of estimated states. What does this mean?

-   What are the transition probabilities?

-   If included, what are the covariate effects? What do these mean?

-   Anything else interesting that you've discovered?

## Multivariate HMM - 2 state

```{r}
# loop through a few states and compare AIC
set.seed(123)
AIC_tbl = data.frame(nstate=0, AIC=0)
fit_list = NULL
for (i in 1:3){
mod<-depmix(list(Copepod_richness ~ 1, N_copepod ~ 1, S_copepod ~ 1,Biological_transition ~ 1),
                nstates = i,
                family=list(gaussian(), gaussian(),gaussian(),gaussian()),
                data=big.df)
fitmod <- fit(mod)
fit_list[[i]] = fitmod
# Transition matrix
# summary(fitmod, which = "transition")
# AIC
AIC_tbl[i,"nstate"] = i
AIC_tbl[i,"AIC"] = AIC(fitmod)
}

# do the same but with z scores
set.seed(123)
AIC_tbl_z = data.frame(nstate=0, AIC=0)
fit_list_z = NULL
for (i in 1:3){
mod<-depmix(list(Copepod_richness ~ 1, N_copepod ~ 1, S_copepod ~ 1,Biological_transition ~ 1),
                nstates = i,
                family=list(gaussian(), gaussian(),gaussian(),gaussian()),
                data=big.df.z)
fitmod <- fit(mod)
fit_list_z[[i]] = fitmod
# Transition matrix
# summary(fitmod, which = "transition")
# AIC
AIC_tbl_z[i,"nstate"] = i
AIC_tbl_z[i,"AIC"] = AIC(fitmod)
}

```

2 states seem like the most reasonable. Though a 3rd state lowers the AIC, adding more states usually lowers the AIC. We proceed with a 2 state HMM due to its interperability. 

```{r 2 state plots}
# compare HMM with raw data and z score data
# RAW DATA
#most probable states
prstates2 <- apply(posterior(fit_list[[2]]) [,c("S1", "S2")], 1, which.max)
# plot(prstates2, type='b', xlab='Time', ylab='State')

#estimated data/fits
mu2 <- summary(fit_list[[2]])[,1]
pred2 <- data.frame("year"=seq(min(big.df$Year), max(big.df$Year)), "fit" = mu2[prstates2])

# Z SCORE DATA
#most probable states
prstates2_z <- apply(posterior(fit_list_z[[2]]) [,c("S1", "S2")], 1, which.max)
# plot(prstates2, type='b', xlab='Time', ylab='State')

#estimated data/fits
mu2_z <- summary(fit_list_z[[2]])[,1]
pred2_z <- data.frame("year"=seq(min(big.df$Year), max(big.df$Year)), "fit" = mu2_z[prstates2_z])

# Raw data
ggplot() + 
  geom_point(data=cv.df,aes(x=Year,y=value,color=variable)) +
  geom_line(data=pred2, aes(year, fit)) + 
  ggtitle("Copepods - raw data and predictions") + 
  ylab("Indicator Value") + xlab("Year") + theme_bw()

# Z score
ggplot() + 
  geom_point(data=cv.df,aes(x=Year,y=z_score,color=variable),shape=4,size=3) +
  geom_line(data=pred2_z, aes(year, fit), linetype = "dashed") + 
  ggtitle("Copepods - z-score data and predictions") + 
  ylab("Indicator Value") + xlab("Year") + theme_bw()

# Transition Tables
summary(fit_list[[2]], which = "transition")
summary(fit_list_z[[2]], which = "transition")

```

There seems to be 2 state system, where the first state is associated with high copepod richness and S copepod, and low N copepod The second state is associated with low copepod richness and S copepod, and high N copepod. Our analysis shows that z-scoring the indicator data shows the same state fits as the raw data results, albeit at different scales. Z-scores are only useful for plotting purposes. Transition probabilities are identical. Though z-scoring the data is helpful in visualizing the contrast among states, we proceed with raw data when adding covariates. 


```{r 3 state plots}
# #most probable states, LIZ EDITED THIS
# prstates3 <- apply(posterior(fitmod.3st) [,c("S1", "S2", "S3")], 1, which.max)
# plot(prstates3, type='b', xlab='Time', ylab='State')
# 
# #estimated data
# mu3 <- summary(fitmod.3st)[,1]
# pred3 <- data.frame("year"=seq(min(cop.df$Year), max(cop.df$Year)), "fit" = mu3[prstates3])
# 
# ggplot(cop.df) + 
#   geom_point(aes(x=Year, y=Copepod_richness), col="black", size=1.5) + 
#   geom_point(aes(x=Year, y=N_copepod), col="blue", size=1.5) +
#   geom_point(aes(x=Year, y=S_copepod), col="magenta", size=1.5) +
#   geom_line(data=pred3, aes(year, fit)) + 
#   ggtitle("Copepods - raw data and predictions") + 
#   ylab("Richness or Biomass") + xlab("Year") + theme_bw()

```
I don't think we need the above chunk.

## Multivariate HMM with covariates

** Tried PDO, deep temperature, and SST, but not coded here. SST == better model fit. 

```{r covar}
#building the 2 state model
set.seed(123)
# mod.2covar <-depmix(list(Copepod_richness ~ 1, N_copepod ~ 1, S_copepod ~ 1),
#                 nstates = 2,# Could change this to three. Adding states almost always improves AICs
#                 family=list(gaussian(), gaussian(),gaussian()),
#                 transition = ~ SST+Deep_temperature,
#                 data=covar)
# 
# fitmod.2covar <- fit(mod.2covar)
# summary(fitmod.2covar, which = "transition")
# 
# aics <- c(AIC(fitmod.2st), AIC(fitmod.2covar))
# aics

# model sel
cov.terms<-c("SST","Deep_temperature")
# Create a table of indicators as to whethr that predictor is included
mod.ind <- as.matrix(expand.grid(c(FALSE,TRUE),c(FALSE,TRUE)))
mod.tab <- data.frame(mod.ind)
names(mod.tab) <- cov.terms

# Define a column for storing AIC
mod.tab$AIC  <- NA

for (i in 1:nrow(mod.tab)){
  ind_on=as.matrix(mod.tab[i,1:length(cov.terms)])
  # ind_off=as.matrix(!mod.tab[i,1:length(mod.terms)])

  # ind_off <- !mod.ind[model_i, ]
  # ind_on <- mod.ind[model_i, ]
  
  # Set which covariates should be included in formulas
  if (length(cov.terms[ind_on])==0){
    formula = ~1
  }else{
    formula =  paste("~",paste(cov.terms[ind_on],collapse="+"),sep="")
  }

  mod.2covar <-depmix(list(Copepod_richness ~ 1, N_copepod ~ 1, S_copepod ~ 1),
                nstates = 2,# Could change this to three. Adding states almost always improves AICs
                family=list(gaussian(), gaussian(),gaussian()),
                transition = eval(parse(text=formula)),
                data=covar)
  
  mod.tab[i,"AIC"] = AIC(mod.2covar)
}
```
All models that include covariates in the transition probabilities only increase the AIC, suggesting that we should not include covariates in our final model. 

SST slightly improves the model fit of the two state model. Don't really know how to interpret the transition matrix... 

SST maybe has a larger effect on the transition of Copepod richness to state 2? So when SST is high, Copepod Richness increases?

```{r covar 3 state}
# 3 state model 
set.seed(1)
mod.3covar <-depmix(list(Copepod_richness ~ 1, N_copepod ~ 1, S_copepod ~ 1),
                 nstates = 3,
                 family=list(gaussian(), gaussian(),gaussian()),
                 transition = ~ SST,
                 data=covar)

fitmod.3covar <- fit(mod.3covar)
summary(fitmod.3covar, which = "transition")

aics <- c(AIC(fitmod.3st), AIC(fitmod.3covar))
aics
#SST slightly improves the 2 state model AIC, no improvement to three state model

```
Adding covariate does not improve model fit to the three state model. 


```{r covariates plot}

#most probable states
prstates_covar <- apply(posterior(fitmod.2covar) [,c("S1", "S2")], 1, which.max)
plot(prstates_covar, type='b', xlab='Time', ylab='State')

#estimated data
mu_covar <- summary(fitmod.2covar)[,1]
pred_covar <- data.frame("year"=seq(min(covar$Year), max(covar$Year)), "fit" = mu_covar[prstates_covar])

ggplot(covar) + 
  geom_point(aes(x=Year, y=Copepod_richness), col="black", size=1.5) + 
  geom_point(aes(x=Year, y=N_copepod), col="blue", size=1.5) +
  geom_point(aes(x=Year, y=S_copepod), col="magenta", size=1.5) +
  geom_line(data=pred2, aes(year, fit), col = "orange")+
  geom_line(data=pred_covar, aes(year, fit)) + 
  ggtitle("Copepods - raw data and predictions") + 
  ylab("Richness or Biomass") + xlab("Year") + theme_bw()

## Fits are visually the same with and without covariates

```

# Discussion


# Team contributions

Example: "All team members helped decide on the goal and ran the analyses for the individual regions. Team members 2 & 3 wrote most of the code for the analysis. Team member 1 worked on the plotting section of the report using and adapting code that team member 3 wrote. All team members helped edit the report and wrote the discussion together."

